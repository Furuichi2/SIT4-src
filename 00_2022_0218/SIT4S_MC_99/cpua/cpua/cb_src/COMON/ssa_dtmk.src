;	***************************************************
;	***						***
;	***						***
;	***	データ変換				***
;	***						***
;	***						***
;	***************************************************
	.LIST	OFF
	.INCLUDE	"cm_equ1.equ"		; //共通定義:必ず実行ﾌﾟﾛｸﾞﾗﾑにｲﾝｸﾙｰﾄﾞする事
	.INCLUDE	"shn_cmd1.mac"		; //
	.INCLUDE	"ssa_kmc1.mac"		; //
	.INCLUDE	"ssa_pfom.equ"		; //equ定義
	.INCLUDE	"ssa_khad.equ"		; //equ定義
	.INCLUDE	"ssa_wrmk.ext"		; //
	.INCLUDE	"dp_cpuab.ext"		; //
	.INCLUDE	"dp_cpud.ext"		; //[2013-11-29 MC]
	.INCLUDE	"ssa_krom.ext"		; //
	.INCLUDE	"cb_param.ext"		; //
	.INCLUDE	"ssa_ver1.equ"		; //

	.INCLUDE	"ssa_timlt.equ"		; //



_TBLCURV		.DEFINE		"_CMPILE_YES"	;(SYSPARAMでｶｰﾌﾞ有/無)

;;;;;	============= 2013-03-07=======================
;;;;;	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
;;;;;_TBLCURV		.DEFINE		"_CMPILE_YES"	;CPUAは常にYESY:曲線ﾃｰﾌﾞﾙ(CPUAと同じ)
;;;;;	.AELSE
;;;;;		.AIF	_CPUB_TBLCURV EQ _CMPILE_YES	;CPUBの指定
;;;;;
;;;;;_TBLCURV		.DEFINE		"_CMPILE_YES"	;YES:曲線ﾃｰﾌﾞﾙ(CPUAと同じ)
;;;;;
;;;;;		.AELSE
;;;;;
;;;;;_TBLCURV		.DEFINE		"_CMPILE_NO"	;NO:直線タイプ
;;;;;		.AENDI	
;;;;;	.AENDI

;	================================================

	.LIST	ON

	.SECTION	P,CODE			;


;	//	***********************************
;	//	***	EXTERN 宣言 PROGRAM	***
;	//	***********************************
;;	.IMPORT		_RENEA_ORGIN_SET

	.IMPORT		_ABS_PLS_CHG_CTL_PLS		;
	.IMPORT		_CAM_DATA_MOV
	.IMPORT		_DIG36000_CHG_RENEA1
	.IMPORT		_RENEA_1ROT_PLS_AND_DIG_MAK1
	.IMPORT		_FUL_CLS_OBJPLS_CHK		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる


	.IMPORT		_CHG_LSI_LATE_TO_PLS		;2006-09-19

	.IMPORT		_COS_IN_DEG		;SSA_COM1.SRC
	.IMPORT		_COS_DIG1_UNIT_COEF	;SSA_COM1.SRC

	.IMPORT		_BRKTMCAL_DT_MOV	;2012-03-06

	.IMPORT		_TEP_DTMAK		;2013-06-13

;	-------------------------------------------
;	---	下振り子加速	2010-09-27[1]	---
;	-------------------------------------------
	.IMPORT	_DNM_TBL_CALC		;POS1/ACCT.INC





;	//	***********************************
;	//	***	EXTERN 宣言 MEMORY,HARD	***
;	//	***********************************
	.IMPORT		_FSYS_MAX_STEP_SEL		;2004-01-26
	.IMPORT		_FSYS_OPT_CNT_SEL	;SEL=1 連寸一、連続一行程有効

	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
	.AELSE
	.IMPORT		_SEQ_DP_TOP		;
	.AENDI

;	//	***********************************
;	//	***	PUBLIC 宣言 PROGRAM	***
;	//	***********************************
	.EXPORT		_CB_BAKUP_LOAD		;-->ssa_k.src
	.EXPORT		_PWR_ON_DAT_LOAD	;-->ssa_k.src
	.EXPORT		_SYS_DAT_LOAD		;-->ssa_k.src
	.EXPORT		_SV_DAT_LOAD		;-->ssa_k.src
	.EXPORT		_STEP_DAT_CHANGE1	;-->ssa_k.src
	.EXPORT		_FULL_CLOSE_DATA_MOV	;

	.EXPORT		_HMI_CPU_HAND		;-->ssa_k.src
	.EXPORT		_DIG_LNGTH_CALC1	;

	.EXPORT		_CALC_DATA_LOOP_MAKE1	;-->ssa_k.src
	.EXPORT		_UP_AREA_DATCHK		;-->ssa_ctrl.src

	.EXPORT		_LINK_CLANK_DIG_MAK
	.EXPORT		_POS_LSI_FRQ_DATA_MAK	;20060919 -->SSA_POS

	.EXPORT		_CHK_DNM_SPEC_MOD1		;2010-10-05
	.EXPORT		_DNM_MAXSPM_ACCLAT_MAK		;2010-10-05
	.EXPORT		_DATA_CMP2B_R5R6_REF

	.EXPORT		_CYCLE_SPD1		;

	.IMPORT		_REVRSE_BASINC_SPDCALC

;;;;	.IMPORT		_ACCLW_DATA_MAIN	;2015-11-17
	.IMPORT		_ACC_MATHED_SEL_MAIN	;2016-04-18

;//	**********ﾒﾓﾘ
	.IMPORT	_ACCB_ACCLAT_TIM1

;	*******************************************
;	***					***
;	***	ﾃﾞｰﾀ転送 符号拡張		***
;	***	2Bor4B-->2B/4B			***
;	*******************************************
	.MACRO	DATA_STD_SHN_MOV	SRC,L1,DST,L2
	MOV.L	#\SRC,R5		;
	MOV.\L1	@R5,R2			;

	MOV.L	#\DST,R6		;
	MOV.\L2	R2,@R6			;
	.ENDM

;	*******************************************
;	***					***
;	***	ﾃﾞｰﾀ転送 符号拡張		***
;	***	2Bor4B-->2B/4B			***
;	*******************************************
	.MACRO	DATA_MAX_MIN_SHN_MOV	SRC,L1,DST,L2,MAX,L3,MIN,L4
	MOV.L	#\SRC,R5		;
	MOV.\L1	@R5,R2			;
	MOV.\L3	#\MIN,R1		;
	CMP/GE	R1,R2			;
	BT	JMP1\@			;
	MOV	R1,R2			;
JMP1\@:					;
	MOV.\L4	#\MAX,R1		;
	CMP/GE	R2,R1			;
	BT	JMP2\@			;R2=<R1
	MOV	R1,R2			;
JMP2\@:					;
	MOV.L	#\DST,R6		;
	MOV.\L2	R2,@R6			;
	.ENDM



	.MACRO	DATA_LOP_SHN_MOV	SRC,L1,DST,L2,LOOP,CNT_REG,DSTADD
	MOV.W	#\LOOP,\CNT_REG		;
	MOV.L	#\SRC,R5		;
	MOV.L	#\DST,R6		;

JMP0\@:					;
	TST	\CNT_REG,\CNT_REG	;
	TST_BIT_OF JMP1\@		;
	MOV.\L1	@R5+,R2			;

	MOV.\L2	R2,@R6			;
	ADD	#\DSTADD,R6		;
	ADD	#-1,\CNT_REG		;
	M_BRA	JMP0\@			;

JMP1\@:					;
	.ENDM



;	***********************************
;	***	ｽﾃｯﾌﾟ分のﾙｰﾌﾟ転送	***
;	************************************
;2015-09-30 DATA_LOP_SHN_MOVの変形

	.MACRO	DATA_STEPLOP_SHN_MOV	SRC,L1,DST,L2,CNT_REG,DSTADD

	MOV.L	#_SET1_MTSTEP_MAXM,\CNT_REG	;
	MOV.W	@\CNT_REG,\CNT_REG	;

	MOV.L	#\SRC,R5		;
	MOV.L	#\DST,R6		;

JMP0\@:					;
	TST	\CNT_REG,\CNT_REG	;
	TST_BIT_OF JMP1\@		;
	MOV.\L1	@R5+,R2			;

	MOV.\L2	R2,@R6			;
	ADD	#\DSTADD,R6		;
	ADD	#-1,\CNT_REG		;
	M_BRA	JMP0\@			;

JMP1\@:					;
	.ENDM


;	*******************************************
;	***					***
;	***	ｻﾌﾞﾙｰﾁﾝ付転送			***
;	***	ｻﾌﾞﾙｰﾁﾝ内ではR8,R9保持が必要	***
;	***	LOOP=1:1回			***
;	*******************************************
	.MACRO	DATA_LOP_CHG_MOV	SRC,L1,DST,L2,CALLSB,LOOP,CNT_REG,DSTADD
	MOV.W	#\LOOP,\CNT_REG		;
	MOV.L	#\SRC,R8		;
	MOV.L	#\DST,R9		;

JMP0\@:					;
	TST	\CNT_REG,\CNT_REG	;
	TST_BIT_OF JMP1\@		;
	MOV.\L1	@R8+,R2			;

	FAR_JSR	#\CALLSB,R0		;R8,R9保持する事
	
	MOV.\L2	R2,@R9			;
	ADD	#\DSTADD,R9		;
	ADD	#-1,\CNT_REG		;
	M_BRA	JMP0\@			;
JMP1\@:					;
	.ENDM


;	*******************************************
;	***					***
;	***	ｻﾌﾞﾙｰﾁﾝ付転送			***
;	***	ｻﾌﾞﾙｰﾁﾝ内ではR8,R9保持が必要	***
;	***	LOOP=1:1回			***
;	*******************************************
;DATA_LOP_CHG_MOVの変形 2015-09-30 
	.MACRO	DATA_STEPLOP_CHG_MOV	SRC,L1,DST,L2,CALLSB,CNT_REG,DSTADD

	MOV.L	#_SET1_MTSTEP_MAXM,\CNT_REG	;
	MOV.W	@\CNT_REG,\CNT_REG	;

	MOV.L	#\SRC,R8		;
	MOV.L	#\DST,R9		;

JMP0\@:					;
	TST	\CNT_REG,\CNT_REG	;
	TST_BIT_OF JMP1\@		;
	MOV.\L1	@R8+,R2			;

	FAR_JSR	#\CALLSB,R0		;R8,R9保持する事
	
	MOV.\L2	R2,@R9			;
	ADD	#\DSTADD,R9		;
	ADD	#-1,\CNT_REG		;
	M_BRA	JMP0\@			;
JMP1\@:					;
	.ENDM


	.MACRO	DATA_STD_CHG_MOV	SRC,L1,DST,L2,CALLSB
	MOV.L	#\SRC,R8						;
	MOV.\L1	@R8,R2							;

	FAR_JSR	#\CALLSB,R0		;

	MOV.L	#\DST,R9		;
	MOV.\L2	R2,@R9			;
	.ENDM



;	------------- SRC DATA / LATE ->DST DATA --------
	.MACRO	DT_DIV_LATCHG	SRC,L1,DST,L2,LATE
	MOV.L	#\SRC,R1					;
	MOV.\L1	@R1,R2						;
	MOV.L	#\LATE,R4
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0	;
	MOV.L	#\DST,R1
	MOV.\L2	R2,@R1

	.ENDM






;	*******************************************
;	***					***
;	***	1度ﾃﾞｰﾀを10倍			***
;	***	2B->2B				***
;	*******************************************
	.MACRO	DATA_DIG_M10_MOV	SRC,L1,DST,L2
	.ENDM

;	*******************************************
;	***					***
;	***	0.1度ﾃﾞｰﾀをﾘﾝｸ1ﾊﾟﾙｽに変換	***
;	***	2B		4B		***
;	*******************************************
	.MACRO	DATA_DIG_LNK_MOV	SRC,L1,DST,L2
	.ENDM



;	*******************************************
;	***					***
;	***	ﾊﾝﾄﾞｼｨｴｸ			***
;	***					***
;	***					***
;	*******************************************
_HMI_CPU_HAND:			;-->ssa_k.src
	SUB_START
	MOV.L	#_HS_SVCHG_B_TO_A,R1	;
	MOV.L	@R1,R0			;DPRAM "IN"

	MOV.L	#_CPU_SV_HAND_IN,R1	;
	MOV.L	@R1,R2

;;;2015-04-07整理(論理変更ない)	MOV.L	#_CPU_SV_HAND_OUT,R1	;回答
;;;2015-04-07整理(論理変更ない)	MOV.L	R2,@R1			;

	MOV.L	#_CPU_SV_HAND_OUT,R1	;回答
	MOV.L	R0,@R1			;WORKへ
	XOR	R0,R2			;
	AND	R2,R0			;
	MOV.L	#_CPU_SV_HAND_IN_ON,R1	;
	MOV.L	R0,@R1

;	===========================================
;	==== 	ONｴｯｼﾞ時に必要な処理を行う	===
;	===========================================
	MOV	#BIT0,R0			;[ON固定]
	TST	#BIT0,R0			;SERVO PARAM
	TST_BIT_OF HMI_CPU_HD_SET050		;
	PUSH_REG1 R0


	FAR_JSR	#_PWR_ON_DAT_LOAD,R0		;電源のﾊﾝﾄﾞｼｪｲｸ終了時
;;;<<<不要>>>	FAR_JSR	#_SYS_DAT_LOAD,R0		;電源のﾊﾝﾄﾞｼｪｲｸ終了時のみとする

;;;2013-02-05	FAR_JSR	#_SV_DAT_LOAD,R0		;ﾒｲﾝｽｷｬﾝ:変更要求時
	FAR_JSR	#_SV_DAT_N_LOAD,R0		;

	FAR_JSR	#_STEP_DAT_CHANGE1,R0		;ﾒｲﾝｽｷｬﾝ:位置決め中以外
	FAR_JSR	#_FULL_CLOSE_DATA_MOV,R0	;ﾒｲﾝｽｷｬﾝ:位置決め中以外

;	-------2012-03-06--
	FAR_JSR	#_SV_ERR_CMPDT_MAKE,R0		;

;	-------------------------------------------
;	---	下振り子加速	2010-09-27[1]	---
;	-------------------------------------------
	FAR_JSR	#_DNM_TBL_CALC,R0		;ｽｷｬﾝ分割すべきはこれ2013-


;	---------------------------------------------------
;	---	オーバヒート電流	2012-09-25	---
;	---------------------------------------------------
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
	.IMPORT	_OVERH_MODE_DT_MAK
	FAR_JSR	#_OVERH_MODE_DT_MAK,R0		;
	.AENDI


;	-------------------------------------------
;	---	データチェック	2013-02		---
;	-------------------------------------------
 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
;;;;2015-10-23	FAR_JSR	#_MOTION_DATASPD_CHK,R0		;[

;	-------2015-10-23-----------
	FAR_JSR	#_MOTION_DATA_LMT_CHK,R0		;[3つのﾁｪｯｸ]

;;;;2015-10-23	;	---------2015-07-08-----
;;;;2015-10-23		FAR_JSR	#_SPD_POS_SET_ERRCHK1,R0	

 .AENDI



 .AIF	_CB_CPU_SEL EQ	_CB_CPUA

	.IMPORT	_TECH_DAN_DIG_MAKE	;2013-03
	FAR_JSR	#_TECH_DAN_DIG_MAKE,R0	;2013-03金型ﾀｯﾁ挿入演算


;;;;;;	FAR_JSR	#_SPD_DATA_CHANGE_CHK1,R0	;戻り速度変更       2015-10-25[]
;;;;;;	FAR_JSR	#_SPD_DATA_CHANGE_CHK2,R0	;モーション速度変更 2015-05-20[型ﾀｯﾁ,ﾃﾞｰﾀﾁｪｯｸ赤・青丸]

;	------ 2015-05-20---
	.IMPORT	_INSERT_MOTCHK_SVCHG
	FAR_JSR	#_INSERT_MOTCHK_SVCHG,R0	;

 .AENDI



	POP_REG1 R0
HMI_CPU_HD_SET050:

;;;2015-04-07整理(論理変更ない)		TST	#BIT1,R0			;SV
;;;2015-04-07整理(論理変更ない)		TST_BIT_OF HMI_CPU_HD_SET100		;ここにはこない(2010)
;;;2015-04-07整理(論理変更ない)		PUSH_REG1 R0				;
;;;2015-04-07整理(論理変更ない)	
;;2012-03-06ここにはこない	FAR_JSR	#_SV_DAT_LOAD,R0		;ﾒｲﾝｽｷｬﾝ:変更要求時
;;2012-03-06ここにはこない	FAR_JSR	#_STEP_DAT_CHANGE1,R0		;ﾒｲﾝｽｷｬﾝ:位置決め中以外
;;2012-03-06ここにはこない	FAR_JSR	#_FULL_CLOSE_DATA_MOV,R0	;ﾒｲﾝｽｷｬﾝ:位置決め中以外
;;2012-03-06ここにはこない
;;2012-03-06ここにはこない
;;2012-03-06ここにはこない;	-------------------------------------------
;;2012-03-06ここにはこない;	---	下振り子加速	2010-09-27[1]	---
;;2012-03-06ここにはこない;	-------------------------------------------
;;2012-03-06ここにはこない	FAR_JSR	#_DNM_TBL_CALC,R0		;
;;;2015-04-07整理(論理変更ない)	
;;;2015-04-07整理(論理変更ない)		POP_REG1 R0
;;;2015-04-07整理(論理変更ない)	HMI_CPU_HD_SET100:

;	=====================================
;;;2015-04-07整理(論理変更ない)		MOV.L	#_CPU_SV_HAND_IN_ON,R1		;本当は不要
;;;2015-04-07整理(論理変更ない)		MOV.L	@R1,R0				;
;;;2015-04-07整理(論理変更ない)	
;;;2015-04-07整理(論理変更ない)		TST	#BIT2,R0			;原点
;;;2015-04-07整理(論理変更ない)		TST_BIT_OF HMI_CPU_HD_SET200		;
;;;2015-04-07整理(論理変更ない)		PUSH_REG1 R0
;;;2015-04-07整理(論理変更ない)		NOP
;;;2015-04-07整理(論理変更ない)	;;;	FAR_JSR	#_RENEA_ORGIN_SET,R0		;怪しいからチェックしてから
;;;2015-04-07整理(論理変更ない)		POP_REG1 R0
;;;2015-04-07整理(論理変更ない)	HMI_CPU_HD_SET200:

	MOV.L	#_SVP_RNAORG_POS1,R1		;
	MOV.L	@R1,R0				;
	MOV.L	#_OLD_RNAORG_POS1,R1		;
	MOV.L	@R1,R2				;OLD LOAD
	MOV.L	R0,@R1				;
	XOR	R2,R0				;
	TST	R0,R0				;
	TST_BIT_OF HMI_CPU_HD_SET500		;
	PUSH_REG1 R0				;
	DATA_STD_SHN_MOV SRC=_SVP_RNAORG_POS1	,L1=L,DST=_SET1_RNAORG_POS1	,L2=L	;4;機械原点入力
	FAR_JSR	#_RENEA_ORGIN_SET,R0		;ﾊﾞｯｸｱｯﾌﾟﾃﾞｰﾀ→OFFSET1へ
	POP_REG1 R0				;
HMI_CPU_HD_SET500:				;


;	===========================================
;	==== 	ONｴｯｼﾞ時に必要な処理終了	===
;	===========================================
	FAR_JSR	#_CPU_SV_HAND_ACK,R0	;実出力
	SUB_END
	M_RTS


;	***************************************************
;	***	バックアップデータLOAD			***
;	***************************************************
_CB_BAKUP_LOAD:
	SUB_START
	DATA_STD_SHN_MOV	SRC=_SVP_RNAORG_POS1	,L1=L,DST=_SET1_RNAORG_POS1	,L2=L	;4;機械原点入力

;	===== ﾊﾞｯｸｱｯﾌﾟLOAD =====
	MOV.L	#_SVB_RNAORG_PLS1,R1	;
	MOV.L	@R1,R2			;

	MOV.L	#_RNA_POS_OFFSET1,R4	;(電源投入時 HMI->取込み)
	MOV.L	R2,@R4			;

;	=======================
	MOV.L	#_SET1_RNAORG_POS1,R4	;
	MOV.L	@R4,R0			;

	MOV.L	#_OLD_RNAORG_POS1,R4	;
	MOV.L	R0,@R4			;

	MOV.L	#_RNA_POS_OFFSET2,R4	;原点設定
	MOV.L	R0,@R4			;

	.IMPORT	_KAJYUU_BAKUP_INIT_DISP
	FAR_JSR	#_KAJYUU_BAKUP_INIT_DISP,R0

	SUB_END
	M_RTS


_PWR_ON_DAT_LOAD:
	SUB_START

;;;;	FAR_JSR	#_DEBUG_DEF_DAT_SET,R0

	DATA_STD_SHN_MOV	SRC=_SVP_RNADIR_SEL1	,L1=W,DST=_SET1_RNADIR_SEL1	,L2=W	;2;ﾘﾆｱｾﾝｻ極性
	DATA_STD_SHN_MOV	SRC=_SVP_INCDIR_SEL1	,L1=W,DST=_SET1_INCDIR_SEL1	,L2=W	;2;PG極性

;;2004-08-04	==== 2;PG1回転のﾊﾟﾙｽ選択 =====
;;	MOV.W	#H'2000,R2		;(8192)
;;	MOV	R2,R3			;DEFULT
;;	MOV.L	#_SVP_INCPLS_1REV,R1	;
;;	MOV.W	@R1,R0			;
;;	CMP/EQ	#0,R0			;
;;	BT	PWR_ON_DT_LD_INCPLS050	;YES 8192
;;
;;	SHLL	R2			;
;;	CMP/EQ	#1,R0			;
;;	BT	PWR_ON_DT_LD_INCPLS050	;YES 16384
;;
;;	SHLL	R2			;
;;	CMP/EQ	#2,R0			;
;;	BT	PWR_ON_DT_LD_INCPLS050	;YES 32767
;;	MOV	R3,R2			;"8192"
;;					;
;;PWR_ON_DT_LD_INCPLS050:			;


;	======= 2009-11-03 ===================
;	======== [2009-11-03 PG01]
;	========= ﾄﾖﾀ仕様 180000ﾊﾟﾙｽで360度===
	MOV.L	#_SVP_INCPLS_1REV,R1	;
	MOV.W	@R1,R0			;
 	CMP/EQ	#3,R0			;本当は3
 	BF	INC_PLS_STDCHG_STR	;3以外は今までどおり

	MOV.W	#1,R0			;回転=1(1REV×1)
	MOV.L	#_SET1_INCPLS_HOSN,R1	;
	MOV.W	R0,@R1			;

	MOV.W	#D'360,R0		;
	MOV.L	#_SET1_INCPLS_HOSM,R1	;
	MOV.W	R0,@R1			;


	MOV.L	#_SVP_INCPLS_HOSN,R1	;1回転*1,000,000(MAX)
	MOV.W	@R1,R2			;data=10000×100
	MOV.W	#D'100,R4		;
	DMULS.L	R4,R2			;
	STS.L	MACL,R2			;
	MOV.L	#_SET1_INCPLS_1REV,R1	;4byteに変更2009-11-03
	MOV.L	R2,@R1			;
	M_BRA	INC_PLS_FUNCCHG_EXT	;

INC_PLS_STDCHG_STR:





;	==== 2;PG1回転のﾊﾟﾙｽ選択 =====
	MOV.W	#H'2000,R2		;(8192)
	MOV	R2,R3			;DEFULT
	MOV.L	#_SVP_INCPLS_1REV,R1	;
	MOV.W	@R1,R0			;
	CMP/EQ	#0,R0			;
	BT	PWR_ON_DT_LD_INCPLS050	;YES 8192

	SHLR	R2			;
	CMP/EQ	#1,R0			;
	BT	PWR_ON_DT_LD_INCPLS050	;YES 4096

	SHLR	R2			;
	CMP/EQ	#2,R0			;
	BT	PWR_ON_DT_LD_INCPLS050	;YES 2048

	MOV	R3,R2			;H'2000
					;
PWR_ON_DT_LD_INCPLS050:			;
;;[2009-11-03 PG]	MOV.L	#_SET1_INCPLS_1REV,R1	;
;;[2009-11-03 PG]	MOV.W	R2,@R1			;2;PG1回転のﾊﾟﾙｽ選択
;	----------[2009-11-03 PG02]---
	MOV.L	#_SET1_INCPLS_1REV,R1	;
	MOV.L	R2,@R1			;2;PG1回転のﾊﾟﾙｽ選択


	DATA_STD_SHN_MOV	SRC=_SVP_INCPLS_HOSN	,L1=W,DST=_SET1_INCPLS_HOSN	,L2=W	;2;PG補正N　ﾓｰﾀN回
	DATA_STD_SHN_MOV	SRC=_SVP_INCPLS_HOSM	,L1=W,DST=_SET1_INCPLS_HOSM	,L2=W	;2;PG補正M　ｸﾗﾝｸ角度M


INC_PLS_FUNCCHG_EXT			;2009-11-03

	MOV.L	#_SET1_INCPLS_HOSM,R1				;1度
	MOV.W	@R1,R2						;
	EXTU.W	R2,R2						;
	MOV.W	#D'10,R4					;
	DMULS.L	R4,R2						;
	STS.L	MACL,R2						;
	MOV.L	#_SETY_INCPLS_HOSM01X,R1			;//0.1度
	MOV.L	R2,@R1						;

;;	DATA_STD_CHG_MOV	SRC=_SVP_INCPLS_HOSN	,L1=W,DST=_SET1_INCPLS_HOSN	,L2=W	,CALLSB=_WD_DIV10;2;PG補正N　ﾓｰﾀN回
;;	DATA_STD_SHN_MOV	SRC=_SVP_INCPLS_HOSM	,L1=W,DST=_SET1_INCPLS_HOSM	,L2=W	;2;PG補正M　ｸﾗﾝｸ角度M
;;	MOV.L	#_SET1_INCPLS_HOSM,R1				;0.1度
;;	MOV.W	@R1,R2						;
;;	EXTU.W	R2,R2						;
;;	MOV.L	#_SETY_INCPLS_HOSM01X,R1			;//0.1度
;;	MOV.L	R2,@R1						;

	M_BRA	ABC1000						;

	.ALIGN	4						;
ABC1000


	MOV.L	#_SETY_INCPLS_HOSM01X,R1			;//0.1度
	MOV.L	@R1,R2						;

	MOV.W	#D'10,R4					;
	DMULS.L	R4,R2						;
	STS.L	MACL,R3						;
	MOV.L	#_SETY_INCPLS_HOSM001,R1			;//0.01度
	MOV.L	R3,@R1						;
	DMULS.L	R4,R3						;
	STS.L	MACL,R3						;
	MOV.L	#_SETY_INCPLS_HOSM0001,R1			;//0.001度
	MOV.L	R3,@R1						;(使用しないつもり)

	MOV.W	#D'10,R4					;
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0	;
	MOV.L	#_SETX_INCPLS_HOSM,R1				;1度
	MOV.W	R2,@R1						;
	MOV.L	#_SETY_INCPLS_HOSM1XX,R1			;//1度
	MOV.L	R2,@R1						;


;;;2010-10-05	DATA_STD_SHN_MOV	SRC=_SVP_MOTRPM_MAXM	,L1=W,DST=_SET1_MOTRPM_MAXM	,L2=W	;2;ﾓｰﾀ最大回転数 ***.*rpm
	M_BRA	DTMK_MOTMAX_SET
DTMK_MOTMAX_SET:

	DATA_STD_SHN_MOV	SRC=_SVP_MOTRPM_MAXM	,L1=W,DST=_SETD_MOTRPM_MAXM	,L2=W	;2;ﾓｰﾀ最大回転数 ***.*rpm

;;20140-11-10;------2010-10-05 ----
;;20140-11-10	FAR_JSR	#_CHK_DNM_SPEC_MOD1,R0

	FAR_JSR	#_CHK_DNM_SPEC_MODA1X,R0	;2014-11-10:最大速度は寸動もふりこと同じものを参照する
	TST	R0,R0
	TST_BIT_ON DTMK_MOTMAX_SET100	;ふりこ時最大速度変更[ふりこで且つ安一,連続,オプション （寸動,段取、原点除く）]
	DATA_STD_SHN_MOV	SRC=_SVP_MOTRPM_MAXM	,L1=W,DST=_SET1_MOTRPM_MAXM	,L2=W	;2;ﾓｰﾀ最大回転数 ***.*rpm
	M_BRA	DTMK_MOTMAX_SET200

DTMK_MOTMAX_SET100:

	FAR_JSR	#_DNM_MAXSPM_ACCLAT_MAK,R0	;2010-01-25
;;;;	DATA_STD_SHN_MOV	SRC=_SVP_MOTRPM_MAXP	,L1=W,DST=_SET1_MOTRPM_MAXM	,L2=W	;2;ﾓｰﾀ最大回転数 ***.*rpm
	DATA_STD_SHN_MOV	SRC=_SVX_DNM_MAXSPM	,L1=W,DST=_SET1_MOTRPM_MAXM	,L2=W	;2;ﾓｰﾀ最大回転数 ***.*rpm

DTMK_MOTMAX_SET200
	
;;;;;2012-03-06	MOV.L	#_SET1_MOTRPM_MAXM,R1		;ﾃﾞﾊﾞｯｸ
;;;;;2012-03-06	MOV.W	@R1,R2				;
;;;;;2012-03-06	MOV.L	#_SQ_CBWK_TOP+_WKSQCB248,R1	;
;;;;;2012-03-06	MOV.W	R2,@R1				;
;;;;;2012-03-06	MOV.L	#_SET1_ACCLAT_TIM1,R1		;
;;;;;2012-03-06	MOV.W	@R1,R2				;
;;;;;2012-03-06	MOV.L	#_SQ_CBWK_TOP+_WKSQCB249,R1	;
;;;;;2012-03-06	MOV.W	R2,@R1				;

	M_BRA	DTMK_MOTMAX_SET300			;

DTMK_MOTMAX_SET300







	DATA_STD_SHN_MOV	SRC=_SVP_RNAPOS_MAXP	,L1=L,DST=_SET1_RNAPOS_MAXP	,L2=L	;4;機械上限機械
	DATA_STD_SHN_MOV	SRC=_SVP_RNAPOS_MINP	,L1=L,DST=_SET1_RNAPOS_MINP	,L2=L	;4;機械下限機械
	DATA_STD_SHN_MOV	SRC=_SVP_RNA_STLORK	,L1=L,DST=_RNA_STLORK		,L2=L	;4;ストローク

;2011/03/23 半径
	MOV.L	#_RNA_STLORK,R1		;
	MOV.L	@R1,R2			;
	SHLR	R2
	MOV.L	#_RNA_STLORK_HALF,R1	;//設定(半径)
	MOV.L	R2,@R1			;

;;	MOV.L	#_RNA_STLORK,R1		;
;;	MOV.L	@R1,R2			;
;;	MOV.L	#_SET1_RNAPOS_MINP,R3	;
;;	MOV.L	@R3,R4			;
;;	MOV.L	#_SET1_RNAPOS_MAXP,R5	;
;;	ADD	R2,R4			;
;;	MOV.L	R4,@R5			;

	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_JUDG	,L1=L,DST=_SET1_UPAREA_JUDG	,L2=L	;4;上死点判定範囲
												;=待機点範囲
	DATA_STD_SHN_MOV	SRC=_SVP_DNAREA_JUDG	,L1=L,DST=_SET1_DNAREA_JUDG	,L2=L	;4;反転設定不可範囲
												;反転設定範囲

	MOV.L	#_SET1_DNAREA_JUDG,R1			;//	4	;反転設定不可範囲
	MOV.L	@R1,R2					;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0		;
	MOV.L	#_SETX_DNAREA_JG_LNK,R4			;反転設定不可範囲LINK 度
	MOV.L	R2,@R4					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_SETX_DNAREA_JG_PLS,R4			;反転設定不可範囲LINK-PLS
	MOV.L	R2,@R4					;




;	====	2002-10-24	===
;;;S00e	DATA_STD_CHG_MOV	SRC=_SVP_DAIHAI_LNG1	,L1=W,DST=_SETX_DAIPOS_MINP,L2=L,CALLSB=_UW_MUL1000	;ダイハイト下限
;;;S00e	DATA_STD_CHG_MOV	SRC=_SVP_DAIHAI_LNG2	,L1=W,DST=_SETX_DAIPOS_MAXP,L2=L,CALLSB=_UW_MUL1000	;ダイハイト上限
;	===	2002-10-24	===
	DATA_STD_CHG_MOV	SRC=_SVP_DAIHAI_LNG1	,L1=W,DST=_SETX_DAIPOS_MINP,L2=L,CALLSB=_UW_MUL100	;ダイハイト下限
	DATA_STD_CHG_MOV	SRC=_SVP_DAIHAI_LNG2	,L1=W,DST=_SETX_DAIPOS_MAXP,L2=L,CALLSB=_UW_MUL100	;ダイハイト上限

;;;;;;2011-02-19 機能削除(ﾃﾞｰﾀを他のに使用する)
;;;	MOV.L	#_SVP_OUTPLS_HOSA,R1	;
;;;	MOV.W	@R1,R2			;
;;;	TST	R2,R2			;
;;;	TST_BIT_ON OUTHOS_DT_040	;
;;;	MOV.W	#1,R2			;
;;;OUTHOS_DT_040:				;
;;;	CMP/PZ	R2			;
;;;	BT	OUTHOS_DT_060		;
;;;	MOV.W	#H'7FFF,R2		;
;;;OUTHOS_DT_060:				;

	MOV.W	#1,R2			;2011-02-19 ADD
	MOV.L	#_SETX_OUTPLS_HOSA,R4	;//出力ﾊﾟﾙｽ補正A
	MOV.W	R2,@R4			;


;;;;;;2011-02-19 機能削除(ﾃﾞｰﾀを他のに使用する)
;;;	MOV.L	#_SVP_OUTPLS_HOSB,R1	;
;;;	MOV.W	@R1,R2			;
;;;	TST	R2,R2			;
;;;	TST_BIT_ON OUTHOS_DT_140	;
;;;	MOV.W	#1,R2
;;;OUTHOS_DT_140:
;;;	CMP/PZ	R2			;
;;;	BT	OUTHOS_DT_160		;
;;;	MOV.W	#H'7FFF,R2		;
;;;OUTHOS_DT_160:				;

	MOV.W	#1,R2			;2011-02-19 ADD
	MOV.L	#_SETX_OUTPLS_HOSB,R4	;//出力ﾊﾟﾙｽ補正B
	MOV.W	R2,@R4			;


;;2006-09-30	======= 上昇ﾎｰﾙﾄﾞ角度 ========
;;		MOV.L	#_SVP_UPHOLD_DIG,R3		;上昇ﾎｰﾙﾄﾞ角度 0.1(ｸﾗﾝｸ)
;;		MOV.W	@R3,R2				;
;;		FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0	;
;;		MOV.L	#_UP_HOLD_DIG,R4		;//0.1度(165.0):ﾓｰﾀ軸ｴﾝｺｰﾀﾞ角度で比較
;;		MOV.W	R2,@R4				;

;	===========================================
;	===	2006-09-30			===
;	===========================================
;	上昇ﾎｰﾙﾄﾞ角＝多段設定があった場合
;	上昇ホールド角＋２度を上昇ホールドとする
	FAR_JSR	#_STEP_UP_HOLD_CMP,R0		;ANS R2:上昇角度
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0	;
	MOV.L	#_UP_HOLD_DIG,R4		;//0.1度(165.0):ﾓｰﾀ軸ｴﾝｺｰﾀﾞ角度で比較
	MOV.W	R2,@R4				;


;	===================================================
;	===						===
;	===	速度演算前に行う演算			===
;	===	(転送前にはワークが確定していない)	===
;	===						===
;	===================================================

;	===========================================================
;	===	演算簡略化の為シスパラで演算途中を作成しておく	===
;	===========================================================
;	CALC_MEM_1REV_MUL_NROT;//1回転パルス(8192)*Ｎ回転(32)=4byte

;	----------[2009-11-03 PG03]---
;;;	MOV.L	#_SET1_INCPLS_1REV,R0		;
;;;	MOV.W	@R0,R1				;3600*32767=
;;;	EXTU.W	R1,R1				;
	MOV.L	#_SET1_INCPLS_1REV,R0		;
	MOV.L	@R0,R1				;3600*32767=

	MOV.L	#_SET1_INCPLS_HOSN,R0		;PG補正N　ﾓｰﾀN回
	MOV.W	@R0,R3				;
	EXTU.W	R3,R3				;
	DMULS.L	R1,R3				;
	STS	MACL,R2				;
	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R1	;(8192*32)
	MOV.L	R2,@R1				;

;	_CALC_MEM_1REV_ML_NROT_ML36	;//1回転パルス(8192)*Ｎ回転(32)*3600=4byte

	MOV.W	#D'3600/10,R1				;
	DMULS.L	R1,R2					;R2=
	STS	MACL,R2					;
	MOV.L	#_CALC_MEM_1REV_ML_NROT_ML36,R1	;(8192*64*3600/10ならいいが)
	MOV.L	R2,@R1					;()


;	===========================================
;	===	最大速度作成 pls/s		===
;	===	制御上の最大値(ふりこで変わる)	===
;	===========================================
;	=== 100.00% *RPM*....... PLS/S 最大値用	===
	MOV.W	#_SPD_PER_MAX,R2		;
	FAR_JSR	#_PG_SPD1,R0			;
	MOV.L	#_LINK_MAX_SPD_PLS,R1		;//ｲﾝｸﾘﾒﾝﾀﾙｴﾝｺｰﾀﾞ換算値　pls/s
	MOV.L	R2,@R1				;[SETD_LINK_MAX_SPD_PLS　ｻｰﾎﾞﾊﾟﾗとromﾊﾟﾗ変化]


;	===================================
;	===	最大速度作成 pls/s	===
;	===	2010-10-20 本当の最大値	===
;	===================================
;	=== 100.00% *RPM*....... PLS/S 最大値用	===
	MOV.W	#_SPD_PER_MAX,R2	;
	FAR_JSR	#_MAXABS_PG_SPD1,R0	;
	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R1	;//ｲﾝｸﾘﾒﾝﾀﾙｴﾝｺｰﾀﾞ換算値　pls/s
	MOV.L	R2,@R1				;[SETD_LINK_MAX_SPD_PLS　ｻｰﾎﾞﾊﾟﾗ]



;	====================================
;	===	LINK１回転のﾊﾟﾙｽ数	====
;	====================================
	MOV.W	#3600,R2		;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0
	MOV.L	#_LINK_1ROT_PLS,R1	;//機械1回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	R2,@R1			;


;	===================================
;	===	2014-09-03 最大速度角度	===
;	===	ﾛｰﾀﾘｶﾑ用		===
;	===================================
;	N回転でM度進みます.
;;2014-09-22	
;;	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R1		;//

	MOV.L	#_LINK_MAX_SPD_PLS,R1				;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
	MOV.L	@R1,R2						;
	MOV.L	#_LINK_1ROT_PLS,R1				;//機械1回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	@R1,R4						;
	MOV.W	#D'3600,R1					;
	FAR_JSR	#_MULDIV_R2S32mR1S32dR4S32aR1R2S64,R0		;

	MOV.L	#_SETD_DEGSPD_MAX,R1				;//最大速度で1秒間に何度動作しますか 0.1度/SEC
	MOV.L	R2,@R1						;1WORDだと思うが...
	M_BRA	ROT234_MAK

ROT234_MAK:
	
;	***********************************
;	***	2010-10-07		***
;	***********************************
	FAR_JSR	#_REV2TO4_DATA_MAKE,R0
	M_BRA	ROT234_MAK_END

ROT234_MAK_END:







;	===================================
;	===	位置決めLSI換算		===
;	===================================
;	1pls/s(1HZ)
;		******HZ *FFFF/250000
;		= ***** *FFFF/250000HZ(250KHZ)
;
;	65535*(N+1)/50000=時間 50000は500Kからきた数値
;	65535*(1+1)/50000=2.6msec
;	時間*50000/65535-1 =LATE

	MOV.L	#H'FFFF,R2
	MOV.L	#_POS_LSI_SPDMAX,R1;	
	MOV.L	R2,@R1

	MOV.L	#D'500000,R2		;pls/s
	MOV.L	#_POS_FRQ_SPDMAX,R1	;500KHZ
	MOV.L	R2,@R1			;
	MOV.W	#2,R2			;現象の製品

	MOV.L	#_SVP_REVDAT_SPD2,R1		;自起動速度
	MOV.W	@R1,R2				;
	EXTU.W	R2,R2
	TST	R2,R2				;
	TST_BIT_ON CLS_BASSPD_20		;
	MOV.W	#1,R2				;
CLS_BASSPD_20:					;
;;;2010-12-08	MOV.L	#_POS_LSI_CLS_SPDBAS,R1		;ﾌﾙｸﾛｰｽﾞ運転時の自起動
;;;2010-12-08	MOV.L	R2,@R1				;65535=500KHZ  500.000 1:10HZ 10=100H

	MOV.L	#_POS_LSI_SPDBAS,R1		;回転(自起動)
	MOV.L	R2,@R1				;(速度上は??PLS/S)

;---2010-12-08　反転専用起動速度追加-----
	MOV.L	#_SVP_ONESTR_SPD2,R1		;反転時自起動速度
	MOV.W	@R1,R2				;
	EXTU.W	R2,R2				;
	TST	R2,R2				;
	TST_BIT_ON CLS_BASSPD_30		;
	MOV.W	#1,R2				;
CLS_BASSPD_30:					;
	MOV.L	#_POS_LSI_CLS_SPDBAS,R1		;ﾌﾙｸﾛｰｽﾞ運転時の自起動
	MOV.L	R2,@R1				;65535=500KHZ  500.000 1:10HZ 10=100H






	MOV.L	#_SVP_REVDAT_SPD3,R1		;ｲﾝﾁﾝｸﾞ時
	MOV.W	@R1,R2				;
	EXTU.W	R2,R2				;
	TST	R2,R2				;
	TST_BIT_ON CLS_BASSPD_40		;
	MOV.W	#1,R2				;
CLS_BASSPD_40:					;
	MOV.L	#_POS_LSI_CLSINC_SPDBAS,R1	;ｲﾝﾁﾝｸﾞ時
	MOV.L	R2,@R1				;


	MOV.W	#D'24,R2		;
	MOV.L	#_POS_LSI_SPDLAT,R1	;500KHZ (49:250K)
	MOV.W	R2,@R1			;

	M_BRA	KANSAN_DT1000		;2010-12-08 ADD JUMP

KANSAN_DT1000:


;	===========================================
;	===	2004-05-24 100.00%換算のLMIT	===
;	===========================================
	MOV.W	#D'10000,R2
	FAR_JSR	#_CYCLE_SPD1,R0					;

	MOV.L	#_POS_LSI_SPDMAX,R0				;
	MOV.L	@R0,R1						;
	MOV.L	#_POS_FRQ_SPDMAX,R0				;500KHZ(500000PLS/S)
	MOV.L	@R0,R4						;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;

;	------- 連続の補正の余裕分----
	MOV.W	#D'1000,R4					;7KHZ
	ADD	R4,R2						;
	MOV.L	#_POS_FRQ_SPDMAX,R0				;500KHZ(500000PLS/S)
	MOV.L	@R0,R4						;
	CMP/HS	R2,R4						;
	BT	DT_CNTMAX_HOSI050				;
	MOV	R4,R2						;
DT_CNTMAX_HOSI050						;
	MOV.L	#_LSI_SET_SPD_MAXLMT,R1				;
	MOV.L	R2,@R1						;
	M_BRA	ORGIN_HURIDIG_MAK				;2008-07-29

	.POOL

	.ALIGN	4			;2010-08-23

;	===================================
;	===	原点復帰時の目標角度	===
;	===================================
ORGIN_HURIDIG_MAK:
;	----------- 2011-03-22 MC 原点復帰方法変更
	MOV.L	#_WPAR_ORGDRV_MD2,R1	;
	MOV.W	@R1,R0			;
	CMP/EQ	#1,R0			;
	BF	ORGIN_HURIDIG_MK100	;
	FAR_JSR	#_ORGIN_HAB_DTMK2,R0	;
	TST	R0,R0			;
	TST_BIT_OF ORGIN_HURIDIG_MK100	;
	M_BRA	ORGIN_HURIDIG_MK300	;
;	------------------------------------------

ORGIN_HURIDIG_MK100:			;
;	=== 2008-07-29(S03m 特殊) ===
	FAR_JSR	#_ORGIN_HAB_DTMAK,R0			;
	TST	R0,R0					;
	TST_BIT_OF ORGIN_HURIDIG_MK200			;幅の設定がない
	M_BRA	ORGIN_HURIDIG_MK300			;



;	---------通常ﾃﾞｰﾀ------
ORGIN_HURIDIG_MK200:					;
;	===================================
;	===	原点復帰時の目標角度	===
;	===================================
	MOV.W	#_UP360_JGDIG,R2			;3.0度 原点復帰上昇時(4.0)
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;

	NEG	R2,R3
	MOV.L	#_ORG_FIRST_OBJPLS,R1			;相対位置
	MOV.L	R3,@R1					;-6度

	ADD	R2,R2					;+12度
	MOV.L	#_ORG_SECOND_OBJPLS,R1			;相対距離
	MOV.L	R2,@R1					;

ORGIN_HURIDIG_MK300:					;




	MOV.W	#_UPDN_DIRJG_DIG,R2			;"角度(距離ではない つもり)"
	MOV.L	#_SETX_UPDN_CHK_DN_DIG,R1		;180.0度(下死点角度 180.0)
	MOV.L	R2,@R1					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_SETX_UPDN_CHK_DN_PLS,R1		;180.0度相当のﾊﾟﾙｽ(下死点角度)
	MOV.L	R2,@R1					;

	MOV.L	#_UPDN_DIRJG_DIG+_FUL_CLS_RNADIG,R2	;180.0+80.0=260.0~0は＋のﾊﾟﾙｽ 360~280はﾏｲﾅｽのﾊﾟﾙｽ
	MOV.L	#_SETX_FULCLS_AREA_DIG,R1		;
	MOV.L	R2,@R1		
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_SETX_FULCLS_AREA_PLS,R1		;
	MOV.L	R2,@R1					;

;	====== 2006-09-19 ========
	MOV.L	#_POS_LSI_CLS_SPDBAS,R1			;ﾌﾙｸﾛｰｽﾞ運転時の自起動
	MOV.L	@R1,R2					;
	FAR_JSR	#_CHG_LSI_LATE_TO_PLS,R0		;
	MOV.L	#_SET_CLS_SPDBAS_PLS,R1			;//PLS/S
	MOV.L	R2,@R1					;

	MOV.L	#_POS_LSI_SPDBAS,R1			;回転(自起動)
	MOV.L	@R1,R2
	FAR_JSR	#_CHG_LSI_LATE_TO_PLS,R0
	MOV.L	#_SET_SPDBAS_PLS,R1			;//PLS/S
	MOV.L	R2,@R1					;

;;;2012-10-05	MOV.L	#_POS_LSI_CLSINC_SPDBAS,R1		;ｲﾝﾁﾝｸﾞ時
;;;2012-10-05	MOV.L	@R1,R2
;;;2012-10-05	FAR_JSR	#_CHG_LSI_LATE_TO_PLS,R0		;
;;;2012-10-05	MOV.L	#_SET_CLSINC_SPDBAS_PLS,R1		;//PLS/S
;;;2012-10-05	MOV.L	R2,@R1					;
;;;ｼｰｹﾝｽから選べる


;	---------2015-03-15 非常停止中、急停止中は演算 以降は起動時-----------------
	MOV.L	#_emg_err_flg,R1		;//異常ﾗｯﾁ
	MOV.W	@R1,R0				;
	MOV.L	#_exq_err_flg,R1			;
	MOV.W	@R1,R2					;
	OR	R2,R0					;
	TST	R0,R0					;
	TST_BIT_OF DTMK_CLSINC_SEL100			;

	FAR_JSR	#_REVRSE_BASINC_SPDCALC,R0

DTMK_CLSINC_SEL100


;;;;----------------- 移動--------------------
;;;;
;;;;
;;;;;	=======  2012-10-05 =========
;;;;	MOV.L	#_CB_SEQ_CB_COM351,R1					;ｲﾝﾁﾝｸﾞ速度選択
;;;;	MOV.W	@R1,R0							;
;;;;	MOV.W	#BIT9+BIT8+BIT7+BIT6+BIT5+BIT4+BIT3+BIT2+BIT1,R4	;
;;;;	TST	R4,R0							;
;;;;	TST_BIT_OF CLSINC_SEL_DEF					;
;;;;
;;;;	MOV.B	#D'9-1,R3							;
;;;;	MOV.B	#BIT1,R4						;
;;;;	MOV.L	#(_PAR_NEGCTL_SPDS1-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;
;;;;
;;;;CLSINC_SEL_050LOP:
;;;;	TST	R4,R0
;;;;	TST_BIT_ON CLSINC_SEL_100	;
;;;;	SHLL	R4
;;;;	ADD	#2,R1			;
;;;;	ADD	#-1,R3			;
;;;;	TST	R3,R3			;
;;;;	TST_BIT_ON CLSINC_SEL_050LOP	;BIT1~BIT8
;;;;CLSINC_SEL_100:
;;;;	MOV.W	@R1,R2			;
;;;;	TST	R2,R2			;
;;;;	TST_BIT_ON CLSINC_SEL_300	;
;;;;	ADD	#1,R2			;
;;;;	M_BRA	CLSINC_SEL_300		;
;;;;
;;;;
;;;;CLSINC_SEL_DEF:
;;;;	MOV.L	#_POS_LSI_CLSINC_SPDBAS,R1		;ｲﾝﾁﾝｸﾞ時
;;;;	MOV.L	@R1,R2
;;;;CLSINC_SEL_300
;;;;	FAR_JSR	#_CHG_LSI_LATE_TO_PLS,R0		;
;;;;	MOV.L	#_SET_CLSINC_SPDBAS_PLS,R1		;//PLS/S
;;;;	MOV.L	R2,@R1					;

	SUB_END
	M_RTS


;	===========================================
;	===	原点復帰時の進み・戻り角度	===
;	===========================================
;	R0=0 今までのまま
	.ALIGN	4			;2008-07-29
_ORGIN_HAB_DTMAK:
	SUB_START

	MOV.L	#_PAR_ORGIN_HAB1,R1			;sit3の特殊で原点の振り角度で使用(2008-07-29)
	MOV.W	@R1,R3					;
	TST	R3,R3					;
	TST_BIT_OF XORGIN_HURIDIG_MK200			;"0" 未使用
	MOV.W	#D'80,R4				;
	CMP/HS	R4,R3					;80 =< R2 THEN ABNOMAL DATA
	BT	XORGIN_HURIDIG_MK200			;

	MOV.L	#_PAR_ORGIN_HAB2,R1			;sit3の特殊で原点の振り角度で使用(2008-07-29)
	MOV.W	@R1,R5					;
	TST	R5,R5					;
	TST_BIT_OF XORGIN_HURIDIG_MK200			;"0" 未使用
	MOV.W	#D'80,R4				;
	CMP/HS	R4,R5					;80 =< R2 THEN ABNOMAL DATA
	BT	XORGIN_HURIDIG_MK200			;

;	--------- 幅 R3=戻り R5=進み--------
	PUSH_REG1	R5				;
	MOV	R3,R2					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	NEG	R2,R3
	MOV.L	#_ORG_FIRST_OBJPLS,R1			;相対位置
	MOV.L	R3,@R1					;-6度
	POP_REG1	R5				;


	PUSH_REG1	R2				;FIRST 結果 PUSH
	MOV	R5,R2					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;進み
	POP_REG1	R3				;
	ADD	R3,R2					;進み＋｜戻り｜
	MOV.L	#_ORG_SECOND_OBJPLS,R1			;相対距離
	MOV.L	R2,@R1					;
	M_BRA	XORGIN_HURIDIG_MK300			;

XORGIN_HURIDIG_MK200				;
	XOR	R0,R0				;
	M_BRA	XORGIN_HURIDIG_END

XORGIN_HURIDIG_MK300				;
	MOV.B	#-1,R0				;
XORGIN_HURIDIG_END
	SUB_END
	M_RTS








;	===========================================
;	===	原点復帰時の進み・戻り角度	===
;	===	ｻｰﾎﾞﾊﾟﾗﾒｰﾀﾀｲﾌﾟ 2011-03-22	===
;	===========================================
;	R0=0 今までのまま
	.ALIGN	4			;2008-07-29
_ORGIN_HAB_DTMK2:
	SUB_START

;;;;	MOV.L	#_SVP_ORGREV_AGL,R1			;サーボパラメータBF　　逆転
;;;;	MOV.L	@R1,R3					;

	MOV.L	#_PAR_ORGIN_HAB1,R1			;sit3の特殊で原点の振り角度で使用(2008-07-29)
	MOV.W	@R1,R3					;

	TST	R3,R3					;
	TST_BIT_OF XORGIN_HURIDIG_MK2_200		;"0" 未使用
	MOV.W	#D'500,R4				;50.0度
	CMP/HS	R4,R3					;80 =< R2 THEN ABNOMAL DATA
	BT	XORGIN_HURIDIG_MK2_200			;

;;;;	MOV.L	#_SVP_ORGFWD_AGL,R1			;サーボパラメータBG　　正転
;;;;	MOV.L	@R1,R5					;

	MOV.L	#_PAR_ORGIN_HAB2,R1			;sit3の特殊で原点の振り角度で使用(2008-07-29)
	MOV.W	@R1,R5					;

	TST	R5,R5					;
	TST_BIT_OF XORGIN_HURIDIG_MK2_200		;"0" 未使用
	MOV.W	#D'500,R4				;50.0
	CMP/HS	R4,R5					;80 =< R2 THEN ABNOMAL DATA
	BT	XORGIN_HURIDIG_MK2_200			;

;	--------- 幅 R3=戻り R5=進み--------
	PUSH_REG1	R5				;
	MOV	R3,R2					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	NEG	R2,R3					;
	MOV.L	#_ORG_FIRST_OBJPLS,R1			;相対位置
	MOV.L	R3,@R1					;-6度
	POP_REG1	R5				;


	PUSH_REG1	R2				;FIRST 結果 PUSH
	MOV	R5,R2					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;進み
	POP_REG1	R3				;
	ADD	R3,R2					;進み＋｜戻り｜
	MOV.L	#_ORG_SECOND_OBJPLS,R1			;相対距離
	MOV.L	R2,@R1					;
	M_BRA	XORGIN_HURIDIG_MK2_300			;

XORGIN_HURIDIG_MK2_200				;
	XOR	R0,R0				;
	M_BRA	XORGIN_HURIDIG2_END

XORGIN_HURIDIG_MK2_300				;
	MOV.B	#-1,R0				;
XORGIN_HURIDIG2_END
	SUB_END
	M_RTS












;	***********************************************************
;	***							***
;	***	原点プリセットでマイナスにならないように	***
;	***	３回転＋する					***
;	***	2010-10-07 １回転目で停止しない対策		***
;	***							***
;	***	-1回転引いてもいいように			***
;	***							***
;	***********************************************************
;	MOV.L	@R4+,R7				;
;	MOV.L	@R4,R8				;
;	R7
;	R8 + 3REV
;
	.EXPORT	_ADD_REV_CHG
_ADD_REV_CHG:
	SUB_START
	PUSH_REG1 R0
	PUSH_REG1 R1
	PUSH_REG1 R2


	XOR	R1,R1					;ｵﾌｾｯﾄしない
	XOR	R2,R2					;2014-09-18

;;;;;	MOV.L	#_LINK_1ROT_PLS,R1			;//3回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
;;;;;	MOV.L	@R1,R2					;
;;;;;	XOR	R1,R1					;

;;;;;	MOV.L	#_LINK_3ROT_PLS,R1			;//3回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
;;;;;	MOV.L	@R1,R2					;
;;;;;	XOR	R1,R1					;

;;;;;	MOV.L	#_LINK_1000ROT_PLS,R0			;//1000回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
;;;;;	MOV.L	@R0,R1					;
;;;;;	MOV.L	@(4,R0),R2				;

	NEG1_64	H_REG=R1,L_REG=R2,WKREG=R0				;
	ADD8B DT_REGH=R1,DT_REGL=R2,DT_ANS_REGH=R7,DT_ANS_REGL=R8	;R1,R2 +R7,R8=>R7,R8



	POP_REG1 R2
	POP_REG1 R1
	POP_REG1 R0
	SUB_END
	M_RTS

;	***********************************************************
;	***							***
;	***	2回転のﾃﾞｰﾀをあらかじめ作成しておく		***
;	***	3回転のﾃﾞｰﾀをあらかじめ作成しておく		***
;	***	4回転のﾃﾞｰﾀをあらかじめ作成しておく		***
;	***	2007-09-21					***
;	***********************************************************
_REV2TO4_DATA_MAKE:
	SUB_START
;	====================================
;	===	LINK2回転のﾊﾟﾙｽ数	====
;	====================================
	MOV.W	#3600*2,R2				;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_LINK_2ROT_PLS,R1			;//2回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	R2,@R1					;


;	====================================
;	===	LINK3回転のﾊﾟﾙｽ数	====
;	====================================
	MOV.W	#3600*3,R2				;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_LINK_3ROT_PLS,R1			;//3回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	R2,@R1					;


;	====================================
;	===	LINK4回転のﾊﾟﾙｽ数	====
;	====================================
	MOV.W	#3600*4,R2				;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_LINK_4ROT_PLS,R1			;//4回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	R2,@R1					;






;	====================================
;	===	LINK1000回転のﾊﾟﾙｽ数	====
;	====================================
	MOV.L	#3600*1000,R2				;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS_8B,R0	;1000回転

	MOV.L	#_LINK_1000ROT_PLS,R0			;//4回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	R1,@R0					;
	MOV.L	R2,@(4,R0)				;


	SUB_END
	M_RTS




;	*******************************************
;	***					***
;	***	システムパラメータ		***
;	***					***
;	*******************************************
	.ALIGN	4				;
_SYS_DAT_LOAD
	SUB_START

;	-----------2011-09-12 ----
	MEM_WORD_BLOCK_MOV1	SRC_ADR=_CB_SYS_PARAM000,DST_ADR=_W_PARAM_TOP,CNT_DAT=256,DT_REG=R2,CNT_REG=R3

	MOV.L	#_CB_SYS_PARAM256,R1
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD1,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM000
						;(符号拡張も考えると同じMOV.Wになる)
	CMP/EQ	R2,R0				;
	BF	SYS_DAT_LD_COPY100		;

	MOV.L	#_CB_SYS_PARAM257,R1
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD2,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM001
	CMP/EQ	R2,R0				;
	BF	SYS_DAT_LD_COPY100

	MOV.L	#_CB_SYS_PARAM510,R1
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD3,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM126
	CMP/EQ	R2,R0				;
	BF	SYS_DAT_LD_COPY100

	MOV.L	#_CB_SYS_PARAM511,R1
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD4,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM127
	CMP/EQ	R2,R0				;
	BF	SYS_DAT_LD_COPY100

	MEM_WORD_BLOCK_MOV1	SRC_ADR=_CB_SYS_PARAM256,DST_ADR=_W_PARAM_TOP+256*2,CNT_DAT=256,DT_REG=R2,CNT_REG=R3
	M_BRA	SYS_DAT_LD_COPY200

SYS_DAT_LD_COPY100
	NOP					;ERRにするかどうかはあるが
	M_BRA	SYS_DAT_LD_COPY200

SYS_DAT_LD_COPY200
;	----------2011-09-12--------

	DATA_STD_SHN_MOV SRC=_PAR_DRVHOS_SEL1		,L1=W,DST=_WPAR_DRVHOS_SEL1	,L2=W	;2;運転中の補正制御選択=0:旧 =1
	DATA_STD_SHN_MOV SRC=_PAR_DRVHOS_DIG1		,L1=W,DST=_WPAR_DRVHOS_DIG1	,L2=W	;2;360ｴﾝｺｰﾀﾞ角度上 170.0度(ｻﾝﾌﾟﾘﾝｸﾞ開始可能な角度) 
	DATA_STD_SHN_MOV SRC=_PAR_DRVHOS_DIG2		,L1=W,DST=_WPAR_DRVHOS_DIG2	,L2=W	;2;
	DATA_STD_SHN_MOV SRC=_PAR_DRVHOS_WAITCNT        ,L1=W,DST=_WPAR_DRVHOS_WAITCNT	,L2=W	;2;//初回のｶｳﾝﾄ開始待ち回数
	DATA_MAX_MIN_SHN_MOV SRC=_PAR_DRVHOS_AVLCNT,L1=W,DST=_WPAR_DRVHOS_AVLCNT,L2=W,MAX=20,L3=W,MIN=1,L4=W	;2;移動平均の元データ回数
	DATA_MAX_MIN_SHN_MOV SRC=_PAR_DRVHOS_NO_USE,L1=W,DST=_WPAR_DRVHOS_NO_USE,L2=W,MAX=4,L3=W,MIN=1,L4=W	;2;読み飛ばしデータ回数

	MOV.L	#_WPAR_DRVHOS_NO_USE,R5		;
	MOV.W	@R5,R2				;
	ADD	R2,R2				;
	ADD	#1,R2				;R2
	MOV.L	#_WPAR_DRVHOS_AVLCNT,R1		;
	MOV.W	@R1,R0				;
	CMP/HS	R2,R0				;
	BT	SYS_DT_LD_DRV_HOSDT_CHK50	;2N+1 =< 平均回数
	XOR	R2,R2				;
	MOV.W	R2,@R5				;
SYS_DT_LD_DRV_HOSDT_CHK50:			;


;	===== 2003-05-12 ==
;;	.AIF	_PRG_CHG20030512 EQ _COMPILE_YES	;
;;0305024	DATA_STD_CHG_MOV	SRC=_PAR_INCSTP_EDYTM	,L1=W,DST=_WPAR_INCSTP_EDYTM,L2=W,CALLSB=_DATMOV_0_THEN_5000	;遅延時間
	DATA_STD_CHG_MOV	SRC=_PAR_INCSTP_EDYTM1	,L1=W,DST=_WPAR_INCSTP_EDYTM1,L2=W,CALLSB=_DATMOV_0_THEN_5000	;遅延時間2003-05-24
	DATA_STD_CHG_MOV	SRC=_PAR_INCSTP_EDYTM2	,L1=W,DST=_WPAR_INCSTP_EDYTM2,L2=W,CALLSB=_DATMOV_0_THEN_5000	;遅延時間2003-05-24
	DATA_STD_SHN_MOV	SRC=_WPAR_INCSTP_EDYTM2	,L1=W,DST=_WPAR_INCSTP_EDYTM,L2=W	;(初期値)


;;	.AENDI
	DATA_STD_SHN_MOV SRC=_PAR_RNA_SFTY_LNG1		,L1=W,DST=_WPAR_RNA_SFTY_LNG1	,L2=W	;2;安全装置停止判定距離

;//	*******************************************
;//	***	2003-06-13			***
;//	***	ニアゼロタイムアウト		***
;//	*******************************************
;;;2012-03-06	MOV.W	#D'500,R2			;0.5秒
	MOV.W	#D'1200,R2			;1.2秒
	MOV.L	#_NZ_TIM_OUT_SV1,R1		;運転中止(寸動部分)
	MOV.W	R2,@R1				;

;;;;2012-03-06	XOR	R2,R2				;
	MOV.L	#(_PAR_INP_ERRTIM-_CB_SYS_PARAM000+_W_PARAM_TOP),R1
	MOV.W	@R1,R0							;
	MOV.W	#D'1000,R2						;
	TST	R0,R0							;
	TST_BIT_OF SYS_NERA_ERRTM050					;
	MOV	R0,R2						;
SYS_NERA_ERRTM050						;
	MOV.L	#_NZ_TIM_OUT_SV2,R1				;異常
	MOV.W	R2,@R1						;

;//	*******************************************
;//	***					***
;//	***	2003-07-01			***
;//	***	実速度算出/ﾌﾞﾚｰｷ異常		***
;//	***	回転仕様			***
;//	*******************************************
	DATA_STD_SHN_MOV SRC=_PAR_ZERO_SPD	,L1=W,DST=_WPAR_ZERO_SPD		,L2=W	;2;実速度算出用　0.01%
	DATA_STD_SHN_MOV SRC=_PAR_BRK_SEL_SPD	,L1=W,DST=_WPAR_BRK_SEL_SPD		,L2=W	;2;ﾌﾞﾚｰｷ異常見ない速度 10.00%
;;;2003-07-14	DATA_STD_SHN_MOV SRC=_PAR_BRK1_DLYTM	,L1=W,DST=_WPAR_BRK1_DLYTM		,L2=W	;2;
;;;2003-07-14	DATA_STD_SHN_MOV SRC=_PAR_BRK1_ACCTM	,L1=W,DST=_WPAR_BRK1_ACCTM		,L2=W	;2;


;;;	DATA_STD_SHN_MOV SRC=_SVP_TEPLAT_DAT1	,L1=W,DST=_WPAR_BRK1_DLYTM		,L2=W	;2; 手動ﾊﾟﾙｻ低倍率	
;;;	DATA_STD_SHN_MOV SRC=_SVP_TEPLAT_DAT2	,L1=W,DST=_WPAR_BRK1_ACCTM		,L2=W	;2; 手動ﾊﾟﾙｻ高倍率	

	DATA_STD_SHN_MOV SRC=_PAR_BRK2_ACCTM	,L1=W,DST=_WPAR_BRK2_ACCTM		,L2=W	;2;
;;;;;	DATA_STD_SHN_MOV SRC=_PAR_BRK1_ACCTM	,L1=W,DST=_WPAR_BRK1_ACCTM		,L2=W	;2;
	DATA_STD_SHN_MOV SRC=_PAR_ILNGERR_LNG	,L1=W,DST=_WPAR_ILNGERR_LNG		,L2=W	;2;移動量異常ｵｰﾊﾞ許容値
	DATA_STD_SHN_MOV SRC=_PAR_ILNGERR_DIG	,L1=W,DST=_WPAR_ILNGERR_DIG		,L2=W	;2;異常検知開始角度


;	==== 2003-07-01 =====
	MOV.W	#D'10,R4
	MOV.L	#_ENCPLS_POINT_SEL,R1				;
	MOV.W	R4,@R1						;
	MOV.W	#D'1000,R2					;
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0	;R2/R4 
	MOV.L	#_ENCPLS_1000MSEC_LAT,R1			;
	MOV.W	R2,@R1						;

	MOV.W	#D'10,R4
	MOV.L	#_OUTPLS_POINT_SEL,R1	;
	MOV.W	R4,@R1			;
	MOV.W	#D'1000,R2					;
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0	;R2/R4 
	MOV.L	#_OUTPLS_1000MSEC_LAT,R1			;
	MOV.W	R2,@R1						;

;	---------------------------
;	---- 	2006-04-10	---
;	---------------------------
	FAR_JSR	#_SELF_CHK_PARAM_MOVE,R0	


;	---------------------------
;	---- 	2006-07-16	---
;	---------------------------
	DATA_STD_SHN_MOV SRC=_PAR_LSA_FILTIM	,L1=W,DST=_WPAR_LSA_FILTIM,L2=W	;2;異常検知

;	------------------
;	--- 2006-07-28 ---
;	------------------
;;;;;;;;2007-01-23	DATA_STD_SHN_MOV SRC=_PAR_OVRLIDE_GMN	,L1=W,DST=_WPAR_OVRLIDE_GMN,L2=W					;2;
;(----------------------------)
;;;;;;;;2007-01-23	MEM_MOV_TO_MEM	SRC_ADR=_WPAR_OVRLIDE_GMN,L1=W,DST_ADR=_OVERLIDE_DT_SEL,L2=W,WKREG1=R1,WKREG2=R2,WKREG3=R3


	DATA_STD_SHN_MOV SRC=_PAR_ORG2CHK_TIM	,L1=W,DST=_WPAR_ORGMOD2_TIM,L2=W					;2;

;	========2006-09-30(ｵｰﾊﾞﾗｲﾄﾞ加減速時間)=========
	DATA_STD_SHN_MOV SRC=_PAR_ANAIN_SEL	,L1=W,DST=_WPAR_ANAIN_SEL,L2=W		;2;//0:0~10V:X%(SIT3-TYPE) 1:-100%~(0)5~10V(100%):
;;;;;;;;2007-01-23	DATA_STD_SHN_MOV SRC=_PAR_ACCTYP_SEL	,L1=W,DST=_WPAR_ACCTYP_SEL,L2=W		;2;//0:0~10V:X%(SIT3-TYPE) 1:-100%~(0)5~10V(100%):


	M_BRA	SYS_DT_LD1000

SYS_DT_LD1000

;	----------- 2009-03-11-----------
	FAR_JSR	#_TOYOTA_ADD_SYS,R0
	M_BRA	SYS_DT_LD2000

SYS_DT_LD2000
;	----------- 2010-08-23 ﾏｲﾅﾁｪﾝｼﾞ-----------
	DATA_STD_SHN_MOV SRC=_PAR_BRKTOUT_SPD	,L1=W,DST=_WPAR_BRKTOUT_SPD,L2=W	;2;
	DATA_STD_SHN_MOV SRC=_PAR_BRKTCHK_SPD	,L1=W,DST=_WPAR_BRKTCHK_SPD,L2=W	;2;


;	
	DATA_LOP_SHN_MOV SRC=_PAR_KJYU_STOPTBL,L1=W,DST=_WPAR_KJYU_STOPTBL,L2=W,LOOP=D'12,CNT_REG=R7,DSTADD=2	;

;	---- ｽﾄｯﾋﾟﾝｸﾞﾀｲﾏ,ﾌﾞﾚｰｷﾀｲﾏ用時間(2010-08-20以前は50ms固定)---
	MOV.L	#_PAR_STOPING_TIM,R1			;
	MOV.W	@R1,R2					;
	TST	R2,R2					;
	TST_BIT_ON SYS_DT_STOPTIM_LD100			;
	MOV.W	#_SYS_STOPPING_TIM,R2			;
SYS_DT_STOPTIM_LD100
	MOV.W	#D'200,R1				;MAX 200msec
	CMP/HS	R2,R1					;
	BT	SYS_DT_STOPTIM_LD200			;data<200msec
	MOV	R1,R2					;
SYS_DT_STOPTIM_LD200
	MOV.L	#_WPAR_STOPING_TIM,R1			;//予備、ｽﾄｯﾋﾟﾝｸﾞﾀｲﾏ,ﾌﾞﾚｰｷﾀｲﾏ用時間(2010-08-20以前は50ms固定)
	MOV.W	R2,@R1					;

;;;;;;;;;;;;;;; SSA_K.SRCにて実行　2015-10-22
;;;;;;;;;;;;;;;	----------2015-09-30 100段仕様時はふりこ加減速-----------------------------
;;;;;;;;;;;;;;;	MOV.L	#_SYS_100STEP_DNM_SEL,R1	;	//100段時の振子
;;;;;;;;;;;;;;;	MOV.W	@R1,R0				;
;;;;;;;;;;;;;;;	TST	R0,R0				;
;;;;;;;;;;;;;;;	TST_BIT_ON SYS_DT_DNM_MATH_100
;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;	DATA_STD_SHN_MOV SRC=_PAR_ACC_MATHED	,L1=W,DST=_WPAR_ACC_MATHED,L2=W		;WPAR_ACC_MATHED=1:振子ﾃｰﾌﾞﾙﾀｲﾌﾟ
;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;SYS_DT_DNM_MATH_100:


;	-------------
	.AIF _CHG_DNM_20170225 EQ _CMPILE_YES	;
	FAR_JSR	#_DNM_ACC_MATHED_SELECT,R0
	.AENDI



	FAR_JSR	#_CBSYS_DNM_TBLCHK,R0		;2010-10-25　CPUA/B


;	---------- 時間タイプパラメータ 2010-12-08--------------
	FAR_JSR	#_PARAM_TIM_DT_CHG,R0	;2010-12-08

;	---- 2011-01-18-----------
	M_BRA	SYS_LD_COP_CMP_500

SYS_LD_COP_CMP_500:
	DATA_STD_SHN_MOV SRC=_PAR_COP_DISP_SPM1	,L1=W,DST=_WPAR_COP_DISP_SPM1,L2=W	;2;//2010-12-27 荷重切替サイクル速度比較1spm単位


;	---- 2011-03-22-----------
	M_BRA	SYS_LD_ORG_HOS_600
SYS_LD_ORG_HOS_600:
	DATA_STD_SHN_MOV SRC=_PAR_ORGDRV_MD2,L1=W,DST=_WPAR_ORGDRV_MD2,L2=W	;2;//原点復帰方法 1:2011-03-22ﾀｲﾌﾟ
	DATA_STD_SHN_MOV SRC=_PAR_DAIHAI_SEL,L1=W,DST=_WPAR_DAIHAI_SEL,L2=W	;2;//手動ﾀﾞｲﾊｲﾄの演算方法の変更1:2011-03-22ﾀｲﾌﾟ


	DATA_STD_SHN_MOV SRC=_PAR_SLDALM_LNG,L1=W,DST=_WPAR_SLDALM_LNG,L2=W	;2;//ｽﾗｲﾄﾞ移動異常検出用　ｽﾗｲﾄﾞ移動量 2011-03-22[ｸﾗﾝｸ機構MC　H1F]
	DATA_STD_SHN_MOV SRC=_PAR_SLDALM_TIM,L1=W,DST=_WPAR_SLDALM_TIM,L2=W	;2;//ｽﾗｲﾄﾞ移動異常検出用　ｽﾗｲﾄﾞ移動測定時間2011-03-22[ｸﾗﾝｸ機構MC　H1F]
	DATA_STD_SHN_MOV SRC=_PAR_ORGPOS_LNG1,L1=W,DST=_WPAR_ORGPOS_LNG1,L2=W	;2;//原点の比較距離:2011-03-22ﾀｲﾌﾟ



	M_BRA	SYS_LD_ORG_HOS_700
SYS_LD_ORG_HOS_700:
;	---2011-05-11--
	DATA_STD_SHN_MOV SRC=_PAR_BRKTST_ORGDEG,L1=W,DST=_WPAR_BRKTST_ORGDEG,L2=W	;2;//制動試験時の原点復帰完了角度 270.0度


;	---- 2011-07-04-----
	FAR_JSR	#_BIBUN_KANSHI_SYS_SET,R0
	M_BRA	SYS_LD_BRKSYS_800

SYS_LD_BRKSYS_800:
;	---2011-09-20--
	DATA_STD_CHG_MOV SRC=(_PAR_BRKTST_DNDLMT-_CB_SYS_PARAM000+_W_PARAM_TOP)	,L1=W	,DST=_WPARX_BRKTST_DNDLMT	,L2=L,CALLSB=_CYCLE_SPD1	;//4;


;	---- 2012-03-06 --
	FAR_JSR	#_BRKTMCAL_DT_MOV,R0	;2012-03-06



;	---- 2012-05-30--
	MOV.W	#D'50,R2
	MOV.L	#_PAR_NEGWAIT_TIM-_CB_SYS_PARAM000+_W_PARAM_TOP,R1
	MOV.W	@R1,R0			;
	TST	R0,R0			;
	TST_BIT_OF SYS_LD_BRKSYS_900	;
	MOV	R0,R2			;
SYS_LD_BRKSYS_900:			;
	MOV.L	#_FUL_CLS_DLYTM_SV,R1	;
	MOV.W	R2,@R1			;



;	----------------- 2013-02-05 ---------
	FAR_JSR	#_SYS2_DT_LOAD,R0			;


;	-----------2013-06-13
	FAR_JSR	#_TEP_DTMAK,R0


	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***				***
;	***********************************
;	2017-02-25 100段使用でも10段までは振り子の加速はカーブも対応
;
_DNM_ACC_MATHED_SELECT:
	SUB_START
	MOV.W	#D'10,R4
	MOV.L	#_SET1_MTSTEP_MAXM,R1		;
	MOV.W	@R1,R2				;
	CMP/HI	R4,R2				;MAX=10 < R2
	BT	DNM_ACC_MATHEDSELECT_100	;

	MOV.L	#_SVP_MTSTEP_MAXM,R1		;
	MOV.W	@R1,R2
	CMP/HI	R4,R2				;MAX=10 < R2
	BT	DNM_ACC_MATHEDSELECT_100	;

	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定=1~10(2~11)
	MOV.W	@R1,R2				;
	CMP/HI	R4,R2				;MAX=10 < R2
	BT	DNM_ACC_MATHEDSELECT_100	;


	DATA_STD_SHN_MOV SRC=_PAR_ACC_MATHED	,L1=W,DST=_WPAR_ACC_MATHED,L2=W		;WPAR_ACC_MATHED=1:振子ﾃｰﾌﾞﾙﾀｲﾌﾟ
	M_BRA	DNM_ACC_MATHEDSELECT_200	;

DNM_ACC_MATHEDSELECT_100:

	XOR	R0,R0
	MOV.L	#_WPAR_ACC_MATHED,R1
	MOV.W	R0,@R1

DNM_ACC_MATHEDSELECT_200:

	SUB_END
	M_RTS
	

;	***************************************************
;	***						***
;	***		処理を軽くするため		***
;	***		電源投入時だけのものはここへ	***
;	***		2013-02-05			***
;	***						***
;	***************************************************
;
	.export		_SYS2_DT_LOAD
_SYS2_DT_LOAD
	SUB_START

						;;2013-03-07[CPUAはON　CPUBはSW分]
	.AIF	_TBLCURV EQ _CMPILE_YES		;YES:曲線ﾃｰﾌﾞﾙ(CPUAと同じ) NO:直線タイプ 2013-03-06


	.IMPORT	_USE_IN_TBL_MOV			;

;	======= 2013-02-05[]ふりこ処理軽くする 設定→シスパラ=====
	FAR_JSR	#_USE_IN_TBL_MOV,R0		;2010-10-20

;;;ここではTBL_ANS_ACCTIMができていない
;;;	========== ふりこ時のテーブル専用加減速===
;;;	---------<<<<<加減速時間 1~1000>>>>>-----------
	MOV.L	#_TBL_ANS_ACCTIM,R1				;2010-10-25
	MOV.W	@R1,R2						;
	TST	R2,R2
	TST_BIT_ON ACC_TBLMAK1_DTCHK050				;
	MOV.W	#1,R2						;
ACC_TBLMAK1_DTCHK050						;
	MOV.W	#D'1000,R0					;
	CMP/HS	R2,R0						;
	BT	ACC_TBLMAK1_DTCHK100				;
	MOV	R0,R2						;1msec~1000でﾘﾐｯﾄ
ACC_TBLMAK1_DTCHK100						;
	MOV.L	#_ACCB_ACCLAT_TIM1,R1				;
	MOV.W	R2,@R1						;

	.AENDI		;


	SUB_END
	M_RTS
	

_ACC_TBLX_RECALC:
	SUB_START

	.AIF	_TBLCURV EQ _CMPILE_YES		;YES:曲線ﾃｰﾌﾞﾙ(CPUAと同じ) NO:直線タイプ 2013-03-06

;	========== ふりこ時のテーブル専用加減速===
;	---------<<<<<加減速時間 1~1000>>>>>-----------
	MOV.L	#_TBL_ANS_ACCTIM,R1				;2010-10-25
	MOV.W	@R1,R2						;
	TST	R2,R2
	TST_BIT_ON ACC_TBLXMAK1_DTCHK050				;
	MOV.W	#1,R2						;
ACC_TBLXMAK1_DTCHK050						;
	MOV.W	#D'1000,R0					;
	CMP/HS	R2,R0						;
	BT	ACC_TBLXMAK1_DTCHK100				;
	MOV	R0,R2						;1msec~1000でﾘﾐｯﾄ
ACC_TBLXMAK1_DTCHK100						;
	MOV.L	#_ACCB_ACCLAT_TIM1,R1				;
	MOV.W	R2,@R1						;

	.AENDI		;2013-03-07[CPUAはON　CPUBはSW分]

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	システムパラメータ		***
;	***	トヨタ仕様			***
;	***					***
;	*******************************************
;_CB_SYS_PARAM063	
;_PAR_MCNRNA_SEL		.DATA.W		1	;1:機械でﾘﾆｱｽｹｰﾙを使用しない構造･･原点復帰

;_CB_SYS_PARAM064	
;_PAR_CUPCHK_SEL		.DATA.W		1	;1:SIT2用ｶｯﾌﾟﾘﾝｸﾞﾁｪｯｸ

;_CB_SYS_PARAM065				;停止中の360ｴﾝｺｰﾀﾞの動作許容量
;_PAR_360STP_HAB		.DATA.W		2	;0:未使用 2:停止中2度は許容する 358-359-0度-1-2

	.ALIGN	4				;
_TOYOTA_ADD_SYS:
	SUB_START

;	========= 2009-03-11(ﾄﾖﾀ仕様) ===========
	DATA_STD_SHN_MOV SRC=_PAR_MCNRNA_SEL,L1=W,DST=_WPAR_MCNRNA_SEL,L2=W	;

	DATA_STD_SHN_MOV SRC=_PAR_CUPCHK_SEL,L1=W,DST=_WPAR_CUPCHK_SEL,L2=W	;

;;;	DATA_STD_SHN_MOV SRC=_PAR_360STP_HAB,L1=W,DST=_WPAR_360STP_HAB,L2=W	 ;
;2011-07-04
	MOV.L	#_PAR_360STP_HAB,R1
	MOV.W	@R1,R2			;
	TST	R2,R2
	TST_BIT_OF SYS_STP360_100	;
	MOV.W	#10,R4			;
	CMP/HS	R4,R2
	BT	SYS_STP360_100		;R4=<R2 ok
	MOV	R4,R2			;
SYS_STP360_100
	MOV.L	#_WPAR_360STP_HAB,R1	;
	MOV.W	R2,@R1			;


	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***	2011-07-04		***
;	***				***
;	***********************************
	.ALIGN	4				;
_BIBUN_KANSHI_SYS_SET				;
	SUB_START

	MOV.L	#_PAR_ACC_ERR_FLT,R1
	MOV.W	@R1,R0

	MOV.W	#D'20,R2		;
	TST	R0,R0				;
	TST_BIT_OF BIBUN_SYSSET100		;

	CMP/HS	R2,R0				;
	BT	BIBUN_SYSSET100			;R2=<

	MOV	R0,R2				;1~19

BIBUN_SYSSET100					;
	MOV.L	#_BBN_SET_TIME,R1		;//MAX20msec
	MOV.W	R2,@R1				;

	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***	2011-07-04		***
;	***				***
;	***********************************
	.ALIGN	4				;
_BIBUN_KANSHI_SV_SET				;
	SUB_START

;;;	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R0		;//ｲﾝｸﾘﾒﾝﾀﾙｴﾝｺｰﾀﾞ換算値　pls/s
;;;	MOV.L	@R0,R2					;
;;;	MOV.L	#_SET1_ACCLAT_TIM1,R1			;
;;;	MOV.W	@R1,R4					;
;;;	MOV.W	#D'1000,R1				;
;;;	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0		;
;;;	MOV.L	#_SETX_MAX_ACC_LATE,R1			;//最大周波数*1000/時間
;;;	MOV.L	R2,@R1					;

;;;_SVP_RISE_ZWID		.SRES	2		;サーボパラメータBH　　上昇監視ｾﾞﾛ幅0.01
;;;_SVP_RISE_CMP1		.SRES	2		;サーボパラメータBI　　上昇監視比較10.01
;;;_SVP_RISE_CMP2		.SRES	2		;サーボパラメータBJ　　上昇監視比較20.01
;;;_SVP_RISE_CMP3		.SRES	2		;サーボパラメータBK　　上昇監視比較予備0.01
;;;_SVP_RISE_DLY1		.SRES	2		;サーボパラメータBL　　監視遅延1
;;;_SVP_RISE_DLY2		.SRES	2		;サーボパラメータBM　　監視遅延2


;;2014-10-23	MOV.L	#_SVP_RISE_ZWID,R0			;サーボパラメータBH　　上昇監視ｾﾞﾛ幅
;;2014-10-23	MOV.W	@R0,R1					;
;;2014-10-23	MOV.L	#_LINK_MAX_SPD_PLS,R0			;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
;;2014-10-23	MOV.L	@R0,R2					;
;;2014-10-23	MOV.L	#D'10000,R4				;
;;2014-10-23	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0		;
;;2014-10-23	MOV.L	#_SETX_ACCERR_ZEROHAB,R1		;3%以下は0
;;2014-10-23	MOV.L	R2,@R1					;(CPUA)

;;2014-10-23	MOV.L	#_SVP_RISE_CMP1,R0			;サーボパラメータBI　　上昇監視比較10.01
;;2014-10-23	MOV.W	@R0,R1					;
;;2014-10-23	MOV.L	#_LINK_MAX_SPD_PLS,R0			;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
;;2014-10-23	MOV.L	@R0,R2					;
;;2014-10-23	MOV.W	#D'10000,R4				;
;;2014-10-23	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0		;
;;2014-10-23	MOV.L	#_SETX_ACCERR_ERR1DAT,R1		;(CPUB)
;;2014-10-23	MOV.L	R2,@R1					;
;;2014-10-23	M_BRA	BIBUN_KANSHI_SVSET100			;

;;;2014-10-23	MOV.L	#_SVP_RISE_CMP2,R0			;サーボパラメータBJ　　上昇監視比較10.01
;;;2014-10-23	MOV.W	@R0,R1					;
;;;2014-10-23	MOV.L	#_LINK_MAX_SPD_PLS,R0			;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
;;;2014-10-23	MOV.L	@R0,R2					;
;;;2014-10-23	MOV.W	#D'10000,R4				;
;;;2014-10-23	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0		;
;;;2014-10-23	MOV.L	#_SETX_ACCERR_ERR2DAT,R1		;BJ
;;;2014-10-23	MOV.L	R2,@R1					;
;;;2014-10-23	M_BRA	BIBUN_KANSHI_SVSET100			;

;;2014-10-23BIBUN_KANSHI_SVSET100			;

;;2015-07-14;	------ 2011-09-01
;;2015-07-14	MOV.L	#_SVP_RISE_CMP3,R0			;サーボパラメータBK　　上昇監視比較10.01
;;2015-07-14	MOV.W	@R0,R1					;
;;2015-07-14;;;;2014-10-22	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R0	;//
;;2015-07-14	MOV.L	#_LINK_MAX_SPD_PLS,R0			;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
;;2015-07-14	MOV.L	@R0,R2					;
;;2015-07-14	MOV.W	#D'10000,R4				;
;;2015-07-14	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0		;
;;2015-07-14	MOV.L	#_SETX_ACCERR_ERR3DAT,R1		;BK
;;2015-07-14	MOV.L	R2,@R1					;




;	-----いつでも異常が連続した回数 0なら
	MOV.L	#_SVP_RISE_DLY1,R0			;サーボパラメータBL　　監視遅延1[異常状態継続時間]
	MOV.W	@R0,R2					;
	MOV.L	#_SETX_ACCERR_DLY1,R1			;//異常状態がこの継続した異常停止
	MOV.W	R2,@R1					;
;;;未使用2014-10-23	MOV.L	#_SETX_ACCERR_DLY2,R1			;//加速度>0時の異常遅延
;;;未使用2014-10-23	MOV.W	R2,@R1					;


;-----------------------------[指令の遅延時間に使用 2011-08-29]
	MOV.L	#_SVP_RISE_DLY2,R0			;サーボパラメータBM　　監視遅延2[機械遅延時間]
	MOV.W	@R0,R2					;
	MOV.L	#_SETX_ACCERR_SEL,R1			;2011-07-11
	MOV.W	R2,@R1					;SEL=過去時間
;;;未使用2014-10-23	MOV.L	#_SETX_ACCERR2_DLY1,R1	;異常ﾁｪｯｸ遅延時間
;;;未使用2014-10-23	MOV.W	R2,@R1			;
	M_BRA	BIBUN_KANSHI_SVSET200			;

BIBUN_KANSHI_SVSET200			;

;;2014-10-23	;	------ 2011-09-01
;;2014-10-23		MOV.L	#_SVP_ORGREV_AGL,R1			;サーボパラメータBF　　逆転[加工領域角度：監視係数を変える]
;;2014-10-23		MOV.L	@R1,R3					;
;;2014-10-23		MOV.L	#_UP_HOLD_DIG,R4			;
;;2014-10-23		MOV.W	@R4,R2					;
;;2014-10-23		ADD	R3,R2					;
;;2014-10-23		MOV.L	#_SETX_HOLD_CMP1_DEG,R1			;
;;2014-10-23		MOV.W	R2,@R1					;


;	--------2014-10-23--------------------
;	------------- 180度に対する上昇ホールド
	MOV.L	#_SVP_UPHOLD_DIG,R0			;上昇ﾎｰﾙﾄﾞ角度 0.1
	MOV.W	@R0,R3					;ｸﾗﾝｸ角度
	MOV.W	#D'3600,R2				;
	SUB	R3,R2					;180.0-160.0+180.0:
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0		;
	MOV.L	#_SETX_HOLD_CMP1_DEG,R1			;回転・往路時の上昇
	MOV.W	R2,@R1					;

	MOV.L	#_SVP_UPHOLD_DIG,R0			;上昇ﾎｰﾙﾄﾞ角度 0.1
	MOV.W	@R0,R2					;ｸﾗﾝｸ角度
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0		;
	MOV.L	#_DNM_SETX_HOLD_CMP1_DEG,R1		;//0.1度(165.0):ﾓｰﾀ軸ｴﾝｺｰﾀﾞ角度で比較
	MOV.W	R2,@R1					;







	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***	2011-08-01		***
;	***				***
;	***********************************
;	2012-09-25 リニア位置から荷重に変更する。この部分は変更無し。コメントだけ追加

	.ALIGN	4				;
_RNA_INSERT_SV_SET:
	SUB_START

	MOV.L	#_SVP_ACCLAT_TIMP,R0			;サーボパラメータBB.加減速時間　未使用(2011-02-18ｺﾒﾝﾄ)
	MOV.W	@R0,R2					;
	MOV.W	#D'100,R4				;
	CMP/HS	R2,R4					;
	BT	RNA_INSERT_SVSET_100			;
	MOV	R4,R2					;
RNA_INSERT_SVSET_100:					;
	MOV.L	#_SETX_RNA_ACC_BEFTIM,R1		;タッチ検出から過去のデータを参照する時間設定
	MOV.W	R2,@R1					;リニア加速度でも荷重加速度でも同じ意味

	MOV.L	#_SVP_RAD,R1				;サーボパラメータBE　　半径 0.001mm
	MOV.L	@R1,R2					;
	MOV.L	#_SETX_RNA_ACC_CHKPOS,R1		;リニア位置検出の場合リニア加速度との比較しきい値
	MOV.L	R2,@R1					;荷重検出の場合荷重加速度との比較しきいち

	

	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	2008-11-11			***
;	***	(H2W 2008-06-11) ﾘﾆｱのﾊｰﾄﾞｾﾚｸﾄ	***
;	***		  　ﾘﾆｱのﾘｾｯﾄ条件	***
;	***					***
;	*******************************************
;	_PAR_RNA_ALMSEL	=  0:ﾌﾟﾛﾄﾛﾙ 通常ﾘﾆｱ ,ﾘﾆｱ異常時停止
;			   1:ﾌﾟﾛﾄﾛﾙ 通常ﾘﾆｱ ,ﾘﾆｱ異常時動作
;		    	  10:ﾌﾟﾛﾄﾛﾙ 振動強化ﾘﾆｱ ,ﾘﾆｱ異常時停止 2008-06-11
;			  11:ﾌﾟﾛﾄﾛﾙ 振動強化ﾘﾆｱ ,ﾘﾆｱ異常時動作 2008-06-11
;[2015-10-13 MTS対応 CE2の移植]
;				20:X社製造 ﾌﾟﾛﾄｺﾙ 0.01um,
;				21:X社製造 ﾌﾟﾛﾄｺﾙ 0.01um
	.EXPORT	_RNA_RESET_PROTOCOL_CHK
 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	.IMPORT	_SND_CMD_CHECK_INIT1		;
 .AENDI
	
	.ALIGN	4				;
_RNA_RESET_PROTOCOL_CHK:
	SUB_START

	XOR	R2,R2				;
	MOV.L	#_PAR_RNA_ALMSEL,R1		;
	MOV.W	@R1,R0				;
	CMP/EQ	#1,R0				;
	BT	SYS_DATLD_RNASEL_050		;1
	CMP/EQ	#11,R0				;
	BT	SYS_DATLD_RNASEL_050		;1
	CMP/EQ	#21,R0				;2015-10-13
	BT	SYS_DATLD_RNASEL_050		;1
	M_BRA	SYS_DATLD_RNASEL_100		;1,11以外(0or10):_IN_PARAM_RNA_CHK

SYS_DATLD_RNASEL_050
	MOV.W	#1,R2
	MOV.L	#_IN_PARAM_RNA_CHK,R1		;1:ERRを見ない　特殊ﾊﾞｰｼﾞｮﾝ
	MOV.W	R2,@R1				;

SYS_DATLD_RNASEL_100


	XOR	R2,R2				;
	MOV.L	#_PAR_RNA_ALMSEL,R1		;
	MOV.W	@R1,R0				;
	CMP/EQ	#10,R0				;
	BT	SYS_DATLD_RNASEL_250		;1:_RNA_PROTOCOL_SEL
	CMP/EQ	#11,R0				;
	BT	SYS_DATLD_RNASEL_250		;1:_RNA_PROTOCOL_SEL

;2015-10-13
	CMP/EQ	#20,R0				;
	BT	SYS_DATLD_RNASEL_225		;RNA_PROTOCOL_X=1
	CMP/EQ	#21,R0				;
	BT	SYS_DATLD_RNASEL_225		;RNA_PROTOCOL_X=1
	M_BRA	SYS_DATLD_RNASEL_300		;0:_RNA_PROTOCOL_SEL

;	------------------------------------------
SYS_DATLD_RNASEL_225
	MOV.B	#1,R2
	MOV.L	#_RNA_PROTOCOL_X,R1		;"1"X社製ﾌﾟﾛﾄｺﾙ
	MOV.W	R2,@R1				;
	M_BRA	SYS_DATLD_RNASEL_300		;ｺﾏﾝﾄﾞ等が変わる

SYS_DATLD_RNASEL_250
	MOV.W	#1,R2
	MOV.L	#_RNA_PROTOCOL_SEL,R1		;1:振動強化ﾘﾆｱ
	MOV.W	R2,@R1				;

SYS_DATLD_RNASEL_300

 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
;	---2015-10-13 -----------
	FAR_JSR	#_SND_CMD_CHECK_INIT1,R0	;SCIF
 .AENDI	;IF-CPUA


	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	*** 		2006-04-10		***
;	***					***
;	*******************************************
_SELF_CHK_PARAM_MOVE:
	SUB_START
	SUB_END
	M_RTS





;	*******************************************
;	***					***
;	***	/運転画面設定			***
;	***	/ｻｰﾎﾞﾊﾟﾗﾒｰﾀ			***
;	*******************************************
;;;	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_INP1	,L1=W,DST=_SET1_UPAREA_INPX	,L2=W	;上死点ｲﾝﾎﾟｼﾞｼｮﾝ

	.MACRO	DATA_ADD_SP1_MOV SRC,DST,CONF,ADDDT
		MOV.W	#\CONF,R4
		MOV.L	#\SRC,R1
		MOV.W	@R1,R2
;;	.AIF	_PRG_CHG20030127 EQ _COMPILE_YES	;ﾌﾟﾛｸﾞﾗﾑ変更箇所(反転仕様以外の標準に入れる変更)
;;	.AENDI
		TST	R2,R2			;
		TST_BIT_OF JMP01\@

		CMP/EQ	R4,R2
		BT	JMP01\@
		MOV.W	#\ADDDT,R4		;
		ADD	R4,R2			;
JMP01\@:
		MOV.L	#\DST,R1	;
		MOV.W	R2,@R1			;PG偏差異常幅PLS
	.ENDM




;	***************************************************
;	***						***
;	***************************************************
_SV_DAT_N_LOAD:
	SUB_START

;;;;;;;	FAR_JSR	#_DT_10STEP_SVLOAD,R0			;2015-09-30 100<=>10段仕様切替





;;;;;;;;	MOV.L	#_SVCHK_SCAN,R1			;
;;;;;;;;	MOV.W	@R1,R0				;
;;;;;;;;	ADD	#1,R0				;
;;;;;;;;	AND	#H'3,R0				;4ｽｷｬﾝに1回とする
;;;;;;;;	MOV.W	R0,@R1				;
;;;;;;;;	TST	R0,R0				;
;;;;;;;;	TST_BIT_ON SV_DAT_N_LD_EXT		;

	FAR_JSR	#_SV_DAT_LOAD,R0		;


	MOV.L	#_emg_err_flg,R1		;//異常ﾗｯﾁ
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_OF SV_DAT_N_LD_EXT		;

						;2014-09-20
	FAR_JSR	#_SV_DAT_SETGAMEN_LOAD,R0	;非常停止ﾚﾍﾞﾙ時のみﾃﾞｰﾀの取り込みを行う
						;特に位置決め中変更不可のもの
						;(設定画面の読出)


SV_DAT_N_LD_EXT:

	FAR_JSR	#_MYUTING_FUNC_CHECK,R0		;2重回路に関わる設定はここ

	SUB_END
	M_RTS






;	***************************************************
;	***						***
;	***						***
;	***						***
;	***************************************************
_SV_DAT_LOAD:
	SUB_START

	FAR_JSR	#_SV_LOAD_FUNC_SEL1,R0			;機能選択

	FAR_JSR	#_SV_LOAD_SELF_SEL1,R0			;ｾﾙﾌﾁｪｯｸ機能

	FAR_JSR	#_SV_LOAD_SRV_PARSYS,R0			;ｻｰﾎﾞﾊﾟﾗﾒｰﾀ[ｼｽﾃﾑ演算の規定値]

	FAR_JSR	#_SV_LOAD_SRV_PARERR1,R0		;ｻｰﾎﾞﾊﾟﾗﾒｰﾀ[異常検知-EMG]

	FAR_JSR	#_SV_LOAD_SRV_PARCMP1,R0		;ｻｰﾎﾞﾊﾟﾗﾒｰﾀ[異常検知-比較値]

	FAR_JSR	#_SV_LOAD_SRV_PARSV1,R0			;ｻｰﾎﾞﾊﾟﾗﾒｰﾀ[ｲﾝﾎﾟｼﾞｼｮﾝ,ｸﾘｰﾌﾟ速度]

	FAR_JSR	#_SV_LOAD_SRV_PARSV2,R0			;ｻｰﾎﾞﾊﾟﾗﾒｰﾀ[]

	FAR_JSR	#_SV_LOAD_SV_MOTION1,R0			;方式[変更API有り]

;	--------- 2015-09-29 ---------
	FAR_JSR	#_SV_LOAD_STEP_MAX_SET,R0		;段数[変更API有り]


;	-------- 2015-11-11
;;;2016-04-18	FAR_JSR	#_ACCLW_DATA_MAIN,R0

;	-------- 2016-04-18--------------
	FAR_JSR	#_ACC_MATHED_SEL_MAIN,R0	;2016-04-18

;	-------- 待機点タイマと設定タイマの変更処理前
	FAR_JSR	#_TIMER_CHG_CHECK,R0	;2007-12-28 「_MOTION_DATA_DPRAM_TO_WORK1」より前で行う
	M_BRA	AAABBB_000

AAABBB_000:

;	------------- モーションデータ転送-------------
	FAR_JSR	#_MOTION_DATA_DPRAM_TO_WORK1,R0	;2015-10-22

;	---	2016-04-16 SW(PRESS/POS,ACC BEFORE/AFTER) ----
	FAR_JSR	#_DTMK_SW_INFO_MOV,R0	;

	M_BRA	DTMK_ACC_LATE_SET

DTMK_ACC_LATE_SET:

;;;2014-11-10	加減速時間もテーブルから算出するからMODA1Xを生かす
;;;;加減速をテーブルから参照する際に寸動は有り	FAR_JSR	#_CHK_DNM_SPEC_MODA1X,R0	;加減速をテーブルから参照する際に寸動は無し
;;;;加減速をテーブルから参照する際に寸動は無し	FAR_JSR	#_CHK_DNM_SPEC_MOD1,R0				;

	FAR_JSR	#_CHK_DNM_SPEC_MODA1X,R0	;加減速をテーブルから参照する際に寸動は無し
	TST	R0,R0							;
	TST_BIT_ON DTMK_ACC_LATE_100							;ふりこで且つモーションで且つテーブル加速	

	MEM1_BIT0_F_ORSET MEM=_DNM_DEBUG_STS1,LG=W,BIT=(BIT9),WKRG1=R1,WKRG2=R4		;DEBUG 2012-12-10

;	=====2012-10-05 反転の時の加速度比率
	MOV.L	#_SETX_POS_CTL_MATH,R1			;
	MOV.W	@R1,R0					;
	TST	#_DMATH_REVRSE,R0			;DRIVE MATH 反転
	TST_BIT_OF DTMK_ACC_LATE_050			;反転ではない JUMP NOMALO
	MOV.L	#_INP_MODE,R1				;
	MOV.W	@R1,R0					;
	TST	#(_W1OPT+_W1CNT+_W1SGL+_W1INC),R0	;
	TST_BIT_OF DTMK_ACC_LATE_050			;
	
	MOV.L	#(_PAR_NEG_ACCLATE-_CB_SYS_PARAM000+_W_PARAM_TOP),R0	;
	MOV.W	@R0,R2							;
	TST	R2,R2							;
	TST_BIT_OF DTMK_ACC_LATE_050					;反転加減速LATE
	MOV.L	#_SVP_ACCLAT_TIM1,R0					;
	MOV.W	@R0,R1							;
	MOV.W	#D'1000,R4						;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0				;
	MOV.L	#_SET1_ACCLAT_TIM1,R1					;(ふりこの直線を選択)
	MOV.W	R2,@R1							;
	M_BRA	DTMK_ACC_LATE_200					;


DTMK_ACC_LATE_050


	DATA_STD_SHN_MOV	SRC=_SVP_ACCLAT_TIM1	,L1=W,DST=_SET1_ACCLAT_TIM1	,L2=W	;

	M_BRA	DTMK_ACC_LATE_200								;



DTMK_ACC_LATE_100:
	MEM1_BIT0_F_ORSET MEM=_DNM_DEBUG_STS1,LG=W,BIT=(BIT8),WKRG1=R1,WKRG2=R4		;DEBUG 2012-12-10



	DATA_STD_SHN_MOV	SRC=_TBL_ANS_ACCTIM	,L1=W,DST=_SET1_ACCLAT_TIM1	,L2=W		;


DTMK_ACC_LATE_200:




	M_BRA	CCC000		;2007-12-28
CCC000:

;	===================================
;	===	位置決めLSI		===
;	===================================
;	***********************************
;	***	加減速演算+SET		***
;	***********************************
;	1msec data
;	時間*50000(500KHZ)/65535-1 =LATE
;	時間*500000/(65535*10)
	MOV.L	#_POS_FRQ_SPDMAX,R0				;500KHZ(500000PLS/S)
	MOV.L	@R0,R1						;
	MOV.L	#_SET1_ACCLAT_TIM1,R0				;
	MOV.W	@R0,R2						;

;	============= 2004-09-19 =============
	MOV.L	#_SVP_INCPLS_1REV,R0				;
	MOV.W	@R0,R0						;
	TST	R0,R0						;
	TST_BIT_OF DTMK_LATE030					;
	SHLL	R2						;
	CMP/EQ	#1,R0						;
	BT	DTMK_LATE030					;
	SHLL	R2						;
DTMK_LATE030:							;
;	=======================================

	MOV.L	#D'65535*10,R4					;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;R2*1REV*HOSN/HOSM

	MOV.W	#2,R3						;
	CMP/GE	R3,R2						;
	BT	DTMK_LATE050					;
	MOV	R3,R2						;
DTMK_LATE050:							;
	MOV.L	#_POS_LSI_ACCLT1,R0				;R2*SPDMAX(500,000)/65535*10
	SHLR	R2						;1~30000
	SHLL	R2
	MOV.W	R2,@R0						;



	MOV.W	#2,R2			;
	MOV.L	#_POS_LSI_ACCLT2,R0	;min
	MOV.W	R2,@R0			;

	FAR_JSR	#_CAM_DATA_MOV,R0	;

	FAR_JSR	#_MOV_DATA_ABNOMAL_CHK,R0


;	------------- ﾃﾞｰﾀ変更 2015-10-25-----------
	FAR_JSR	#_SPD_DATA_CHANGE_CHK1,R0	;戻り速度変更ﾁｪｯｸ
	FAR_JSR	#_SPD_DATA_CHANGE_CHK2,R0	;ﾓｰｼｮﾝ速度変更
	FAR_JSR	#_POS_DATA_CHANGE_CHK1,R0	;異常用角度
	FAR_JSR	#_OVERLIDE_DATA_CHG_CHK,R0	;ｵｰﾊﾞﾗｲﾄﾞ















;	====== 2003-07-14 ====
	DATA_STD_SHN_MOV SRC=_SVP_TEPLAT_DAT1	,L1=W,DST=_WPAR_BRK1_DLYTM		,L2=W	;2; 手動ﾊﾟﾙｻ低倍率=>ﾌﾞﾚｰｷ遅延時間
	DATA_STD_SHN_MOV SRC=_SVP_TEPLAT_DAT2	,L1=W,DST=_WPAR_BRK1_ACCTM		,L2=W	;2; 手動ﾊﾟﾙｻ高倍率=>ﾌﾞﾚｰｷ加速時間

;	------------------
;	--- 2006-04-10 ---
;	------------------
;;;;	MOV.L	#_PAR_SLFBRK_PLS,R1	;
;;;;	MOV.W	@R1,R0			;
	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_INP1	,L1=W,DST=_SET1_UPAREA_INPX	,L2=W	;上死点ｲﾝﾎﾟｼﾞｼｮﾝ

	MOV.L	#_SET1_UPAREA_INPX,R1	;
	MOV.W	@R1,R0			;
	MOV.L	#_SELF_MOV_LENGTH,R1	;// PLS(換算値)
	MOV.L	R0,@R1			;

;;;	MOV.L	#_PAR_SLFBRK_SPD,R1	;
;;;	MOV.W	@R1,R2			;100.0%
;;;	FAR_JSR	#_CYCLE_SPD2,R0		;

	MOV.L	#_SET1_STDINC_SPD1,R1	;
	MOV.L	@R1,R2			;
	MOV.L	#_SELF_MOV_SPEED,R1	;// PLS(換算値)
	MOV.L	R2,@R1			;


;	------------------
;	--- 2006-07-14 ---
;	------------------
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
	.IMPORT	_CPUA_TREND_SV_MOV	
	FAR_JSR	#_CPUA_TREND_SV_MOV,R0
	.AENDI

;	------------------
;	--- 2006-07-16 ---
;	------------------
	DATA_STD_SHN_MOV SRC=_SVP_LSAABN_AGL1	,L1=L,DST=_SET1_LSAABN_AGL1	,L2=W	;2;LSA異常検知の角度1
	DATA_STD_SHN_MOV SRC=_SVP_LSAABN_AGL2	,L1=L,DST=_SET1_LSAABN_AGL2	,L2=W	;2;LSA異常検知の角度2

;	---------------------------
;	--- 2006-07-28		---
;	---------------------------
	DATA_STD_SHN_MOV SRC=_SVP_PLSALO_PLS,L1=W,DST=_SET1_PLSALO_PLS,L2=W	;2;//パルサ倍率低
	DATA_STD_SHN_MOV SRC=_SVP_PLSAHI_PLS,L1=W,DST=_SET1_PLSAHI_PLS,L2=W	;2;//パルサ倍率高

;	--------------------------
;	--- 2006-07-28 ｵｰﾊﾞﾗｲﾄﾞ---
;	--------------------------
	DATA_STD_SHN_MOV SRC=_SVP_OVERLIDE_COF	,L1=W,DST=_SET1_OVERLIDE_COF	,L2=W	;2;[割込内でも実施<制動試験>]



;	--------------------------------------
;	--- 2006-07-28 荷重[荷重補正用]    ---
;	--------------------------------------
	DATA_STD_SHN_MOV SRC=_SVP_KJSTR_STEP1,L1=W,DST=_SET1_KJSTR_STEP1	,L2=W	;2;
	DATA_STD_SHN_MOV SRC=_SVP_KJEND_STEP1,L1=W,DST=_SET1_KJEND_STEP1	,L2=W	;2;
	DATA_STD_CHG_MOV SRC=_SVP_KJSTR_DIG1,L1=W,DST=_SET1_KJSTR_DIG1,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;
	DATA_STD_CHG_MOV SRC=_SVP_KJEND_DIG1,L1=W,DST=_SET1_KJEND_DIG1,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;


;	-----------------------------------
;	--- 2014-05-30 荷重[ﾄﾚﾝﾄﾞ用]    ---
;	-----------------------------------
	DATA_STD_SHN_MOV SRC=_SVP_KAJAREA_SNO,L1=W,DST=_SET1_KAJAREA_SNO	,L2=W	;2;
	DATA_STD_SHN_MOV SRC=_SVP_KAJAREA_ENO,L1=W,DST=_SET1_KAJAREA_ENO	,L2=W	;2;
	DATA_STD_CHG_MOV SRC=_SVP_KAJAREA_SAG,L1=W,DST=_SET1_KJSTR_DIG2,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;
	DATA_STD_CHG_MOV SRC=_SVP_KAJAREA_EAG,L1=W,DST=_SET1_KJEND_DIG2,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;

	MOV.L	#_SVP_KAJAREA_SEL,R1	;
	MOV.W	@R1,R0			;
	CMP/EQ	#1,R0			;
	BT	SV_TRDDT_SEL100
	CMP/EQ	#2,R0			;
	BT	SV_TRDDT_SEL100
	XOR	R0,R0
SV_TRDDT_SEL100
	MOV.L	#_SET1_KAJAREA_SEL,R1	;//記録荷重選択　ﾄﾚﾝﾄﾞ選択
	MOV.W	R0,@R1			;0:(最大),1(最小　ﾏｲﾅｽ側最大):2:幅




;	-----------------------------------
;	--- 2014-05-30 荷重[型タッチ]    ---
;	-----------------------------------
;	;タッチ位置検出角度
;	;タッチ位置検出角度
;	=== 2014/04/14 ===	SHIMA
	DATA_STD_CHG_MOV SRC=_SVP_KATTCH_SAG,L1=W,DST=_SET1_KATTCH_SAG,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;
	DATA_STD_CHG_MOV SRC=_SVP_KATTCH_EAG,L1=W,DST=_SET1_KATTCH_EAG,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;

;	----------------------------
;	--- 2006-07-28 段取停止  ---
;	----------------------------
;上死点と待機点とは異なる
;反転は待機点
;中型は待機点
;標準は上死点だ
	FAR_JSR	#_DND_STEP_CTRL_DT_MOV,R0


;	*******************************************
;	***					***
;	***	2007-01-23 ﾊﾟﾗﾒｰﾀをSQに変更	***
;	***					***
;	*******************************************
;
;	--------2007-01-23--------------------------------------
	XOR	R2,R2
	MOV.L	#_CB_SEQ_CB_SEL342,R1				;342
	MOV.W	@R1,R0						;
	TST	#BIT1,R0					;342.1:画面ｵｰﾊﾞﾗｲﾄﾞ(PAR52)
	TST_BIT_OF SQ_OVR_TYPSEL050				;
	MOV.B	#1,R2						;
SQ_OVR_TYPSEL050						;
	MOV.L	#_OVERLIDE_DT_SEL,R1				;0:画面ｵｰﾊﾞﾗｲﾄﾞ無効/SEQ有効
	MOV.W	R2,@R1						;1:画面ｵｰﾊﾞﾗｲﾄﾞ有効/SEQ無効

;	--------2007-01-23　ｵｰﾊﾞﾗｲﾄﾞをﾊﾟﾗﾒｰﾀからｼｰｹﾝｽに変更-------
;	--------2008-11-04 ｵｰﾊﾞﾗｲﾄﾞに加速度一定を追加---------------
	MOV.W	#2,R2						;
	MOV.L	#_CB_SEQ_CB_SEL342,R1				;342
	MOV.W	@R1,R0						;
	TST	#BIT4,R0					;342.4
	TST_BIT_ON SQ_ACC_TYPSEL050				;加速度一定

	XOR	R2,R2						;加速度一定でないなら距離/時間一定
	TST	#BIT2,R0					;342.2:加減速タイプ(PAR55)
	TST_BIT_OF SQ_ACC_TYPSEL050				;
	MOV.W	#1,R2						;
SQ_ACC_TYPSEL050						;
	MOV.L	#_WPAR_ACCTYP_SEL,R1				;0:距離一定
	MOV.W	R2,@R1						;1:時間一定

;	----------- 2009-03-11-----------
	FAR_JSR	#_TOYOTA_ADD_SV,R0

	M_BRA	BREAK_DATA2_LOAD


;	----------- 2010-08-23-------------
BREAK_DATA2_LOAD:
	MOV.L	#_SET1_BREAK_DIG,R5		;
	MOV.W	@R5,R2				;
	MOV.L	#_SVP_BREAK_DIG_RAT,R5 		;割合
	MOV.W	@R5,R1				;
	MOV.W	#D'100,R4			;1% 設定
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;R2*0~100%/100
	MOV.L	#_SETX_BREAK_DIG2,R1		;//0.1度
	MOV.W	R2,@R1				;

	MOV.L	#_SET1_BREAK_TIM1,R5		;
	MOV.W	@R5,R2				;
	MOV.L	#_SVP_BREAK_TIM_RAT,R5 		;割合
	MOV.W	@R5,R1				;
	MOV.W	#D'100,R4			;1% 設定
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;R2*0~100%/100
	MOV.L	#_SETX_BREAK_TIM2,R1		;//0.1度
	MOV.W	R2,@R1				;


;	------------- ｼｰｹﾝｽでﾘﾆｱｽｹｰﾙなし使用を可能とする---
	MOV.L	#_CB_SEQ_CB_COM349,R1						;
	MOV.W	@R1,R0								;
	TST	#BIT2,R0							;
	TST_BIT_OF PARMCN_CHG_100

;	----------------------------------
	MOV.W	#1,R0					;
	MOV.L	#_WPAR_MCNRNA_SEL,R1			;
	MOV.W	R0,@R1					;

PARMCN_CHG_100:
;	---- 2014-08-06
	MOV.L	#_WPAR_MCNRNA_SEL,R1			;
	MOV.W	@R1,R0					;
	CMP/EQ	#1,R0					;
	BF	PARMCN_CHG_120				;

	XOR	R0,R0					;
	MOV.L	#_WPAR_ORGDRV_MD2,R1			;原点復帰をｸﾗﾝｸﾀｲﾌﾟにしない
	MOV.W	R0,@R1					;

PARMCN_CHG_120:





;	-----------加振制御　比較荷重-----------
	DATA_STD_SHN_MOV SRC=_SVP_VIB_KJYU_TTL,L1=W,DST=_SET1_VIB_KJYU_TTL	,L2=W	;2;800KN=800
;	-----------加振制御　最大荷重-----------
	DATA_STD_SHN_MOV SRC=_SVP_MAX_KJYU,L1=W,DST=_SET1_MAX_KJYU	,L2=W	;2; 2000KN=2000

	M_BRA	NEG_CTRL_ADD_SV00


NEG_CTRL_ADD_SV00:
	FAR_JSR	#_FULCLS_TEMAEPOS_SEL,R0	;2012-10-05

;;2012-10-05 ;------- 2011-02-19
;;2012-10-05	MOV.L	#_SVP_OUTPLS_HOSA,R1		;NO.44 出力パルス補正0or1->2011-02-19[反転制御]反転制御手前距離(ﾊﾟﾙｽ)
;;2012-10-05	MOV.W	@R1,R2				;
;;2012-10-05	MOV.W	#1,R4				;
;;2012-10-05	CMP/EQ	R4,R2				;1なら0
;;2012-10-05	BF	NEG_CTRL_ADD_SV10		;
;;2012-10-05	XOR	R2,R2				;
;;2012-10-05NEG_CTRL_ADD_SV10:
;;2012-10-05	MOV.L	#_NEG_CTRL_BEFOR_OBJ_PLS,R1	;//目標−手前
;;2012-10-05	MOV.L	R2,@R1				;

;--------- 未使用-----------
;;	MOV.L	#_SVP_OUTPLS_HOSB,R1		;NO.45 出力パルス補正0or1->2011-02-19[反転制御]
;;	MOV.W	@R1,R4				;
;;	ADD	R4,R2				;
;;	MOV.L	#_NEG_CTRL_BEFOR_SLW_PLS,R1	;//目標−手前−速度減速
;;	MOV.L	R2,@R1				;



;	-------- 2011-07-04
	FAR_JSR	#_BIBUN_KANSHI_SV_SET,R0	;
	FAR_JSR	#_RNA_INSERT_SV_SET,R0	;型タッチ位置算出
	M_BRA	BRKTST_ADD_SV100

BRKTST_ADD_SV100:
;	-------- 2011-09-14
;	----2011-05-11------
;2;//制動試験時の原点復帰完了角度 270.0度
	DATA_STD_CHG_MOV SRC=_WPAR_BRKTST_ORGDEG,L1=W	,DST=_WPARX_BRKTST_ORGDEGX	,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;LINK(360)
	DATA_STD_CHG_MOV	SRC=_WPARX_BRKTST_ORGDEGX	,L1=W,DST=_WPARX_BRKTST_ORGPLS	,L2=L	;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS					;4;PG待機点ﾊﾟﾙｽ

;	----2011-09-14------
	DATA_STD_CHG_MOV SRC=(_PAR_BRKTST_STPDEG-_CB_SYS_PARAM000+_W_PARAM_TOP),L1=W	,DST=_WPARX_BRKTST_STPDEGX,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;LINK(360)
	DATA_STD_CHG_MOV	SRC=_WPARX_BRKTST_STPDEGX	,L1=W,DST=_WPARX_BRKTST_STPPLS	,L2=L	;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS					;4;停止角度

;	---2011-09-14 相対距離 _WPARX_BRKTST_STPPLS-_WPARX_BRKTST_ORGPLS
	MOV.L	#_WPARX_BRKTST_ORGPLS,R0	;
	MOV.L	@R0,R1				;
	MOV.L	#_WPARX_BRKTST_STPPLS,R0	;
	MOV.L	@R0,R2				;
	FAR_JSR	#_LINK_LENGTH_CALC_FWD,R0	;
	MOV.L	#_WPARX_BRKTST_STPLNG,R1	;//相対ﾊﾟﾙｽ
	MOV.L	R2,@R1				;


	FAR_JSR	#_BRKTST_AREA_DT_MAK,R0	;




;	----------- 2012-10-19 ------
;//349.5復活 制動試験とは別の目的で上昇復帰
;;;	MOV.L	#_PAR_ELSE_ORGDEG-_CB_SYS_PARAM000+_W_PARAM_TOP,R1	;
;;;	MOV.W	@R1,R2							;
;;;	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0				;

	DATA_STD_CHG_MOV SRC=(_PAR_ELSE_ORGDEG-_CB_SYS_PARAM000+_W_PARAM_TOP)
+				,L1=W	,DST=_WPARX_ELSE_ORGDEGX	,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;LINK(360)

	DATA_STD_CHG_MOV	SRC=_WPARX_ELSE_ORGDEGX,L1=W,DST=_WPARX_ELSE_ORGPLS,L2=L
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS					;4;PG待機点ﾊﾟﾙｽ


;	---------- 2013-02-20 ﾐｭｰﾃﾝｸﾞに関わる処理を一箇所に集める ----------
	FAR_JSR	#_MYUTING_SELCT_ELSE,R0


;CPUAだけの処理
;	----------金型ﾀｯﾁ速度-----------
	DATA_STD_CHG_MOV SRC=_SVP_KATTCH_SPD	,L1=W,DST=_SET1_KATTCH_SPD,L2=L,CALLSB=_CYCLE_SPD1	;pls/s


	
;	--------- 2014-08-30-------------------

	FAR_JSR	#_POS_HLD1_DTMAK,R0


;	--------------------------------------
;;2014-09-22	
;;	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R0		;//
	MOV.L	#_LINK_MAX_SPD_PLS,R0				;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
	MOV.L	@R0,R2						;
	MOV.L	#_SET1_ACCLAT_TIM1,R0				;V/T-> V*1000/T
	MOV.W	@R0,R4						;
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0
	MOV.L	#_POSHLD_SET_DN_ACC,R1				;//位置決めキャンセル減速
	MOV.L	R2,@R1						;


	FAR_JSR	#_MOT_REP_DTMAKE,R0				;

	SUB_END
	M_RTS




;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	動作仕様選択			***
;	***	LEVEL1				***
;	*******************************************
;	途中から変更しないことが基本
_SV_LOAD_FUNC_SEL1:		;機能選択
	SUB_START

;;;2015-10-25;	===2004-01-26 ===
;;;2015-10-25	XOR	R4,R4
;;;2015-10-25	MOV.L	#_FSYS_MAX_STEP_SEL,R1		;2004-01-26
;;;2015-10-25	MOV.W	@R1,R0				;
;;;2015-10-25	CMP/EQ	#1,R0				;
;;;2015-10-25	BF	SYS_PM_SW_SEL050		;NO MAX10対応しない
;;;2015-10-25;	24.3
;;;2015-10-25;;	MOV.L	#_SEQ_DP_TOP+_DPSQ024,R1	; 
;;;2015-10-25	MOV.L	#_CB_SEQ_SW_SEL024,R1		;//SEQ 24
;;;2015-10-25
;;;2015-10-25	MOV.W	@R1,R0				;
;;;2015-10-25	TST	#BIT3,R0			;24.3=1?
;;;2015-10-25	TST_BIT_OF SYS_PM_SW_SEL050		;
;;;2015-10-25	MOV.W	#1,R4				;
;;;2015-10-25SYS_PM_SW_SEL050:
;;;2015-10-25
;;;2015-10-25	MOV.W	#1,R4				;2015-10-25
;;;2015-10-25	MOV.L	#_WFSYS_MAX_STEP_SEL,R1		;10段/5段切り替え
;;;2015-10-25	MOV.W	R4,@R1				;

	XOR	R4,R4
	MOV.L	#_FSYS_OPT_CNT_SEL,R1		;2004-01-26
	MOV.W	@R1,R0				;
	CMP/EQ	#1,R0				;
	BF	SYS_PM_SW_SEL100		;OPTION 連続**一行程対応しない

	MOV.L	#_CB_SEQ_SW_SEL028,R1		;//[_SEQ_DP_TOP+_DPSQ028 DPRAM直接
	MOV.W	@R1,R0				;
	MOV.W	#(BIT12+BIT11),R3
	TST	R3,R0				;28.11/28.12=1
	TST_BIT_OF SYS_PM_SW_SEL100		;
	MOV.W	#1,R4				;
SYS_PM_SW_SEL100:
	MOV.L	#_WFSYS_OPT_CNT_SEL,R1		;SEL=1 連寸一、連続一行程有効
	MOV.W	R4,@R1				;

	SUB_END
	M_RTS
	

;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	ｾﾙﾌﾁｪｯｸ機能選択			***
;	***	LEVEL1				***
;	*******************************************
;	途中から変更しないことが基本
;
_SV_LOAD_SELF_SEL1
	SUB_START
;	----------------------------
;	----- ｾﾙﾌﾁｪｯｸ関連-----------
;	----------------------------

;	==== 2007-09-07 ちゃんとｾﾙﾌを生かす===
	MOV.L	#_PAR_SELFCHK_POWSEL,R1		;
	MOV.W	@R1,R0				;
	CMP/EQ	#1,R0				;
	BT	SELF_DT_MAK_100			;"1"ならちゃんとセルフする

;	====== 00:指定不可(非常停止時のみVS異常等)		
;	====== 01:停止解除はvs異常等+pls　動作時は停止解除	
;	====== 02:やらない					

;	------ 2006-12-06 １回起動したらｾﾙﾌはやらない[1]----
	MOV.L	#_SELF_LOCK_FLG,R1		;2006
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_OF SELF_DT_MAK_100
	XOR	R2,R2				;
	XOR	R3,R3				;
	M_BRA	SELF_DT_MAK_EXT			;

SELF_DT_MAK_100:
	XOR	R2,R2
	XOR	R3,R3
;;;;;;2006-04-26	MOV.L	#_CB_SEQ_SW_SEL028,R1			;//SEQ 28.0<前光電管>
;;;;;;2006-04-26	MOV.W	@R1,R0					;
;;;;;;2006-04-26	TST	#BIT0,R0				;
;;;;;;2006-04-26	TST_BIT_OF SELF_DT_MAK_EXT			;//SEQ 28.0<前光電管>

	MOV.L	#_PAR_SELF_MATH_SEL,R1			;
	MOV.W	@R1,R0					;
	CMP/EQ	#2,R0					;ｾﾙﾌﾁｪｯｸ無効
	BT	SELF_DT_MAK_EXT				;YES

;	----SYSPARAM=1---------
	MOV.W	#(BIT1*1+BIT0*1),R2			;非常停止(BIT0=1)と動作(BIT1=1)の両方有り
	MOV.W	#(BIT5*1+BIT4*0)+(BIT1*1+BIT0*1),R3	;非常停止解除時はVS異常とﾊﾟﾙｽ(BIT1=BIT0=1),動作時はﾊﾟﾙｽ(BIT5=1,BIT4=0)
	CMP/EQ	#1,R0					;
	BT	SELF_DT_MAK_EXT				;

;	----SYSPARAM=0---------
	MOV.W	#(BIT1*0+BIT0*1),R2			;非常停止有りと動作時なし
	MOV.W	#(BIT5*0+BIT4*0)+(BIT1*0+BIT0*1),R3	;非常停止解除時はVS異常のみ DEFUALT

SELF_DT_MAK_EXT:
	MOV.L	#_SELF_CHK_SEL,R1		;
	MOV.W	R2,@R1				;
	MOV.L	#_SELF_CHK_MATHED,R1		;
	MOV.W	R3,@R1				;


	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	サーボパラメータ設定		***
;	***	速度などの各演算の規定値	***
;	***	LEVEL1				***
;	*******************************************
_SV_LOAD_SRV_PARSYS:
	SUB_START

	FAR_JSR	#_POS_LSI_100PER_FRQ_MAK,R0

	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	サーボパラメータ設定[異常検知]	***
;	***	LEVEL1				***
;	*******************************************
_SV_LOAD_SRV_PARERR1:
	SUB_START

;	------------偏差ｵｰﾊﾞ 2013-03-10 ふりこの時CPUBは大きくする
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
	DATA_STD_SHN_MOV	SRC=_SVP_INCHEN_ELNG	,L1=W,DST=_SET1_INCHEN_ELNG,L2=W		;PG偏差異常幅PLS

	.AELSE

	MOV.L	#(_PAR_CPUB_DN_HOVR-_CB_SYS_PARAM000+_W_PARAM_TOP),R1		;
	MOV.W	@R1,R2								;
	TST	R2,R2								;
	TST_BIT_OF HENOVER_DT_100						;ふりこのｼｽﾊﾟﾗ未使用

	MOV.L	#_SETX_POS_CTL_MATH,R1			;
	MOV.W	@R1,R0					;
	TST	#_DMATH_DNDRIV,R0			;ふりこ
	TST_BIT_OF HENOVER_DT_100			;

	MOV.L	#_SET1_INCHEN_ELNG,R1			;
	MOV.W	R2,@R1					;
	M_BRA	HENOVER_DT_200				;

HENOVER_DT_100
	DATA_STD_SHN_MOV	SRC=_SVP_INCHEN_ELNG	,L1=W,DST=_SET1_INCHEN_ELNG,L2=W		;PG偏差異常幅PLS
HENOVER_DT_200:
	.AENDI	




	DATA_STD_CHG_MOV	SRC=_SVP_INCENC_ELNG	,L1=W,DST=_SET1_INCENC_ELNG,L2=W,CALLSB=_MUL10	;PG-ENC一致量0.0度
	DATA_STD_SHN_MOV	SRC=_SVP_INCRNA_ELNG	,L1=W,DST=_SET1_INCRNA_ELNG,L2=W		;PG-ﾘﾆｱ一致量mm

	DATA_STD_SHN_MOV	SRC=_SVP_INCSTP_ELNG	,L1=W,DST=_SET1_INCSTP_ELNG,L2=W		;PG停止異常量PLS
	DATA_STD_SHN_MOV	SRC=_SVP_RNASTP_ELNG	,L1=W,DST=_SET1_RNASTP_ELNG,L2=W		;ﾘﾆｱ停止異常量mm
	DATA_STD_SHN_MOV	SRC=_SVP_RNAREV_ELNG	,L1=W,DST=_SET1_RNAREV_ELNG,L2=W		;ﾘﾆｱ逆転異常量mm

;;	ｼｽﾊﾟﾗを逆転異常量へ(ﾊﾟﾙｽ払出完了したら異常を見ないからCPUA/Bの区別しない)
;;	画面設定の逆転異常量をｵｰﾊﾞﾗﾝ量へ
	DATA_STD_SHN_MOV	SRC=_PAR_INC_ERRLNG1	,L1=W,DST=_SET1_INCREV_ELNG,L2=W	;PG逆転異常量PLS

	DATA_STD_SHN_MOV	SRC=_SVP_INCREV_ELNG	,L1=W,DST=_WPAR_INCOVER_LNG,L2=W	;PGｵｰﾊﾞﾗﾝ反転仕様

	SUB_END
	M_RTS
	


;	***************************************************
;	***						***
;	***	2015-10-26 整理				***
;	***	サーボパラメータ設定[異常検知-比較]	***
;	***	LEVEL1					***
;	***************************************************

_SV_LOAD_SRV_PARCMP1:		;ｻｰﾎﾞﾊﾟﾗﾒｰﾀ[異常検知-比較値]
	SUB_START


	DATA_STD_CHG_MOV	SRC=_SVP_AMP100P_VLT,L1=W,DST=_SET1_AMP100P_VLT,L2=W,CALLSB=_MUL10;//AMP100%相当時の電圧値 0~10.0v(ｻｰﾎﾞﾊﾟﾗﾒｰﾀ)*10

;	=== 2003-07-09
	DATA_STD_SHN_MOV	SRC=_SVP_BREAK_DIG	,L1=W,DST=_SET1_BREAK_DIG,L2=W			;0.1度
	DATA_STD_SHN_MOV	SRC=_SVP_BREAK_TIM1	,L1=W,DST=_SET1_BREAK_TIM1,L2=W	;ブレーキタイマ設定1msec

;	===================================================
;	====		ダイハイト比較			===
;	===================================================
;;本当はこれ	DATA_STD_SHN_MOV	SRC=_SVP_DAIHAI_ORG0	,L1=L,DST=_SET1_DAIHAI_ORG0	,L2=L		;ダイハイト基準　設定位置はここから見た設定
	DATA_STD_SHN_MOV	SRC=_SVP_DAIHAI_ORG0	,L1=L,DST=_SET1_DAIHAI_ORG0	,L2=L		;ダイハイト基準　設定位置はここから見た設定


;;現物あわせ
;;	MOV.L	#_SVP_DAIHAI_ORG0,R1		;現物あわせ
;;	MOV.W	@R1,R2				;
;;	EXTU.W	R2,R2				;
;;	MOV.W	#D'10,R1			;
;;	DMULU.L	R1,R2				;
;;	STS	MACL,R2				;
;;	MOV.L	#_SET1_DAIHAI_ORG0,R1		;
;;	MOV.L	R2,@R1				;



	MOV.L	#_SET1_DAIHAI_ORG0,R1		;画面設定
	MOV.L	@R1,R7				;
;	================================
;;;	MOV.L	#_SVP_DAIHAI_LNG1,R1		;ﾀﾞｲﾊｲﾄ補正比較値(小)
;;;	MOV.W	@R1,R5				;
	MOV.L	#_SVP_DAIHSA_LENG,R1		;画面設定
	MOV.W	@R1,R5				;
	NEG	R5,R4				;
	MOV.L	#_SET1_DAIORG0_CMP1UP,R1	;
	ADD	R7,R5				;
	MOV.L	R5,@R1				;
	MOV.L	#_SET1_DAIORG0_CMP1DN,R1	;
	ADD	R7,R4				;
	MOV.L	R4,@R1				;
;	================================
	MOV.L	#_SVP_DAIHAI_LNG2,R1		;ﾀﾞｲﾊｲﾄ補正比較値(中)
	MOV.W	@R1,R5				;
	NEG	R5,R4				;
	MOV.L	#_SET1_DAIORG0_CMP2UP,R1	;
	ADD	R7,R5				;
	MOV.L	R5,@R1				;
	MOV.L	#_SET1_DAIORG0_CMP2DN,R1	;
	ADD	R7,R4				;
	MOV.L	R4,@R1				;
;	================================
	MOV.L	#_SVP_DAIHAI_LNG3,R1		;ﾀﾞｲﾊｲﾄ補正比較値(大)
	MOV.W	@R1,R5				;
	NEG	R5,R4				;
	MOV.L	#_SET1_DAIORG0_CMP3UP,R1	;
	ADD	R7,R5				;
	MOV.L	R5,@R1				;
	MOV.L	#_SET1_DAIORG0_CMP3DN,R1	;
	ADD	R7,R4				;
	MOV.L	R4,@R1				;
;	=============================
;;	.AIF	_PRG_CHG20030127 EQ _COMPILE_YES	;ﾌﾟﾛｸﾞﾗﾑ変更箇所(反転仕様以外の標準に入れる変更)
;;	.AENDI
;	==== 2003-01-27 ======
;	================================
	MOV.L	#_SVP_DAIHSA_LENG,R1		;画面設定
	MOV.W	@R1,R5				;
	NEG	R5,R4				;
	MOV.L	#_SET1_DAIORG0_CMP4UP,R1	;
	ADD	R7,R5				;
	MOV.L	R5,@R1				;
	MOV.L	#_SET1_DAIORG0_CMP4DN,R1	;
	ADD	R7,R4				;
	MOV.L	R4,@R1				;
;	=============================


	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	サーボパラメータ設定		***
;	***	LEVEL1				***
;	*******************************************
_SV_LOAD_SRV_PARSV1:
	SUB_START


;	----------- 反転下限距離
	DATA_STD_SHN_MOV	SRC=_SVP_NEG_OFS_LNG	,L1=L,DST=_SET1_NEG_OFS_LNG,L2=L	;//反転下限距離(0.001mm ｻｰﾎﾞﾊﾟﾗﾒｰﾀ)

;	===		ﾆｱｾﾞﾛ	==========
;;;	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_INP1	,L1=W,DST=_SET1_UPAREA_INPX	,L2=W	;上死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;;	DATA_STD_SHN_MOV	SRC=_SVP_DNAREA_INP1	,L1=W,DST=_SET1_DNAREA_INPX	,L2=W	;下死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;;	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_OBJARA_INPX	,L2=W	;目標位置ｲﾝﾎﾟｼﾞｼｮﾝ
;;;	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_INP1	,L1=W,DST=_SET1_UPAREA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS1;上死点ｲﾝﾎﾟｼﾞｼｮﾝ角度
;;;	DATA_STD_CHG_MOV	SRC=_SVP_DNAREA_INP1	,L1=W,DST=_SET1_DNAREA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS2;下死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_OBJARA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS3;目標位置ｲﾝﾎﾟｼﾞｼｮﾝ
;	==== ﾆｱｾﾞﾛを1つに統合===
;;	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_UPAREA_INPX	,L2=W	;上死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_DNAREA_INPX	,L2=W	;下死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_OBJARA_INPX	,L2=W	;目標位置ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_UPAREA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS1;上死点ｲﾝﾎﾟｼﾞｼｮﾝ角度
;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_DNAREA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS2;下死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP1	,L1=W,DST=_SET1_OBJARA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS3;目標位置ｲﾝﾎﾟｼﾞｼｮﾝ


;	======= 反転のmmｲﾝﾎﾟｼﾞｼｮﾝ============
;	0.01mmﾃﾞｰﾀ => 0.001mmﾃﾞｰﾀ(2014-12-25) ×10は別部分(FULL_CLOSE_DATA_MOV)で実施しているのをやめる
	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP0	,L1=W,DST=_SET1_OBJARA_INPX	,L2=W	;目標位置ｲﾝﾎﾟｼﾞｼｮﾝmm

;	=======回転のﾊﾟﾙｽｲﾝﾎﾟｼﾞｼｮﾝ ==========(上死点ｲﾝﾎﾟｼﾞｼｮﾝを使用)<予備の４　Ｓ字の下　上から５行目>
	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP1,L1=W,DST=_SET1_OBJARA_INPXPLS	,L2=W	;目標位置ｲﾝﾎﾟｼﾞｼｮﾝpls
	DATA_STD_SHN_MOV	SRC=_SVP_INPPOS_TIM1,L1=W,DST=_SET1_INPPOS_TIM1	,L2=W	;ｲﾝﾎﾟｼﾞｼｮﾝ時間(回転)

;	-------------------- (予備,最大周波数 4byte-->2byte )2009-10-07ふりこｲﾝﾎﾟｼﾞｼｮﾝ---------
	DATA_STD_SHN_MOV	SRC=_SVP_MOTMAX_FREQ,L1=L,DST=_SET1_OBJARA_INPXPSX	,L2=W	;目標位置ｲﾝﾎﾟｼﾞｼｮﾝpls(2009-10-07ふりこ)

;;	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP0	,L1=W,DST=_SET1_UPAREA_INPX	,L2=W	;上死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_SHN_MOV	SRC=_SVP_OBJARA_INP0	,L1=W,DST=_SET1_DNAREA_INPX	,L2=W	;下死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP0	,L1=W,DST=_SET1_UPAREA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS1;上死点ｲﾝﾎﾟｼﾞｼｮﾝ角度
;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP0	,L1=W,DST=_SET1_DNAREA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS2;下死点ｲﾝﾎﾟｼﾞｼｮﾝ
;;	DATA_STD_CHG_MOV	SRC=_SVP_OBJARA_INP0	,L1=W,DST=_SET1_OBJARA_INPXPLS	,L2=W,CALLSB=_RNACHGPLS3;目標位置ｲﾝﾎﾟｼﾞｼｮﾝ


;	==== 下死点ｲﾝﾎﾟｼﾞｼｮﾝ設定==>機械伸び量(2.000:ﾓｰﾀ回転ﾊﾟﾙｽ)======
	DATA_STD_SHN_MOV	SRC=_SVP_DNAREA_INP1	,L1=W,DST=_SET1_FULCLS_MXPLS,L2=W	;



;	===		速度		===
	DATA_STD_CHG_MOV	SRC=_SVP_DNDINC_SPD1	,L1=W,DST=_SET1_DNDINC_SPD1	,L2=L,CALLSB=_CYCLE_SPD1	;//4;段取速度
	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_SPD1	,L1=W,DST=_SET1_UPAREA_SPD1	,L2=L,CALLSB=_CYCLE_SPD1	;//4;待機点復帰速度
	DATA_STD_CHG_MOV	SRC=_SVP_STDINC_SPD1	,L1=W,DST=_SET1_STDINC_SPD1	,L2=L,CALLSB=_CYCLE_SPD1	;//4;寸動速度(未使用)

;	======= ｸﾘｰﾌﾟ速度====
	DATA_STD_CHG_MOV	SRC=_SVP_REVDAT_SPD1	,L1=W,DST=_SET1_REVDAT_SPD1	,L2=L,CALLSB=_CYCLE_SPD1	;//4;予備速度1
	DATA_STD_CHG_MOV	SRC=_SVP_REVDAT_SPD1	,L1=W,DST=_SET1_UPCLEEP_SPD	,L2=L,CALLSB=_CYCLE_SPD1	;//4;予備速度1

;	======= ｸﾛｰｽﾞ/ｲﾝﾁﾝｸﾞ時の速度====
	DATA_STD_CHG_MOV	SRC=_SVP_REVDAT_SPD2	,L1=W,DST=_SET1_REVDAT_SPD2	,L2=L,CALLSB=_CYCLE_SPD1	;//4;予備速度2


	DATA_STD_CHG_MOV	SRC=_SVP_REVDAT_SPD3	,L1=W,DST=_SET1_REVDAT_SPD3	,L2=L,CALLSB=_CYCLE_SPD1	;//4;予備速度3
;;2006-07-28	DATA_STD_CHG_MOV	SRC=_SVP_TEPDAT_SPD1	,L1=W,DST=_SET1_TEPDAT_SPD1	,L2=L,CALLSB=_CYCLE_SPD1	;//4;手動ﾊﾟﾙｻ速度

	DATA_STD_SHN_MOV	SRC=_SVP_TEPLAT_DAT1	,L1=W,DST=_SET1_TEPLAT_DAT1,L2=W	;手動ﾊﾟﾙｻ低倍率	
	DATA_STD_SHN_MOV	SRC=_SVP_TEPLAT_DAT2	,L1=W,DST=_SET1_TEPLAT_DAT2,L2=W	;手動ﾊﾟﾙｻ低倍率	


	DATA_STD_SHN_MOV	SRC=_SVP_INCPOS_KP01	,L1=W,DST=_SET1_INCPOS_KP01,L2=W	;PG位置比例ｹﾞｲﾝ
	DATA_STD_SHN_MOV	SRC=_SVP_RNAPOS_KP01	,L1=W,DST=_SET1_RNAPOS_KP01,L2=W	;ﾘﾆｱ位置比例ｹﾞｲﾝ

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	サーボパラメータ設定		***
;	***	LEVEL1				***
;	*******************************************
_SV_LOAD_SRV_PARSV2:
	SUB_START

;	======= 連続ﾀｲﾏ 1秒-->1000msec ======
	DATA_STD_CHG_MOV	SRC=_SVP_CNT_TIM,L1=W,DST=_SET1_CNT_TIM,L2=L,CALLSB=_UW_MUL1000;	;連続タイマ
	DATA_STD_SHN_MOV	SRC=_SVP_CNT_CNT,L1=W,DST=_SET1_CNT_CNT,L2=W		;連続カウンタ


	SUB_END
	M_RTS

;	***************************************************
;	***						***
;	***						***
;	***						***
;	***						***
;	***	各種デ−タ転送とデータ変更の関数	***
;	***						***
;	***						***
;	***						***
;	***						***
;	***************************************************
;	*******************************************
;	***					***
;	***	2015-10-26 整理			***
;	***	サーボパラメータ設定		***
;	***	LEVEL1				***
;	*******************************************
_SV_LOAD_SV_MOTION1:			;方式,段数
	SUB_START

	MOV.L	#_SVP_MRTION_SEL1,R1
	MOV.W	@R1,R0
	AND	#_DMATH_UPDRIV+_DMATH_DNDRIV+_DMATH_REVRSE+_DMATH_CNTROT,R0	;同じ意味

;	======== 方式選択　変な場合は反転とする========
	CMP/EQ	#_DMATH_CNTROT,R0		;DRIVE MATH 連続回転
	BT	SV_STEP_DATCHK_0100		;

	CMP/EQ	#_DMATH_REVRSE,R0		;DRIVE MATH 反転
	BT	SV_STEP_DATCHK_0100		;

	CMP/EQ	#_DMATH_DNDRIV,R0		;DRIVE MATH 下往復
	BT	SV_STEP_DATCHK_0100		;

	CMP/EQ	#_DMATH_UPDRIV,R0		;DRIVE MATH 上往復
	BT	SV_STEP_DATCHK_0100		;

	MOV	#_DMATH_REVRSE,R0		;DRIVE MATH 反転
SV_STEP_DATCHK_0100:

	MOV.L	#_SET1_MRTION_SEL1,R1			;
	MOV.W	@R1,R2					;
	MOV.W	R0,@R1					;

	CMP/EQ	R2,R0					;
	BT	SV_STEP_DATCHK_0200			;

	FAR_JSR	#_API_MATH_DATA_CHG_SIG_ON,R0			;方式変更有り


SV_STEP_DATCHK_0200:
	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***					***
;	***					***
;	***	100段仕様/5/10段仕様		***
;	***	2015-09-29			***
;	***					***
;	***					***
;	*******************************************
;SVP_MTSTEP_MAXM
_SV_LOAD_STEP_MAX_SET
	SUB_START

	MOV.L	#_SVP_MTSTEP_MAXM,R1	;
	MOV.W	@R1,R2			;
	TST	R2,R2			;
	TST_BIT_ON SV_STEP_MAXSEL_0050	;
	MOV.B	#1,R2
SV_STEP_MAXSEL_0050:

	MOV.L	#_SYS_STEP_MAX,R1	;
	MOV.W	@R1,R0			;
	CMP/HS	R2,R0			;R2 =< R0
	BT	SV_STEP_MAXSEL_0100	;
	MOV.B	#1,R2			;
SV_STEP_MAXSEL_0100:			;
	MOV.L	#_SET1_MTSTEP_MAXM,R1	;
	MOV.W	@R1,R0			;
	MOV.W	R2,@R1			;
	CMP/EQ	R2,R0			;
	BT	SV_STEP_MAXSET_END	;

	FAR_JSR	#_API_STEPMAX_DATA_CHG_SIG_ON,R0			;段数変更有り

;;;;;;;;;;;;; 2015-10-22
;;;;;;;;;;;;;	DATA_MAX_MIN_SHN_MOV SRC=_SVP_MTSTEP_MAXM,L1=W,DST=_SET1_MTSTEP_MAXM,L2=W,MAX=_EQ_STEP_MX3,L3=W,MIN=1,L4=W		;98段数
;;;;;;;;;;;;;	M_BRA SV_STEP_MAXSET_END
;;;;;;;;;;;;;
;;;;;;;;;;;;;
;;;;;;;;;;;;;	MOV.L	#_WFSYS_MAX_STEP_SEL,R1	;
;;;;;;;;;;;;;	MOV.W	@R1,R0			;
;;;;;;;;;;;;;	CMP/EQ	#1,R0			;10段仕様?
;;;;;;;;;;;;;	BT	SV_STEP_MAXSEL_0100	;YES 10
;;;;;;;;;;;;;
;;;;;;;;;;;;;SV_STEP_MAXSEL_0050:
;;;;;;;;;;;;;;	=== 5段 ===
;;;;;;;;;;;;;	DATA_MAX_MIN_SHN_MOV SRC=_SVP_MTSTEP_MAXM,L1=W,DST=_SET1_MTSTEP_MAXM,L2=W,MAX=_EQ_STEP_MAX,L3=W,MIN=1,L4=W		;5段数
;;;;;;;;;;;;;	M_BRA	SV_STEP_MAXSEL_0200
;;;;;;;;;;;;;
;;;;;;;;;;;;;SV_STEP_MAXSEL_0100:
;;;;;;;;;;;;;;	===10段===
;;;;;;;;;;;;;	DATA_MAX_MIN_SHN_MOV SRC=_SVP_MTSTEP_MAXM,L1=W,DST=_SET1_MTSTEP_MAXM,L2=W,MAX=_EQ_STEP_MX2,L3=W,MIN=1,L4=W		;10段数
;;;;;;;;;;;;;
;;;;;;;;;;;;;SV_STEP_MAXSEL_0200:
;;;;;;;;;;;;;

SV_STEP_MAXSET_END

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	DPRAM,DPRAM相当をﾜｰｸへ		***
;	***	モーションステップデータ	***
;	***	2015-10-22			***
;	***					***
;	*******************************************
_MOTION_DATA_DPRAM_TO_WORK1:
	SUB_START

;	=========== 待機点関連=====================
;	===	 待機角度と待機停止時間(目標位置は今回使用しない)	===
	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_DIG0,L1=W,DST=_SET1_UPAREA_DIG0,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;PG待機点角度

;	------ 復路の待機点 [2009-10-07下振子] -----------
	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_DIG0,L1=W,DST=_DNM_SET1_UPAREA_DIG0,L2=W,CALLSB=_SV_DN_CLANK_LINK_CHG;2;PG待機点角度

;	== 2004-01-28 ==
	MOV.L	#_SET1_UPAREA_DIG0,R1		;
	MOV.W	@R1,R3				;
	MOV.W	#_OVER1_JGDIG,R1		;.EQU	50	;5.0 DIG
	DIG_REGA_ADD_REGB_ANS_REGB REGA=R1,REGB=R3,WKREG=R4,LATE=D'3600	;ANS R3
	MOV.L	#_SVX_OVER_ERR_DIG,R1		;５度相当//待機点+５度   5
	MOV.W	R3,@R1				;

	MOV.L	#_SET1_UPAREA_DIG0,R1		;
	MOV.W	@R1,R2				;
	MOV.W	#_OVER1_JGDIG,R3		;
	DIG_REGA_SUB_REGB_ANS_REGB REGA=R3,REGB=R2,WKREG=R4,LATE=D'3600	;ANS R2
	MOV.L	#_SVX_OVER_JGSTR_DIG,R1;//待機点-度 355
	MOV.W	R2,@R1				;


	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_DIG1	,L1=W,DST=_SET1_UPAREA_DIG1	,L2=W	;2;回転時待機点(上死点)	
	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_DIG1	,L1=W,DST=_SETX_UPDN_CHK_UP_DIG	,L2=L	;2;360上死点
	MOV.L	#_SETX_UPDN_CHK_UP_DIG,R4	;(上死点角度 0.1度)
	MOV.L	@R4,R2					;
	FAR_JSR	#_POSCHG_LINK_DIG_TO_LINK_PLS,R0	;
	MOV.L	#_SETX_UPDN_CHK_UP_PLS,R1		;上死点相当のﾊﾟﾙｽ
	MOV.L	R2,@R1					;(これより大きいか/小さいかで判断できない)
							;下死点ﾊﾟﾙｽからﾊﾟﾙｽこの範囲なら上昇

	XOR	R0,R0
	MOV.L	#_SVPX_UPAREA_DIG1,R1	;ｸﾗﾝｸ上死点設定
	MOV.W	R0,@R1

	XOR	R0,R0
	MOV.L	#_SET1_ENC360_HOS1,R1	;2;360ｴﾝｺｰﾀﾞ補正値(いずれあった方がいいでしょう)
	MOV.W	R0,@R1			;


	DATA_STD_SHN_MOV	SRC=_SVP_UPAREA_POS0	,L1=L,DST=_SET1_UPAREA_POS0	,L2=L				;2;PG待機点位置


;	========= 戻り速度と戻り後のタイマ====================
	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_TIM0	,L1=W,DST=_SET1_UPAREA_TIM0	,L2=L,CALLSB=_TIM10MS_TO_1MS	;
	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_SPD0	,L1=W,DST=_SET1_UPAREA_SPD0	,L2=L,CALLSB=_CYCLE_SPD2	;基準速度 pls/s


;	---------- DPRAM→DPRAM相当---------------
	FAR_JSR	#_MOTION_DPRAM_STEP10_MOVE,R0	;DPRAM->DPRAM相当WORK


	FAR_JSR	#_STEP_DATA_DPRAM_TO_WORK1,R0	;2015-10-22

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	DPRAMをDPRAM相当へ		***
;	***	モーションステップデータ	***
;	***	2015-10-22[10段/100段切替]	***
;	*******************************************
_MOTION_DPRAM_STEP10_MOVE
	SUB_START
	MOV.L	#_SYS_100STEP_USE,R1		;
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_ON  MOTION_DPRAM_STEP10_MVEXT	;100段の場合はｼﾘｱﾙﾀｲﾌﾟ


	DATA_STEPLOP_SHN_MOV	SRC=_SVP_OBJECT_POS_TOP	,L1=L,DST=_SVPX1_OBJECT_POS_TOP	,L2=L,CNT_REG=R7,DSTADD=4
	DATA_STEPLOP_SHN_MOV	SRC=_SVP_OBJECT_DIG_TOP	,L1=W,DST=_SVPX1_OBJECT_DIG_TOP	,L2=W,CNT_REG=R7,DSTADD=2
	DATA_STEPLOP_SHN_MOV	SRC=_SVP_OBJECT_SPD_TOP	,L1=W,DST=_SVPX1_OBJECT_SPD_TOP	,L2=W,CNT_REG=R7,DSTADD=2
	DATA_STEPLOP_SHN_MOV	SRC=_SVP_OBJECT_TIM_TOP	,L1=W,DST=_SVPX1_OBJECT_TIM_TOP	,L2=W,CNT_REG=R7,DSTADD=2



MOTION_DPRAM_STEP10_MVEXT
	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	DPRAM相当をﾜｰｸへ		***
;	***	モーションステップデータ	***
;	***					***
;	*******************************************
;	100段/10段->COPY
;
;	[2019-02-05][1]_STEP_DATA_DPRAM_TO_WORK1: SVPX1_OBJECT_SPD_TOP->SET1_OBJECT_SPD_TOP
;	[2019-02-05][2]_STEP_POS_SPD_TIM_STEPMOV: SET1_OBJECT_SPD_TOP->SETX_POS_SDAT1_SPD
;	[2019-02-05][3]_CPOS_INI1_DTMOV2 :SETX_POS_SDAT1_SPD->_CPOS_SDAT1_SPD
;				   _CPOS_SPD_DTMOV   :SETX_POS_SDAT1_SPD->_CPOS_SDAT1_SPD

_STEP_DATA_DPRAM_TO_WORK1:
	SUB_START

;	===	 各段角度と各段停止時間(目標位置は使用しない)		===
	DATA_STEPLOP_CHG_MOV	SRC=_SVPX1_OBJECT_DIG_TOP	,L1=W,DST=_SET1_OBJECT_DIG_TOP	,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1
+				,CNT_REG=R7,DSTADD=2	;


	DATA_STEPLOP_SHN_MOV	SRC=_SVPX1_OBJECT_POS_TOP	,L1=L,DST=_SET1_OBJECT_POS_TOP	,L2=L,CNT_REG=R7,DSTADD=4


;	------ 2014-09-20 R指定時ﾀｲﾏを1msec加算するため　設定変更異常チェックが取らない
;;;;;;;	DATA_STEPLOP_CHG_MOV	SRC=_SVPX1_OBJECT_TIM_TOP	,L1=W,DST=_CHK_OBJECT_TIM_TOP	,L2=L,CALLSB=_TIM10MS_TO_1MS	;
;;;;;;;				,CNT_REG=R7,DSTADD=4								;

;	2015-10-25
	DATA_STEPLOP_CHG_MOV	SRC=_SVPX1_OBJECT_TIM_TOP	,L1=W,DST=_WK_OBJECT_TIM_TOP	,L2=L,CALLSB=_TIM10MS_TO_1MS	;
+				,CNT_REG=R7,DSTADD=4								;



	MOV.L	#_SET1_MTSTEP_MAXM,R7	;
	MOV.W	@R7,R7			;;2015-09-30#_EQ_STEP_MX2;

;;;;;;	MOV.L	#_CHK_OBJECT_TIM_TOP,R8		;L
	MOV.L	#_WK_OBJECT_TIM_TOP,R8		;2015-10-25

	MOV.L	#_SET1_OBJECT_TIM_TOP,R9	;
	MOV.B	#1,R3				;
	MOV.L	#_SET1_MOTREP_USEFUL,R1	;//ROMﾊﾟﾗ及びSWの入/切(ROMPARAM,繰返回数,入/切)
	MOV.W	@R1,R0				;
	MOV.L	#_SET1_MOTREP_STGE,R1		;//繰り返し終了行程[この工程は停止工程とする]
	MOV.W	@R1,R4				;

SVTIMMOVLOP1:					;
	TST	R7,R7				;
	TST_BIT_OF SVTIMMOVLOPEX		;
	MOV.L	@R8+,R2				;
	TST	R2,R2
	TST_BIT_ON SVTIMMOVLOP2			;ﾀｲﾏ0以外 JUMP
;ﾀｲﾏ=0
	TST	R0,R0				;
	TST_BIT_OF SVTIMMOVLOP2			;R指定なし

	CMP/EQ	R4,R3				;R指定の最後=工程
	BF	SVTIMMOVLOP2			;
	MOV.B	#1,R2				;ﾀｲﾏ=0 --> ﾀｲﾏ=1msec

SVTIMMOVLOP2:					;
	MOV.L	R2,@R9			;
	ADD	#4,R9			;
	ADD	#-1,R7			;
	ADD	#1,R3			;
	M_BRA	SVTIMMOVLOP1
SVTIMMOVLOPEX


;	===	速度演算  ===
	DATA_STEPLOP_CHG_MOV	SRC=_SVPX1_OBJECT_SPD_TOP	,L1=W,DST=_SET1_OBJECT_SPD_TOP	,L2=L,CALLSB=_CYCLE_SPD2	;
+				,CNT_REG=R7,DSTADD=4								;

;	===== 角度/ﾘﾆｱﾊﾟﾙｽ変換 ===
	DATA_STD_CHG_MOV	SRC=_SET1_UPAREA_DIG0	,L1=W,DST=_SET1_UPAREA_PLS0	,L2=L	;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS				;4;PG待機点ﾊﾟﾙｽ

	DATA_STD_CHG_MOV	SRC=_SET1_UPAREA_DIG1	,L1=W,DST=_SET1_UPAREA_PLS1	,L2=L	;上死点
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS				;4;PG待機点ﾊﾟﾙｽ

	DATA_STEPLOP_CHG_MOV	SRC=_SET1_OBJECT_DIG_TOP,L1=W,DST=_SET1_OBJECT_PLS_TOP	,L2=L	;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS				;
+				,CNT_REG=R7,DSTADD=4						;


;	================[2009-10-07下振子]復路====================================
	DATA_STEPLOP_CHG_MOV	SRC=_SVPX1_OBJECT_DIG_TOP	,L1=W,DST=_DNM_SET1_OBJECT_DIG_TOP	,L2=W,CALLSB=_SV_DN_CLANK_LINK_CHG
+				,CNT_REG=R7,DSTADD=2	;

	DATA_STD_CHG_MOV	SRC=_DNM_SET1_UPAREA_DIG0	,L1=W,DST=_DNM_SET1_UPAREA_PLS0	,L2=L	;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS					;4;PG待機点ﾊﾟﾙｽ

	DATA_STEPLOP_CHG_MOV	SRC=_DNM_SET1_OBJECT_DIG_TOP,L1=W,DST=_DNM_SET1_OBJECT_PLS_TOP	,L2=L	;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS				;
+				,CNT_REG=R7,DSTADD=4					;			;


	SUB_END
	M_RTS



;	*******************************************
;	***	2016-04-18			***
;	*******************************************
;	荷重/位置(置き換えできていない)  前／後加速ＳＷ
_DTMK_SW_INFO_MOV
	SUB_START

	MEM_WORD_BLOCK_MOV1	SRC_ADR=_SVPX1_MOT_INF,DST_ADR=_SET1_MOT_INF,CNT_DAT=100,DT_REG=R2,CNT_REG=R3

	SUB_END
	M_RTS


;	***************************************************
;	***						***
;	***						***
;	***	非常停止ﾚﾍﾞﾙ時のみﾃﾞｰﾀの取り込みを行う	***
;	***	2014-09-20				***
;	***						***
;	***************************************************
;	少しつつ整理を始めよう！！2014-09-20
_SV_DAT_SETGAMEN_LOAD:
	SUB_START

	FAR_JSR	#_SV_DAT_GAMEN_EXTRA1,R0		;機能拡張画面1 繰返,一定速度

	SUB_END
	M_RTS



;	***************************************************
;	***						***
;	***	非常停止ﾚﾍﾞﾙ時のみﾃﾞｰﾀの取り込みを行う	***
;	***	機能拡張画面				***
;	***	2014-09-20				***
;	***						***
;	***************************************************
_SV_DAT_GAMEN_EXTRA1
	SUB_START

;	----------------------REPEAT処理有効・無効---------------
	MOV.L	#(_PAR_REPCNT-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;=GMN_PAR077
	MOV.W	@R1,R0						;
	TST	R0,R0						;
	TST_BIT_OF SV_DAT_GEXTRA1_110				;回数指定無し=やらない

;切-SW
	MOV.L	#_SEQAB_DP_TOP+32*2,R1				;
	MOV.W	@R1,R0						;
	MOV.W	#BIT13,R4					;
	TST	R4,R0						;
	TST_BIT_OF SV_DAT_GEXTRA1_110				;

	MOV.L	#_SVP_MOTREP_CNT,R1				;繰り返し回数
	MOV.W	@R1,R0						;
	MOV.B	#1,R4						;
	CMP/HS	R0,R4						;0,1では繰り返しはしない
	BT	SV_DAT_GEXTRA1_110				;R0(0,1)=<R4(1)

	ADD	#-1,R0						;
	MOV.L	#_SET1_MOTREP_CNT,R1				;
	MOV.W	R0,@R1						;1~

	MOV.L	#_SVP_MOTREP_STGE,R1
	MOV.W	@R1,R3						;
	MOV.L	#_SVP_MOTREP_STGS,R1				;
	MOV.W	@R1,R2
	MOV.L	#_SET1_MTSTEP_MAXM,R1				;
	MOV.W	@R1,R4						;存在する工程であること[戻れなくなる]

;	-------- 1=< R2=< R3 =< MAX ------------
	MOV.B	#1,R1						;
	CMP/HS	R1,R2						;
	BF	SV_DAT_GEXTRA1_100				;
	CMP/HS	R2,R3						;
	BF	SV_DAT_GEXTRA1_100				;
	CMP/HS	R3,R4						;
	BF	SV_DAT_GEXTRA1_100				;
	M_BRA	SV_DAT_GEXTRA1_200

;	----------------- 無効時-----------------------
SV_DAT_GEXTRA1_100
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=_SQ_CBWK_TOP+_WKSQCB227,LG=W,BIT=(BIT14),WKRG1=R1,WKRG2=R4	;
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)
	M_BRA	SV_DAT_GEXTRA1_120								;

SV_DAT_GEXTRA1_110
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB227),LG=W,BIT=(~BIT14),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)
SV_DAT_GEXTRA1_120


	XOR	R2,R2					;
	MOV.L	#_SET1_MOTREP_USEFUL,R1			;//ROMﾊﾟﾗ及びSWの入/切(ROMPARAM,繰返回数,入/切)
	MOV.W	R2,@R1					;無効SET
	M_BRA	SV_DAT_GEXTRA1_300

;	---------------- 有効時のみデータ転送有り-------------------
;	非常停止中なので書き込みをあまり気にしなくて良い
SV_DAT_GEXTRA1_200

	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB227),LG=W,BIT=(~BIT14),WKRG1=R1,WKRG2=R4	;繰り返しする
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)

	DATA_STD_SHN_MOV SRC=_SVP_MOTREP_STGS	,L1=W,DST=_SET1_MOTREP_STGS	,L2=W	;繰り返し開始行程
	DATA_STD_SHN_MOV SRC=_SVP_MOTREP_STGE	,L1=W,DST=_SET1_MOTREP_STGE	,L2=W	;繰り返し終了行程
	DATA_STD_CHG_MOV SRC=_SVP_MOTREP_SPD	,L1=W,DST=_SET1_MOTREP_SPD,L2=L,CALLSB=_CYCLE_SPD2	;繰り返し戻り速度 pls/s

	DATA_STD_SHN_MOV SRC=_SVP_ROTCAM_ONR	,L1=W,DST=_SET1_ROTCAM_ONR	,L2=W	;//ﾛｰﾀﾘｶﾑ ON行程 ﾘﾋﾟｰﾄ戻り
	DATA_STD_SHN_MOV SRC=_SVP_ROTCAM_OFR	,L1=W,DST=_SET1_ROTCAM_OFR	,L2=W	;//ﾛｰﾀﾘｶﾑ OFF行程 ﾘﾋﾟｰﾄ戻り
	DATA_STD_SHN_MOV SRC=_SVP_EJECAM_ONR	,L1=W,DST=_SET1_EJECAM_ONR	,L2=W	;//ｴｼﾞｪｸﾀ ON行程 ﾘﾋﾟｰﾄ戻り
	DATA_STD_SHN_MOV SRC=_SVP_EJECAM_OFR	,L1=W,DST=_SET1_EJECAM_OFR	,L2=W	;//ｴｼﾞｪｸﾀ OFF行程 ﾘﾋﾟｰﾄ戻り
	DATA_STD_SHN_MOV SRC=_SVP_MISCAM_ONR	,L1=W,DST=_SET1_MISCAM_ONR	,L2=W	;//ﾐｽﾌｨｰﾄﾞON行程 ﾘﾋﾟｰﾄ戻り
	DATA_STD_SHN_MOV SRC=_SVP_MISCAM_OFR	,L1=W,DST=_SET1_MISCAM_OFR	,L2=W	;//ﾐｽﾌｨｰﾄﾞOFF行程 ﾘﾋﾟｰﾄ戻り


	MOV.B	#BIT0,R2					;有効
	MOV.L	#_SET1_MOTREP_USEFUL,R1			;//ROMﾊﾟﾗ及びSWの入/切(ROMPARAM,繰返回数,入/切)
	MOV.W	R2,@R1						;
SV_DAT_GEXTRA1_300


	SUB_END
	M_RTS





















;	***************************************************
;	***						***
;	***	各世代のﾐｭｰﾃﾝｸﾞに関わる機能を集める	***
;	***	2013-08-20				***
;	***************************************************
_MYUTING_SELCT_ELSE:
	SUB_START

;	------- 2012-10-16------
	XOR	R2,R2
	XOR	R3,R3

	MOV.L	#(_PAR_MYUTING_SEL-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;
	MOV.W	@R1,R0							;
	CMP/EQ	#1,R0							;
	BF	SYS_LD_MUTSYS_100					;SWを参照しない=旧機能


	MOV.L	#(_PAR_MYUTING_MATH-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;332
	MOV.W	@R1,R0							;
	CMP/EQ	#1,R0							;
	BF	SYS_LD_MUTSYS_030					;
;-------SYS=1 SW有り
	MOV.W	#1,R2							;MATH=1:停止中はﾐｭｰﾃﾝｸﾞにするしないをSWで決定
	XOR	R3,R3							;DRVSEL=0:反転,ふりこを上昇無効にしない
	M_BRA	SYS_LD_MUTSYS_100					;


SYS_LD_MUTSYS_030:
	CMP/EQ	#2,R0							;
	BF	SYS_LD_MUTSYS_050					;
;-------SYS=2 SW有り
	MOV.W	#1,R2							;MATH=1:停止中はﾐｭｰﾃﾝｸﾞにするしないをSWで決定
	MOV.W	#1,R3							;DRVSEL=1:反転,ふりこを上昇無効にする
	M_BRA	SYS_LD_MUTSYS_100					;


SYS_LD_MUTSYS_050:
;-------SYS=0 SW有り
;;;;	XOR	R2,R2							;MATH=0:停止中はﾐｭｰﾃﾝｸﾞ固定:動作中はSWに従う
;;;;	XOR	R3,R3							;DRVSEL=0:反転,ふりこを上昇無効にしない

SYS_LD_MUTSYS_100:							;
	MOV.L	#_UPMSK2_MATH,R1					;//0:参照しない 1:参照する 2012-10-15
	MOV.W	R2,@R1							;//1:ﾐｭｰﾃﾝｸﾞしない時は全停止()

;	-------- 2013-02-23---
	MOV.L	#_UPMSK2_DRVSEL,R1					;//2013-02-23 
	MOV.W	R3,@R1							;0:反転,ふりこを上昇無効にしない
									;1:反転,ふりこを上昇無効にする




;	ｼｽﾃﾑﾊﾟﾗﾒｰﾀ66[]
	DATA_STD_SHN_MOV SRC=_PAR_SFYOPT_USEL	,L1=W,DST=_WPAR_SFYOPT_USEL,L2=W	;2;0[現行]:1[上昇無効にしない]

;	------------2012-09-25 ｼｰｹﾝｽへROMﾊﾟﾗ結果を教える(外部SWを使用する、しない)-----------
	XOR	R2,R2							;
	MOV.L	#(_PAR_MYUTING_SEL-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;279 SWを使用する,しない
	MOV.W	@R1,R0							;
	CMP/EQ	#1,R0							;
	BF	MASK2_ROMINFO_MAK100					;
	MOV.W	#BIT9,R2						;
MASK2_ROMINFO_MAK100							;


	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MOV.L	#_SQ_CBWK_TOP+_WKSQCB229,R1				;
	MOV.W	@R1,R0							;
	OR	R2,R0							;
	MOV.W	R0,@R1							;
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)


	SUB_END
	M_RTS

;;;;;2013-08-20 上記と差し替え
;;;;;	***************************************************
;;;;;	***						***
;;;;;	***	各世代のﾐｭｰﾃﾝｸﾞに関わる機能を集める	***
;;;;;	***	2013-02-15~				***
;;;;;	***************************************************
;;;;;_MYUTING_SELCT_ELSE:
;;;;;	SUB_START
;;;;;
;;;;;;	------- 2012-10-16------
;;;;;	XOR	R2,R2
;;;;;	XOR	R3,R3
;;;;;
;;;;;	MOV.L	#(_PAR_MYUTING_MATH-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;332
;;;;;	MOV.W	@R1,R0							;
;;;;;	CMP/EQ	#1,R0							;
;;;;;	BT	SYS_LD_MUTSYS_050					;
;;;;;
;;;;;	CMP/EQ	#2,R0							;
;;;;;	BF	SYS_LD_MUTSYS_100					;1or2ではない
;;;;;
;;;;;	MOV.W	#1,R2							;
;;;;;	MOV.W	#1,R3							;
;;;;;	M_BRA	SYS_LD_MUTSYS_100					;
;;;;;
;;;;;SYS_LD_MUTSYS_050:							;
;;;;;	MOV.W	#1,R2							;
;;;;;	XOR	R3,R3							;
;;;;;SYS_LD_MUTSYS_100:							;
;;;;;	MOV.L	#_UPMSK2_MATH,R1					;//0:参照しない 1:参照する 2012-10-15
;;;;;	MOV.W	R2,@R1							;//1:ﾐｭｰﾃﾝｸﾞしない時は全停止()
;;;;;									;//
;;;;;
;;;;;;	-------- 2013-02-23---
;;;;;	MOV.L	#_UPMSK2_DRVSEL,R1					;//2013-02-23 
;;;;;	MOV.W	R3,@R1							;0:反転,ふりこを上昇無効にしない
;;;;;									;1:反転,ふりこを上昇無効にする
;;;;;
;;;;;
;;;;;
;;;;;
;;;;;;	ｼｽﾃﾑﾊﾟﾗﾒｰﾀ66[]
;;;;;	DATA_STD_SHN_MOV SRC=_PAR_SFYOPT_USEL	,L1=W,DST=_WPAR_SFYOPT_USEL,L2=W	;2;0[現行]:1[上昇無効にしない]
;;;;;
;;;;;;	------------2012-09-25 ｼｰｹﾝｽへROMﾊﾟﾗ結果を教える(外部SWを使用する、しない)-----------
;;;;;	XOR	R2,R2							;
;;;;;	MOV.L	#(_PAR_MYUTING_SEL-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;279 SWを使用する,しない
;;;;;	MOV.W	@R1,R0							;
;;;;;	CMP/EQ	#1,R0							;
;;;;;	BF	MASK2_ROMINFO_MAK100					;
;;;;;	MOV.W	#BIT9,R2						;
;;;;;MASK2_ROMINFO_MAK100							;
;;;;;	MOV.L	#_SQ_CBWK_TOP+_WKSQCB229,R1				;
;;;;;	MOV.W	@R1,R0							;
;;;;;	OR	R2,R0							;
;;;;;	MOV.W	R0,@R1							;
;;;;;
;;;;;	SUB_END
;;;;;	M_RTS


;	*******************************************
;	***					***
;	***					***
;	***	16ｽｷｬﾝだかね			***
;	***					***
;	*******************************************
	.EXPORT	_MYUTING_FUNC_CHECK
_MYUTING_FUNC_CHECK
	SUB_START
;	---------------------------------------------------
;	---	ﾐｭｰﾃﾝｸﾞ機能の選択 安全装置有効時参照	---
;	---	2013-02-20				---
;	---------------------------------------------------
	XOR	R2,R2
	MOV.L	#_CB_SEQ_CB_COM349,R1			;
	MOV.W	@R1,R0					;
	MOV.W	#BIT9,R4				;
	TST	R4,R0					;
	TST_BIT_OF MYUTING_FUNC_CHK100

	MOV.W	#1,R2					;

MYUTING_FUNC_CHK100:					;
	MOV.L	#_MYUTING_MOD_STOPSEL,R1		;//1:いつでも遮光有効(ﾐｭｰﾃﾝｸﾞ無効)
	MOV.W	R2,@R1					;

	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	2012-10-05			***
;	***	ﾌﾙｸﾛｰｽﾞ手前距離を選択式にする	***
;	***					***
;	*******************************************
	.ALIGN	4				;
_FULCLS_TEMAEPOS_SEL
	SUB_START

	MOV.L	#_CB_SEQ_CB_COM350,R1					;手前選択
	MOV.W	@R1,R0							;
	MOV.W	#BIT9+BIT8+BIT7+BIT6+BIT5+BIT4+BIT3+BIT2+BIT1,R4	;
	TST	R4,R0							;
	TST_BIT_OF CLSINC_TEMAESEL_DEF					;

	MOV.B	#D'9-1,R3						;
	MOV.B	#BIT1,R4						;
	MOV.L	#(_PAR_BEFRE_PLSP1-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;

CLSINC_TEMAESEL_050LOP:
	TST	R4,R0				;
	TST_BIT_ON CLSINC_TEMAESEL_100		;
	SHLL	R4
	ADD	#2,R1				;
	ADD	#-1,R3				;
	TST	R3,R3				;
	TST_BIT_ON CLSINC_TEMAESEL_050LOP	;BIT1~BIT8
CLSINC_TEMAESEL_100:
	MOV.W	@R1,R2				;
	M_BRA	NEG_CTRL_ADD_SV10		;


CLSINC_TEMAESEL_DEF:
	MOV.L	#_SVP_OUTPLS_HOSA,R1		;NO.44 出力パルス補正0or1->2011-02-19[反転制御]反転制御手前距離(ﾊﾟﾙｽ)
	MOV.W	@R1,R2				;

	MOV.W	#1,R4				;
	CMP/EQ	R4,R2				;1なら0
	BF	NEG_CTRL_ADD_SV10		;
	XOR	R2,R2				;
NEG_CTRL_ADD_SV10:
	MOV.L	#_NEG_CTRL_BEFOR_OBJ_PLS,R1	;//目標−手前
	MOV.L	R2,@R1				;
	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	設定				***
;	***	トヨタ仕様			***
;	***	2009-03-11			***
;	*******************************************
;原点ﾌﾟﾘｾｯﾄのため
;
	.ALIGN	4				;
_TOYOTA_ADD_SV:
	SUB_START

	MOV.L	#_SVP_UPAREA_DIG1,R1	;
	MOV.W	@R1,R2			;
	FAR_JSR	#_WD_DIV10,R0		;
	MOV.W	#D'10,R4		;
	FAR_JSR	#_MUL10,R0		;0.1度==>0にする
	MOV.L	#_SET360_UPAREA_DIG1,R1	;1度単位　23.4-->23.0
	MOV.W	R2,@R1			;

	DATA_STD_CHG_MOV	SRC=_SET360_UPAREA_DIG1,L1=W,DST=_SET360_UPAREA_PLS1,L2=L;上死点
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS			;4;PG待機点ﾊﾟﾙｽ


	SUB_END
	M_RTS


;	苦肉
	.ALIGN	4				;
_DNM_SPEC_CPUB_LATE:
	SUB_START

	PUSH_REG1 R2
	MEM1_BIT0_TO_BIT7_ORSET MEM=_DNM_DEBUG_STS1,LG=W,BIT=BIT7,WKREG=R1 ;2012-12-10 DEBUG
	POP_REG1 R2

;;;;	MOV.L	#_SVP_ACCLAT_TIMP,R1
	MOV.L	#_TBL_ANS_ACCTIM,R1		;
	MOV.W	@R1,R2				;


DNM_SPEC_CPUBLAT200:

	MOV.W	#8000,R1					;8000
	MOV.W	#10000,R4					;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;
	MOV.W	#D'10,R4					;検定10
;;;;	MOV.W	#D'20,R4					;最終20
	CMP/HI	R4,R2						;
	BF	DNM_SPEC_CPUBLAT250				;
	SUB	R4,R2						;
DNM_SPEC_CPUBLAT250:

	MOV.L	#_SET1_ACCLAT_TIM1,R1				;
	MOV.W	R2,@R1						;

	SUB_END
	M_RTS

;	***************************
;	***	2012-12-10	***
;	***************************
_DNM_STD_ACCTYPE
	SUB_START
	MOV.L	#_SETX_POS_CTL_MATH,R1			;
	MOV.W	@R1,R0					;
	TST	#_DMATH_DNDRIV,R0			;ふりこ
	TST_BIT_OF DTMK_ACC_LATE_055			;NO

	MEM1_BIT0_F_ORSET MEM=_DNM_DEBUG_STS1,LG=W,BIT=(BIT11),WKRG1=R1,WKRG2=R4		;DEBUG 2012-12-10

	MOV.L	#_SVP_ACCLAT_TIM1,R1
	MOV.W	@R1,R2
	MOV.W	#9500,R1					;20msec*0.05=10msec
;;;;	MOV.W	#9000,R1					;20msec
	MOV.W	#10000,R4					;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;R2*1REV*HOSN/HOSM
	MOV.L	#_SET1_ACCLAT_TIM1,R1				;
	MOV.W	R2,@R1						;
	M_BRA	DTMK_ACC_LATE_058


DTMK_ACC_LATE_055
	DATA_STD_SHN_MOV	SRC=_SVP_ACCLAT_TIM1	,L1=W,DST=_SET1_ACCLAT_TIM1	,L2=W	;


DTMK_ACC_LATE_058

	SUB_END
	M_RTS


;;	*******************************************
;;	***					***
;;	***	ふりこモードか？		***
;;	***	2010-10-05			***
;;	*******************************************
;;	R0=0
;;	R0=0以外
;;
;;	.ALIGN	4				;
;;_CHK_DNM_SPEC_MOD1:
;;	SUB_START
;;	MOV.L	#_WPAR_ACC_MATHED,R1				;
;;	MOV.W	@R1,R0						;
;;	CMP/EQ	#1,R0						;
;;	BF	CHK_DNM_SPCMOD_100
;;
;;	MOV.L	#_SETX_POS_CTL_MATH,R1				;
;;	MOV.W	@R1,R0						;
;;	TST	#_DMATH_DNDRIV,R0				;
;;	TST_BIT_OF CHK_DNM_SPCMOD_100				;
;;
;;	MOV.L	#_INP_MODE,R1					;
;;	MOV.W	@R1,R0						;
;;	TST	#(_W1OPT+_W1CNT+_W1SGL),R0			;SGLで制動試験ﾓｰﾄﾞもやるから.
;;	TST_BIT_OF CHK_DNM_SPCMOD_100				;
;;
;;
;;	-------2011-12-02------------
;;	MOV.L	#_BRKTST_INPUT_CMD,R1				;
;;	MOV.W	@R1,R0						;
;;	TST	#BIT0,R0					;
;;	TST_BIT_ON CHK_DNM_SPCMOD_100				;安全一行程だがテストモードだ
;;;	------------------------------
;;
;;	MOV.L	#_cbsys_tbl_err,R1				;//PARAM-TABLE-ERR
;;	MOV.W	@R1,R0						;
;;	TST	R0,R0
;;	TST_BIT_ON CHK_DNM_SPCMOD_090				;
;;
;;	MOV.W	#1,R0
;;	M_BRA	CHK_DNM_SPCMOD_END				;
;;
;;CHK_DNM_SPCMOD_090:
;;	MEM1_BIT0_F_ORSET MEM=(_SQ_CBWK_TOP+_WKSQCB224),LG=W,BIT=(BIT8),WKRG1=R1,WKRG2=R4
;;
;;
;;CHK_DNM_SPCMOD_100
;;	XOR	R0,R0
;;
;;CHK_DNM_SPCMOD_END
;;	SUB_END
;;	M_RTS

;	***********************************
;	***				***
;	***	ﾘﾝｸ360上の相対距離[PLS]	***
;	***	R2 - R1 =R2		***
;	***	2011-09-14		***
;	***				***
;	***********************************
;
	.ALIGN	4				;
_LINK_LENGTH_CALC_FWD
	SUB_START
	SUB	R1,R2				;
	CMP/PZ	R2				;
	BT	LINK_LENGTH_CALFWD100		;

	MOV.L	#_LINK_1ROT_PLS,R0		;//1回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	@R0,R3				;
	ADD	R3,R2				;
	CMP/PZ	R2
	BT	LINK_LENGTH_CALFWD100		;

	MOV.W	#1,R2				;

LINK_LENGTH_CALFWD100
	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***		異常データ作成		***
;	***		2012-03-06		***
;	*******************************************
;
	.ALIGN	4				;
;	-------2012-03-06--
_SV_ERR_CMPDT_MAKE:
	SUB_START

	MOV.L	#_SETX_DNAREA_JG_PLS,R1			;反転設定不可範囲LINK-PLS
	MOV.L	@R1,R2					;
	MOV.L	#_SET1_FULCLS_MXPLS,R1			;
	MOV.W	@R1,R0					;
	ADD	R0,R2					;170.0相当ﾊﾟﾙｽ+30000pls

	MOV.L	#_LINK_1ROT_PLS,R1			;
	MOV.L	@R1,R4					;
	CMP/HS	R2,R4					;R2=<R4
	BT	SV_ERR_CMPDTMAK100			;
	SUB	R4,R2					;
SV_ERR_CMPDTMAK100:
	FAR_JSR	#_LINK_PLS_CHG_LINK_DIG,R0		;
	ADD	#1,R2					;+0.1度
	MOV.L	#_REVMOD_REVDN_DIG,R1			;//反転設定＋不可範囲[LINK]
	MOV.W	R2,@R1					;


	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***		1回転LINKﾊﾟﾙｽ->0.1度	***
;	***		2012-03-06		***
;	***		なぜいままでなかった	***
;	*******************************************
	.ALIGN	4				;
	.EXPORT	_LINK_PLS_CHG_LINK_DIG		
_LINK_PLS_CHG_LINK_DIG:
	SUB_START					;
	MOV.L	#_SETY_INCPLS_HOSM01X,R0		;//0.1度  _SET1_INCPLS_HOSM*10=0.1度
	MOV.L	@R0,R1					;
	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0		;=SET1_INCPLS_1REV*_SET1_INCPLS_HOSN
	MOV.L	@R0,R4					;R2:X回転
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0		;R2*1REV*HOSN/HOSM
	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	system-param-table check	***
;	***					***
;	*******************************************
;	S2b	cbsys_tbl_err		;//cbsysの加速度ﾃｰﾌﾞﾙ異常
;	BIT0:異常
;
	.MACRO	DT_UPDN_CHK DN_DAT,UP_DAT,WKREG,JMPADR
	MOV.W	#\DN_DAT,\WKREG
	CMP/HS	\WKREG,R0		;
	BF	\JMPADR			;ERR
	MOV.W	#\UP_DAT,\WKREG		;
	CMP/HS	R0,\WKREG		;
	BF	\JMPADR			;ERR

	.ENDM

	.ALIGN	4				;
_CBSYS_DNM_TBLCHK
	SUB_START
	MOV.L	#_CB_SYS_PARTBL001,R1	;CODE:ｺｰﾄﾞ存在なければﾃﾞｰﾀなし
	MOV.W	@R1,R0			;
	MOV.W	#H'1234,R4		;
	CMP/EQ	R4,R0			;
	BF	CBSYS_DNMTBLCK_900	;

	MOV.L	#_CB_SYS_PARTBL002,R1					;1:加速度ﾃｰﾌﾞﾙ使用NO.[1個より増えた場合用]
	MOV.W	@R1,R0							;1~3
	DT_UPDN_CHK DN_DAT=1,UP_DAT=3,WKREG=R4,JMPADR=CBSYS_DNMTBLCK_910

	MOV.L	#_CB_SYS_PARTBL003,R1	;1:最大回転速度/加減速時間ﾃｰﾌﾞﾙ使用[1個より増えた場合用]
	MOV.W	@R1,R0			;
	CMP/EQ	#1,R0			;
	BF	CBSYS_DNMTBLCK_910	;

	MOV.L	#_CB_SYS_DNMTBL1_CNT,R1	;
	MOV.W	@R1,R0			;
	DT_UPDN_CHK DN_DAT=10,UP_DAT=100,WKREG=R4,JMPADR=CBSYS_DNMTBLCK_920	;

	MOV.L	#_CB_SYS_ACCTBL1_CNT,R1
	MOV.W	@R1,R0			;
	DT_UPDN_CHK DN_DAT=50,UP_DAT=500,WKREG=R4,JMPADR=CBSYS_DNMTBLCK_930

	MOV.L	#_CB_SYS_ACCTBL2_CNT,R1
	MOV.W	@R1,R0			;
	DT_UPDN_CHK DN_DAT=50,UP_DAT=500,WKREG=R4,JMPADR=CBSYS_DNMTBLCK_930

	MOV.L	#_CB_SYS_ACCTBL3_CNT,R1
	MOV.W	@R1,R0			;
	DT_UPDN_CHK DN_DAT=50,UP_DAT=500,WKREG=R4,JMPADR=CBSYS_DNMTBLCK_930

	XOR	R0,R0
	M_BRA	CBSYS_DNMTBLCK_END

;	-------- CODE ERR[書き込まれた形跡がない] --------
CBSYS_DNMTBLCK_900
	MOV.W	#BIT1+BIT0,R0
	M_BRA	CBSYS_DNMTBLCK_END	;

CBSYS_DNMTBLCK_910
	MOV.W	#BIT2+BIT0,R0
	M_BRA	CBSYS_DNMTBLCK_END	;

CBSYS_DNMTBLCK_920
	MOV.W	#BIT3+BIT0,R0
	M_BRA	CBSYS_DNMTBLCK_END	;

CBSYS_DNMTBLCK_930
	MOV.W	#BIT4+BIT0,R0
	M_BRA	CBSYS_DNMTBLCK_END	;

CBSYS_DNMTBLCK_END
	MOV.L	#_cbsys_tbl_err,R1		;//cbsysの加速度ﾃｰﾌﾞﾙ異常
	MOV.W	R0,@R1				;

	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***	加速時間及び最大速度演算	***
;	***					***
;	*******************************************
;	最低２回は回る必要あり。計算後他の設定に反映が必要
;	待機点[]→[]→ｽﾄﾛｰｸ算出→
;	ｽﾄﾛｰｸからﾃｰﾌﾞﾙの中のﾃﾞｰﾀ読み取り→直線補間[]
;	_SVP_UPAREA_DIG0,L1=W,DST=_SET1_UPAREA_DIG0,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;PG待機点角度
;画面設定値に対して以下の演算
;@クランク→リンク	
;	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0			;(DIG-->DIG変換)(ﾚｼﾞｽﾀのみ) 1度
;
;	MOV	#100,R4						;
;	DMULS.L	R4,R2						;
;	STS.L	MACL,R2						;
;Aリンク−リニア
;	FAR_JSR	#_DIG36000_CHG_RENEA1,R0			;360.000度-->0.001mm
;
;結果は以下と同じはず
;　_SVP_UPAREA_POS0		.SRES	4	;待機点位置
;
;_TBL_ANS_ACCTIM		.SRES	2	;
;_TBL_ANS_MAXSPM		.SRES	2	;
;	R3:Yn_1		R5:Xn_1
;	R2:Yn		R4:Xn
;	ANS:R2=y	R1:x
;	limit R6(Yn)

_DNM_MAXSPM_ACCLAT_MAK:
	SUB_START

	MOV.L	#_SET1_UPAREA_DIG0,R1				;
	MOV.W	@R1,R2						;0.1度
	MOV.W	#D'100,R4					;
	DMULS.L	R4,R2						;
	STS.L	MACL,R2						;0.001度
	FAR_JSR	#_DIG36000_CHG_RENEA1,R0			;360.000度-->0.001mm
	MOV.L	#_TBL_USE_POS0,R1				;待機点の距離
	MOV.L	R2,@R1						;0.001mm

	MOV.W	#D'1000,R4					;
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0	;1mm単位 1.***mm

;	--------ﾃｰﾌﾞﾙｻｰﾁ-----------
	MOV	R2,R1						;R1[X]
	MOV.L	#_CB_SYS_DNMTBL1_CNT,R0				;
	MOV.W	@R0,R8						;20~100 *2*3個=6byte LOOP=R8

	MOV.L	#_CB_SYS_DNMTBL1_DATA_TOP,R7			;
	MOV.W	@R7+,R4						;[Xn]mm
	MOV.W	@R7+,R2						;[Yn]回転数
	MOV.W	@R7+,R9						;[Zn]時間

	CMP/HI	R1,R4						;R1 < R4
	BF	DNM_MAXSPM_ACCLT_MK100				;NO
								;YES R1 < R4
								;ANS R2,R9
	M_BRA	DNM_MAXSPM_ACCLT_MK500				;
				

DNM_MAXSPM_ACCLT_MK100:
	ADD	#-1,R8						;1個は既に読み取った

DNM_MAXSPM_ACCLT_MK100LOP:
	TST	R8,R8						;
	TST_BIT_OF DNM_MAXSPM_ACCLT_MK500			;data　ｵｰﾊﾞ

	MOV	R4,R5						;R5:[Xn_1]
	MOV	R2,R3						;R3:[Yn_1]
	MOV	R9,R10						;R10:[Zn_1]

	MOV.W	@R7+,R4						;[Xn]mm
	MOV.W	@R7+,R2						;[Yn]回転数
	MOV.W	@R7+,R9						;[Zn]時間

	CMP/HI	R1,R4						;
	BT	DNM_MAXSPM_ACCLT_MK200				;R1 < R4 YES JUMP
	ADD	#-1,R8						;
	M_BRA	DNM_MAXSPM_ACCLT_MK100LOP			;


;	----------[[[[[]]]] ----------
;	----------[[[[[]]]]
DNM_MAXSPM_ACCLT_MK200:
	PUSH_REG1 R1
	PUSH_REG1 R4				;R4:Xn
	PUSH_REG1 R5				;R5:Xn_1

	FAR_JSR	#_FPU_POS_HOKAN1,R0		;R1:X
						;ANS R2
	POP_REG1 R5				;
	POP_REG1 R4				;
	POP_REG1 R1				;

;	RPM:R2 1rpm data()
	PUSH_REG1 R2	
	MOV	R10,R3				;Yn_1:R3
	MOV	R9,R2				;Yn:R2	
	FAR_JSR	#_FPU_POS_HOKAN1,R0		;X
	MOV	R2,R9				;1msec data
	POP_REG1 R2				;

DNM_MAXSPM_ACCLT_MK500:
	MOV.W	#D'10,R1					;
	DMULS.L	R1,R2						;
	STS	MACL,R2						;

;	--- DATA CHECK[ｼｽﾃﾑのmax-spm以下であること]----
	MOV.L	#_TBL_ANS_MAXSPM,R1				;
	MOV.W	R2,@R1						;
	MOV.L	#_SVX_DNM_MAXSPM,R1				;
	MOV.W	R2,@R1						;

;	--- 1000以下であること
	MOV.L	#_TBL_ANS_ACCTIM,R1				;
	MOV.W	R9,@R1



;	----------------- 当面 ------------------------
;;;;2011-05-30	MOV.L	#_SET1_PLSALO_PLS,R1				;//パルサ倍率低
;;;;2011-05-30	MOV.W	@R1,R0						;

;;;;;2013-02-05[]	XOR	R0,R0						;TBL=1　ONLY　[R0=0or1]
;;;;;2013-02-05[]	MOV.L	#_TBL_ANS_ACC_SEL,R1				;(0,1),2[TBL2],3[TBL3]
;;;;;2013-02-05[]	MOV.W	R0,@R1						;

	FAR_JSR	#_ACC_TBLX_RECALC,R0


	SUB_END
	M_RTS
	







;	*******************************************
;	***					***
;	***	運転画面設定多段ﾃﾞｰﾀ		***
;	***	演算				***
;	*******************************************
;	"PGﾘﾝｸﾊﾟﾙｽ変換位置"
;	ﾊﾟﾙｽ変換+ｽﾃｯﾌﾟﾃﾞｰﾀ作成
;
;	増加方向の運転ﾃﾞｰﾀ作成（回転、反転、往復の片道）
;
;	ﾓｰｼｮﾝ運転時のみ
;	(一部待機点選択にも使用)
;
;	運転側では開始時にラッチですので、演算タイミングを気にしなくて良いが
;	基本的には非運転中に演算を行う。
;
;
_STEP_DAT_CHANGE1:
	SUB_START
	MOV.L	#_SET1_MTSTEP_MAXM,R1				;
	MOV.W	@R1,R2						;
	MOV.L	#_SETX_POS_STEP_MAX,R1				;//設定=1~10(2~11)
	MOV.W	R2,@R1						;

;;;;;;;;2015-10-22
;;;;;;;;;;;;	MOV.W	#1,R3						;min
;;;;;;;;;;;;
;;;;;;;;;;;;;	== 2004-01-26 ==
;;;;;;;;;;;;	MOV.L	#_WFSYS_MAX_STEP_SEL,R1		;
;;;;;;;;;;;;	MOV.W	@R1,R0				;
;;;;;;;;;;;;	CMP/EQ	#1,R0				;10段仕様?
;;;;;;;;;;;;	BT	STEP_DATCHG1_0020		;YES
;;;;;;;;;;;;	MOV.W	#_EQ_STEP_MAX,R1		;max5
;;;;;;;;;;;;	M_BRA	STEP_DATCHG1_0040		;
;;;;;;;;;;;;STEP_DATCHG1_0020				;
;;;;;;;;;;;;	MOV.W	#_EQ_STEP_MX2,R1		;max10
;;;;;;;;;;;;STEP_DATCHG1_0040				;
;;;;;;;;;;;;
;;;;;;;;;;;;	MOV.W	#_EQ_STEP_MX3,R1
;;;;;;;;;;;;	REG_PMAX_MMIN_LMT DATA_REG=R2,MAX_REG=R1,MIN_REG=R3
;;;;;;;;;;;;
;;;;;;;;;;;;	MOV.L	#_SETX_POS_STEP_MAX,R1				;//設定=1~10(2~11)
;;;;;;;;;;;;	MOV.W	R2,@R1						;


;	======== 方式選択　変な場合は反転とする========
	MOV.L	#_SET1_MRTION_SEL1,R1				;
	MOV.W	@R1,R0						;
	MOV.L	#_SETX_POS_CTL_MATH,R1				;
	MOV.W	R0,@R1						;

;	====== 使用待機点選択=====
	MOV.L	#_SET1_UPAREA_PLS1,R3			;//4;待機点位置(ｲﾝｸﾘﾒﾝﾀﾙ):上死点
	MOV.L	#_SET1_UPAREA_DIG1,R4			;2;回転時待機点(上死点)	
	MOV.L	#_SET1_UPAREA_POS1,R5			;(内部で作成)

	MOV.L	#_SVPX_UPAREA_DIG1,R6			;ｸﾗﾝｸ上死点設定
	MOV.W	@R6,R6					;

;;;2019-06-25
;;;2019-06-25	MOV.L	#_INP_MODE,R1					;
;;;2019-06-25	MOV.W	@R1,R0						;
;;;2019-06-25	TST	#(_W1DUP+_W1OPT+_W1CNT+_W1SGL+_W1INC+_W1DIC),R0	;
;;;2019-06-25	TST_BIT_OF STEP_DATCHG1_0150				;
;;;2019-06-25

;	===== 2004-05-24=======================
	MOV.L	#_PAR_WTSEL_USE,R0			
	MOV.W	@R0,R0					;
	CMP/EQ	#1,R0					;待機点選択使用時は上死点ではない
	BT	STEP_DATCHG1_0120			;
;	=======================================


	MOV.L	#_SETX_POS_CTL_MATH,R1			;
	MOV.W	@R1,R0					;
	TST	#_DMATH_CNTROT+_DMATH_UPDRIV,R0		;回転時は上死点
	TST_BIT_ON STEP_DATCHG1_0150			;

STEP_DATCHG1_0120:
;	(反転,ふりこ,回転でも待機点はフリー)
	MOV.L	#_SET1_UPAREA_PLS0,R3			;//4;待機点PLS(ｲﾝｸﾘﾒﾝﾀﾙ)
	MOV.L	#_SET1_UPAREA_DIG0,R4			;2;PG待機点角度(0.1)
	MOV.L	#_SET1_UPAREA_POS0,R5			;


	MOV.L	#_SVP_UPAREA_DIG0,R6			;待機点角度(ｸﾗﾝｸ角度0.1)
	MOV.W	@R6,R6

	
STEP_DATCHG1_0150:
	MOV.L	@R3,R0					;
	MOV.L	#_SETX_UPAREA_PLS,R1			;//4;待機点PLS(ｲﾝｸﾘﾒﾝﾀﾙ):上死点
	MOV.L	R0,@R1					;

	MOV.W	@R4,R0
	MOV.L	#_SETX_UPAREA_DIG,R1			;2;回転/反転時待機点
	MOV.W	R0,@R1					;

	MOV.L	@R5,R0
	MOV.L	#_SETX_UPAREA_RNA,R1			;(内部で作成)
	MOV.L	R0,@R1

;	================================================

	MOV.L	#_WSVX_CLNK_UP_POS,R1			;
	MOV.W	R6,@R1					;ｸﾗﾝｸ角度

;	==================================================


;	-------- [20091007下振子]2007-04-03--------
	MOV.L	#_SETX_POS_CTL_MATH,R1		;
	MOV.W	@R1,R0				;
	TST	#_DMATH_DNDRIV,R0		;ふりこ
	TST_BIT_OF STEP_DATCHG1_0200		;

	FAR_JSR	#_DNM_UP_AREA_DT_MAK,R0
	FAR_JSR	#_DN_STEP_POS_SPD_TIM_STEPMOV,R0	;POS,TIM,SPD SET

	M_BRA	STEP_DATCHG1_0200
STEP_DATCHG1_0200:


;	======= その他 ======
	FAR_JSR	#_STEP_KJYUOBJ_MOV,R0		;2014-03-20
	FAR_JSR	#_POS_MOD_FLGMAK,R0		;[ﾓｰﾄﾞが段取,原点復帰でも安一でのﾃﾞｰﾀ作成する]
	FAR_JSR	#_STEP_POS_SPD_TIM_STEPMOV,R0	;POS,TIM,SPD SET[どのﾓｰﾄﾞでもそれなりに作成する]
	FAR_JSR	#_STEP_INF1_STEPMOV,R0		;方向,速度連続[どのﾓｰﾄﾞでもそれなりに作成する]
	FAR_JSR	#_STEP_INF2_STEPMOV,R0		;連続時の段数[どのﾓｰﾄﾞでもそれなりに作成する]
	FAR_JSR	#_STEP_BANK_USE_CHK,R0		;2004-12-20


	FAR_JSR	#_MAK_UP_AREA_DT,R0

;	--------[20091007下振子] 2007-04-03--------
	MOV.L	#_SETX_POS_CTL_MATH,R1		;
	MOV.W	@R1,R0				;
	TST	#_DMATH_DNDRIV,R0		;ふりこ
	TST_BIT_OF STEP_DATCHG1_0250		;

	FAR_JSR	#_DNM_MAK_UP_AREA_DT,R0

	M_BRA	STEP_DATCHG1_0250
STEP_DATCHG1_0250:


	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***	特殊運転状況作成	***
;	***				***
;	***********************************
;	Input _SETX_POS_CTL_MATH,_MODE_SEL
;	Outpt _SETX_POS_MOD_FLG1 BIT2,BIT1,BIT0
;	BIT0:1:回転連続
;	BIT1:1:回転寸動
;	BIT2:1:回転で待機点停止しない運転(BIT0もたつしBIT2もたつ)
;	BIT3:1:2004-12-15 1:ﾀｲﾏが全くない(BIT0+BIT2+BIT3)
_POS_MOD_FLGMAK:
	SUB_START
	MOV.L	#_SETX_POS_CTL_MATH,R1				;
	MOV.W	@R1,R0						;

;	=====	回転の連続  =BIT0
;	=====	回転の寸動時=BIT1
	CMP/EQ	#_DMATH_CNTROT,R0		;
	BF	POS_MOD_FLGMK080		;
	MOV.L	#_MODE_SEL,R1			;
	MOV.W	@R1,R0				;
	TST	#_W1CNT,R0			;連続
	TST_BITON_DLY POS_MOD_FLGMK100		;
	MOV.B	#BIT0,R2			;連続ｾｯﾄ

	TST	#_W1INC,R0			;寸動?
	TST_BITON_DLY POS_MOD_FLGMK100		;
	MOV.B	#BIT1,R2			;寸動ｾｯﾄ

POS_MOD_FLGMK080:
	XOR	R2,R2
POS_MOD_FLGMK100:
	MOV.L	#_SETX_POS_MOD_FLG1,R1		;//回転時の停止しない連続
	MOV.W	@R1,R0				;
	AND	#LOW ~(BIT3+BIT2+BIT1+BIT0),R0	;BIT0~BIT7data
	OR	R2,R0				;
	TST	#(BIT1+BIT0),R0			;
	TST_BIT_OF POS_MOD_FLGMK200		;
	MOV.L	#_SET1_UPAREA_TIM0,R3		;//4;待機時間
	MOV.L	@R3,R2				;
	TST	R2,R2				;
	TST_BIT_ON POS_MOD_FLGMK200		;
	OR	#BIT2,R0			;
POS_MOD_FLGMK200:				;
;	================2004-12-15========================
	TST	#BIT2,R0			;
	TST_BIT_OF POS_MOD_FLGMK300		;上死点停止有り EXIT
	PUSH_REG1 R0
	FAR_JSR	#_STEP_TIM_0CHK,R0		;
	POP_REG1 R0
	OR	R2,R0				;
POS_MOD_FLGMK300:				;
;	========================================
	MOV.L	#_SETX_POS_MOD_FLG1,R1		;//回転時の停止しない連続
	MOV.W	R0,@R1				;

	SUB_END
	M_RTS



;	***************************************************
;	***						***
;	***	位置、速度、時間の転送			***
;	***	この処理は起動前に単独で行っていい	***
;	***	いつでもいいけど			***
;	***************************************************
_STEP_POS_SPD_TIM_STEPMOV:
	SUB_START
	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
	MOV.W	@R1,R5				;ｽﾃｯﾌﾟ最大数 1~10
	SHLL2	R5				;*4
	XOR	R0,R0				;0~9+1

	MOV.L	#_SET1_OBJECT_SPD_TOP,R9	;//4BYTE SET1_OBJECT_SP01;01段目移動速度 2BYTE-->4BYTE
	MOV.L	#_SET1_OBJECT_TIM_TOP,R10	;//4BYTE SET1_OBJECT_TM01;01段目停止時間 99.99*10=1msec
	MOV.L	#_SET1_OBJECT_PLS_TOP,R11	;//4BYTE SET1_OBJECT_PS01;01段目目標位置~

	MOV.L	#_SETX_POS_SDAT1_SPD,R12		;
	MOV.L	#_SETX_POS_SDAT1_TIM,R13		;
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R14		;

	MOV.L	#_SETX_UPAREA_PLS,R1		;//4;待機点
	MOV.L	@R1,R6				;
	MOV.L	#_LINK_1ROT_PLS,R1		;待機点より小さかったら+１回転
	MOV.L	@R1,R7				;反転時もこの論理でＯＫ
;R6:待機点
;R7:1REV

STEP_DAT1_MV_LOP1:
	CMP/HI	R5,R0				;
	BT	STEP_DAT1_MV_200		;
	CMP/EQ	R0,R5				;最後?
	BF	STEP_DAT1_MV_050		;
;	==== 最後の工程 この考え方は運転方法で異なる(以下は回転と反転のみ通じる考え)=====
;	===本当はここではなく、往復を考慮するとCDAT側で行う==
	MOV.L	#_SETX_POS_CTL_MATH,R1		;
	MOV.W	@R1,R2				;
	MOV.W	#_DMATH_CNTROT,R4		;
	TST	R4,R2				;回転?
	TST_BIT_OF STEP_DAT1_MV_020		;
	MOV.L	#_SET1_UPAREA_SPD0,R1		;//4;基準速度
	MOV.L	#_SET1_UPAREA_TIM0,R2		;//4;待機時間
	MOV.L	@R1,R1				;SPD
	MOV.L	@R2,R2				;TIM
	MOV	R6,R3				;
	ADD	R7,R3				;待機点+1REV(回転仕様時)
	M_BRA	STEP_DAT1_MV_100		;
STEP_DAT1_MV_020:
;;;20091007下振子	MOV.L	#_SET1_UPAREA_SPD0,R1		;//4;基準速度
;;;20091007下振子	MOV.L	#_SET1_UPAREA_TIM0,R2		;//4;待機時間
;;;20091007下振子	MOV.L	@R1,R1				;SPD
;;;20091007下振子	MOV.L	@R2,R2				;TIM
;;;20091007下振子	MOV	R6,R3				;
;;;20091007下振子	XOR	R7,R7				;待機点
;;;20091007下振子	M_BRA	STEP_DAT1_MV_100		;

;	-------- [20091007下振子]2007-04-03------
	MOV.W	#_DMATH_DNDRIV,R4		;
	TST	R4,R2				;ふりこ
	TST_BIT_ON STEP_DAT1_MV_030		;YES
;	---------------------------
	MOV.L	#_SET1_UPAREA_SPD0,R1		;//4;基準速度
	MOV.L	#_SET1_UPAREA_TIM0,R2		;//4;待機時間
	MOV.L	@R1,R1				;SPD
	MOV.L	@R2,R2				;TIM
	MOV	R6,R3				;
	XOR	R7,R7				;待機点
	M_BRA	STEP_DAT1_MV_100		;

;	--------[20091007下振子]2007-04-03｢最終ｽﾃｯﾌﾟが復路待機点｣---------------
STEP_DAT1_MV_030:
	MOV.L	#_SET1_UPAREA_SPD0,R1		;//4;基準速度
	MOV.L	#_SET1_UPAREA_TIM0,R2		;//4;待機時間
	MOV.L	@R1,R1				;SPD
	MOV.L	@R2,R2				;TIM
	MOV.L	#_DNM_SET1_UPAREA_PLS0,R3	;最終は復路の待機点
	MOV.L	@R3,R3				;
	MOV	R3,R6				;
	M_BRA	STEP_DAT1_MV_100		;R7=1LOTのまま


STEP_DAT1_MV_050:
	MOV.L	@R9+,R1				;SPD
	MOV.L	@R10+,R2			;TIM
	MOV.L	@R11+,R3			;POS

STEP_DAT1_MV_100:
	MOV.L	R1,@(R0,R12)			;SPD
	MOV.L	R2,@(R0,R13)			;TIM

	CMP/GE	R6,R3				;待機点=<R3
	BT	STEP_DAT1_MV_150		;"必ずEQUを含む事"
	ADD	R7,R3				;
STEP_DAT1_MV_150:				;
	MOV.L	R3,@(R0,R14)			;POS
	ADD	#4,R0				;
	M_BRA	STEP_DAT1_MV_LOP1

STEP_DAT1_MV_200:

	SUB_END
	M_RTS





;	***************************************************
;	***						***
;	***	2009-10-07				***
;	***	位置の転送				***
;	***	復路専用				***
;	***						***
;	***************************************************
_DN_STEP_POS_SPD_TIM_STEPMOV:
	SUB_START
	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
	MOV.W	@R1,R5				;ｽﾃｯﾌﾟ最大数 1~10
	SHLL2	R5				;*4
	XOR	R0,R0				;0~9+1

	MOV.L	#_DNM_SET1_OBJECT_PLS_TOP,R11	;//4BYTE SET1_OBJECT_PS01;01段目目標位置~
	MOV.L	#_SETX_POS_SDAT2_OFSPOS,R14	;

	MOV.L	#_DNM_SETX_UPAREA_PLS,R1	;//4;待機点
	MOV.L	@R1,R6				;
	MOV.L	#_LINK_1ROT_PLS,R1		;待機点より大きかったらー１回転
	MOV.L	@R1,R7				;
;R6:待機点
;R7:1REV

DN_STEP_DAT1_MV_LOP1:
	CMP/HI	R5,R0				;
	BT	DN_STEP_DAT1_MV_200		;EXIT
	CMP/EQ	R0,R5				;最後?
	BF	DN_STEP_DAT1_MV_050		;

	MOV.L	#_SET1_UPAREA_PLS0,R3		;最終は往路の待機点
	MOV.L	@R3,R3				;
	MOV	R3,R6				;
	M_BRA	DN_STEP_DAT1_MV_100		;R7=1LOTのまま

DN_STEP_DAT1_MV_050:
	MOV.L	@R11+,R3			;POS

DN_STEP_DAT1_MV_100:

	CMP/GE	R3,R6				;R3=<待機点(R6)
	BT	DN_STEP_DAT1_MV_150		;"必ずEQUを含む事"
	SUB	R7,R3				;
DN_STEP_DAT1_MV_150:				;
	MOV.L	R3,@(R0,R14)			;POS
	ADD	#4,R0				;
	M_BRA	DN_STEP_DAT1_MV_LOP1

DN_STEP_DAT1_MV_200:

	SUB_END
	M_RTS




;	*******************************************
;	***					***
;	***	2009-10-07[2007-04-03]		***
;	***	復路のデータ			***
;	***					***
;	*******************************************
_DNM_UP_AREA_DT_MAK:
	SUB_START

	MOV.L	#_SVP_UPAREA_DIG0,R6			;待機点角度
	MOV.W	@R6,R2					;
	FAR_JSR	#_DIG01_CHG_DN_DATA_MAKE,R0		;
	MOV.L	#_DNM_WSVX_CLNK_UP_POS,R1		;
	MOV.W	R2,@R1					;ｸﾗﾝｸ角度

	MOV.L	#_DNM_SET1_UPAREA_PLS0,R3		;//4;待機点位置(ｲﾝｸﾘﾒﾝﾀﾙ)
	MOV.L	@R3,R0					;
	MOV.L	#_DNM_SETX_UPAREA_PLS,R1		;//4;待機点位置(ｲﾝｸﾘﾒﾝﾀﾙ):上死点
	MOV.L	R0,@R1					;使用箇所[LOT-CNT,上昇ﾎｰﾙﾄﾞ,]

	MOV.L	#_DNM_SET1_UPAREA_DIG0,R4		;2;PG待機点角度
	MOV.W	@R4,R0					;
	MOV.L	#_DNM_SETX_UPAREA_DIG,R1		;2;回転/反転時待機点
	MOV.W	R0,@R1					;



;;	U2b	DNM_WSVX_CLNK_UP_POS_UP	;//
;;	U2b	DNM_WSVX_CLNK_UP_POS_DN	;//
	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***	運転中はﾘﾌﾚｯｼｭ停止	***
;	***	ﾌﾙｸﾛｰｽﾞﾃﾞｰﾀ		***
;	***				***
;	***********************************
;	==== 2003-02-21 ===
EQ_REV_MIN_NEAR_PLS	.EQU	5	;

_FULL_CLOSE_DATA_MOV:
	SUB_START
	MOV.L	#_SETX_UPAREA_PLS,R1		;待機点
	MOV.L	@R1,R7				;
	MOV.L	#_SDATCLS_UPOBJ_PLS,R1		;
	MOV.L	R7,@R1				;待機点

	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
	MOV.W	@R1,R8				;R12 ｽﾃｯﾌﾟMAX STEP=1の時2回まわす
	MOV.L	#_SET1_OBJARA_INPX,R1		;
	MOV.W	@R1,R9				;R13 ｲﾝﾎﾟｼﾞｼｮﾝ mm

;	==== 2003-02-22 =====
	TST	R9,R9				;
	TST_BIT_ON FULL_CLOSE_DAT_MV_010	;
	MOV.W	#1,R9				;
FULL_CLOSE_DAT_MV_010:

;;;2014-12-25	画面 0.01mm==>0.001mmに変更に伴い*10をやめる
;;;2014-12-25;	==== *10 ====
;;;2014-12-25	ADD	R9,R9		;*2
;;;2014-12-25	MOV	R9,R0		;
;;;2014-12-25	ADD	R9,R9		;*4
;;;2014-12-25	ADD	R9,R9		;*8
;;;2014-12-25	ADD	R0,R9		;


	MOV.L	#_SET1_OBJECT_PLS_TOP,R10	;//4BYTE SET1_OBJECT_PS01;01段目目標位置~
						;data元
	MOV.L	#_SET1_OBJECT_DIG_TOP,R11
	MOV.L	#_SDATCLS_OBJPLS,R12		;//目標ﾊﾟﾙｽ(+だけ)(反転制御用角度)
	MOV.L	#_SDATCLS_OBJMM,R13		;//目標ﾊﾟﾙｽから算出されるmm
	MOV.L	#_SDATCLS_OBJ_NEAR_UPDNPLS,R14	;//



FULL_CLOSE_DAT_MVLOP00:
	MOV.L	@R10+,R2			;設定角度ﾊﾟﾙｽ
	CMP/PL	R8				;
	BT	FULL_CLOSE_DAT_MV015		;
	MOV.L	#_SETX_UPAREA_PLS,R1		;2;回転/反転時待機点
;;;2006-07-28 bug	MOV.W	@R1,R2		;
	MOV.L	@R1,R2				;

FULL_CLOSE_DAT_MV015:				;
	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
	MOV.L	R2,@R12				;角度ﾊﾟﾙｽSAVE(位置決め時保持)
;;;;;;;;;	ADD	#4,R12				;


;	=== 度==>mm変換 ===
	MOV.W	@R11+,R2			;
	CMP/PL	R8				;
	BT	FULL_CLOSE_DAT_MV035		;
	MOV.L	#_SETX_UPAREA_DIG,R1		;2;回転/反転時待機点
	MOV.W	@R1,R2				;
FULL_CLOSE_DAT_MV035:				;
	MOV.W	#D'100,R4			;
	DMULS.L	R4,R2				;
	STS	MACL,R2				;

	PUSH_REG1 R8
	PUSH_REG1 R9
	PUSH_REG1 R10
	PUSH_REG1 R11
	PUSH_REG1 R12
	PUSH_REG1 R13
	PUSH_REG1 R14
	FAR_JSR	#_DIG36000_CHG_RENEA1,R0	;"mm" Input R2
	POP_REG1 R14
	POP_REG1 R13
	POP_REG1 R12
	POP_REG1 R11
	POP_REG1 R10
	POP_REG1 R9
	POP_REG1 R8
	MOV.L	R2,@R13				;mm
;;;;;	ADD	#4,R13				;

;	======= mm ==> ﾊﾟﾙｽ変換 目標位置のﾊﾟﾙｽ===========
	PUSH_REG1 R2					;
	MOV	R2,R5					;
	MOV.W	#D'900,R2				;90.0度(右半球)
	CMP/PZ	R5					;
	BT	FULL_CLOSE_DAT_MV040			;-1mm ==>+1mm
	NEG	R5,R5					;
	MOV.W	#_UPDN_DIRJG_DIG+_FUL_CLS_RNADIG,R2	;上昇(260度)
FULL_CLOSE_DAT_MV040:					;
	PUSH_REG1 R3
	PUSH_REG1 R8
	PUSH_REG1 R9
	PUSH_REG1 R10
	PUSH_REG1 R11
	PUSH_REG1 R12
	PUSH_REG1 R13
	PUSH_REG1 R14
	FAR_JSR	#_RENEA_1ROT_PLS_AND_DIG_MAK1,R0	;ANS R2:PLS
	POP_REG1 R14
	POP_REG1 R13
	POP_REG1 R12
	POP_REG1 R11
	POP_REG1 R10
	POP_REG1 R9
	POP_REG1 R8
	POP_REG1 R3
;;;;	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
	MOV.L	#_REV_CALC_WORK0,R1		;目標位置ﾊﾟﾙｽSAVE
	MOV.L	R2,@R1				;
	POP_REG1 R2				;


	MOV	R2,R3				;mm
	ADD	R9,R2				;OBJ+mm<許す>
	SUB	R9,R3				;OBJ-mm

;	======= mm ==> ﾊﾟﾙｽ変換 R2:目標mm+範囲:角度としては減少=========
	MOV	R2,R5					;
	MOV.W	#D'900,R2				;90.0度(右半球)
	CMP/PZ	R5					;
	BT	FULL_CLOSE_DAT_MV050			;-1mm ==>+1mm
	NEG	R5,R5					;
	MOV.W	#_UPDN_DIRJG_DIG+_FUL_CLS_RNADIG,R2	;上昇(260度)
FULL_CLOSE_DAT_MV050:					;
	PUSH_REG1 R3
	PUSH_REG1 R8
	PUSH_REG1 R9
	PUSH_REG1 R10
	PUSH_REG1 R11
	PUSH_REG1 R12
	PUSH_REG1 R13
	PUSH_REG1 R14
	FAR_JSR	#_RENEA_1ROT_PLS_AND_DIG_MAK1,R0	;ANS R2:PLS
	POP_REG1 R14
	POP_REG1 R13
	POP_REG1 R12
	POP_REG1 R11
	POP_REG1 R10
	POP_REG1 R9
	POP_REG1 R8
	POP_REG1 R3
;;;;	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
	MOV.L	#_REV_CALC_WORK1,R1		;位置+ALFA=>ﾊﾟﾙｽは低いほう
	MOV.L	R2,@R1				;


;	======= mm ==> ﾊﾟﾙｽ変換  mm-alfa :角度としては増加=================
	MOV.W	#D'900,R2				;90.0度(右半球)
	MOV	R3,R5					;mm
	MOV.L	#_RNA_STLORK,R0				;
	MOV.L	@R0,R1					;
	CMP/GE	R5,R1					;
	BT	FULL_CLOSE_DAT_MV100			;
	SUB	R1,R5					;2mm
	SUB	R5,R1					;
	MOV	R1,R5					;
	MOV.W	#_UPDN_DIRJG_DIG+_FUL_CLS_RNADIG,R2	;上昇(260度)
FULL_CLOSE_DAT_MV100:
	PUSH_REG1 R8
	PUSH_REG1 R9
	PUSH_REG1 R10
	PUSH_REG1 R11
	PUSH_REG1 R12
	PUSH_REG1 R13
	PUSH_REG1 R14
	FAR_JSR	#_RENEA_1ROT_PLS_AND_DIG_MAK1,R0	;ANS R2:PLS
	POP_REG1 R14
	POP_REG1 R13
	POP_REG1 R12
	POP_REG1 R11
	POP_REG1 R10
	POP_REG1 R9
	POP_REG1 R8
;;;;	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
	MOV.L	#_REV_CALC_WORK2,R1		;ﾊﾟﾙｽは多い方
	MOV.L	R2,@R1				;

;	===============================
	MOV.L	#_REV_CALC_WORK0,R1		;ﾊﾟﾙｽは多い方
	MOV.L	@R1,R3				;基準値
	SUB	R3,R2				;
	FAR_JSR	#_CHK1_CAL_1ROT_PLS,R0		;R2
	PUSH_REG1 R2

	MOV.L	#_REV_CALC_WORK1,R1		;ﾊﾟﾙｽは多い方
	MOV.L	@R1,R2				;基準値
	SUB	R3,R2				;
	FAR_JSR	#_CHK1_CAL_1ROT_PLS,R0		;R2
	POP_REG1 R4				;
	CMP/GE	R4,R2				;
	BT	FULL_CLOSE_DAT_MV130		;
	MOV	R4,R2				;大きい方のﾃﾞｰﾀ
FULL_CLOSE_DAT_MV130:				;

	MOV.W	#EQ_REV_MIN_NEAR_PLS,R4		;
	CMP/GE	R4,R2				;
	BT	FULL_CLOSE_DAT_MV150		;
	MOV	R4,R2				;min
FULL_CLOSE_DAT_MV150:				;

	MOV	R2,R3				;(DELT)
	MOV.L	@R12,R4				;
	ADD	R4,R2				;大きい
	FAR_JSR	#_CHK2_CAL_1ROT_PLS,R0		;
	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
	MOV.L	R2,@R14				;
	ADD	#4,R14				;
	MOV	R4,R2				;
	SUB	R3,R2				;
	FAR_JSR	#_CHK2_CAL_1ROT_PLS,R0		;
	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
	MOV.L	R2,@R14				;
	ADD	#4,R14				;


	ADD	#4,R12		;目標角度
	ADD	#4,R13				;

	CMP/PL	R8			;
	BF	FULL_CLOSE_DAT_MV200	;
	ADD	#-1,R8			;
	M_BRA	FULL_CLOSE_DAT_MVLOP00
FULL_CLOSE_DAT_MV200:
	SUB_END
	M_RTS

;	===== Input R2 ===
_CHK1_CAL_1ROT_PLS
	SUB_START
	MOV.L	#_LINK_1ROT_PLS,R1		;//1回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	@R1,R1				;
	CMP/PZ	R2				;
	BT	CHK1_CAL_1ROTPLS_050		;
	NEG	R2,R2				;
CHK1_CAL_1ROTPLS_050:
	CMP/GE	R2,R1				;
	BT	CHK1_CAL_1ROTPLS_EXT		;R2 =< R1
	SUB	R1,R2				;
CHK1_CAL_1ROTPLS_EXT
	SUB_END
	M_RTS


;	===== Input R2 ===
_CHK2_CAL_1ROT_PLS
	SUB_START
	MOV.L	#_LINK_1ROT_PLS,R1		;//1回転ﾊﾟﾙｽ(設定ﾚﾍﾞﾙ)
	MOV.L	@R1,R1				;
	CMP/PZ	R2				;
	BT	CHK2_CAL_1ROTPLS_050		;
	ADD	R1,R2				;
	CMP/PZ	R2				;
	BT	CHK2_CAL_1ROTPLS_EXT		;
	XOR	R2,R2				;
	M_BRA	CHK2_CAL_1ROTPLS_EXT		;

CHK2_CAL_1ROTPLS_050:
	CMP/GE	R2,R1				;
	BT	CHK2_CAL_1ROTPLS_EXT		;R2 =< R1
	SUB	R1,R2				;
CHK2_CAL_1ROTPLS_EXT
	SUB_END
	M_RTS

;;	***********************************
;;	***				***
;;	***	運転中はﾘﾌﾚｯｼｭ停止	***
;;	***	ﾌﾙｸﾛｰｽﾞﾃﾞｰﾀ		***
;;	***				***
;;	***********************************
;	==== 2003-02-21 ===
;;_FULL_CLOSE_DATA_MOV:
;;	SUB_START
;;	MOV.L	#_SETX_UPAREA_PLS,R1		;待機点
;;	MOV.L	@R1,R7				;
;;	MOV.L	#_SDATCLS_UPOBJ_PLS,R1		;
;;	MOV.L	R7,@R1				;待機点
;;
;;	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
;;	MOV.W	@R1,R8				;R12 ｽﾃｯﾌﾟMAX STEP=1の時2回まわす
;;	MOV.L	#_SET1_OBJARA_INPX,R1		;
;;	MOV.W	@R1,R9				;R13 ｲﾝﾎﾟｼﾞｼｮﾝ mm
;;
;;	==== *10 ====
;;	ADD	R9,R9		;*2
;;	MOV	R9,R0		;
;;	ADD	R9,R9		;*4
;;	ADD	R9,R9		;*8
;;	ADD	R0,R9		;
;;
;;
;;	MOV.L	#_SET1_OBJECT_PLS_TOP,R10	;//4BYTE SET1_OBJECT_PS01;01段目目標位置~
;;						;data元
;;	MOV.L	#_SET1_OBJECT_DIG_TOP,R11
;;	MOV.L	#_SDATCLS_OBJPLS,R12		;//目標ﾊﾟﾙｽ(+だけ)(反転制御用角度)
;;	MOV.L	#_SDATCLS_OBJMM,R13		;//目標ﾊﾟﾙｽから算出されるmm
;;	MOV.L	#_SDATCLS_OBJ_NEAR_UPDNPLS,R14	;//
;;
;;
;;
;;FULL_CLOSE_DAT_MVLOP00:
;;	MOV.L	@R10+,R2			;設定角度ﾊﾟﾙｽ
;;	CMP/PL	R8				;
;;	BT	FULL_CLOSE_DAT_MV015		;
;;	MOV.L	#_SETX_UPAREA_PLS,R1		;2;回転/反転時待機点
;;	MOV.W	@R1,R2				;
;;FULL_CLOSE_DAT_MV015:				;
;;	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
;;	MOV.L	R2,@R12				;角度ﾊﾟﾙｽSAVE(位置決め時保持)
;;	ADD	#4,R12				;
;;
;;	=== 度==>mm変換 ===
;;	MOV.W	@R11+,R2			;
;;	CMP/PL	R8				;
;;	BT	FULL_CLOSE_DAT_MV035		;
;;	MOV.L	#_SETX_UPAREA_DIG,R1		;2;回転/反転時待機点
;;	MOV.W	@R1,R2				;
;;FULL_CLOSE_DAT_MV035:				;
;;	MOV.W	#D'100,R4			;
;;	DMULS.L	R4,R2				;
;;	STS	MACL,R2				;
;;
;;	PUSH_REG1 R8
;;	PUSH_REG1 R9
;;	PUSH_REG1 R10
;;	PUSH_REG1 R11
;;	PUSH_REG1 R12
;;	PUSH_REG1 R13
;;	PUSH_REG1 R14
;;	FAR_JSR	#_DIG36000_CHG_RENEA1,R0	;"mm" Input R2
;;	POP_REG1 R14
;;	POP_REG1 R13
;;	POP_REG1 R12
;;	POP_REG1 R11
;;	POP_REG1 R10
;;	POP_REG1 R9
;;	POP_REG1 R8
;;
;;	MOV.L	R2,@R13				;mm
;;	ADD	#4,R13				;
;;
;;	MOV	R2,R3				;mm
;;	ADD	R9,R2				;OBJ+mm<許す>
;;	SUB	R9,R3				;OBJ-mm
;;
;;;	=======================================
;;	MOV	R2,R5					;
;;	MOV.W	#D'900,R2				;90.0度(右半球)
;;	CMP/PZ	R5					;
;;	BT	FULL_CLOSE_DAT_MV050			;-1mm ==>+1mm
;;	NEG	R5,R5					;
;;	MOV.W	#_UPDN_DIRJG_DIG+_FUL_CLS_RNADIG,R2	;上昇(260度)
;;FULL_CLOSE_DAT_MV050:					;
;;	PUSH_REG1 R3
;;	PUSH_REG1 R8
;;	PUSH_REG1 R9
;;	PUSH_REG1 R10
;;	PUSH_REG1 R11
;;	PUSH_REG1 R12
;;	PUSH_REG1 R13
;;	PUSH_REG1 R14
;;	FAR_JSR	#_RENEA_1ROT_PLS_AND_DIG_MAK1,R0	;ANS R2:PLS
;;	POP_REG1 R14
;;	POP_REG1 R13
;;	POP_REG1 R12
;;	POP_REG1 R11
;;	POP_REG1 R10
;;	POP_REG1 R9
;;	POP_REG1 R8
;;	POP_REG1 R3
;;	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
;;	MOV.L	R2,@R14				;目標位置+ALFAmm==>PLS
;;	ADD	#4,R14				;
;;
;;
;;	=======================================
;;	MOV.W	#D'900,R2				;90.0度(右半球)
;;	MOV	R3,R5					;mm
;;	MOV.L	#_RNA_STLORK,R0				;
;;	MOV.L	@R0,R1					;
;;	CMP/GE	R5,R1					;
;;	BT	FULL_CLOSE_DAT_MV100			;
;;	SUB	R1,R5					;2mm
;;	SUB	R5,R1					;
;;	MOV	R1,R5					;
;;	MOV.W	#_UPDN_DIRJG_DIG+_FUL_CLS_RNADIG,R2	;上昇(260度)
;;FULL_CLOSE_DAT_MV100:
;;
;;
;;	PUSH_REG1 R8
;;	PUSH_REG1 R9
;;	PUSH_REG1 R10
;;	PUSH_REG1 R11
;;	PUSH_REG1 R12
;;	PUSH_REG1 R13
;;	PUSH_REG1 R14
;;	FAR_JSR	#_RENEA_1ROT_PLS_AND_DIG_MAK1,R0	;ANS R2:PLS
;;	POP_REG1 R14
;;	POP_REG1 R13
;;	POP_REG1 R12
;;	POP_REG1 R11
;;	POP_REG1 R10
;;	POP_REG1 R9
;;	POP_REG1 R8
;;	FAR_JSR	#_FUL_CLS_OBJPLS_CHK,R0		;Input R2 もし260~0の間なら"-"のﾊﾟﾙｽになる
;;	MOV.L	R2,@R14		;<目標位置-mm>==>pls
;;	ADD	#4,R14		;
;;
;;	CMP/PL	R8			;
;;	BF	FULL_CLOSE_DAT_MV200	;
;;	ADD	#-1,R8			;
;;	M_BRA	FULL_CLOSE_DAT_MVLOP00
;;FULL_CLOSE_DAT_MV200:
;;	SUB_END
;;	M_RTS




;	***************************************************
;	***						***
;	***	速度連続と運転方向の作成		***
;	***	この処理は起動前に単独で行っていい	***
;	***						***
;	***************************************************
;	どんな運転でも、１回転内で終わるステップ情報を作成する
;	但し、回転連続・寸動の場合のみ速度連続の情報は残す
;	"正転運転用"
;
_STEP_INF1_STEPMOV:
	SUB_START
;	----[2009-10-07下振子]
	MOV.L	#_SETX_POS_CTL_MATH,R1				;
	MOV.W	@R1,R0						;
	TST	#_DMATH_DNDRIV,R0
	TST_BIT_OF STEP_INF1_MV020

	FAR_JSR	#_DNM_STEP_INF1_STEPMOV,R0	;ふりこ(荷重制御は無い)
	M_BRA	STEP_INF1_MV500					;

;	-------------------
STEP_INF1_MV020:

;	------------荷重制御(反転時のみ)に追加------------------------
	XOR	R9,R9					;
	MOV.L	#_SETX_POS_CTL_MATH,R1			;
	MOV.W	@R1,R0					;
	TST	#_DMATH_CNTROT,R0			;回転時
	TST_BIT_ON STEP_INF1_MV025			;

	.AIF	_KJYU_CLS EQ	_CMPILE_YES		;YES:反転ﾓｰﾄﾞで荷重でのｸﾛｰｽﾞを行う

	MOV.L	#_SETX_FULCLS_MATEHD_SW,R1		;
	MOV.W	@R1,R9
	.AENDI
STEP_INF1_MV025:
;	--------------------------------------------------

	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
	MOV.W	@R1,R5				;ｽﾃｯﾌﾟ最大数 1~10
						;1~10
	MOV.L	#_SETX_UPAREA_PLS,R1		;//4;待機点
	MOV.L	@R1,R6				;
	MOV.L	#_LINK_1ROT_PLS,R1		;待機点より小さかったら１回転
	MOV.L	@R1,R7				;

	XOR	R8,R8				;ｽﾃｯﾌﾟ 0~10

	MOV.L	#_SETX_POS_SDAT1_TIM,R11	;
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R12	;

	MOV.L	#_SETX_POS_SDAT1_CNTSTEP,R13	;
	MOV.L	#_SETX_POS_SDAT1_INF1,R14	;


STEP_INF1_MVLP01:

	XOR	R0,R0				;INF BIT0:(連続) BIT1:(0:正/逆)

	CMP/HI	R5,R8				;R8:STEP R5:MAX
	BT	STEP_INF1_MV500			;

	CMP/EQ	R5,R8				;最後?
	BF	STEP_INF1_MV100			;
;	==== 最終[[回転の場合　最終は待機点＋１ 反転は＋１しない　戻ってくる]]=====
	MOV.L	@R12,R1				;POSn_1
	MOV.L	@(1*4,R12),R2			;POSn(=待機点+1REVが入っている)
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R10	;
	MOV.L	@R10,R3				;
	ADD	R7,R3				;POSn+1(次の1段目+1REV)
	MOV.L	#_SETX_POS_SDAT1_TIM,R10	;R10:WORK
	MOV.L	@R10,R4				;TIM1段目
	M_BRA	STEP_INF1_MV250			;

STEP_INF1_MV100:
	TST	R8,R8
	TST_BIT_ON STEP_INF1_MV200		;
;	=== 1段目=====
	MOV	R6,R1				;POSn_1=待機点
	MOV.L	@R12,R2				;POSn
	MOV.L	@(1*4,R12),R3			;POSn+1
						;R12は+しない
	MOV.L	@R11+,R4			;TIM
	M_BRA	STEP_INF1_MV250			;

STEP_INF1_MV200:
;	=== 2段目~(最終-1)=====
	MOV.L	@R12,R1				;POSn_1
	MOV.L	@(1*4,R12),R2			;POSn
	MOV.L	@(2*4,R12),R3			;POSn+1
	ADD	#4,R12				;POS +
	MOV.L	@R11+,R4			;TIM +
STEP_INF1_MV250:

;	==== 方向判別 ======
	TST	R8,R8
	TST_BIT_OF STEP_INF1_MV300			;1段目:正転 BIT1=0

	CMP/EQ	R1,R2				;
	BT	STEP_INF1_MV280			;EQU THEN 前回ﾃﾞｰﾀ参照

	CMP/GT	R1,R2				;R1 < R2(正転)
	BT	STEP_INF1_MV300			;
	OR	#BIT1,R0			;
	M_BRA	STEP_INF1_MV300			;

STEP_INF1_MV280:

;------2014-03-20 R9 ﾚｽﾞｼﾀ　反転の荷重制御ON/OFFに使用する[停止する、しないの反転]
;	その為、以下の判定でのR9を使用禁止

	PUSH_REG1 R1
	MOV	R14,R10				;SETX_POS_SDAT1_INF1:R14=>R10
	ADD	#-4,R10				;
	MOV.L	@R10,R1				;R9=>R1 work
	MOV	#BIT1,R10			;
	TST	R10,R1				;R9=>R1
	TST_BIT_OF STEP_INF1_MV295		;１段前が正転なら今回も正転JUMP
	OR	#BIT1,R0			;１段前が逆転ならこの段も逆転
STEP_INF1_MV295					;
	POP_REG1 R1

;;;;	MOV	R14,R10				;
;;;;	ADD	#-4,R10				;
;;;;	MOV.L	@R10,R9				;work
;;;;	MOV	#BIT1,R10			;
;;;;	TST	R10,R9				;
;;;;	TST_BIT_OF STEP_INF1_MV300		;１段前が正転なら今回も正転JUMP
;;;;	OR	#BIT1,R0			;１段前が逆転ならこの段も逆転
;;;;STEP_INF1_MV300:				;

STEP_INF1_MV300:				;

;	====== 連続ﾁｪｯｸ ====
	TST	R4,R4				;
	TST_BIT_ON STEP_INF1_MV400		;ﾀｲﾏ=0以外停止あり

	.AIF	_KJYU_CLS EQ	_CMPILE_YES	;YES:反転ﾓｰﾄﾞで荷重でのｸﾛｰｽﾞを行う
	MOV.B	#BIT0,R4			;
	TST	R4,R9				;
	TST_BIT_ON STEP_INF1_MV400		;荷重制御ON 停止有り
	.AENDI


	CMP/EQ	R1,R2				;
	BF	STEP_INF1_MV330			;

	TST	#BIT1,R0			;今回は正転か?
	TST_BIT_ON STEP_INF1_MV350		;NO逆転(同じ設定の場合その前の段の回転)
STEP_INF1_MV330:
	CMP/GE	R1,R2				;
	BF	STEP_INF1_MV350			;
	CMP/GE	R2,R3				;
	BF	STEP_INF1_MV400			;
;	==== R1 =< R2 =< R3[正転連続] ===
	OR	#BIT0,R0			;速度連続
	M_BRA	STEP_INF1_MV400			;

STEP_INF1_MV350:
	CMP/GE	R2,R1				;
	BF	STEP_INF1_MV400			;
	CMP/GE	R3,R2				;
	BF	STEP_INF1_MV400			;
;	=== R1 >= R2 >= R3 [逆転連続] ===
	OR	#BIT0,R0			;速度連続
STEP_INF1_MV400:				;

	CMP/EQ	R5,R8				;最後?
	BF	STEP_INF1_MV450			;NO

	MOV.L	#_SETX_POS_MOD_FLG1,R1		;//回転時の停止しない連続
	MOV.W	@R1,R2				;
	MOV	#(BIT1+BIT0),R3			;
	TST	R3,R2				;
	TST_BIT_ON STEP_INF1_MV450		;最終工程も速度連続を許すﾓｰﾄﾞ
	AND	#LOW ~BIT0,R0			;最終工程に速度連続なし

STEP_INF1_MV450:
	MOV.L	R0,@R14				;
	ADD	#4,R14				;
	ADD	#1,R8				;
	SHLR	R9				;2014-03-20荷重制御
	M_BRA	STEP_INF1_MVLP01



STEP_INF1_MV500:


	SUB_END
	M_RTS


;	***************************************************
;	***						***
;	***	下振子専用				***
;	***	2009-10-07					***
;	***						***
;	***************************************************
;	どんな運転でも、１回転内で終わるステップ情報を作成する
;	"正転運転用"
;	(INF1の作成)
;	往路と復路を一括して作成
_DNM_STEP_INF1_STEPMOV:
	SUB_START
	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
	MOV.W	@R1,R5				;ｽﾃｯﾌﾟ最大数 1~10
						;1~10
	MOV.L	#_SETX_UPAREA_PLS,R1		;//4;待機点
	MOV.L	@R1,R6				;

	XOR	R8,R8				;ｽﾃｯﾌﾟ 0~10

	MOV.L	#_SETX_POS_SDAT1_TIM,R11	;
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R12	;

	MOV.L	#_SETX_POS_SDAT2_INF1,R13	;復路
	MOV.L	#_SETX_POS_SDAT1_INF1,R14	;往路


DNM_STEP_INF1_MVLP01:

	XOR	R0,R0				;INF BIT0:(連続) BIT1:(0:正/逆)

	CMP/HI	R5,R8				;R8:STEP R5:MAX
	BT	DNM_STEP_INF1_MV500			;

	CMP/EQ	R5,R8				;最後?
	BF	DNM_STEP_INF1_MV100			;

;	==== 最終[[]]=====
	MOV.L	@R12,R1				;POSn_1
	MOV.L	@(1*4,R12),R2			;POSn(=復路待機点)
	MOV	R2,R3				;
	MOV	#1,R4				;TIMER=1
	M_BRA	DNM_STEP_INF1_MV250			;

DNM_STEP_INF1_MV100:
	TST	R8,R8
	TST_BIT_ON DNM_STEP_INF1_MV200		;
;	=== 1段目=====
	MOV	R6,R1				;POSn_1=待機点
	MOV.L	@R12,R2				;POSn
	MOV.L	@(1*4,R12),R3			;POSn+1
						;R12は+しない
	MOV.L	@R11+,R4			;TIM
	M_BRA	DNM_STEP_INF1_MV250			;

DNM_STEP_INF1_MV200:
;	=== 2段目~(最終-1)=====
	MOV.L	@R12,R1				;POSn_1
	MOV.L	@(1*4,R12),R2			;POSn
	MOV.L	@(2*4,R12),R3			;POSn+1
	ADD	#4,R12				;POS +
	MOV.L	@R11+,R4			;TIM +
DNM_STEP_INF1_MV250:

;	==== 方向判別 ======
	TST	R8,R8
	TST_BIT_OF DNM_STEP_INF1_MV300		;1段目:正転 BIT1=0

	CMP/EQ	R1,R2				;
	BT	DNM_STEP_INF1_MV280		;EQU THEN 前回ﾃﾞｰﾀ参照

	CMP/GT	R1,R2				;R1 < R2(正転)
	BT	DNM_STEP_INF1_MV300		;
	OR	#BIT1,R0			;
	M_BRA	DNM_STEP_INF1_MV300		;

DNM_STEP_INF1_MV280:

	MOV	R14,R10				;
	ADD	#-4,R10				;
	MOV.L	@R10,R9				;work
	MOV	#BIT1,R10			;
	TST	R10,R9				;
	TST_BIT_OF DNM_STEP_INF1_MV300		;１段前が正転なら今回も正転JUMP
	OR	#BIT1,R0			;１段前が逆転ならこの段も逆転
DNM_STEP_INF1_MV300:				;


;	====== 連続ﾁｪｯｸ ====
	TST	R4,R4				;
	TST_BIT_ON DNM_STEP_INF1_MV400		;ﾀｲﾏ=0以外停止あり

	CMP/EQ	R1,R2				;
	BF	DNM_STEP_INF1_MV330		;

	TST	#BIT1,R0			;今回は正転か?
	TST_BIT_ON DNM_STEP_INF1_MV350		;NO逆転(同じ設定の場合その前の段の回転)
DNM_STEP_INF1_MV330:
	CMP/GE	R1,R2				;
	BF	DNM_STEP_INF1_MV350			;
	CMP/GE	R2,R3				;
	BF	DNM_STEP_INF1_MV400			;
;	==== R1 =< R2 =< R3[正転連続] ===
	OR	#BIT0,R0			;速度連続
	M_BRA	DNM_STEP_INF1_MV400			;

DNM_STEP_INF1_MV350:
	CMP/GE	R2,R1				;
	BF	DNM_STEP_INF1_MV400			;
	CMP/GE	R3,R2				;
	BF	DNM_STEP_INF1_MV400			;
;	=== R1 >= R2 >= R3 [逆転連続] ===
	OR	#BIT0,R0			;速度連続
DNM_STEP_INF1_MV400:				;

	CMP/EQ	R5,R8				;最後?
	BF	DNM_STEP_INF1_MV450			;NO

;	---- 最終工程も速度連続を許すﾓｰﾄﾞ---

DNM_STEP_INF1_MV450:
	MOV.L	R0,@R14				;
	XOR	#BIT1,R0			;
	MOV.L	R0,@R13
	ADD	#4,R14				;往路
	ADD	#4,R13				;復路
	ADD	#1,R8				;
	M_BRA	DNM_STEP_INF1_MVLP01



DNM_STEP_INF1_MV500:


	SUB_END
	M_RTS




;	***************************************************
;	***						***
;	***	速度連続と運転方向の作成		***
;	***	この処理は起動前に単独で行っていい	***
;	***						***
;	***************************************************
;	どんな運転でも、１回転内で終わるステップ情報を作成する
;	但し、回転連続・寸動の場合のみ速度連続の情報は残す
;	"正転運転用"
;
_STEP_INF2_STEPMOV:
	SUB_START
	MOV.L	#_SETX_POS_STEP_MAX,R1		;//設定= 1~10
	MOV.W	@R1,R5				;ｽﾃｯﾌﾟ最大数 1~10
						;1~10(2~11の意味)
	MOV	R5,R6				;R6(連続ｽﾃｯﾌﾟの最後の段)
	MOV.L	#_SETX_POS_SDAT1_CNTSTEP,R13	;
	MOV.L	#_SETX_POS_SDAT1_INF1,R14	;
	MOV	R5,R1				;
	SHLL2	R1				;*4byte
	ADD	R1,R13				;ﾗｽﾄ CONT
	ADD	R1,R14				;ﾗｽﾄ

	MOV	R6,R1				;
	ADD	#1,R1				;0~10 1~11

	MOV.L	R1,@R13				;
	ADD	#-4,R13				;
	ADD	#-4,R14				;
	ADD	#-1,R5				;

STEP_INF2_MVLP01:

	MOV.L	@R14,R0				;CONF
	TST	#BIT0,R0			;速度連続?
	TST_BIT_ON STEP_INF2_MV100		;YES
	MOV	R5,R6				;今のｽﾃｯﾌﾟを入れる
STEP_INF2_MV100:
	MOV	R6,R1				;
	ADD	#1,R1				;
	MOV.L	R1,@R13				;
	TST	R5,R5				;
	TST_BIT_OF STEP_INF2_MV200		;
	ADD	#-4,R13				;
	ADD	#-4,R14				;
	ADD	#-1,R5				;
	M_BRA	STEP_INF2_MVLP01		;

STEP_INF2_MV200:

	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***	連続・回転の運転方法	***
;	***	2004-12-20		***
;	***********************************
_STEP_BANK_USE_CHK:
	SUB_START
	XOR	R2,R2
	MOV.L	#_SETX_POS_MOD_FLG1,R1		;
	MOV.W	@R1,R0				;
	AND	#(BIT2+BIT0),R0			;
	CMP/EQ	#(BIT2+BIT0),R0			;
	BF	STEP_BANK_USECHK_END		;

	MOV.W	#BIT0,R2			;

STEP_BANK_USECHK_END:
	MOV.L	#_SETX_BANK_USELFUL,R1		;上死点がない
	MOV.W	R2,@R1				;

	SUB_END
	M_RTS

_STEP_TIM_0CHK:
	SUB_START

;	XOR	R2,R2				;ANS(BIT3=0/1)
	MOV.W	#BIT3,R2			;

	MOV.L	#_SETX_POS_STEP_MAX,R1		;
	MOV.W	@R1,R4				;
	MOV	R4,R0				;
	ADD	#-1,R4				;
	SHLL2	R4				;
	MOV.L	#_SETX_POS_SDAT1_TIM,R1		;
	ADD	R4,R1				;

STEP_TIM0CHK_LOP:
	MOV.L	@R1,R4				;TIM-LOAD
	TST	R4,R4				;
	TST_BIT_OF STEP_TIM0CHK_100		;T=0 
	XOR	R2,R2				;ﾀｲﾏ発見ANS(BIT3=0/1)
STEP_TIM0CHK_100:
	ADD	#-4,R1
	ADD	#-1,R0
	TST	R0,R0				;
	TST_BIT_ON STEP_TIM0CHK_LOP		;

	SUB_END
	M_RTS





;	*******************************************
;	***					***
;	*******************************************
;	荷重設定2BYTE→4BYTE
;	ｼｽﾊﾟﾗ,ｼｰｹﾝｽのｲﾝﾀｰﾛｯｸ
_STEP_KJYUOBJ_MOV:
	SUB_START

	.AIF	_KJYU_CLS EQ	_CMPILE_YES		;YES:反転ﾓｰﾄﾞで荷重でのｸﾛｰｽﾞを行う
;;;;;;;;;2017-08-15
;;;;;;;;;2017-08-15	MOV.L	#_SEQAB_DP_TOP+53*2,R1			;2015-04-10 CPUBにはこれしか見えない
;;;;;;;;;2017-08-15	MOV.W	@R1,R0					;
;;;;;;;;;2017-08-15	MOV.W	#H'3FF,R4				;
;;;;;;;;;2017-08-15	AND	R4,R0					;
;;;;;;;;;2017-08-15	MOV.L	#_SETX_FULCLS_MATEHD_SW,R1		;
;;;;;;;;;2017-08-15	MOV.W	@R1,R4					;OLD-LOAD
;;;;;;;;;2017-08-15	MOV.W	R0,@R1					;NEW-SAVE
;;;;;;;;;2017-08-15
;;;;;;;;;2017-08-15	CMP/EQ	R4,R0
;;;;;;;;;2017-08-15	BT	STEP_KJYUOBJ_MV020			;
;;;;;;;;;2017-08-15
;;;;;;;;;2017-08-15	MOV.L	#_SV_CHG_FLG2,R1			;異常
;;;;;;;;;2017-08-15	MOV.L	@R1,R0					;
;;;;;;;;;2017-08-15	MOV.B	#BIT1,R0				;
;;;;;;;;;2017-08-15	MOV.L	R0,@R1					;
;;;;;;;;;2017-08-15
;;;;;;;;;2017-08-15STEP_KJYUOBJ_MV020:

	MOV.L	#_SVPX1_OBJECT_PRS_TOP,R5		;2015-09-30[_X1_]
	MOV.L	#_SETX_KJYUCLS_OBJ,R6			;

;	------- 2015-09-30---------
	MOV.L	#_SET1_MTSTEP_MAXM,R1			;
	MOV.W	@R1,R3					;
	TST	R3,R3
	TST_BIT_OF STEP_KJYUOBJ_MV150			;

;;;;	MOV.W	#D'10,R3				;MAXM

STEP_KJYUOBJ_MVLOP100:
	MOV.W	@R5+,R2
	MOV.L	R2,@R6
	ADD	#4,R6
	ADD	#-1,R3
	TST	R3,R3
	TST_BIT_ON STEP_KJYUOBJ_MVLOP100		;

STEP_KJYUOBJ_MV150:

	.AENDI


	SUB_END
	M_RTS




;	***********************************
;	***				***
;	***	段取工程制御		***
;	***				***
;	***********************************

_DND_STEP_CTRL_DT_MOV:
	SUB_START

	FAR_JSR	#_DND_STEP_SET_CHK,R0	;

	DATA_STD_CHG_MOV SRC=_SVP_DNDINC_SPD1	,L1=W	,DST=_SET1_TEPCTL_SPD1	,L2=L,CALLSB=_CYCLE_SPD1	;//4;


	MEM_MOV_TO_MEM	SRC_ADR=_SETX_UPAREA_DIG,L1=W,DST_ADR=_SET1_DND_STOPDIG_UP,L2=W,WKREG1=R1,WKREG2=R2,WKREG3=R3
	MEM_MOV_TO_MEM	SRC_ADR=_SETX_UPAREA_PLS,L1=L,DST_ADR=_SET1_DND_UPPLS,L2=L,WKREG1=R1,WKREG2=R2,WKREG3=R3

	DATA_STD_SHN_MOV SRC=_SET1_DND_STOPDIG_UP	,L1=W	,DST=_SET1_DND_DIGTOP+0*2	,L2=W	;2;上
	DATA_STD_CHG_MOV SRC=_SVP_DND_STOPDIG1		,L1=W	,DST=_SET1_DND_DIGTOP+1*2	,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;LINK(360)
	DATA_STD_CHG_MOV SRC=_SVP_DND_STOPDIG1		,L1=W	,DST=_SET1_DND_DIGTOP+2*2	,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1;2;

;	----目標位置pls作成 N回転+---
	DATA_LOP_CHG_MOV	SRC=_SET1_DND_DIGTOP,L1=W,DST=_SET1_DND_PLSTOP	,L2=L		;
+				,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS				;PLS変換
+				,LOOP=_EQ_DND_MAX,CNT_REG=R7,DSTADD=4				;MAX=3

	SUB_END
	M_RTS



;	***********************************
;	***				***
;	***	STOP 情報		***
;	***				***
;	***********************************
_DND_STEP_SET_CHK:
	SUB_START

	XOR	R2,R2				;CNT
	XOR	R0,R0				;BIT
	MOV.L	#_SEQAB_DP_TOP+32*2,R1		;
	MOV.W	@R1,R3				;
	MOV.W	#BIT8,R4			;
	TST	R4,R3				;上
	TST_BIT_OF DND_STEPSET_CK050		;
	OR	#BIT0,R0			;
	ADD	#1,R2				;
DND_STEPSET_CK050:

	MOV.W	#BIT9,R4			;途中
	TST	R4,R3				;
	TST_BIT_OF DND_STEPSET_CK100		;
	OR	#BIT1,R0			;
	ADD	#1,R2				;
DND_STEPSET_CK100:
	
	MOV.L	#_SET1_DND_STOP_SW,R1		;0,BIT0,BIT1
	MOV.W	R0,@R1				;

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	起動時のﾃﾞｰﾀ固定化		***
;	***	転送	(POS)			***
;	*******************************************
	.EXPORT	_DND_POS_START_DAT_INI
_DND_POS_START_DAT_INI
	SUB_START
	MEM_MOV_TO_MEM	SRC_ADR=_SET1_DND_STOP_SW,L1=W,DST_ADR=_CPOS_DND_STOP_SW,L2=W,WKREG1=R1,WKREG2=R2,WKREG3=R3
	MEM_MOV_TO_MEM	SRC_ADR=_SET1_DND_DIGTOP+0*2,L1=W,DST_ADR=_CPOS_DND_DIGTOP+0*2,L2=W,WKREG1=R1,WKREG2=R2,WKREG3=R3	;対起点
	MEM_MOV_TO_MEM	SRC_ADR=_SET1_DND_DIGTOP+1*2,L1=W,DST_ADR=_CPOS_DND_DIGTOP+1*2,L2=W,WKREG1=R1,WKREG2=R2,WKREG3=R3	;対起点

	MEM_MOV_TO_MEM	SRC_ADR=_SET1_DND_PLSTOP+0*4,L1=L,DST_ADR=_CPOS_DND_PLSTOP+0*4,L2=L,WKREG1=R1,WKREG2=R2,WKREG3=R3	;対起点
	MEM_MOV_TO_MEM	SRC_ADR=_SET1_DND_PLSTOP+1*4,L1=L,DST_ADR=_CPOS_DND_PLSTOP+1*4,L2=L,WKREG1=R1,WKREG2=R2,WKREG3=R3	;対起点

	SUB_END
	M_RTS




;	***********************************
;	***				***
;	***	実測作成		***
;	***				***
;	***********************************
;	MAIN-LOOP

_CALC_DATA_LOOP_MAKE1:
	SUB_START
	SUB_END
	M_RTS

;	***********************************
;	***	現在目標角度 兼 実測	***
;	***********************************
	.EXPORT	_NOW_INC_DIG_MAK	;
;	dig * 8192
;	Y[pls]＝1回転パルス(8192)*Ｎ回転(32)*3600／Ｍ度[0.1度](3600)
;	DIG=Y*M/(8192*32)

_NOW_INC_DIG_MAK:
	SUB_START

	MOV.L	#_LINK_RL_OBJ_ABSPLS,R4					;
	MOV.L	@R4+,R1							;
	MOV.L	@R4,R2							;(制御目標値/今は実測だけど)

	FAR_JSR	#_POSCHG_LINK_ABSPLS_ROTNUM_OFSPLS,R0			;R1,R2+/-回転数 余りパルス(符号つき)
;R2:回転数
;R5,R6: R2回転相当のﾊﾟﾙｽ数
;R3:+/-ｵﾌｾｯﾄﾊﾟﾙｽ

	CMP/PZ	R3					;
	BT	NOW_INC_ROT_CAL_100			;
;	--- [本来は1回転を引かないといけない2011-03-22]--
	ADD	#-1,R2					;その１回引くことに対応
	MOV.L	#_LINK_1ROT_PLS,R1			;
	MOV.L	@R1,R4					;
	ADD	R4,R3					;
	CMP/PZ	R3					;
	BT	NOW_INC_ROT_CAL_100			;
	XOR	R3,R3					;"演算誤差0":ありえないはず?BREAK CHEAK
NOW_INC_ROT_CAL_100					;

	MOV.L	#_LINK_NOWROT_NUM_ZR,R4					;//回転数
	MOV.L	R2,@R4							;
	MOV.L	#_LINK_NOWROT_NUMPLS_ZR,R4				;//RL_OBJ_ABSPLS/nm = 回転数相当のﾊﾟﾙｽ
	MOV.L	R5,@(0,R4)						;
	MOV.L	R6,@(4,R4)						;
	MOV.L	#_LINK_NOWROT_OFSPLS,R4					;(+/-　使用しない?反転でも使用しないですむ?	)
	MOV.L	R3,@R4							;
	MOV.L	#_LINK_NOWROT_OFSPLS_P,R4				;[[[目標]]]
	MOV.L	R3,@R4							;



;;;;	MOV.L	#_LINK_NOWROT_NUM_ZR,R4					;//回転数
;;;;	MOV.L	R2,@R4							;
;;;;	MOV.L	#_LINK_NOWROT_NUMPLS_ZR,R4				;//RL_OBJ_ABSPLS/nm = 回転数相当のﾊﾟﾙｽ
;;;;	MOV.L	R5,@(0,R4)						;
;;;;	MOV.L	R6,@(4,R4)						;
;;;;	MOV.L	#_LINK_NOWROT_OFSPLS,R4					;[[[目標]]]
;;;;	MOV.L	R3,@R4							;
;;;;
;;;;	MOV	R3,R2			;ﾊﾟﾙｽ
;;;;	CMP/PZ	R2						;
;;;;	BT	NOW_INC_ROT_CAL_100				;
;;;;	MOV.L	#_LINK_1ROT_PLS,R1				;[本来は1回転を引かないといけない2011-03-22]
;;;;	MOV.L	@R1,R4						;
;;;;	ADD	R4,R2						;
;;;;	CMP/PZ	R2						;
;;;;	BT	NOW_INC_ROT_CAL_100				;
;;;;	XOR	R2,R2						;"演算誤差0":ありえないはず?BREAK CHEAK
;;;;NOW_INC_ROT_CAL_100						;
;;;;	MOV.L	#_LINK_NOWROT_OFSPLS_P,R4			;[[[目標]]]
;;;;	MOV.L	R2,@R4						;

;	------------ 2014-10-06-------------
	MOV.L	#_LINK_NOWROT_OFSPLS_P,R4				;[[[目標]]]
	MOV.L	@R4,R2							;

	MOV.L	#_SETY_INCPLS_HOSM01X,R0			;//0.1度
	MOV.L	@R0,R1						;
	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0			;
	MOV.L	@R0,R4						;R2:X回転
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;R2*1REV*HOSN/HOSM
	MOV.L	#_OBJ_ENC360,R1					;未使用
	MOV.W	R2,@R1						;

	FAR_JSR	#_PV_LINK_DG_CHG_CLNK_DG1,R0	;R0,R1,R2のみ使用

	MOV.L	#_OBJDIG_CLANK,R1		;
	MOV.W	R2,@R1				;

;	------------------------ 実測側---------------------
	MOV.L	#_LINK_PV_ABSPLS,R4					;20060919
	MOV.L	@R4+,R1							;
	MOV.L	@R4,R2							;(制御目標値/今は実測だけど)

	FAR_JSR	#_POSCHG_LINK_ABSPLS_ROTNUM_OFSPLS,R0			;R1,R2+/-回転数 余りパルス(符号つき)

;;;;;;;未使用	MOV.L	#_INCENC_LINK_NOWROT_NUM_ZR,R4				;//回転数
;;;;;;;未使用	MOV.L	R2,@R4							;
;;;;;;;未使用	MOV.L	#_INCENC_LINK_NOWROT_NUMPLS_ZR,R4				;//RL_OBJ_ABSPLS/nm = 回転数相当のﾊﾟﾙｽ
;;;;;;;未使用	MOV.L	R5,@(0,R4)						;
;;;;;;;未使用	MOV.L	R6,@(4,R4)						;
;;;;;;;未使用	MOV.L	#_INCENC_LINK_NOWROT_OFSPLS,R4		;+/- data
;;;;;;;未使用	MOV.L	R3,@R4					;

	MOV	R3,R2						;ﾊﾟﾙｽ
	CMP/PZ	R2						;
	BT	NOW_INC_ROT_CAL_200				;
	MOV.L	#_LINK_1ROT_PLS,R1				;
	MOV.L	@R1,R4						;
	ADD	R4,R2						;
	CMP/PZ	R2						;
	BT	NOW_INC_ROT_CAL_200				;
	XOR	R2,R2						;"演算誤差0":ありえないはず?BREAK CHEAK
NOW_INC_ROT_CAL_200						;
	MOV.L	#_INC_LINK_NOWROT_OFSPLS_P,R4			;[[[実測 1REV PLS]]]
	MOV.L	R2,@R4						;

	MOV.L	#_SETY_INCPLS_HOSM01X,R0			;//0.1度
	MOV.L	@R0,R1						;

	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0			;
	MOV.L	@R0,R4						;R2:X回転
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;R2*1REV*HOSN/HOSM



	MOV.L	#_INC_ENC360,R1						;
	MOV.W	R2,@R1							;

	MOV.L	#_DISP_ENC360,R1	;
	MOV.W	R2,@R1			;0.1度
	SUB_END
	M_RTS

;	***************************************************
;	***		目標位置の角度			***
;	***************************************************
	.EXPORT		_OBJ_POS_DIG_MAK
_OBJ_POS_DIG_MAK:
	SUB_START
	PUSH_ALL
	MOV.L	#_LINK_SV_OBJ_ABSPLS,R4		;(はじめの起動分はﾒｲﾝで作られている)
	MOV.L	@R4+,R1							;
	MOV.L	@R4,R2							;(制御目標値/今は実測だけど)

	FAR_JSR	#_POSCHG_LINK_ABSPLS_ROTNUM_OFSPLS,R0			;R1,R2+/-回転数 余りパルス(符号つき)

	MOV	R3,R2				;ﾊﾟﾙｽ
	CMP/PZ	R2						;
	BT	SV_OBJ_ROT_CAL_100				;
	MOV.L	#_LINK_1ROT_PLS,R1				;
	MOV.L	@R1,R4						;
	ADD	R4,R2						;
	CMP/PZ	R2						;
	BT	SV_OBJ_ROT_CAL_100				;
	XOR	R2,R2						;"演算誤差0":ありえないはず?BREAK CHEAK
SV_OBJ_ROT_CAL_100						;R2=OFSET_PLS

	MOV.L	#_SETY_INCPLS_HOSM01X,R0			;//0.1度
	MOV.L	@R0,R1						;

	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0			;
	MOV.L	@R0,R4						;R2:X回転
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;R2*1REV*HOSN/HOSM
	MOV.L	#_SV_OBJ360,R1					;
	MOV.W	R2,@R1						;
								;ANS R2
	POP_ALL
	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***	待機点ﾃﾞｰﾀ算出		***
;	***				***
;	***********************************
;	R0=00 ok
;	R0=FF NG
;	待機点となる回転数の算出
;	Onput 	R1,R2 	回転数相当のﾊﾟﾙｽ
;	Output	R3	回転数
;	これに待機点を足せば、待機点絶対位置になる
_UP_AREA_DATCHK:
	SUB_START
	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***					***
;	***	位置決め			***
;	***	1msec/200usec処理用		***
;	***	制御データ変換			***
;	***					***
;	*******************************************
;	_CPOS_INI1_DTMOV1:ﾜｰｸ→位置決めﾜｰｸへ(運転中のﾃﾞｰﾀ保証)
;
;
	.EXPORT	_CPOS_INI1_DTMOV1;-->ssa_pos1.src
	.EXPORT	_CPOS_INI1_DTMOV2;-->ssa_pos1.src
	.EXPORT	_CPOS_ROT_NUM_SET;-->ssa_pos1.src
	.EXPORT	_CPOS_ABS_POS_SET;-->ssa_pos1.src

_CPOS_INI1_DTMOV1:
	SUB_START
	DATA_STD_SHN_MOV SRC=_SETX_POS_MOD_FLG1	,L1=W,DST=_CPOS_MOD_FLG1,L2=W;
	DATA_STD_SHN_MOV SRC=_SETX_POS_CTL_MATH	,L1=W,DST=_CPOS_CTL_MATH,L2=W;
	DATA_STD_SHN_MOV SRC=_SETX_POS_STEP_MAX	,L1=W,DST=_CPOS_STEP_MAX,L2=W;

;;;[2009-10-07下振子]	DATA_STD_SHN_MOV SRC=_SETX_UPAREA_PLS	,L1=L,DST=_CPOS_UPAREA_PLS,L2=L;
;	=== [2009-10-07下振子]2007-04-03 ==
	MOV.L	#_SETX_POS_CTL_MATH,R1							;
	MOV.W	@R1,R0									;
	TST	#_DMATH_DNDRIV,R0
	TST_BIT_OF CPOS_INI1_DTMV1_050							;

	MOV.L	#_DNM_DIR_NOW_FLG,R1							;
	MOV.W	@R1,R0									;
	TST	R0,R0									;
	TST_BIT_OF CPOS_INI1_DTMV1_050							;往路

	DATA_STD_SHN_MOV SRC=_DNM_SETX_UPAREA_PLS	,L1=L,DST=_CPOS_UPAREA_PLS,L2=L;
	M_BRA	CPOS_INI1_DTMV1_100							;


CPOS_INI1_DTMV1_050:
	DATA_STD_SHN_MOV SRC=_SETX_UPAREA_PLS	,L1=L,DST=_CPOS_UPAREA_PLS,L2=L;
CPOS_INI1_DTMV1_100:

;	=== 2004-12-20 ==
	DATA_STD_SHN_MOV SRC=_SETX_BANK_USELFUL	,L1=W,DST=_CPOS_BANK_USELFUL,L2=W;

	SUB_END
	M_RTS



_CPOS_INI1_DTMOV2:
	SUB_START
	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R8				;LOOP data 1~10
	XOR	R0,R0

	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R3	;
	MOV.L	#_SETX_POS_SDAT1_SPD,R4		;
	MOV.L	#_SETX_POS_SDAT1_TIM,R5		;
	MOV.L	#_SETX_POS_SDAT1_CNTSTEP,R6	;
	MOV.L	#_SETX_POS_SDAT1_INF1,R7	;

;	=== [2009-10-07下振子]2007-04-03 ==
	PUSH_REG1 R0
	MOV.L	#_SETX_POS_CTL_MATH,R1		;
	MOV.W	@R1,R0				;
	TST	#_DMATH_DNDRIV,R0
	TST_BIT_OF CPOS_INI1_DTMV2_100		;

	MOV.L	#_DNM_DIR_NOW_FLG,R1		;起動時は確定しているDNM_DIR_SET_FLG->NOW
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_OF CPOS_INI1_DTMV2_100		;往路

	MOV.L	#_SETX_POS_SDAT2_OFSPOS,R3	;
	MOV.L	#_SETX_POS_SDAT2_INF1,R7	;

CPOS_INI1_DTMV2_100:
	POP_REG1 R0
;	====== [2009-10-07下振子]2007-04-03=====

	MOV.L	#_CPOS_SDAT1_OFSPOS,R10		;//SETX-->起動時COPY
	MOV.L	#_CPOS_SDAT1_SPD,R11		;//SETX-->起動時COPY
	MOV.L	#_CPOS_SDAT1_TIM,R12		;//SETX-->起動時COPY
	MOV.L	#_CPOS_SDAT1_CNTSTEP,R13	;//SETX-->起動時COPY
	MOV.L	#_CPOS_SDAT1_INF1,R14		;//SETX-->起動時COPY

CPOS_INI1_DTMV2_LOP:
	MOV.L	@R3+,R1				;
	MOV.L	R1,@(R0,R10)			;
	MOV.L	@R4+,R1				;
	MOV.L	R1,@(R0,R11)			;
	MOV.L	@R5+,R1				;
	MOV.L	R1,@(R0,R12)			;
	MOV.L	@R6+,R1				;
	MOV.L	R1,@(R0,R13)			;
	MOV.L	@R7+,R1				;
	MOV.L	R1,@(R0,R14)			;
	ADD	#4,R0				;
	TST	R8,R8				;
	TST_BIT_OF CPOS_INI1_DTMV2_500		;
	ADD	#-1,R8				;
	M_BRA	CPOS_INI1_DTMV2_LOP		;
CPOS_INI1_DTMV2_500:

;	-------------０度＜０点（０〜１度）＜待機点---------------------------
;	-------------０度＜待機点＜０点（３００〜３５９）[-1]-----------------
	MOV.L	#_SETX_UPAREA_PLS,R4		;待機点
	MOV.L	#_DNM_DIR_NOW_FLG,R1		;起動時は確定しているDNM_DIR_SET_FLG->NOW
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_OF CPOS_INI1_DTMV2_600		;
	MOV.L	#_DNM_SETX_UPAREA_PLS,R4	;//4;待機点
CPOS_INI1_DTMV2_600:
	MOV.L	@R4,R0
	MOV.L	#_CPOS_SDAT1_UP_OFSPOS,R4	;//2014-09-20 上死点 繰返に開始側の待機点も必要
	MOV.L	R0,@R4


	.AIF	_KJYU_CLS EQ	_CMPILE_YES		;YES:反転ﾓｰﾄﾞで荷重でのｸﾛｰｽﾞを行う
	MOV.L	#_SETX_FULCLS_MATEHD_SW,R1
	MOV.W	@R1,R2
	MOV.L	#_CPOS_FULCLS_MATEHD_SW,R1		;
	MOV.W	R2,@R1

	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R3				;LOOP data 1~10

	MOV.L	#_SETX_KJYUCLS_OBJ,R5
	MOV.L	#_CPOS_KJYUCLS_OBJ,R6
	BLOCK_MOV1 LG=L,AD_DT=4,SRC_REG=R5,DST_REG=R6,DATA_REG=R0,CNT_REG=R3

	.AENDI

	SUB_END
	M_RTS


;	***********************************
;	***	連続の速度変更		***
;	***	2003-07-09		***
;	***********************************
	.EXPORT	_CPOS_SPD_DTMOV
_CPOS_SPD_DTMOV:
	SUB_START
	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R3				;LOOP data 1~10

	MOV.L	#_SETX_POS_SDAT1_SPD,R1		;
	MOV.L	#_CPOS_SDAT1_SPD,R2		;//SETX-->起動時COPY

CPOS_SPD_DTMV_LOP:
	MOV.L	@R1+,R0				;
	MOV.L	R0,@R2				;
	ADD	#4,R2				;
	TST	R3,R3				;
	TST_BIT_OF CPOS_SPD_DTMV_050
	ADD	#-1,R3				;
	M_BRA	CPOS_SPD_DTMV_LOP		;
CPOS_SPD_DTMV_050:

	SUB_END
	M_RTS


;	***********************************
;	***	連続のタイマ変更	***
;	***	2003-07-14		***
;	***********************************
	.EXPORT	_CPOS_TIM_DTMOV
_CPOS_TIM_DTMOV:
	SUB_START

	XOR	R5,R5
	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R3				;LOOP data 1~10

	MOV.L	#_SETX_POS_SDAT1_TIM,R1		;
	MOV.L	#_CPOS_SDAT1_TIM,R2		;

CPOS_TIM_DTMV_LOP:
	MOV.L	@R1+,R0				;
	MOV.L	@R2,R4				;
	TST	R0,R0				;
	TST_BIT_ON CPOS_TIM_DTMV_020		;
	TST	R4,R4				;R0=0(NEW) R4=0(OLD)
	TST_BIT_OF CPOS_TIM_DTMV_040		;0/0ならOK
	MOV.B	#BIT0,R5			;ERR
	M_BRA	CPOS_TIM_DTMV_040		;

CPOS_TIM_DTMV_020:
	TST	R4,R4				;
	TST_BIT_ON CPOS_TIM_DTMV_040		;!=0/!=0 THEN OK
	MOV.B	#BIT0,R5			;ERR
	M_BRA	CPOS_TIM_DTMV_040		;

CPOS_TIM_DTMV_040:
	MOV.L	R0,@R2				;
	ADD	#4,R2				;
	TST	R3,R3				;
	TST_BIT_OF CPOS_TIM_DTMV_100
	ADD	#-1,R3				;
	M_BRA	CPOS_TIM_DTMV_LOP		;
CPOS_TIM_DTMV_100:

	MOV.L	#_SV_CHG_FLG1,R1		;
	MOV.L	R5,@R1				;

	SUB_END
	M_RTS



;	***********************************
;	***				***
;	***	連続のタイマCHECK	***
;	***	2007-12-28		***
;	***				***
;	***********************************
;	---- 2007-12-28 ﾀｲﾏを0<=>0以外に切り替えたら異常とする
;
_TIMER_CHG_CHECK:
	SUB_START

;;;;;2015-10-25	MOV.L	#_SVP_UPAREA_TIM0,R1		;待機点停止時間
;;;;;		MOV.W	@R1,R0				;

	XOR	R7,R7				;FLG

	MOV.L	#_SVP_UPAREA_TIM0,R1		;
	MOV.W	@R1,R2				;
	MOV.L	#_CHK_SET1_UPAREA_TIM0,R1	;待機時間
	MOV.W	@R1,R0				;
	MOV.W	R2,@R1				;

	TST	R0,R0				;
	TST_BIT_ON SVPCHG_TIM_DTMV_005		;
	TST	R2,R2				;
	TST_BIT_OF SVPCHG_TIM_DTMV_010		;
	MOV.B	#BIT0,R7			;変更有り
	M_BRA	SVPCHG_TIM_DTMV_010

SVPCHG_TIM_DTMV_005:
	TST	R2,R2				;
	TST_BIT_ON SVPCHG_TIM_DTMV_010		;
	MOV.B	#BIT0,R7			;変更有り
SVPCHG_TIM_DTMV_010:

	MOV.L	#_SVPX1_OBJECT_TIM_TOP,R1	;2byte
	MOV.L	#_CHK_OBJECT_TIM_TOP,R2		;2014-09-20

	MOV.L	#_SET1_MTSTEP_MAXM,R3		;
	MOV.W	@R3,R3				;2015-09-30_EQ_STEP_MX2

;;;;	XOR	R5,R5				;

SVPCHG_TIM_DTMV_LOP:

	TST	R3,R3				;
	TST_BIT_OF SVPCHG_TIM_DTMV_090

	MOV.W	@R1+,R0				;SV DPRAM data
	MOV.L	@R2,R4				;SV*10 data
	MOV.L	R0,@R2				;
	ADD	#4,R2				;

	TST	R0,R0				;
	TST_BIT_ON SVPCHG_TIM_DTMV_020		;
	TST	R4,R4				;R0=0(NEW) R4=0(OLD)
	TST_BIT_OF SVPCHG_TIM_DTMV_040		;0/0ならOK
	MOV.B	#BIT1,R7			;変更有り
	M_BRA	SVPCHG_TIM_DTMV_040		;ERR

SVPCHG_TIM_DTMV_020:
	TST	R4,R4				;
	TST_BIT_ON SVPCHG_TIM_DTMV_040		;!=0/!=0 THEN OK
	MOV.B	#BIT1,R7			;変更有り

SVPCHG_TIM_DTMV_040:
	ADD	#-1,R3				;
	M_BRA	SVPCHG_TIM_DTMV_LOP		;




SVPCHG_TIM_DTMV_090:
	TST	R7,R7
	TST_BIT_OF SVPCHG_TIM_DTMV_100		;

	FAR_JSR	#_API_TIM_DATA_CHG_SIG_ON,R0	;2015-10-25

;;;	MOV.L	#_SV_CHG_FLG1,R1		;
;;;	MOV.W	@R1,R0				;
;;;	OR	#BIT0,R0
;;;	MOV.L	R0,@R1				;


SVPCHG_TIM_DTMV_100:


	SUB_END
	M_RTS











;	***********************************
;	***				***
;	***	回転数設定		***
;	***				***
;	***********************************
;	Input R2:現在回転数X(払出しﾊﾟﾙｽTOTALから作成)
_CPOS_ROT_NUM_SET:
	SUB_START

;;;2014-09-20未使用	MOV.L	#_CPOS_SDAT1_NUM,R14		;//起動時,その他で演算
;;;2014-09-20未使用	MOV.L	R2,@R14				;+0
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+1
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+2
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+3
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+4
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+5
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+6
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+7
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+8
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+9
;;;2014-09-20未使用	ADD	#4,R14				;
;;;2014-09-20未使用	MOV.L	R2,@R14				;+10

	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***	目標絶対位置作成	***
;	***				***
;	***********************************
;	(1)OFS+1REV-->ABS1~11　切替位置
;	(2)このうち連続データ　目標位置
;	Input R2=_LINK_OBJROT_NUM_ZRに入れる回転数
_CPOS_ABS_POS_SET:
	SUB_START
;	=============================
	MOV.L	#_LINK_OBJROT_NUM_ZR,R1		;//NOW ROTATION 番号
	MOV.L	R2,@R1				;
	FAR_JSR	#_POSCHG_LINK_ROTNUM_PLS,R1	;
	MOV.L	#_LINK_OBJROT_NUMPLS_ZR,R0	;//NOW ROTATION番号相当のﾊﾟﾙｽ
	MOV.L	R1,@R0				;
	MOV.L	R2,@(4,R0)			;
	MOV	R1,R5				;
	MOV	R2,R6				;R5,R6

	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R8				;LOOP data 1~10
	MOV	R8,R0

;	==== Input data====
	SHLL2	R0				;
	MOV.L	#_CPOS_SDAT1_OFSPOS,R11		;//SETX-->起動時COPY
	ADD	R0,R11				;
	MOV.L	#_CPOS_SDAT1_INF1,R12		;_CPOS_SDAT1_CNTSTEP,R12	;//SETX-->起動時COPY
	ADD	R0,R12				;
;	==== Output data====
	SHLL	R0
	MOV.L	#_CPOS_SDAT1_CHGAPOS,R13	;8byte
	ADD	R0,R13				;
	MOV.L	#_CPOS_SDAT1_STPAPOS,R14	;8byte
	ADD	R0,R14				;

	XOR	R9,R9
	MOV.L	@R11,R10				;LAST data
;---- 2010-10-25--
	CMP/PZ	R10				;
	BT	CPOS_ABSPOS_SET020		;
	ADD	#-1,R9				;
CPOS_ABSPOS_SET020:				;
;	--------

	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R9,DT_ANS_REGL=R10

;	=== 2004-12-20 ==
	MOV.L	#_BANK1_LK_END_OBJ_ABSPLS,R1	;(戻り位置)
	MOV.L	R9,@R1				;
	MOV.L	R10,@(4,R1)			;

CPOS_ABSPOS_SET_LOP:				;

	MOV.L	@R11,R2					;
	XOR	R1,R1					;
;---- 2010-10-25--
	CMP/PZ	R2				;
	BT	CPOS_ABSPOS_SET040		;
	ADD	#-1,R1				;
CPOS_ABSPOS_SET040:				;
;	--------

	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R1,DT_ANS_REGL=R2

	MOV.L	@R12,R0			;
	TST	#BIT0,R0		;BIT0=1連続
	TST_BIT_ON CPOS_ABSPOS_SET050	;連続
	MOV	R1,R9			;
	MOV	R2,R10			;
CPOS_ABSPOS_SET050:			;
	MOV.L	R9,@(0*4,R14)		;連続時の目標位置
	MOV.L	R10,@(1*4,R14)		;

	MOV.L	R1,@(0*4,R13)		;切り替え位置(本当は,速度差を演算する必要がある)
	MOV.L	R2,@(1*4,R13)		;

	ADD	#-4,R11			;
	ADD	#-4,R12			;
	ADD	#-8,R13			;
	ADD	#-8,R14			;

	TST	R8,R8			;
	TST_BIT_OF CPOS_ABSPOS_SET_200	;
	ADD	#-1,R8			;
	M_BRA	CPOS_ABSPOS_SET_LOP	;
CPOS_ABSPOS_SET_200:			;


;	---------------ﾘﾋﾟｰﾄ用機点-------------------------
	FAR_JSR	#_CPOS_UP_ABSPOS_SET,R0		;ﾘﾋﾟｰﾄ用だが、共通


	SUB_END
	M_RTS


;	***********************************
;	***				***
;	***	目標絶対位置作成	***
;	***	BANK2ﾃﾞｰﾀ作成		***
;	***	2004-12-20		***
;	***********************************
;	(1)OFS+1REV-->ABS1~11　切替位置
;	(2)このうち連続データ　目標位置
;	Input R2=_LINK_OBJROT_NUM_ZR +1 に入れる回転数
	.EXPORT	_BANK2_TO_BANK1_MOV
	.EXPORT	_BANK2_CPOS_ABS_POS_SET

_BANK2_CPOS_ABS_POS_SET:
	SUB_START
;	=============================
	MOV.L	#_BANK2_LINK_OBJROT_NUM_ZR,R1		;//NOW ROTATION 番号
	MOV.L	R2,@R1					;
	FAR_JSR	#_POSCHG_LINK_ROTNUM_PLS,R1		;
	MOV.L	#_BANK2_LINK_OBJROT_NUMPLS_ZR,R0	;//NOW ROTATION番号相当のﾊﾟﾙｽ
	MOV.L	R1,@R0				;
	MOV.L	R2,@(4,R0)			;
	MOV	R1,R5				;
	MOV	R2,R6				;R5,R6

	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R8				;LOOP data 1~10
	MOV	R8,R0

;	==== Input data====
	SHLL2	R0				;
	MOV.L	#_CPOS_SDAT1_OFSPOS,R11		;//SETX-->起動時COPY
	ADD	R0,R11				;
	MOV.L	#_CPOS_SDAT1_INF1,R12		;_CPOS_SDAT1_CNTSTEP,R12	;//SETX-->起動時COPY
	ADD	R0,R12				;
;	==== Output data====
	SHLL	R0
	MOV.L	#_CPOS_SDAT1_CHGAPOS2,R13				;8byte
	ADD	R0,R13							;
	MOV.L	#_CPOS_SDAT1_STPAPOS2,R14				;8byte
	ADD	R0,R14							;

	XOR	R9,R9
	MOV.L	@R11,R10						;
	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R9,DT_ANS_REGL=R10	;(0,R10)+(回転*PLS)

;	=== 2004-12-20 ==
	MOV.L	#_BANK2_LK_END_OBJ_ABSPLS,R1	;
	MOV.L	R9,@R1				;
	MOV.L	R10,@(4,R1)			;


BANK2_CPOS_ABSPOS_SET_LOP:				;

	MOV.L	@R11,R2					;
	XOR	R1,R1					;
	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R1,DT_ANS_REGL=R2

	MOV.L	@R12,R0			;
	TST	#BIT0,R0		;BIT0=1連続
	TST_BIT_ON BANK2_CPOS_ABSPOS_SET050	;連続
	MOV	R1,R9			;
	MOV	R2,R10			;
BANK2_CPOS_ABSPOS_SET050:			;
	MOV.L	R9,@(0*4,R14)		;連続時の目標位置
	MOV.L	R10,@(1*4,R14)		;

	MOV.L	R1,@(0*4,R13)		;切り替え位置(本当は,速度差を演算する必要がある)
	MOV.L	R2,@(1*4,R13)		;

	ADD	#-4,R11			;
	ADD	#-4,R12			;
	ADD	#-8,R13			;
	ADD	#-8,R14			;

	TST	R8,R8			;
	TST_BIT_OF BANK2_CPOS_ABSPOS_SET_EXT	;
	ADD	#-1,R8			;
	M_BRA	BANK2_CPOS_ABSPOS_SET_LOP	;
BANK2_CPOS_ABSPOS_SET_EXT:			;


;	---------------ﾘﾋﾟｰﾄ用機点-------------------------
	FAR_JSR	#_CPOS_UP_ABSPOS_SET,R0


	SUB_END
	M_RTS


;	-------------０度＜０点（０〜１度）＜待機点---------------------------
;	-------------０度＜待機点＜０点（３００〜３５９）[-1]-----------------
;	判定が必要かも 359度で動く?
_CPOS_UP_ABSPOS_SET:
	SUB_START

;	-----------2014-10-10---------
	MOV.L	#_LINK_OBJROT_NUM_ZR,R1		;//NOW ROTATION 番号
	MOV.L	@R1,R2				;
	FAR_JSR	#_POSCHG_LINK_ROTNUM_PLS,R1	;
	MOV	R1,R5				;
	MOV	R2,R6				;

	MOV.L	#_CPOS_SDAT1_UP_OFSPOS,R0	;//2014-09-20 上死点 繰返に開始側の待機点も必要
	MOV.L	@R0,R2				;
	XOR	R1,R1				;


;;;;;;;;;	MOV.L	#_LINK_NOWROT_NUMPLS_ZR,R0		;
;;;;;;;;;	MOV.L	@R0,R5					;
;;;;;;;;;	MOV.L	@(4,R0),R6					;
	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R1,DT_ANS_REGL=R2
	MOV.L	#_CPOS_SDAT1_UP_POS,R0		;//2014-09-20 上死点 繰返に開始側の待機点も必要
	MOV.L	R1,@(0*4,R0)			;
	MOV.L	R2,@(1*4,R0)			;

	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***	目標絶対位置作成	***
;	***	BANK2-->BANK1へ		***
;	***	運転中のBANK1の作成	***
;	***********************************
_BANK2_TO_BANK1_MOV:
	SUB_START
	MOV.L	#_CPOS_STEP_MAX,R1		;
	MOV.W	@R1,R0				;1=2回ﾙｰﾌﾟする 10=11回ﾙｰﾌﾟ
	MOV.L	#_CPOS_SDAT1_CHGAPOS2,R1	;8byte
	MOV.L	#_CPOS_SDAT1_STPAPOS2,R2	;8byte

	MOV.L	#_CPOS_SDAT1_CHGAPOS,R5		;8byte
	MOV.L	#_CPOS_SDAT1_STPAPOS,R6		;8byte

BANK2_TO_BANK1_MV_LOP:
;	------ BANK2-->BANK1 8byte----
	MOV.L	@R1+,R3				;
	MOV.L	@R2+,R4				;
	MOV.L	R3,@R5				;
	MOV.L	R4,@R6				;
	ADD	#4,R5				;
	ADD	#4,R6				;
	
	MOV.L	@R1+,R3				;
	MOV.L	@R2+,R4				;
	MOV.L	R3,@R5				;
	MOV.L	R4,@R6				;
	ADD	#4,R5				;
	ADD	#4,R6				;

	TST	R0,R0				;
	TST_BIT_OF BANK2_TO_BANK1_MV_END	;
	ADD	#-1,R0				;
	M_BRA	BANK2_TO_BANK1_MV_LOP
BANK2_TO_BANK1_MV_END:

	MOV.L	#_BANK2_LK_END_OBJ_ABSPLS,R1	;
	MOV.L	@R1+,R3				;
	MOV.L	@R1,R4
	MOV.L	#_BANK1_LK_END_OBJ_ABSPLS,R1	;
	MOV.L	R3,@R1				;
	MOV.L	R4,@(4,R1)			;

	MOV.L	#_BANK2_LINK_OBJROT_NUM_ZR,R1	;//NOW ROTATION 番号
	MOV.L	@R1,R2				;
	MOV.L	#_LINK_OBJROT_NUM_ZR,R1		;//NOW ROTATION 番号
	MOV.L	R2,@R1				;今のところこの処理はいらない(2004-12-20 17:00)

	SUB_END
	M_RTS






;	*******************************************
;	***					***
;	***		一旦停止位置		***
;	***		2014-08-30		***
;	***					***
;	*******************************************
_POS_HLD1_DTMAK
	SUB_START

	DATA_STD_CHG_MOV SRC=_SVP_INTLIM_AGL,L1=W,DST=_SET1_INTLIM_AGL,L2=W,CALLSB=_SV_CLNK_DG_CHG_LINK_DG1	;
	DATA_STD_CHG_MOV SRC=_SVP_INTLIM_AGL,L1=W,DST=_SET2_INTLIM_AGL,L2=W,CALLSB=_SV_DN_CLANK_LINK_CHG	


	DATA_STD_CHG_MOV SRC=_SET1_INTLIM_AGL,L1=W,DST=_SET1_INTLIM_PLS,L2=L,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS	;
	DATA_STD_CHG_MOV SRC=_SET2_INTLIM_AGL,L1=W,DST=_SET2_INTLIM_PLS,L2=L,CALLSB=_POSCHG_LINK_DIG_TO_LINK_PLS	;


	MOV.L	#_SET1_INTLIM_PLS,R1
	MOV.L	@R1,R3				;
	MOV.L	#_SETX_UPAREA_PLS,R1		;//4;待機点
	MOV.L	@R1,R6				;
	MOV.L	#_LINK_1ROT_PLS,R1		;待機点より小さかったら+１回転
	MOV.L	@R1,R7				;反転時もこの論理でＯＫ
	CMP/GE	R6,R3				;待機点=<R3
	BT	POS_HLD1DTMK_050		;"必ずEQUを含む事"
	ADD	R7,R3				;
POS_HLD1DTMK_050:				;
	MOV.L	#_SETX_SDAT1_INTLIMOFS,R14	;往路,回転,反転//制御部で参照する元となる設定
	MOV.L	R3,@R14				;POS

	MOV.L	#_SETX_POS_CTL_MATH,R1		;
	MOV.W	@R1,R0				;
	TST	#_DMATH_DNDRIV,R0		;ふりこ
	TST_BIT_OF POS_HLD1DTMK_200		;NO

	MOV.L	#_SET2_INTLIM_PLS,R1
	MOV.L	@R1,R3				;
	MOV.L	#_DNM_SETX_UPAREA_PLS,R1	;//4;待機点
	MOV.L	@R1,R6				;
	CMP/GE	R3,R6				;R3=<待機点(R6)
	BT	POS_HLD1DTMK_150		;
	SUB	R7,R3				;

POS_HLD1DTMK_150
	MOV.L	#_SETX_SDAT2_INTLIMOFS,R14	;往路
	MOV.L	R3,@R14				;POS

POS_HLD1DTMK_200

;	------------------------------------------------------------------
;	--------[設定された停止位置を跨ぐ行程をサーチ,速度を記録]---------
;	------------------------------------------------------------------
	FAR_JSR	#_POSHLD1_DTMK1_STEP,R0		;
;	------------------------------------------------------------------
;	--------[停止位置と速度から減速位置を算出]		----------
;	-------	表示用						----------
;	------------------------------------------------------------------
	FAR_JSR	#_POSHLD1_DTMK2_STEP,R0		;
;	------------------------------------------------------------------
;	--------[減速位置の存在する行程を算出]			----------
;	-------	表示用						----------
;	------------------------------------------------------------------
	FAR_JSR	#_POSHLD1_DTMK3_STEP,R0




	FAR_JSR	#_POS_HLD1_SETDT_DISP_MAK,R0

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***					***
;	***					***
;	*******************************************
;	------------------------------------------------------------------
;	--------[設定された停止位置を跨ぐ行程をサーチ,速度を記録]---------
;	------------------------------------------------------------------
_POSHLD1_DTMK1_STEP:
	SUB_START
	MOV.W	#D'11,R3
	XOR	R0,R0
	MOV.L	#_POSHLD1_STOP_STEPWK,R1	;//SAVE ADR[行程番号1~11,0]0:終了
POS_HLD1DTMK1_240LOP:
	TST	R3,R3				;
	TST_BIT_OF POS_HLD1DTMK1_250EX		;
	MOV.W	R0,@R1				;
	ADD	#2,R1				;
	ADD	#-1,R3				;
	M_BRA	POS_HLD1DTMK1_240LOP		;
POS_HLD1DTMK1_250EX:


	MOV.L	#_SETX_SDAT1_INTLIMOFS,R1	;
	MOV.L	@R1,R7				;停止位置POS

	MOV.L	#_SETX_UPAREA_PLS,R1		;//4;待機点
	MOV.L	@R1,R2				;起点(Sn_1)


	MOV.L	#_SETX_POS_SDAT1_CNTSTEP,R13	;速度連続.LONG
	MOV.L	#_SETX_POS_SDAT1_INF1,R14	;方向　.LONG
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R12	;POSITON [待機点+α] 待機点＜目標位置
	MOV.L	#_SETX_POS_SDAT1_SPD,R11	;SPEED

	MOV.L	#_POSHLD1_STOP_STEPWK,R10		;//SAVE ADR[行程番号1~11,0]0:終了
	MOV.B	#1,R6				;対象行程 1~11
	MOV.L	#_POSHLD1_STOPSPDWK,R9		;//ｽﾃｯﾌﾟ速度


POS_HLD1DTMK1_LOP300:
	MOV	R2,R3				;Sn-->Sn_1
	MOV.L	@R14+,R0			;INF:BIT0=1連続  BIT1=1:逆転
	MOV.L	@R12+,R2			;POS
	MOV.L	@R11+,R1			;SPD
	MOV.L	@R13+,R5			;連続
	TST	#BIT1,R0			;逆転?
	TST_BIT_ON POS_HLD1DTMK1_LOP500		;逆転は対象外

;	------------- "正"---------------
	CMP/GT	R2,R7				;Sn_1 < R7 =<Sn ｲｺｰﾙも含む
	BT	POS_HLD1DTMK1_LOP500		;Sn< R7 対象外

	CMP/GE	R7,R3				;
	BT	POS_HLD1DTMK1_LOP500		;R7=< Sn_1 対象外

;	------対象位置の存在する行程がある-----------
	MOV.L	#_SVP_INTLIM_SNO,R0		;//ｽﾗｲﾄﾞ自動待機機能  干渉限界位置設定　行程
	MOV.W	@R0,R0				;
	TST	R0,R0				;
	TST_BIT_OF POS_HLD1DTMK1_LOP400		;どの行程でも行う

	CMP/EQ	R6,R0				;指定した行程に停止位置が存在するか?
	BF	POS_HLD1DTMK1_LOP500		;存在しない

POS_HLD1DTMK1_LOP400:
	MOV.W	R6,@R10				;[行程番号]
	ADD	#2,R10				;
	MOV.L	R1,@R9				;
	ADD	#4,R9				;ｽﾃｯﾌﾟ速度

POS_HLD1DTMK1_LOP500:
	ADD	#1,R6				;

	MOV.L	#_SETX_POS_STEP_MAX,R1		;
	MOV.W	@R1,R0				;LOOP data 1~10
	ADD	#1,R0				;2~11

	CMP/HI	R0,R6				;11<12
	BT	POS_HLD1DTMK1_LOP600EX		;
	M_BRA	POS_HLD1DTMK1_LOP300		;

POS_HLD1DTMK1_LOP600EX

	MEM_WORD_BLOCK_MOV1	SRC_ADR=_POSHLD1_STOP_STEPWK,DST_ADR=_POSHLD1_STOP_STEP,CNT_DAT=10,DT_REG=R2,CNT_REG=R3

	SUB_END
	M_RTS




;	*******************************************
;	***					***
;	***					***
;	***					***
;	*******************************************
;	------------------------------------------------------------------
;	--------[設定された停止位置を跨ぐ行程をサーチ,速度を記録]---------
;	------------------------------------------------------------------
_POSHLD1_DTMK2_STEP:
	SUB_START

	MOV.L	#(_PAR_POSHLD1_BEFPLS-_CB_SYS_PARAM000+_W_PARAM_TOP),R1	;符号付
	MOV.W	@R1,R2							;
	MOV.L	#_SETX_SDAT1_INTLIMOFS,R1				;
	MOV.L	@R1,R0							;停止位置POS
	ADD	R2,R0							;
	MOV.L	#_SETY_SDAT1_INTLIMOFS,R1				;//停止位置[制御部で参照しているデータ]
	MOV.L	R0,@R1							;

	MOV.L	#_SETX_SDAT2_INTLIMOFS,R1				;
	MOV.L	@R1,R0							;
	SUB	R2,R0							;
	MOV.L	#_SETY_SDAT2_INTLIMOFS,R1				;
	MOV.L	R0,@R1							;



;;;	MOV.L	#_SET_DN_ACC_LATE,R1		;加速度  Vmax/時間=α/1msec当
;;;	MOV.L	@R1,R2				;*1000が必要

;;2014-09-22	
;;	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R0		;//
	MOV.L	#_LINK_MAX_SPD_PLS,R0		;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
	MOV.L	@R0,R2				;
	MOV.L	#_SET1_ACCLAT_TIM1,R0		;V/T-> V*1000/T
	MOV.W	@R0,R4				;
	MOV.W	#D'1000,R1			;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;
	MOV	R2,R8				;加速度αPLS/S/S

	MOV.L	#_SETY_SDAT1_INTLIMOFS,R1	;//停止位置[制御部で使用しているデータ]
	MOV.L	@R1,R7				;R7停止位置

	MOV.L	#_POSHLD1_STOP_STEP,R10		;//SAVE ADR[行程番号1~11,0]0:終了
	MOV.B	#1,R6				;対象行程 1~11
	MOV.L	#_POSHLD1_STOPSPDWK,R9		;//ｽﾃｯﾌﾟ速度
	MOV.L	#_POSHLD1_GENSKPOSWK,R12;//目標角度


POS_HLD1DTMK2_LOP300:
	MOV.W	@R10+,R0			;ｽﾃｯﾌﾟ有?
	TST	R0,R0				;
	TST_BIT_OF POS_HLD1DTMK2_LOP600EX	;終了

	MOV.L	@R9+,R2				;設定速度PLS/S


	MOV.L	#_OVERLIDE_DT_SEL,R1		;画面ｵｰﾊﾞﾗｲﾄﾞ有効
	MOV.W	@R1,R0				;
	CMP/EQ	#1,R0				;
	BF	POS_HLD1DTMK2_320		;

	MOV.L	#_SVP_OVERLIDE_COF,R0
	MOV.W	@R0,R1				;画面設定ｵｰﾊﾞﾗｲﾄﾞ
	M_BRA	POS_HLD1DTMK2_340

POS_HLD1DTMK2_320:
	MOV.L	#_SET_SPD_OVRLIDE,R0		;
	MOV.W	@R0,R1				;設定ｵｰﾊﾞﾗｲﾄﾞ
POS_HLD1DTMK2_340:

;	-------------- 2014-09-16 -------------

	MOV.W	#_OVRLIDE_LATE_MAX,R4		;1~100% 
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;
	PUSH_REG1 R2				;R2:ｵｰﾊﾞﾗｲﾄﾞを含めた速度(PLS/S)

;	IN:R8(加速度)
	MOV	R8,R4				;設定速度 S=V*V/(2･α)=V*V/2 *Tmax/(Vmax*1000)
	FAR_JSR	#_GENSOK_LENGTH_CALC,R0		;R2,R4
	MOV	R7,R0				;R0=R7:停止位置
	SUB	R2,R0				;R0=停止位置-減速距離

	POP_REG1 R2				;2014-09-16:オーバライドを含めた速度


;	---------2014-09-16 偏差分表示へのｼﾌﾄ追加------------
	PUSH_REG1 R0				;停止位置

						;R2:PLS/S
	MOV.L	#(_PAR_POSHLD1_HENSAP-_CB_SYS_PARAM000+_W_PARAM_TOP),R0	;100%時の偏差
	MOV.W	@R0,R1				;PLS(0~30000)
;;2014-09-22	
;;	MOV.L	#_SETD_LINK_MAX_SPD_PLS,R0		;//
	MOV.L	#_LINK_MAX_SPD_PLS,R0		;//2014-09-20制御のmax:ふりこ/回転・反転で変化する
	MOV.L	@R0,R4				;MAX(PLS/S)

	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;R2*偏差/100ｵｰﾊﾞﾗｲﾄﾞを含めた速度

	POP_REG1 R0


	SUB	R2,R0				;
	MOV.L	R0,@R12				;POSHLD1_GENSKPOSWK=停止位置-減速:表示用だから本当は1個だけ必要
	ADD	#4,R12				;
	ADD	#1,R6				;

	MOV.L	#_SETX_POS_STEP_MAX,R1		;
	MOV.W	@R1,R0				;LOOP data 1~10
	ADD	#1,R0				;2~11

	CMP/HI	R0,R6				;11<12
	BT	POS_HLD1DTMK2_LOP600EX		;
	M_BRA	POS_HLD1DTMK2_LOP300		;

POS_HLD1DTMK2_LOP600EX
	SUB_END
	M_RTS



;	INPUT R2(V)
;	INPUT R8(α)
;	L=V*V/2/α
_GENSOK_LENGTH_CALC:
	SUB_START

	TST	R4,R4				;
	TST_BIT_ON GENSOK_LENGTHCAL100		;
	MOV.B	#1,R2				;減速距離は∞
	M_BRA	GENSOK_LENGTHCAL200		;

GENSOK_LENGTHCAL100:
	DMULS.L	R2,R2				;
	STS	MACH,R1				;
	STS	MACL,R2				;V^2

	FAR_JSR	#_DIVS_64R1R2_32R4_32R2,R0	;
	SHLR	R2				;1/2
	
GENSOK_LENGTHCAL200:

	SUB_END
	M_RTS


;	------------------------------------------------------------------
;	--------[設定された停止位置を跨ぐ行程をサーチ,速度を記録]---------
;	------------------------------------------------------------------
;
;	「1個目しか表示しなくていいことに注目」
;
_POSHLD1_DTMK3_STEP:
	SUB_START
	XOR	R0,R0
	MOV.L	#_POSHLD1_GENSK_STEP,R1		;//SAVE ADR[行程番号1~11,0]0:終了
	MOV.W	R0,@R1

	MOV.L	#_POSHLD1_STOP_STEP,R10		;//SAVE ADR[行程番号1~11,0]0:終了
	MOV.W	@R10,R8				;

	TST	R8,R8				;
	TST_BIT_OF POS_HLD1DTMK3_EX		;停止行程無し

	MOV	R8,R7				;行程

POS_HLD1DTMK3_100LOP
	ADD	#-1,R8				;
	TST	R8,R8				;
	TST_BIT_OF POS_HLD1DTMK3_200		;1行程の区間内で指定された=減速行程も1

	MOV	R8,R0				;既に-1している
	ADD	#-1,R0				;
	SHLL2	R0				;

	MOV.L	#_SETX_POS_SDAT1_CNTSTEP,R13	;速度連続.LONG
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R12	;POSITON [待機点+α] 待機点＜目標位置
	MOV.L	#_SETX_POS_SDAT1_INF1,R14	;方向　.LONG

	MOV.L	@(R0,R14),R2			;前の段は速度継続か?
	MOV.B	#BIT0,R4			;
	TST	R4,R2				;
	TST_BIT_OF POS_HLD1DTMK3_200		;前の段は速度継続でない.この段で減速

	MOV.B	#BIT1,R4			;
	TST	R4,R2				;
	TST_BIT_ON POS_HLD1DTMK3_200		;前の段は反転か?(不要ではあるが..)

;	------設定された行程より手前側を検索し
	MOV.L	#_POSHLD1_GENSKPOSWK,R11	;//目標角度(ﾊﾟﾙｽ)
	MOV.L	@R11,R2				;

	MOV.L	@(R0,R12),R3			;
	CMP/GE	R3,R2				;前の段　=<減速
	BT	POS_HLD1DTMK3_200		;

	ADD	#-1,R7				;前の段で減速
	M_BRA	POS_HLD1DTMK3_100LOP

POS_HLD1DTMK3_200
	MOV.L	#_POSHLD1_GENSK_STEP,R1		;//SAVE ADR[行程番号1~11,0]0:終了
	MOV.W	R7,@R1				;





POS_HLD1DTMK3_EX

	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***					***
;	***					***
;	*******************************************
	.EXPORT	_HLDCAM_ABS_POS_SET		;ssa_dtmk.src 2014-08-30
	.EXPORT	_HLDCAM_BANK2_ABS_POS_SET	;ssa_dtmk.src 2014-08-30
_HLDCAM_BANK2_ABS_POS_SET:	;ssa_dtmk.src 2014-08-30
	SUB_START
;;;;;;;	MOV.L	#_BANK2_LINK_OBJROT_NUMPLS_ZR,R0	;//NOW ROTATION番号相当のﾊﾟﾙｽ
;;;;;;;	MOV.L	@R0,R5					;
;;;;;;;	MOV.L	@(4,R0),R6				;
	M_BRA	HLDCAM_ABS_POS_STCOM

_HLDCAM_ABS_POS_SET:	;ssa_dtmk.src 2014-08-30
	SUB_START

;;;;;;;	MOV.L	#_LINK_OBJROT_NUMPLS_ZR,R0		;//NOW ROTATION番号相当のﾊﾟﾙｽ
;;;;;;;	MOV.L	@R0,R5					;
;;;;;;	MOV.L	@(4,R0),R6				;
HLDCAM_ABS_POS_STCOM:	;ssa_dtmk.src 2014-08-30

	MOV.L	#_LINK_OBJROT_NUM_ZR,R1		;//NOW ROTATION 番号
	MOV.L	@R1,R2				;
	FAR_JSR	#_POSCHG_LINK_ROTNUM_PLS,R1	;
	MOV	R1,R5				;
	MOV	R2,R6				;



	MOV.L	#_SETY_SDAT1_INTLIMOFS,R11		;//往路,回転,反転	[補正後の停止目標位置]
	MOV.L	@R11,R2					;
	XOR	R1,R1					;
	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R1,DT_ANS_REGL=R2
	MOV.L	#_POSHLD1_SDAT1_HOLDPOS,R12		;//停止位置[制御部で使用しているデータ]
	MOV.L	R1,@(0*4,R12)				;
	MOV.L	R2,@(1*4,R12)

	MOV.L	#_SETY_SDAT2_INTLIMOFS,R11		;復路
	MOV.L	@R11,R2					;
	XOR	R1,R1					;
	ADD8B DT_REGH=R5,DT_REGL=R6,DT_ANS_REGH=R1,DT_ANS_REGL=R2
	MOV.L	#_POSHLD1_SDAT2_HOLDPOS,R12		;//停止位置
	MOV.L	R1,@(0*4,R12)
	MOV.L	R2,@(1*4,R12)


;	------------- 次ロット開始----------------
	MOV.B	#H'7F,R0		;
	MOV.L	#_POS_HOLDABS_CALCF,R1	;
	MOV.W	R0,@R1			;

	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	*******************************************
;	
_POS_HLD1_SETDT_DISP_MAK
	SUB_START

	MOV.L	#_POSHLD1_STOP_STEP,R1
	MOV.W	@R1+,R0
	MOV.W	@R1,R2					;2つ目の停止位置が存在するか
	TST	R2,R2					;
	TST_BIT_ON POS_HLD1_SETDT_DISPMK_100
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ADCLR MEM=_SQ_CBWK_TOP+_WKSQCB251,LG=W,BIT=(~BIT9),WKRG1=R1,WKRG2=R4	;
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)
	M_BRA	POS_HLD1_SETDT_DISPMK_190

POS_HLD1_SETDT_DISPMK_100
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=_SQ_CBWK_TOP+_WKSQCB251,LG=W,BIT=(BIT9),WKRG1=R1,WKRG2=R4		;複数有り
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)
POS_HLD1_SETDT_DISPMK_190


	MOV.L	#_POSHLD1_GENSK_STEP,R1
	MOV.W	@R1,R2
	MOV.L	#_PVP_WTJUD_SNO,R1				;//ｽﾗｲﾄﾞ自動待機機能  待機判定位置（行程）
	MOV.W	R2,@R1						;

	TST	R2,R2						;
	TST_BIT_ON POS_HLD1_SETDT_DISPMK_200
	XOR	R0,R0
	MOV.L	#_PVP_WTJUD_AGL,R1				;//ｽﾗｲﾄﾞ自動待機機能  待機判定位置（角度）
	MOV.W	R0,@R1						;
	MOV.L	#_PVP_WTJUD_POS,R1				;
	MOV.L	R0,@R1						;
	M_BRA	POS_HLD1_SETDT_DISPMK_600			;存在しない0,0

POS_HLD1_SETDT_DISPMK_200

	MOV.L	#_POSHLD1_GENSKPOSWK,R1				;
	MOV.L	@R1,R2						;
	MOV.L	#_LINK_1ROT_PLS,R1				;
	MOV.L	@R1,R3						;
	CMP/GE	R2,R3						;R2=<1回転なら足し算していない
	BT	POS_HLD1_SETDT_DISPMK_400			;
	SUB	R3,R2						;
POS_HLD1_SETDT_DISPMK_400					;ﾘﾝｸﾊﾟﾙｽ

	MOV.L	#_SETY_INCPLS_HOSM01X,R0			;//0.1度
	MOV.L	@R0,R1						;
	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0			;
	MOV.L	@R0,R4						;R2:X回転
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;R2*1REV*HOSN/HOSM

	MOV.W	#D'3600,R4					;
	CMP/HI	R2,R4						;
	BT	POS_HLD1_SETDT_DISPMK_500
	SUB	R4,R2						;
POS_HLD1_SETDT_DISPMK_500:					;通常制御の結果

	PUSH_REG1 R2
	MOV.W	#D'100,R4						;
	DMULS.L	R4,R2						;
	STS.L	MACL,R2						;
	FAR_JSR	#_DIG36000_CHG_RENEA1,R0			;360.000度-->0.001mm
;;;2014-12-25	FAR_JSR	#_WD_DIV10,R0  0.01mm=>0.001mm(2014-12-25)
	MOV.L	#_PVP_WTJUD_POS,R1				;//ｽﾗｲﾄﾞ自動待機機能  待機判定位置（位置）
	MOV.L	R2,@R1						;0.01mm
	POP_REG1 R2

	FAR_JSR	#_PV_LINK_DG_CHG_CLNK_DG1,R0			;
	MOV.L	#_PVP_WTJUD_AGL,R1				;//ｽﾗｲﾄﾞ自動待機機能  待機判定位置（角度）
	MOV.W	R2,@R1						;

POS_HLD1_SETDT_DISPMK_600:					;




	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	*******************************************













;	*******************************************
;	***					***
;	***					***
;	***	データ変換			***
;	***	演算サブルーチン		***
;	***					***
;	***					***
;	*******************************************
;	*******************************************
;	***					***
;	***	待機点位置の範囲		***
;	***					***
;	*******************************************
;	R2:距離
;	1:待機点近辺の距離をﾊﾟﾙｽ換算する。
;	2:下死点近辺の距離をﾊﾟﾙｽ換算する.
;	3:
;	ちなみ100.000mm=180度として等分する案もある
;	
_RNACHGPLS1:
_RNACHGPLS2:
_RNACHGPLS3:
	SUB_START
	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	角度(0.1)をふりこの復路にする	***
;	***	2009-10-07 2007-04-03		***
;	*******************************************
;
;往路	0,1,2,,3,,,,,179,180,181,,,
;復路	0,359,358,,,,181,180,179,,,
;	復路ﾃﾞｰﾀ=180.0-往路ﾃﾞｰﾀ+180.0=360.0-往路ﾃﾞｰﾀ
;
;	Input  R2
;	Output R2
;	DESTROY R4
	.EXPORT	_DIG01_CHG_DN_DATA_MAKE
_DIG01_CHG_DN_DATA_MAKE:
	SUB_START
	MOV.L	#D'3600,R4		;0----180.0度に対して線対称
	SUB	R2,R4			;data < 180 THEN 180-data +180=3600-data   =
	MOV	R4,R2			;180  < data THEN 180-(data-180)=3600-data =
	CMP/PZ	R2	
	BT	DIG01_CHG_DN_DATMK100	;
	XOR	R2,R2			;
DIG01_CHG_DN_DATMK100:			;
	SUB_END
	M_RTS

;	---- 設定→復路→ｸﾗﾝｸ/ﾘﾝｸ-------------
	.EXPORT	_SV_DN_CLANK_LINK_CHG
_SV_DN_CLANK_LINK_CHG:
	SUB_START
	FAR_JSR	#_DIG01_CHG_DN_DATA_MAKE,R0
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0
	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	位置関連データ変換		***
;	***					***
;	*******************************************
	.EXPORT	_POSCHG_CLNK_DIG_TO_LINK_PLS
	.EXPORT	_POSCHG_CLNK_DIG_TO_RENA_PLS
	.EXPORT	_POSCHG_RENA_PLS_TO_LINK_DIG
	.EXPORT	_POSCHG_LINK_DIG_TO_LINK_PLS
	.EXPORT	_POSCHG_LINK_ABSPLS_ROTNUMBER
	.EXPORT	_POSCHG_LINK_ROTNUM_PLS

;	*******************************************
;	***					***
;	***	画面設定ｸﾗﾝｸ角度→ﾘﾝｸﾊﾟﾙｽ	***
;	***					***
;	*******************************************
;	ｸﾗﾝｸ角度→［関数Lcos(DIG)]→ﾘﾆｱｽｹｰﾙ位置0.1um
;		→[関数TBL RNA/CLANK_DIG]→ﾘﾝｸ角度0.1度
;		→[関数]->ﾊﾟﾙｽ
;	Input R2(0.1度)
;	Output R2(ﾊﾟﾙｽ)
_POSCHG_CLNK_DIG_TO_LINK_PLS
	SUB_START


	SUB_END
	M_RTS

;	*******************************************
;	***	設定ｸﾗﾝｸ角度->ﾘﾆｱｽｹｰﾙ位置	***
;	*******************************************
;	Input  Rn=ｸﾗﾝｸ画面設定角度 0.1度 0~360.0
;	Output Rm(1um),Rs(0/-1 0:350~180 -1:180~350)
;	350:切替点
;	ｸﾗﾝｸ角度→［関数Lcos(DIG)]→ﾘﾆｱｽｹｰﾙ位置1um
;	1000.000 (0~10000/10000)
;	360.0度=0.0001　10000=1
;	4byte*2byte/2byte=4byte(浮動少数点使用可能)
;	"実際にCOSはﾃｰﾌﾞﾙ変換を行う360度のその間は直線補間"
;	ﾃｰﾌﾞﾙは X/10000:Xは0~10000
_POSCHG_CLNK_DIG_TO_RENA_PLS
	SUB_START
	SUB_END
	M_RTS

;	*******************************************
;	***	ﾘﾝｸ角度->ﾘﾆｱｽｹｰﾙ位置		***
;	***	ﾘﾝｸ/ﾘﾆｱﾃｰﾌﾞﾙ使用		***
;	*******************************************
;	Input  Rn=ﾘﾝｸ角度 0.1度 0~360.0
;	Output Rm(1um),Rs(0/-1 0:350~180 -1:180~350)
;	350:切替点
;	ﾘﾝｸ角度→［ﾘﾝｸ/ﾘﾆｱｽｹｰﾙﾃｰﾌﾞﾙ]→ﾘﾆｱｽｹｰﾙ位置1um
;	1000.000 (0~10000/10000)
;	360.0度=0.0001　10000=1
;	4byte*2byte/2byte=4byte(浮動少数点使用可能)
;	"実際にCOSはﾃｰﾌﾞﾙ変換を行う360度のその間は直線補間"
;	ﾃｰﾌﾞﾙは X/10000:Xは0~10000
_POSCHG_LINK_DIG_TO_RENA_PLS
	SUB_START
	SUB_END
	M_RTS


;	*******************************************
;	***	ﾘﾆｱｽｹｰﾙ位置→ﾘﾝｸ角度		***
;	***	ﾘﾆｱﾃｰﾌﾞﾙ/ﾘﾝｸﾃｰﾌﾞﾙ使用		***
;	*******************************************
;	Input  Rn=ﾘﾆｱｽｹｰﾙ位置 1000.000mm(1um),Rs(0/-1 0:350~180 -1:180~350)
;	Output Rm(0.1角度)
;	ﾘﾆｱｽｹｰﾙ位置1um→［関数Lcos(DIG)]→ﾘﾝｸ角度
_POSCHG_RENA_PLS_TO_LINK_DIG
	SUB_START
	SUB_END
	M_RTS


;	*******************************************
;	***	ﾘﾝｸ角度→ﾘﾝｸﾊﾟﾙｽ(1回転内)	***
;	*******************************************
;	Input 	R2:2byte 360.0
;	Output	R2:4byte
;	演算
;	R2*
;	Y[pls]＝X角度[0.1度]×1回転パルス(8192)×Ｎ回転(16)／Ｍ度[0.1度](3600)
;	_SET1_INCPLS_HOSN		.SRES	2	;PG補正N　ﾓｰﾀN回
;	_SET1_INCPLS_HOSM		.SRES	2	;PG補正M　ｸﾗﾝｸ角度M 0.1度
;
;	R2:0~360.0
_POSCHG_LINK_DIG_TO_LINK_PLS
	SUB_START
	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0	;
	MOV.L	@R0,R1				;

;;;;	MOV.L	#_SET1_INCPLS_HOSM,R0		;PG補正M　ﾓｰﾀＭ度
;;;;	MOV.W	@R0,R4				;
;;;	EXTU.W	R4,R4				;
	MOV.L	#_SETY_INCPLS_HOSM01X,R0	;//0.1度
	MOV.L	@R0,R4				;

;;;	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;R2*1REV*HOSN/HOSM
	FAR_JSR	#_X_R2_MUL_R1_DIV_R4,R0	;R2*1REV*HOSN/HOSM

;;	MOV.L	#_SET1_INCPLS_1REV,R0		;
;;	MOV.W	@R0,R1				;3600*32767=
;;	EXTU.W	R1,R1				;
;;	MOV.L	#_SET1_INCPLS_HOSN,R0		;PG補正N　ﾓｰﾀN回
;;	MOV.W	@R0,R3				;
;;	EXTU.W	R3,R3				;+
;;	MOV.L	#_SET1_INCPLS_HOSM,R0		;PG補正M　ﾓｰﾀＭ度
;;	MOV.W	@R0,R4				;
;;	EXTU.W	R4,R4				;+
;;	FAR_JSR	#_FPU_R2_MUL_R1_R3_DIV_R4,R0	;R1*R2*R3/R4-->R2 ANS R2

	SUB_END
	M_RTS


;	0~360.0*

_POSCHG_LINK_DIG_TO_LINK_PLS_8B			;
	SUB_START
	MOV.L	#_CALC_MEM_1REV_MUL_NROT,R0	;
	MOV.L	@R0,R1				;

	MOV.L	#_SETY_INCPLS_HOSM01X,R0	;//0.1度
	MOV.L	@R0,R4				;

	FAR_JSR	#_MULDIV_R2S32mR1S32dR4S32aR1R2S64,R0	;R1,R2

	SUB_END
	M_RTS




;	*******************************************
;	***					***
;	***	Ｘ回転時のLINKﾊﾟﾙｽ作成		***
;	***					***
;	*******************************************
;	R0~R5
;	X:4byte
;	X*8192*
;	Y[pls]＝1回転パルス(8192)*Ｎ回転(32)*3600／Ｍ度[0.1度](3600) *Ｘ回転(4byte)
;	4byte*4byte
;
;	Input 	R2 +/-
;	Output  +/- R1(high Dword),R2(low Dword)
;
_POSCHG_LINK_ROTNUM_PLS:
	SUB_START
	MOV.L	#_CALC_MEM_1REV_ML_NROT_ML36,R0		;1REV*N*3600
	MOV.L	@R0,R1					;R2:X回転
;;07/08	MOV.L	#_SET1_INCPLS_HOSM,R0			;PG補正M　ﾓｰﾀＭ度 0.1
;;	MOV.L	#_SETX_INCPLS_HOSM,R0			;PG補正M　ﾓｰﾀＭ度 1度 _CALC_MEM_1REV_ML_NROT_ML36
;;	MOV.W	@R0,R4					;
;;	EXTU.W	R4,R4					;
	MOV.L	#_SETY_INCPLS_HOSM1XX,R0		;//1度
	MOV.L	@R0,R4					;

;	======= R2*R1/R4 ANS.R1,R2 ====			;
	FAR_JSR	#_MULDIV_R2S32mR1S32dR4S32aR1R2S64,R0	;R1,R2
	SUB_END
	M_RTS


;	Input 	R1,R2 +/-
;	Output  +/- R1(high Dword),R2(low Dword)
_POSCHG_LINK_ROTNUM_8B_PLS:
	SUB_START
	MOV.L	#_CALC_MEM_1REV_ML_NROT_ML36,R0			;1REV*N*3600
	MOV.L	@R0,R3						;R1,R2:X回転
;;;	MOV.L	#_SETX_INCPLS_HOSM,R0				;PG補正M　ﾓｰﾀＭ度　１度 :_CALC_MEM_1REV_ML_NROT_ML36
;;;	MOV.W	@R0,R4						;
;;;	EXTU.W	R4,R4						;
	MOV.L	#_SETY_INCPLS_HOSM1XX,R0		;//1度
	MOV.L	@R0,R4					;

;	======= R1,R2*R3/R4 ANS.R1,R2 ====			;
	FAR_JSR	#_MULDIV_R1R2S64mR3S32dR4S32aR1R2S64,R0
	SUB_END
	M_RTS


;	***********************************************************
;	***							***
;	***	現在の絶対値ﾊﾟﾙｽから回転数と１回転内角度作成	***
;	***							***
;	***********************************************************
;	-の場合は１回転内角度も−で算出
;	R0~R5()
;	ABS(8byte R1,R2)/()
;	X回転=Y_ABS*Ｍ度/(1回転ﾊﾟﾙｽ(8192)*Ｎ回転(16)*3600)
;
;	Input  R1,R2
;	Output R1,R2:回転数
;	Output R3:ｵﾌｾｯﾄﾊﾟﾙｽ
;	Output R5,R6:回転数相当のﾊﾟﾙｽ
	.EXPORT	_POSCHG_LINK_ABSPLS_ROTNUM_OFSPLS
_POSCHG_LINK_ABSPLS_ROTNUM_OFSPLS:
	SUB_START

	PUSH_REG1 R1						;ABS PLS
	PUSH_REG1 R2						;
	FAR_JSR	#_POSCHG_LINK_ABSPLS_ROTNUMBER,R0		;-->ROT

	PUSH_REG1 R1							;回転数
	PUSH_REG1 R2							;
	FAR_JSR	#_POSCHG_LINK_ROTNUM_8B_PLS,R0				;-->ROT==>ﾊﾟﾙｽ
	MOV	R1,R3							;
	MOV	R2,R4							;
	POP_REG1  R6							;
	POP_REG1  R5							;回転数
	POP_REG1 R2							;
	POP_REG1 R1							;最初のﾊﾟﾙｽ

	PUSH_REG1 R5							;回転数
	PUSH_REG1 R6							;
	PUSH_REG1 R3							;回転数相当のﾊﾟﾙｽ
	PUSH_REG1 R4							;
	SUB8B DT_REGH=R3,DT_REGL=R4,DT_ANS_REGH=R1,DT_ANS_REGL=R2	;
	MOV	R2,R3							;+/-

	POP_REG1 R6
	POP_REG1 R5

	POP_REG1 R2						;
	POP_REG1 R1						;R1,R2回転...R3ﾊﾟﾙｽ
	SUB_END
	M_RTS


;	***********************************************************
;	***							***
;	***	現在の絶対値ﾊﾟﾙｽから回転数と１回転内角度作成	***
;	***							***
;	***********************************************************
;	-の場合は１回転内角度も−で算出
;	R0~R5()
;	ABS(8byte R1,R2)/()
;	X回転=Y_ABS*Ｍ度/(1回転ﾊﾟﾙｽ(8192)*Ｎ回転(16)*3600)
;
;	Input  R1,R2
;	Output R2:回転数
_POSCHG_LINK_ABSPLS_ROTNUMBER:
	SUB_START
;;	MOV.L	#_SET1_INCPLS_HOSM,R0				;PG補正M　ﾓｰﾀＭ度
;;;	MOV.L	#_SETX_INCPLS_HOSM,R0				;PG補正M　ﾓｰﾀＭ度 _CALC_MEM_1REV_ML_NROT_ML36
;;;	MOV.W	@R0,R3						;
;;;	EXTU.W	R3,R3						;R1,R2 * R3/R4
	MOV.L	#_SETY_INCPLS_HOSM1XX,R0		;//1度
	MOV.L	@R0,R3					;

	MOV.L	#_CALC_MEM_1REV_ML_NROT_ML36,R0			;1REV*N*3600
	MOV.L	@R0,R4						;R2:X回転
	FAR_JSR	#_MULDIV_R1R2S64mR3S32dR4S32aR1R2S64,R0		;
	SUB_END
	M_RTS

;	***********************************
;	***	出力倍率		***
;	***********************************
;	R2* A/B-->出力ﾊﾟﾙｽ
;;;;;使用されない	.EXPORT	_POS_INC_TO_OUT_CHG
;;;;;使用されない	.EXPORT	_POS_INC_TO_OUT_CHG_MOD
;;;;;使用されない	.EXPORT	_POS_OUT_TO_INC_CHG
;使用されない_POS_INC_TO_OUT_CHG:

	SUB_START
	MOV.L	#_SETX_OUTPLS_HOSA,R0		;//出力ﾊﾟﾙｽ補正A
	MOV.W	@R0,R1				;
	MOV.L	#_SETX_OUTPLS_HOSB,R0		;//出力ﾊﾟﾙｽ補正B
	MOV.W	@R0,R4				;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;R2*1REV*HOSN/HOSM
	SUB_END
	M_RTS

;	***************************
;	***			***
;	***************************
;	R2*A/B = R2...R6  R4:DIV data
;使用されない_POS_INC_TO_OUT_CHG_MOD:
	SUB_START
	MOV.L	#_SETX_OUTPLS_HOSA,R0		;//出力ﾊﾟﾙｽ補正A
	MOV.W	@R0,R1				;
	MOV.L	#_SETX_OUTPLS_HOSB,R0		;//出力ﾊﾟﾙｽ補正B
	MOV.W	@R0,R4				;
	DMULS.L	R1,R2				;
	STS	MACL,R6				;R1*R2
	STS	MACH,R5				;
	PUSH_REG1	R5			;
	PUSH_REG1	R6			;

	PUSH_REG1	R4			;
	MOV	R5,R1				;
	MOV	R6,R2				;
	FAR_JSR	#_DIVS_64R1R2_32R4_32R2,R0	;ANS R2

	POP_REG1	R4
	DMULS.L	R2,R4				;
	POP_REG1	R6			;
	POP_REG1	R5			;
	STS	MACL,R3				;
	STS	MACH,R0				;
	CLRT					;
	SUB8B DT_REGH=R0,DT_REGL=R3,DT_ANS_REGH=R5,DT_ANS_REGL=R6

	SUB_END
	M_RTS

;	***********************************
;	***	出力倍率		***
;	***********************************
;	出力ﾊﾟﾙｽ→R2* B/A-->ｲﾝｸﾘﾒﾝﾀﾙ量
;	"00FF,FFFF"*B/A < 7FFFFFFF 128
;	100倍まで
;使用されない_POS_OUT_TO_INC_CHG:
	SUB_START
	MOV.L	#_SETX_OUTPLS_HOSB,R0		;//出力ﾊﾟﾙｽ補正A
	MOV.W	@R0,R1				;
	MOV.L	#_SETX_OUTPLS_HOSA,R0		;//出力ﾊﾟﾙｽ補正B
	MOV.W	@R0,R4				;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;R2*1REV*HOSN/HOSM
	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***		描画関係		***
;	***					***
;	*******************************************
	.EXPORT	_HMI_DISP_COMMUNICATION	;ssa_dtmk.src
_HMI_DISP_COMMUNICATION:
	SUB_START
	FAR_JSR	#_CYCLE_END_DISP_CHK,R0		;
	SUB_END
	M_RTS

;	*******************************************
;	***	待機点通過			***
;	*******************************************
_CYCLE_END_DISP_CHK:
	SUB_START				;2016-04-11　影響のないバグ
	MOV.L	#_HS_PVP_TAKIKI_FLG,R1		;
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_ON CYCLE_END_DISPCHK_EXT	;

;	======= 描画用 ====
	MOV.L	#_DISP_RE_VIEW_FLG,R5		;
	MOV.W	@R5,R0				;
	TST	#BIT0,R0			;
	TST_BIT_OF CYCLE_END_DISPCHK_EXT	;
	AND	#LOW~BIT0,R0			;
	MOV.W	R0,@R5				;

	FAR_JSR	#_CYCLE_END_DISP_SET,R0		;

CYCLE_END_DISPCHK_EXT:
	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***	連続時の設定異常	***
;	***				***
;	***********************************
	.IMPORT	_SQ_CBWK_TOP
_MOV_DATA_ABNOMAL_CHK:
	SUB_START
	MOV.L	#_CB_SEQ_SW_SEL029,R1		;//SEQ 29.1
	MOV.W	@R1,R0				;
	TST	#BIT2,R0			;(異常解除)
	TST_BIT_ON MOV_DATA_ABNMAL_NOMAL	;


	MOV.L	#_INP_MODE,R1				;
	MOV.W	@R1,R0					;
	TST	#(_W1OPT+_W1CNT+_W1SGL+_W1INC),R0	;
	TST_BIT_OF MOV_DATA_ABNMAL_NOMAL		;

	MOV.L	#_SETX_POS_CTL_MATH,R1			;
	MOV.W	@R1,R0					;
	TST	#_DMATH_REVRSE,R0			;DRIVE MATH 反転
	TST_BIT_OF MOV_DATA_ABNMAL_NOMAL		;

	MOV.L	#_SETX_POS_STEP_MAX,R1			;//設定=1~10(2~11)
	MOV.W	@R1,R0					;
	CMP/EQ	#0,R0					;
	BT	MOV_DATA_ABNMAL_ERR			;

	MOV.L	#_SVP_DNAREA_JUDG,R1			;
	MOV.L	@R1,R3					;

	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R7			;

MOV_DATA_ABNMAL_050;
	MOV.W	@R7+,R2					;
	CMP/GT	R3,R2					;Max < R2
	BT	MOV_DATA_ABNMAL_ERR			;
	ADD	#-1,R0					;
	TST	R0,R0					;
	TST_BIT_OF	MOV_DATA_ABNMAL_NOMAL		;
	M_BRA	MOV_DATA_ABNMAL_050


MOV_DATA_ABNMAL_ERR:
;	== 設定異常==
	MEM1_BIT0_TO_BIT7_ORSET MEM=_SV_DAT_ERR1,LG=W,BIT=BIT0,WKREG=R4
	M_BRA	MOV_DATA_ABNMAL_END

MOV_DATA_ABNMAL_NOMAL:
;	== 設定NOMAL==
	MEM1_BIT0_F_ADCLR MEM=_SV_DAT_ERR1,LG=W,BIT=(~BIT0),WKRG1=R1,WKRG2=R4

MOV_DATA_ABNMAL_END:


;	***************************************************
;	***						***
;	***	待機点、目標角度、モード、工程数	***
;	***						***
;	***************************************************
;_SVPX1_OBJECT_DIG_TOP:				;01段目角度位置
;_SVP_UPAREA_DIG0		.SRES	2	;待機点角度
;_SVP_MRTION_SEL1		.SRES	2	;回転方式
;_SVP_MTSTEP_MAXM		.SRES	2	;段数

;;;;;;2015-10-25	FAR_JSR	#_POS_DATA_CHANGE_CHK1,R0		;

	FAR_JSR	#_UP_OBJ_POS_SET_DT_CHEAK,R0	;

	FAR_JSR	#_NEG_MOT_CMP_CHEAK,R0		;

	MOV.L	#_SV_DAT_ERR1,R1	;//ﾘｾｯﾄに関係なくON/OFF 
	MOV.W	@R1,R0			;
	TST	R0,R0			;
	TST_BIT_ON SV_DATA_CHEAK_ERR	;
	M_BRA	SV_DATA_CHEAK_NOMAL	;


SV_DATA_CHEAK_ERR:
;	== //連続停止,ﾛｯﾄｶｳﾝﾀ,設定異常==
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=(_SQ_CBWK_TOP+_WKSQCB212),LG=W,BIT=(BIT3),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)

	MEM1_BIT0_TO_BIT7_ORSET MEM=_CNT_STOP_CMD,LG=W,BIT=BIT1,WKREG=R4	;
	M_BRA	SV_DATA_CHEAK_END						;

SV_DATA_CHEAK_NOMAL:
;	== //連続停止,ﾛｯﾄｶｳﾝﾀ,設定NOMAL==
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB212),LG=W,BIT=(~BIT3),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)

	MEM1_BIT0_TO_BIT7_ANDCLR MEM=_CNT_STOP_CMD,LG=W,BIT=~BIT1,WKREG=R4
SV_DATA_CHEAK_END:

;	====2003 =====
	FAR_JSR	#_ELSE_TBL_DAT_ERR,R0		;ﾊﾟﾗﾒｰﾀﾃｰﾌﾞﾙｺｰﾄﾞ異常,ﾊﾞｰｼﾞｮﾝﾍﾞﾘﾌｧｲ異常




	SUB_END
	M_RTS

;	===================================================
;	====	ﾊﾟﾗﾒｰﾀﾃｰﾌﾞﾙｺｰﾄﾞ異常,ﾊﾞｰｼﾞｮﾝﾍﾞﾘﾌｧｲ異常	===
;	===================================================
_ELSE_TBL_DAT_ERR:
	SUB_START
;	======  ﾊﾟﾗﾒｰﾀﾃｰﾌﾞﾙ異常=======
	MOV.L	#_CB_SYS_CHKCOD1,R1		;
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD1,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM000
						;(符号拡張も考えると同じMOV.Wになる)
	CMP/EQ	R2,R0				;
	BF	PARAM_TBLCHK_ERR		;

	MOV.L	#_CB_SYS_CHKCOD2,R1		;
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD2,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM001
	CMP/EQ	R2,R0				;
	BF	PARAM_TBLCHK_ERR		;

	MOV.L	#_CB_SYS_CHKCOD3,R1		;
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD3,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM126
	CMP/EQ	R2,R0				;
	BF	PARAM_TBLCHK_ERR		;

	MOV.L	#_CB_SYS_CHKCOD4,R1		;
	MOV.W	@R1,R0				;
	MOV.W	#_WR_CB_SYS_CHKCOD4,R2		;ﾊﾟﾗﾒｰﾀWR開始 _CB_SYS_PARAM127
	CMP/EQ	R2,R0				;
	BF	PARAM_TBLCHK_ERR		;
	M_BRA	PARAM_TBLCHK_END		;

PARAM_TBLCHK_ERR:
	.AIF	_MC_FUNC1_NO	EQ	_CMPILE_YES	;NO:異常等の機能をはずす
	MOV.L	#_TABLE_ERR_FLG,R1	;
	MOV.W	@R1,R0			;
	OR	#BIT2,R0		;
	MOV.W	R0,@R1			;
	.AENDI
PARAM_TBLCHK_END


;	=========(SH4がSH2より遅く立ち上がるのでSH4のみﾍﾞﾘﾌｧｲﾁｪｯｸを行う) ====
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
	MOV.L	#_PVP_CB_A_VER,R5
	MOV.L	#_PVP_CB_B_VER,R6
	MOV.W	@R5+,R0
	MOV.W	@R6+,R1
	CMP/EQ	R0,R1
	BF	VER_DAT_ERR100		;"S"
	MOV.W	@R5+,R0
	MOV.W	@R6+,R1
	CMP/EQ	R0,R1
	BF	VER_DAT_ERR100		;"1"
	MOV.W	@R5+,R0
	MOV.W	@R6+,R1
	CMP/EQ	R0,R1
	BF	VER_DAT_ERR100		;"2"
	MOV.W	@R5+,R0
	MOV.W	@R6+,R1			;"a"試作ｲﾝﾃﾞｯｸｽ

	MOV.W	@R5+,R0			;
	MOV.W	@R6+,R1			;"J"
	CMP/EQ	R0,R1
	BF	VER_DAT_ERR100	

	MOV.W	@R5+,R0			;ﾃｰﾌﾞﾙ
	MOV.W	@R6+,R1			;
	CMP/EQ	R0,R1			;
	BF	VER_DAT_ERR100
	MOV.L	#_TABLE_ERR_FLG,R1	;
	MOV.W	@R1,R0			;
	AND	#LOW ~BIT1,R0		;
	MOV.W	R0,@R1			;
	M_BRA	VER_DAT_ERR200		;

VER_DAT_ERR100:
	.AIF	_MC_FUNC1_NO	EQ	_CMPILE_YES	;NO:異常等の機能をはずす
	MOV.L	#_TABLE_ERR_FLG,R1	;
	MOV.W	@R1,R0			;
	OR	#BIT1,R0		;
	MOV.W	R0,@R1			;
	.AENDI
VER_DAT_ERR200:
	.AELSE
	.AENDI
	SUB_END
	M_RTS



;	ANSRG !=0 ﾃﾞｰﾀ変更有り
	.MACRO	DATA_STD_SHN_MVX	SRC,L1,DST,L2,OLD_REG,ADR_REG,WKREG,FLG,L3
	MOV.L	#\SRC,R5		;
	MOV.\L1	@R5,R2			;

	MOV.L	#\DST,R6		;
	MOV.\L2	@R6,\OLD_REG		;
	MOV.\L2	R2,@R6			;
	XOR	R2,\OLD_REG		;
	MOV.L	#\FLG,\ADR_REG		;//ﾘｾｯﾄ=0[_SV_CHG_FLG1]
	MOV.\L3	@\ADR_REG,\WKREG
	OR	\OLD_REG,\WKREG
	MOV.\L3	\WKREG,@\ADR_REG			;
	.ENDM

;	***************************************************
;	***						***
;	***						***
;	***						***
;	***						***
;	***	各種デ−タ変更時に呼ばれる関数		***
;	***						***
;	***						***
;	***						***
;	***						***
;	***************************************************
;	*******************************************
;	***		方式変更有り		***
;	*******************************************
_API_MATH_DATA_CHG_SIG_ON			;方式変更有り
	SUB_START

;	=============原点復帰に関わる===================================
	XOR	R0,R0				;
	MOV.L	#_ORG_ELSE_NOMAL_FLG1,R1	;//原点動作以外動作禁止 0:異常 1:OK
	MOV.W	R0,@R1				;
	MOV.L	#_ORG_DND_NOMAL_FLG1,R1		;
	MOV.W	R0,@R1				;
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB206),LG=W,BIT=(~BIT6),WKRG1=R1,WKRG2=R4	;ﾓｰｼｮﾝ運転不可
	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB206),LG=W,BIT=(~BIT10),WKRG1=R1,WKRG2=R4	;段取寸動不可
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)



;	=========== 設定異常有り===================================
	MOV.B	#BIT0,R2			;
	FAR_JSR	#_API_SVCHGFLG1_BITSET,R0	;


;	============ CPUAだけ===========================================
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA					;
;	=========== 型タッチデータ無効===================================
	MEM1_BIT0_TO_BIT7_ORSET MEM=_INSERT_MOT_SV_CHGF,LG=W,BIT=BIT1,WKREG=R1	;金型タッチ用

;	=========== データチェック赤青青開始=============================
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用
	.AENDI

	SUB_END
	M_RTS




;	*******************************************
;	***		段数変更有り		***
;	*******************************************
_API_STEPMAX_DATA_CHG_SIG_ON			;段数変更有り
	SUB_START

;	=========== 設定異常有り===================================
	MOV.B	#BIT0,R2			;
	FAR_JSR	#_API_SVCHGFLG1_BITSET,R0	;


;	============ CPUAだけ===========================================
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA					;
;	=========== 型タッチデータ無効===================================
	MEM1_BIT0_TO_BIT7_ORSET MEM=_INSERT_MOT_SV_CHGF,LG=W,BIT=BIT1,WKREG=R1	;金型タッチ用
;	=========== データチェック赤青青開始=============================
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用
	.AENDI

	SUB_END
	M_RTS

;	*******************************************
;	***		待機点,目標角度		***
;	*******************************************
_API_POS_DATA_CHG_SIG_ON			;
	SUB_START

;	=========== 設定異常有り===================================
	MOV.B	#BIT0,R2			;
	FAR_JSR	#_API_SVCHGFLG1_BITSET,R0	;

;	============ CPUAだけ===========================================
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA					;


;	=========== データチェック赤青青開始=============================
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用

	.AENDI

	SUB_END
	M_RTS


;	***********************************************************
;	***							***
;	***	速度変更があった場合の各関数への通知を記述	***
;	***	2015-10-23					***
;	***********************************************************
_API_SPD_DATA_CHG_SIG_ON
	SUB_START

	.AIF	_CB_CPU_SEL EQ	_CB_CPUA	;
	MEM1_BIT0_TO_BIT7_ORSET MEM=_INSERT_MOT_SV_CHGF,LG=W,BIT=BIT1,WKREG=R1	;金型タッチ用
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用
	.AENDI

	SUB_END
	M_RTS


;	*******************************************************************
;	***								***
;	***	オーバライド変更があった場合の各関数への通知を記述	***
;	***								***
;	***	2015-10-23						***
;	*******************************************************************
_API_OVERLIDE_DATA_CHG_SIG_ON:
	SUB_START

	.AIF	_CB_CPU_SEL EQ	_CB_CPUA	;
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用
	.AENDI

	SUB_END
	M_RTS


;	***********************************************************
;	***		タイマの0/0ではない変更有り		***
;	***********************************************************
_API_TIM_DATA_CHG_SIG_ON			;
	SUB_START

;	=========== 設定異常有り===================================
	MOV.B	#BIT0,R2			;
	FAR_JSR	#_API_SVCHGFLG1_BITSET,R0	;

;	============ CPUAだけ===========================================
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA					;
;	=========== データチェック赤青青開始=============================
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用

	.AENDI

	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	設定変更による非常停止指令	***
;	***					***
;	*******************************************
;
_API_SVCHGFLG1_BITSET
	SUB_START
	MOV.L	#_SV_CHG_FLG1,R1	;
	MOV.L	@R1,R0			;
	OR	R2,R0
	MOV.L	R0,@R1
	SUB_END
	M_RTS


;	***************************************************
;	***						***
;	***						***
;	***						***
;	***						***
;	***	各種デ−タ変更のためだけにの関数	***
;	***						***
;	***						***
;	***						***
;	***						***
;	***************************************************
;	***************************************************
;	***		データ変更cheak			***
;	***************************************************
;	[待機点変更]
;	[角度変更]

_POS_DATA_CHANGE_CHK1:
	SUB_START


;;;;;2015-10-25
;;;;;;	===反転から回転/回転から反転にした場合、原点復帰をさせる===
;;;;;	MOV.L	#_SET1_MRTION_SEL1,R1	;
;;;;;	MOV.W	@R1,R0			;
;;;;;	MOV.L	#_DUM_MRTION_SEL1,R1	;(このﾒﾓﾘはこの後にﾘﾌﾚｯｼｭされる)
;;;;;	MOV.W	@R1,R2			;
;;;;;	CMP/EQ	R0,R2			;
;;;;;	BT	DATA_CHG_CK1_050	;
;;;;;
;;;;;;	===========================================
;;;;;	MOV.L	#_ORG_ELSE_NOMAL_FLG1,R1	;//原点動作以外動作禁止 0:異常 1:OK
;;;;;	XOR	R0,R0				;
;;;;;	MOV.W	R0,@R1				;
;;;;;	MOV.L	#_ORG_DND_NOMAL_FLG1,R1		;
;;;;;	XOR	R0,R0				;
;;;;;	MOV.W	R0,@R1				;
;;;;;
;;;;;	===========================================
;;;;;;;	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB206),LG=W,BIT=(~BIT6),WKRG1=R1,WKRG2=R4	;ﾓｰｼｮﾝ運転不可
;;;;;;;	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB206),LG=W,BIT=(~BIT10),WKRG1=R1,WKRG2=R4	;段取寸動不可
;;;;;;;;
;;;;;;;;;DATA_CHG_CK1_050:


	DATA_STD_SHN_MVX	SRC=_SVP_UPAREA_DIG0,L1=W,DST=_DUM_UPAREA_DIG0,L2=W	;反転の待機点
+				,OLD_REG=R1,ADR_REG=R3,WKREG=R4,FLG=_SV_CHG_FLG1,L3=L



;;;;;;;;	DATA_STD_SHN_MVX	SRC=_SVP_MTSTEP_MAXM	,L1=W,DST=_DUM_MTSTEP_MAXM,L2=W		;段数
;;;;;;;;				,OLD_REG=R1,ADR_REG=R3,WKREG=R4,FLG=_SV_CHG_FLG1,L3=L
;;;;;;;;
;;;;;;;;DATA_STD_SHN_MVX	SRC=_SET1_MRTION_SEL1	,L1=W,DST=_DUM_MRTION_SEL1,L2=W		;ﾓｰﾄﾞ
;;;;;;;;			,OLD_REG=R1,ADR_REG=R3,WKREG=R4,FLG=_SV_CHG_FLG1,L3=L


	MOV.L	#_SETX_POS_STEP_MAX,R1				;//設定=1~10(2~11)
	MOV.W	@R1,R8						;
	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R5				;01段目角度位置
	MOV.L	#_DUM_SET1_DIG_TOP,R6				;

	XOR	R7,R7

DATA_CHG_CK1_LOP:
	TST	R8,R8
	TST_BIT_OF DATA_CHG_CK1_100				;
	MOV.W	@R5+,R1						;
	MOV.W	@R6,R2						;
	MOV.W	R1,@R6						;
	ADD	#2,R6						;
	XOR	R1,R2						;NOW/OLD
	OR	R2,R7						;
	ADD	#-1,R8						;
	M_BRA	DATA_CHG_CK1_LOP				;
DATA_CHG_CK1_100:
	TST	R7,R7
	TST_BIT_OF DATA_CHG_CK1_200

	FAR_JSR	#_API_POS_DATA_CHG_SIG_ON,R0			;2015-10-25


DATA_CHG_CK1_200:

	SUB_END
	M_RTS




;	*******************************************************************
;	***								***
;	***		戻り速度データ変更cheak				***
;	***		データ監視					***
;	***								***
;	*******************************************************************
;	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_TIM0	,L1=W,DST=_SET1_UPAREA_TIM0	,L2=L,CALLSB=_TIM10MS_TO_1MS	;
;	DATA_STD_CHG_MOV	SRC=_SVP_UPAREA_SPD0	,L1=W,DST=_SET1_UPAREA_SPD0	,L2=L,CALLSB=_CYCLE_SPD2	;基準速度 pls/s
_SPD_DATA_CHANGE_CHK1:
	SUB_START
	MOV.L	#_SVP_UPAREA_SPD0,R5
	MOV.W	@R5,R1
	MOV.L	#_DUM_SET1_UPAREA_SPD0,R6
	MOV.W	@R6,R2
	MOV.W	R1,@R6
	XOR	R1,R2				;
	TST	R2,R2				;
	TST_BIT_OF SPD_DATA_CHG_CK1_200		;

	.AIF	_CB_CPU_SEL EQ	_CB_CPUA	;
	FAR_JSR	#_API_DATA_CHK_CALC_START,R0					;データチェック用
	.AENDI


SPD_DATA_CHG_CK1_200:

	SUB_END
	M_RTS

;	*******************************************************************
;	***								***
;	***		速度データ変更cheak				***
;	***		異常ではなく型タッチ用,データ監視		***
;	***								***
;	*******************************************************************
;	_SVPX1_OBJECT_SPD_TOP:はDPRAM10段またはｼﾘｱﾙ100段の結果
;
_SPD_DATA_CHANGE_CHK2:
	SUB_START


	MOV.L	#_SETX_POS_STEP_MAX,R1				;//設定=1~10(2~11)
	MOV.W	@R1,R8						;
	MOV.L	#_SVPX1_OBJECT_SPD_TOP,R5			;01段目速度(dpram相当)
	MOV.L	#_DUM_SET1_SPD_TOP,R6				;

	XOR	R7,R7

SPD_DATA_CHG_CK2_LOP:
	TST	R8,R8
	TST_BIT_OF SPD_DATA_CHG_CK2_100				;
	MOV.W	@R5+,R1						;
	MOV.W	@R6,R2						;
	MOV.W	R1,@R6						;
	ADD	#2,R6						;
	XOR	R1,R2						;NOW/OLD
	OR	R2,R7						;
	ADD	#-1,R8						;
	M_BRA	SPD_DATA_CHG_CK2_LOP
SPD_DATA_CHG_CK2_100:
	EXTU.W	R7,R7
	TST	R7,R7
	TST_BIT_OF SPD_DATA_CHG_CK2_200				;


	FAR_JSR	#_API_SPD_DATA_CHG_SIG_ON,R0			;2015-10-22

SPD_DATA_CHG_CK2_200:

	SUB_END
	M_RTS



;	*******************************************************************
;	***								***
;	***		画面オーバライド転送兼データ変更監視		***
;	***		データ監視					***
;	***								***
;	*******************************************************************
_OVERLIDE_DATA_CHG_CHK:
	SUB_START

	
	MOV.L	#_SVP_OVERLIDE_COF,R1		;
	MOV.W	@R1,R2				;
	MOV.L	#_DUM_OVERLIDE_COF,R1		;
	MOV.W	@R1,R3				;
	MOV.W	R2,@R1				;
	CMP/EQ	R3,R2				;
	BT	OVERLIDE_DATA_CHG_CK_END	;変更無し

	FAR_JSR	#_API_OVERLIDE_DATA_CHG_SIG_ON,R0	;

OVERLIDE_DATA_CHG_CK_END:

	SUB_END
	M_RTS






;	*******************************************************************
;	***								***
;	***	回転/反転						***
;	***	上昇ホールド角〜３５９の間に待機点が設定されている	***
;	***	(ﾛｯﾄｶｳﾝﾄ対策)						***
;	***								***
;	***	実際には待機点範囲内もだめ		 		***
;	***								***
;	*******************************************************************
;	待機点＋５度が上昇ホールド角度〜１８０の間に設定されている<反転>
;	回転・反転共通
;	(1)目標位置が待機エリアの間にある
;	(2)上昇ホールド角より下に（165~355の間）待機点が設定されている
;	(3)待機エリアに上昇ホールド角がある
;	(4)待機点より上に目標位置がある
;	画面の設定レベルで行う
;
;
_UP_OBJ_POS_SET_DT_CHEAK:
	SUB_START
;	MOV.L	#_SVP_UPHOLD_DIG,R3		;上昇ﾎｰﾙﾄﾞ角度 0.1
;	MOV.L	#_WSVX_CLNK_UP_POS,R1			;
;	MOV.L	#_WSVX_CLNK_UP_POS_UP,R4	;
;	MOV.W	R3,@R4				;待機点＋α
;	MOV.L	#_WSVX_CLNK_UP_POS_DN,R4	;//ｸﾗﾝｸ設定
;	MOV.W	R1,@R4				;待機点-α
;
;	待機点復帰・段取りではこのチェックは行わない
	MOV.L	#_INP_MODE,R1				;
	MOV.W	@R1,R0					;
	TST	#(_W1OPT+_W1CNT+_W1SGL+_W1INC),R0	;
	TST_BIT_OF UP_OBJ_POS_SET_NOMAL			;

;	====== 待機点エリアに上昇ﾎｰﾙﾄﾞがないかどうかチェック ===
	XOR	R7,R7				;
	MOV.L	#_WSVX_CLNK_UP_POS_DN,R0	;開始
	MOV.W	@R0,R1				;
	MOV.L	#_WSVX_CLNK_UP_POS_UP,R0	;終了
	MOV.W	@R0,R3				;
	MOV.L	#_SVP_UPHOLD_DIG,R0		;上昇ﾎｰﾙﾄﾞ角度 0.1
	MOV.W	@R0,R2				;
	FAR_JSR	#_DIG_AREA_CHK0,R0		;この範囲なら異常R0=1範囲内
	OR	R0,R7				;R7!=0 異常



;	====== 待機点エリアに目標位置がないかどうかチェック ===
	MOV.L	#_WSVX_CLNK_UP_POS_DN,R0	;開始
	MOV.W	@R0,R1				;
	MOV.L	#_WSVX_CLNK_UP_POS_UP,R0	;終了
	MOV.W	@R0,R3				;

	MOV.L	#_SETX_POS_STEP_MAX,R0		;//設定=1~10(2~11)
	MOV.W	@R0,R6				;
	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R5	;01段目角度位置

;	===== 待機点範囲にいるか？それなら異常=======
UP_OBJ_POS_SET_DTCHK_150:			;
	TST	R6,R6				;
	TST_BIT_OF UP_OBJ_POS_SET_DTCHK_200	;
	MOV.W	@R5+,R2				;
	FAR_JSR	#_DIG_AREA_CHK0,R0		;この範囲なら異常R0=1範囲内
	OR	R0,R7				;R7!=0 異常
	ADD	#-1,R6				;
	M_BRA	UP_OBJ_POS_SET_DTCHK_150	;
UP_OBJ_POS_SET_DTCHK_200:


	MOV.L	#_SETX_POS_CTL_MATH,R4		;
	MOV.W	@R4,R0				;
	TST	#_DMATH_CNTROT,R0		;回転?
	TST_BIT_ON UP_OBJ_POS_SET_DTCHK_400	;YES

;	----- 2009-10-07下振子対応--------
	TST	#_DMATH_REVRSE,R0		;DRIVE MATH 反転
	TST_BIT_ON UP_OBJ_POS_SET_DTCHK_230	;(反転JUMP)

	MOV.L	#_WSVX_CLNK_UP_POS_UP,R0	;待機終了位置
	MOV.W	@R0,R1				;起点
	MOV	R1,R2				;
	FAR_JSR	#_DIG01_CHG_DN_DATA_MAKE,R0	;
	MOV	R2,R3				;復路の待機開始
	M_BRA	UP_OBJ_POS_SET_DTCHK_240	;待機点〜往路終点の間にあるか？

UP_OBJ_POS_SET_DTCHK_230:			;
;	==== 反転で待機点から180度(下死点)の範囲にあるか？ それ以外なら異常====

	MOV.L	#_WSVX_CLNK_UP_POS,R0		;
	MOV.W	@R0,R1				;

	MOV.L	#_SVP_DNAREA_JUDG,R0		;待機点から180の範囲内なら正常
	MOV.L	@R0,R3				;

UP_OBJ_POS_SET_DTCHK_240:			;
	MOV.L	#_SETX_POS_STEP_MAX,R0		;//設定=1~10(2~11)
	MOV.W	@R0,R6				;

	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R5	;01段目角度位置

;	===== 待機点範囲にいるか？それなら異常=======
UP_OBJ_POS_SET_DTCHK_250:			;
	TST	R6,R6				;
	TST_BIT_OF UP_OBJ_POS_SET_DTCHK_300	;
	MOV.W	@R5+,R2				;
	FAR_JSR	#_DIG_AREA_CHK0,R0		;この範囲なら異常R0=1範囲内
	TST	R0,R0				;
	TST_BIT_ON UP_OBJ_POS_SET_DTCHK_270	;
	MOV	#1,R0
	OR	R0,R7				;R7!=0 異常
UP_OBJ_POS_SET_DTCHK_270:			;

	ADD	#-1,R6				;
	M_BRA	UP_OBJ_POS_SET_DTCHK_250	;
UP_OBJ_POS_SET_DTCHK_300:


;	===0~上昇ﾎｰﾙﾄﾞ間に待機点があればよい ===
	XOR	R1,R1				;0~

	MOV.L	#_WSVX_CLNK_UP_POS,R0		;
	MOV.W	@R0,R2				;

	MOV.L	#_SVP_UPHOLD_DIG,R0		;上昇ﾎｰﾙﾄﾞ角度 0.1
	MOV.W	@R0,R3				;
	FAR_JSR	#_DIG_AREA_CHK0,R0		;この範囲なら異常R0=1範囲内
	TST	R0,R0				;
	TST_BIT_ON UP_OBJ_POS_SET_DTCHK_400	;
	MOV	#2,R0				;
	OR	R0,R7				;R7!=0 異常
UP_OBJ_POS_SET_DTCHK_400:

	TST	R7,R7
	TST_BIT_OF UP_OBJ_POS_SET_NOMAL		;

UP_OBJ_POS_SET_ERR:
;	== 設定異常==
	MEM1_BIT0_TO_BIT7_ORSET MEM=_SV_DAT_ERR1,LG=W,BIT=BIT1,WKREG=R4
	M_BRA	UP_OBJ_POS_SET_END

UP_OBJ_POS_SET_NOMAL:
;	== 設定NOMAL==
	MEM1_BIT0_F_ADCLR MEM=_SV_DAT_ERR1,LG=W,BIT=(~BIT1),WKRG1=R1,WKRG2=R4
UP_OBJ_POS_SET_END:

	SUB_END
	M_RTS

;	***********************************************************
;	***	反転仕様時下限設定があるかどうかのチェック	***
;	***********************************************************
	.AIF	_NEG_SPEC1 EQ _COMPILE_YES	;
_NEG_MOT_CMP_CHEAK:
	SUB_START
	MOV.L	#_SET1_MRTION_SEL1,R1				;
	MOV.W	@R1,R0						;
	CMP/EQ	#_DMATH_REVRSE,R0				;DRIVE MATH 反転
	BF	NEG_MOT_CMP_CHK200				;NO EXIT

	MOV.L	#_SVP_DNAREA_JUDG,R1				;反転時の下限角度
	MOV.L	@R1,R2						;
	MOV	R2,R7						;170.0
	MOV	R7,R8						;
	MOV	R7,R9						;
	ADD	#-1,R8						;169.9
	ADD	#1,R9						;170.1

	MOV.L	#_SET1_MTSTEP_MAXM,R1				;
	MOV.W	@R1,R6						;LOOP回数
	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R5				;01段目角度位置
	ADD	R6,R5						;
	ADD	R6,R5						;*2
	ADD	#-1*2,R5					;

NEG_MOT_CMP_CHK100:
	TST	R6,R6						;
	TST_BIT_OF NEG_MOT_CMP_CHK250				;異常信号ON
	MOV.W	@R5,R2						;
	CMP/EQ	R2,R7						;
	BT	NEG_MOT_CMP_CHK200				;設定に見えている数値が=反転時下限角度 ok!
	CMP/GE	R8,R2						;
	BF	NEG_MOT_CMP_CHK150				;R8=< R2   data < 169.9
	CMP/GE	R2,R9						;
	BT	NEG_MOT_CMP_CHK200				;R2 =< R9 170.1 OK
NEG_MOT_CMP_CHK150:
	ADD	#-2,R5						;ADR
	ADD	#-1,R6						;ｶｳﾝﾀ
	M_BRA	NEG_MOT_CMP_CHK100				;

;	===== 下限有り===
NEG_MOT_CMP_CHK200:
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ADCLR MEM=(_SQ_CBWK_TOP+_WKSQCB212),LG=W,BIT=(~BIT6),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)
	M_BRA	NEG_MOT_CMP_CHK300				;

;	===== 下限無し===
NEG_MOT_CMP_CHK250:
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=(_SQ_CBWK_TOP+_WKSQCB212),LG=W,BIT=(BIT6),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)
NEG_MOT_CMP_CHK300:
	SUB_END
	M_RTS
	.AENDI



;	***********************************
;	***				***
;	***	待機領域作成		***
;	***				***
;	***********************************
;	クランク角度=>リンク
;反転時 _SVP_UPAREA_DIG0		.SRES	2	;待機点角度
;回転時 待機点=0
;

	.EXPORT	_MAK_UP_AREA_DT
_MAK_UP_AREA_DT:
	SUB_START
	MOV.L	#_WSVX_CLNK_UP_POS,R4					;
	MOV.W	@R4,R1							;
	MOV.L	#_SET1_UPAREA_JUDG,R4					;
	MOV.L	@R4,R3							;
	MOV	R3,R2							;
	DIG_REGA_ADD_REGB_ANS_REGB REGA=R1,REGB=R3,WKREG=R4,LATE=D'3600	;ANS R3
	DIG_REGA_SUB_REGB_ANS_REGB REGA=R2,REGB=R1,WKREG=R4,LATE=D'3600	;ANS R1
	MOV.L	#_WSVX_CLNK_UP_POS_UP,R4	;
	MOV.W	R3,@R4				;待機点＋α
	MOV.L	#_WSVX_CLNK_UP_POS_DN,R4	;//ｸﾗﾝｸ設定
	MOV.W	R1,@R4				;待機点-α

	MOV	R3,R2				;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0
	MOV.L	#_SETX_LINK_UP_POS_UP,R0	;ｸﾗﾝｸ->
	MOV.W	R2,@R0				;

	MOV	R1,R2				;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0
	MOV.L	#_SETX_LINK_UP_POS_DN,R0	;ｸﾗﾝｸ設定==>ﾘﾝｸ(範囲比較)
	MOV.W	R2,@R0				;
	SUB_END
	M_RTS




;	***********************************
;	***				***
;	***	往路待機領域作成	***
;	***	2009-10-07		***
;	***********************************


	.EXPORT	_DNM_MAK_UP_AREA_DT
_DNM_MAK_UP_AREA_DT:
	SUB_START
	MOV.L	#_DNM_WSVX_CLNK_UP_POS,R4					;
	MOV.W	@R4,R1							;
	MOV.L	#_SET1_UPAREA_JUDG,R4					;
	MOV.L	@R4,R3							;
	MOV	R3,R2							;
	DIG_REGA_ADD_REGB_ANS_REGB REGA=R1,REGB=R3,WKREG=R4,LATE=D'3600	;ANS R3
	DIG_REGA_SUB_REGB_ANS_REGB REGA=R2,REGB=R1,WKREG=R4,LATE=D'3600	;ANS R1
	MOV.L	#_DNM_WSVX_CLNK_UP_POS_UP,R4	;
	MOV.W	R3,@R4				;待機点＋α
	MOV.L	#_DNM_WSVX_CLNK_UP_POS_DN,R4	;//ｸﾗﾝｸ設定
	MOV.W	R1,@R4				;待機点-α

	MOV	R3,R2				;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0
	MOV.L	#_DNM_SETX_LINK_UP_POS_UP,R0	;ｸﾗﾝｸ->
	MOV.W	R2,@R0				;

	MOV	R1,R2				;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0
	MOV.L	#_DNM_SETX_LINK_UP_POS_DN,R0	;ｸﾗﾝｸ設定==>ﾘﾝｸ(範囲比較)
	MOV.W	R2,@R0				;
	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	C/Bソフト開始前イニシャル	***
;	***					***
;	*******************************************
	.EXPORT	_DATA_CHK_FLG_INI
_DATA_CHK_FLG_INI:
	SUB_START
	XOR	R0,R0
	MOV.L	#_SV_CHG_FLG1,R1		;
	MOV.L	R0,@R1				;
	MOV.L	#_SV_CHG_FLG2,R1		;
	MOV.L	R0,@R1				;

	MOV.L	#_SV_DAT_ERR1,R1		;
	MOV.W	R0,@R1				;

	MOV.L	#_SQ_CBWK_TOP+_WKSQCB212,R1	;
	MOV.W	R0,@R1				;

	MOV.L	#_SVP_AMPERR_TIM1,R1		;過負荷時間1
	MOV.W	@R1,R0				;
	MOV.L	#_PVX_AMPERR_TIM1,R1		;過負荷時間1
	MOV.W	R0,@R1				;

	MOV.L	#_SVP_AMPERR_TIM2,R1		;過負荷時間2
	MOV.W	@R1,R0
	MOV.L	#_PVX_AMPERR_TIM2,R1		;過負荷時間2
	MOV.W	R0,@R1				;

	MOV.L	#_SVP_AMPERR_TIM3,R1		;過負荷時間3
	MOV.W	@R1,R0				;
	MOV.L	#_PVX_AMPERR_TIM3,R1		;過負荷時間3
	MOV.W	R0,@R1				;

	MOV.W	#D'10000,R0			;大きければなんでもいい
	MOV.L	#_CMP_ERR_TIM1,R1		;
	MOV.W	R0,@R1				;
	MOV.L	#_CMP_STEP_ERR_TIM1,R1		;//工程二重回路
	MOV.W	R0,@R1				;

	MOV.W	#D'1000,R2		;
	MOV.L	#_ORG_PRESET_TIM,R1	;
	MOV.W	R2,@R1

;	===== 動作中・停止中タイマ ==
	MEM_MOV_TO_MEM	SRC_ADR=_PAR_STOP_SMPTIM,L1=W,DST_ADR=_PVCK_STOP_SMPTIM,L2=W,WKREG1=R1,WKREG2=R2,WKREG3=R3



	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***				***
;	***				***
;	***********************************
;
;;	.AIF	_PRG_CHG20030127 EQ _COMPILE_YES	;ﾌﾟﾛｸﾞﾗﾑ変更箇所(反転仕様以外の標準に入れる変更)
;;	.AENDI
	.EXPORT	_DAIHAITO_DATA_DEF_SET	;表示用
_DAIHAITO_DATA_DEF_SET:
	SUB_START
	MOV.L	#_PAR_DRVHOS_SEL1,R1	;ﾜｰｸではなく直接 2003-07-09
	MOV.W	@R1,R0			;
	CMP/EQ	#2,R0			;
	BT	DAIHAITO_DATDEFSET_20	;

	MOV.L	#_SET1_DAIHAI_ORG0,R1	;画面設定
	MOV.L	@R1,R0			;
	MOV.L	#_RNA_STLORK,R1		;
	MOV.L	@R1,R2			;
	ADD	R0,R2			;
	MOV.L	#_RNA_ABS_MEMORG,R1	;(原点復帰で作成・１回転)
	MOV.L	R2,@R1			;
	M_BRA	DAIHAITO_DATDEFSET_50	;

DAIHAITO_DATDEFSET_20:

	MOV.L	#_SVB_DYHITO_POS,R1		;BAK-UP ﾀﾞｲﾊｲﾄ(上死点から求まる下限位置)
	MOV.L	@R1,R0				;
	MOV.L	#_RNA_STLORK,R1			;
	MOV.L	@R1,R2				;
	ADD	R0,R2				;
	MOV.L	#_RNA_ABS_MEMORG,R1		;(原点復帰で作成・１回転)
	MOV.L	R2,@R1				;

	MOV.L	#_SET1_MRTION_SEL1,R1				;
	MOV.W	@R1,R0						;
	CMP/EQ	#_DMATH_CNTROT,R0				;
	BF	DAIHAITO_DATDEFSET_50				;

;	====== 段取寸動可能 ===
	MEM1_BIT0_TO_BIT7_ORSET MEM=_ORG_DND_NOMAL_FLG1,LG=W,BIT=BIT0,WKREG=R1	;bit-set

	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=_SQ_CBWK_TOP+_WKSQCB206,LG=W,BIT=(BIT10),WKRG1=R1,WKRG2=R4	;段取寸動OK
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)


DAIHAITO_DATDEFSET_50:


;	表示以外に使用する場合は	S4b	RNA_ABS_HOS_DT=0の処理を行う;//補正ﾃﾞｰﾀ 2003-01-31

;	=================================
	MOV.L	#_SVB_SLIDE_POS,R1	;2003-07-09 生産下限位置
	MOV.L	@R1,R0			;
	MOV.L	#_PRD_DAI_POS0,R1	;
	MOV.L	R0,@R1			;
	MOV.L	#_PRD_DAI_POS1,R1	;
	MOV.L	R0,@R1			;


	SUB_END
	M_RTS



;	***********************************
;	***				***
;	***	2006-09-30		***
;	***	ANALOG 変換		***
;	***				***
;	***********************************
;	----- 2006-09-30------
	.IMPORT	_PV_AD_DATA		; 移動平均とった後の0~1000 DATA
	.EXPORT	_PV_AD_CHAGE_UNIT
_PV_AD_CHAGE_UNIT:
	SUB_START
	MOV.L	#_PV_AD_DATA,R1			;
	MOV.W	@R1,R2				;
	MOV.L	#_WPAR_ANAIN_SEL,R1		;
	MOV.W	@R1,R0				;
	CMP/EQ	#1,R0				;
	BT	PVAD_CHAGEUNIT_100		;

	MOV.L	#_WPV_AD_DATA,R1		;------ TRD
	MOV.W	R2,@R1				;SAVE

	MOV.L	#_WPV_ABS_AD_DATA,R1		;------ SEQ比較
	MOV.W	R2,@R1				;SAVE

	MOV.L	#_SET1_AMP100P_VLT,R1		;
	MOV.W	@R1,R4				;
	MOV.W	#_DT_100PER_1,R1		;data * 100.0per/volt
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;(0割算付防止)
	MOV.L	#_WPV_POWER_MONI,R1		;
	MOV.W	R2,@R1				;
	M_BRA	PVAD_CHAGEUNIT_END		;

PVAD_CHAGEUNIT_100:
	MOV.W	#_DT_100PER_1/2,R1		;1000/2=500AD
	SUB	R1,R2				;
	ADD	R2,R2				;*2
	MOV.L	#_WPV_AD_DATA,R1		;------ TRD
	MOV.W	R2,@R1				;SAVE 符号付

	CMP/PZ	R2				;
	BT	PVAD_CHAGEUNIT_150		;
	NEG	R2,R2				;
PVAD_CHAGEUNIT_150:				;
	MOV.L	#_WPV_ABS_AD_DATA,R1		;------ SEQ比較
	MOV.W	R2,@R1				;SAVE

	MOV.L	#_SET1_AMP100P_VLT,R1		;
	MOV.W	@R1,R4				;
	MOV.W	#_DT_100PER_1,R1		;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;
	MOV.L	#_WPV_POWER_MONI,R1		;絶対値
	MOV.W	R2,@R1				;

PVAD_CHAGEUNIT_END:

	SUB_END
	M_RTS


;	===========================================
;	===	2006-09-30			===
;	===========================================
;	上昇ﾎｰﾙﾄﾞ角＝多段設定があった場合
;	上昇ホールド角＋２度を上昇ホールドとする	;
;164,165の設定があったら
;167に上昇ホールドを変える
;終了方向から探して1個見つけたらそこで終了
_UP_HOLD_HIS	.EQU	10		;163~165-->165->167

	.ALIGN	4			;
_STEP_UP_HOLD_CMP:			;ANS R2:上昇角度
	SUB_START
	MOV.L	#_SVP_UPHOLD_DIG,R3				;上昇ﾎｰﾙﾄﾞ角度 0.1(ｸﾗﾝｸ)
	MOV.W	@R3,R2						;
	MOV.L	#_SETX_POS_CTL_MATH,R4				;
	MOV.W	@R4,R0						;
	TST	#_DMATH_CNTROT,R0				;回転?
	TST_BIT_OF STEP_UP_HLDCMP500				;NO

	MOV	R2,R3						;
	MOV.W	#_UP_HOLD_HIS,R1				;
	SUB	R1,R3						;
	CMP/PZ	R3						;
	BT	STEP_UP_HLDCMP010				;
	XOR	R3,R3						;1度はありえない
STEP_UP_HLDCMP010:						;
	NOP
	MOV.L	#_SETX_POS_STEP_MAX,R1				;//設定=1~10(2~11)
	MOV.W	@R1,R5						;1
	MOV	R5,R0						;
	ADD	#-1,R0						;
	SHLL	R0						;2byte
	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R4				;
	ADD	R0,R4						

STEP_UP_HLDCMP050:						;
	MOV.W	@R4,R1						;
	CMP/EQ	R2,R1						;165
	BT	STEP_UP_HLDCMP100				;YES JUMP
	CMP/EQ	R3,R1						;164 YES JUMP
	BT	STEP_UP_HLDCMP100				;YES JUMP
	ADD	#-2,R4						;
	ADD	#-1,R5						;
	TST	R5,R5						;
	TST_BIT_ON STEP_UP_HLDCMP050				;
	M_BRA	STEP_UP_HLDCMP500				;
STEP_UP_HLDCMP100:						;
	MOV.W	#_UP_HOLD_HIS*2,R1				;
	ADD	R1,R2						;
	MOV.W	#D'3600,R3					;
	CMP/HI	R2,R3						;
	BT	STEP_UP_HLDCMP500				;
	XOR	R2,R2						;ありえない
STEP_UP_HLDCMP500:						;
	SUB_END
	M_RTS





;	-----------------------------------------------------------
;	---							---
;	---							---
;	---							---
;	-----------------------------------------------------------
	.ALIGN	4			;
_PARAM_TIM_DT_CHG:
	SUB_START

	DT_DIV_LATCHG	SRC=_PAR_CMP_ERR_TIM1,L1=W,DST=_WPAR_CMP_ERR_TIM1,L2=W,LATE=_CMP_ERR_LATE1
	DT_DIV_LATCHG	SRC=_PAR_CMP_ERR_TIM2,L1=W,DST=_WPAR_CMP_ERR_TIM2,L2=W,LATE=_CMP_ERR_LATE1


	SUB_END
	M_RTS



;	***************************************************
;	***						***
;	***	INPUT-1DEG PULS				***
;	***	DIG CHANGE				***
;	***	2011-03-23				***
;	***************************************************
;;	.IMPORT	_COS_IN_DEG		;
	.ALIGN	4			;
	.EXPORT		_OFSPLS_DIG_CHANGE1
_OFSPLS_DIG_CHANGE1
	SUB_START
;;;	MOV.L	#_INC_LINK_NOWROT_OFSPLS_P,R1			;[[[実測 1REV PLS]]]
;;;	MOV.L	@R1,R2						;

	MOV.L	#_LINK_1ROT_PLS,R1				;
	MOV.L	@R1,R4						;
	CMP/HI	R2,R4						;
	BT	OFSPLS_DIGCHG1_100					;R2<R4
	XOR	R2,R2						;
	BT	OFSPLS_DIGCHG1_200					;
OFSPLS_DIGCHG1_100
	MOV.L	#D'360000,R1					;0.001度　360.000
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;

OFSPLS_DIGCHG1_200


	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***	ブレーキテストの待機点範囲	***
;	***	2011-09-14			***
;	*******************************************
	.ALIGN	4			;
_BRKTST_AREA_DT_MAK:
	SUB_START

	MOV.L	#_WPAR_BRKTST_ORGDEG,R4					;ｸﾗﾝｸ角度
	MOV.W	@R4,R1							;
	MOV.L	#_SET1_UPAREA_JUDG,R4					;
	MOV.L	@R4,R3							;ｸﾗﾝｸ角度
	MOV	R3,R2							;
	DIG_REGA_ADD_REGB_ANS_REGB REGA=R1,REGB=R3,WKREG=R4,LATE=D'3600	;ANS R3
	DIG_REGA_SUB_REGB_ANS_REGB REGA=R2,REGB=R1,WKREG=R4,LATE=D'3600	;ANS R1
	MOV.L	#_BRKTST_CLNK_UP_POS_UP,R4	;クランクDIG 0.1度
	MOV.W	R3,@R4				;待機点＋α
	MOV.L	#_BRKTST_CLNK_UP_POS_DN,R4	;
	MOV.W	R1,@R4				;待機点-α

	MOV	R3,R2				;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0
	MOV.L	#_BRKTST_LINK_UP_POS_UP,R0	;ｸﾗﾝｸ->ﾘﾝｸ角度0.1度
	MOV.W	R2,@R0				;

	MOV	R1,R2				;
	FAR_JSR	#_SV_CLNK_DG_CHG_LINK_DG1,R0	;
	MOV.L	#_BRKTST_LINK_UP_POS_DN,R0	;ｸﾗﾝｸ->ﾘﾝｸ角度0.1度
	MOV.W	R2,@R0				;

	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***	ふりこモードか？		***
;	***	2010-10-05			***
;	*******************************************
;	R0=0
;	R0=0以外

	.ALIGN	4				;
_CHK_DNM_SPEC_MOD1:
	SUB_START

	.AIF _CHG_DNM_20170225 EQ _CMPILE_YES	;
	FAR_JSR	#_DNM_ACC_MATHED_SELECT,R0
	.AENDI

	FAR_JSR	#_CHK_DNM_SPCMOD_CHK2,R0			;2011-12-05
	TST	R0,R0						;2011-12-05
	TST_BIT_OF CHK_DNM_SPCMOD_100				;2011-12-05　brk-mode then "r0=0"

	MOV.L	#_WPAR_ACC_MATHED,R1				;
	MOV.W	@R1,R0						;
	CMP/EQ	#1,R0						;
	BF	CHK_DNM_SPCMOD_100

	MOV.L	#_SETX_POS_CTL_MATH,R1				;
	MOV.W	@R1,R0						;
	TST	#_DMATH_DNDRIV,R0				;
	TST_BIT_OF CHK_DNM_SPCMOD_100				;

	MOV.L	#_INP_MODE,R1					;
	MOV.W	@R1,R0						;
	TST	#(_W1OPT+_W1CNT+_W1SGL),R0			;SGLで制動試験ﾓｰﾄﾞもやるから.
	TST_BIT_OF CHK_DNM_SPCMOD_100				;[ふりこのテーブルは寸動はしない]


	MOV.L	#_cbsys_tbl_err,R1				;//PARAM-TABLE-ERR
	MOV.W	@R1,R0						;
	TST	R0,R0
	TST_BIT_ON CHK_DNM_SPCMOD_090				;

	MOV.W	#1,R0
	M_BRA	CHK_DNM_SPCMOD_END				;

CHK_DNM_SPCMOD_090:

	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=(_SQ_CBWK_TOP+_WKSQCB224),LG=W,BIT=(BIT8),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)



CHK_DNM_SPCMOD_100
	XOR	R0,R0

CHK_DNM_SPCMOD_END
	SUB_END
	M_RTS





	.ALIGN	4				;
_CHK_DNM_SPEC_MODA1X:
	SUB_START

	FAR_JSR	#_CHK_DNM_SPCMOD_CHK2,R0			;2011-12-05
	TST	R0,R0						;2011-12-05
	TST_BIT_OF CHK_DNM_SPCMODA1X_100				;2011-12-05　brk-mode then "r0=0"

	MOV.L	#_WPAR_ACC_MATHED,R1				;
	MOV.W	@R1,R0						;
	CMP/EQ	#1,R0						;
	BF	CHK_DNM_SPCMODA1X_100

	MOV.L	#_SETX_POS_CTL_MATH,R1				;
	MOV.W	@R1,R0						;
	TST	#_DMATH_DNDRIV,R0				;
	TST_BIT_OF CHK_DNM_SPCMODA1X_100				;

	MOV.L	#_INP_MODE,R1					;
	MOV.W	@R1,R0						;
	TST	#(_W1OPT+_W1CNT+_W1SGL+_W1INC),R0		;
	TST_BIT_OF CHK_DNM_SPCMODA1X_100				;寸動は直線だが最大速度はふりこテーブルから


	MOV.L	#_cbsys_tbl_err,R1				;//PARAM-TABLE-ERR
	MOV.W	@R1,R0						;
	TST	R0,R0
	TST_BIT_ON CHK_DNM_SPCMODA1X_090				;

	MOV.W	#1,R0
	M_BRA	CHK_DNM_SPCMODA1X_END				;

CHK_DNM_SPCMODA1X_090:
	DI_PUSH_SR_SH3	WK_REG1=R1,WK_REG2=R4	;2020-05-07(2019-11-26)
	MEM1_BIT0_F_ORSET MEM=(_SQ_CBWK_TOP+_WKSQCB224),LG=W,BIT=(BIT8),WKRG1=R1,WKRG2=R4
	EI_POP_SR_SH3 							;2020-05-07(2019-11-26)



CHK_DNM_SPCMODA1X_100
	XOR	R0,R0

CHK_DNM_SPCMODA1X_END
	SUB_END
	M_RTS











_CHK_DNM_SPCMOD_CHK2:						;
	SUB_START
	XOR	R2,R2

;	-------2011-12-02------------
	MOV.L	#_BRKTST_INPUT_CMD,R1				;
	MOV.W	@R1,R0						;
	TST	#BIT0,R0					;
	TST_BIT_ON CHK_DNM_SPCMODCHK2_100			;安全一行程だがテストモードだ
	ADD	#1,R2						;
CHK_DNM_SPCMODCHK2_100:						;
;	------------------------------
	MOV	R2,R0						;
	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***					***
;	***					***
;	***	モーション繰り返し		***
;	***	位置決め部			***
;	***					***
;	***					***
;	***					***
;	*******************************************
;	DIRECTION
	.ALIGN	4					;
_MOT_REP_DTMAKE:
	SUB_START
	MOV.L	#_SET1_MOTREP_USEFUL,R1		;
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_ON MOT_REPDTMAK_100		;
	M_BRA	MOT_REPDTMAK_EXT		;

MOT_REPDTMAK_100:




;	--------- 戻りの際の目標角度------------


	MOV.L	#_SET1_MOTREP_STGS,R1		;
	MOV.W	@R1,R0				;
	CMP/EQ	#1,R0				;
	BF	MOT_REPDTMAK_150		;

	MOV.B	#BIT1,R0			;方向:逆転
	MOV.L	#_SETX_MOTREP_DIR,R1		;//設定上どっちの方向　  1:-1
	MOV.W	R0,@R1				;

	MOV.L	#_SETX_UPAREA_DIG,R1		;2;回転/反転時待機点
	MOV.W	@R1,R2				;
	MOV.L	#_REP_CAMOBJ_DIG,R1		;//ｶﾑ用の戻り目標角度
	MOV.W	R2,@R1				;
	M_BRA	MOT_REPDTMAK_300		;


MOT_REPDTMAK_150:				;
	ADD	#-2,R0				;
	SHLL	R0				;2byte
	MOV.L	#_SET1_OBJECT_DIG_TOP,R1	;
	ADD	R0,R1				;
	MOV.W	@R1,R2				;
	MOV.L	#_REP_CAMOBJ_DIG,R1		;//ｶﾑ用の戻り目標角度
	MOV.W	R2,@R1				;


	MOV.L	#_SET1_MOTREP_STGS,R1		;
	MOV.W	@R1,R0				;
	ADD	#-2,R0				;
	SHLL	R0
	MOV.L	#_SVPX1_OBJECT_DIG_TOP,R4	;
	ADD	R4,R0				;
	MOV.W	@R0,R2				;戻りの目標各ｸﾗﾝｸ

	MOV.L	#_SET1_MOTREP_STGE,R1		;//繰り返し終了行程[この工程は停止工程とする]
	MOV.W	@R1,R0				;
;;;;2014-10-06	ADD	#-2,R0				;間違い
	ADD	#-1,R0				;正解
	SHLL	R0
	ADD	R4,R0				;
	MOV.W	@R0,R3				;戻りの開始角度

	XOR	R0,R0				;動かない
	CMP/EQ	R3,R2				;R3[終了] == R2[開始]
	BT	MOT_REPDTMAK_250		;同じ位置

	XOR	R0,R0
	CMP/HI	R3,R2				;R3[開始]<R2[終了]
	BT	MOT_REPDTMAK_250		;正

	MOV.B	#BIT1,R0			;逆転
MOT_REPDTMAK_250:
	MOV.L	#_SETX_MOTREP_DIR,R1		;//設定上どっちの方向　  1:-1
	MOV.W	R0,@R1				;

MOT_REPDTMAK_300:


MOT_REPDTMAK_EXT:

	SUB_END
	M_RTS














;	*******************************************
;	***					***
;	***					***
;	***					***
;	***	寸動任意起動			***
;	***	起動角度サーチ			***
;	***	［一応汎用ルーチン］		***
;	***					***
;	***					***
;	*******************************************
;	-------------------------------------------
;	---					---
;	---	待機点領域以外であること	---
;	---	待機点領域はその上でﾁｪｯｸする。	---
;	---					---
;	-------------------------------------------
;	------- "input　R7" R7を最初に跨ぐ行程をｻｰﾁする -----
;	OFS_P->R7
;	ANS    	R0=R6 行程1~11 0:存在しない領域
;		R5:BIT1=0/BIT1=1
;
	.EXPORT	_POS_STEP1_SEARCH		;
_POS_STEP1_SEARCH:
	SUB_START

	MOV.L	#_SETX_UPAREA_PLS,R1		;//4;待機点
	MOV.L	@R1,R2				;起点(Sn_1)
	MOV.L	#_SETX_POS_SDAT1_INF1,R14	;方向　.LONG
	MOV.L	#_SETX_POS_SDAT1_OFSPOS,R12	;POSITON [待機点+α] 待機点＜目標位置
	MOV.B	#1,R6				;対象行程 1~11

POS_STEP1_SRCH_100:
	MOV	R2,R3				;Sn-->Sn_1
	MOV.L	@R14+,R0			;BIT1=1:逆転 BIT1=0:正
	MOV.L	@R12+,R2			;POS
	MOV	R0,R5				;方向(ANS)

	TST	#BIT1,R0			;逆転?
	TST_BIT_ON POS_STEP1_SRCH_300		;YES:逆転

;	------------- "正":R3(Sn_1)＜ R7(SX) ≦R2(Sn) ---------------
	CMP/GT	R2,R7				;Sn_1 < R7 =<Sn ｲｺｰﾙも含む
	BT	POS_STEP1_SRCH_500		;Sn< R7 対象外

	CMP/GE	R7,R3				;
	BT	POS_STEP1_SRCH_500		;R7=< Sn_1 対象外

;	------対象位置の存在する行程がある-----------
	M_BRA	POS_STEP1_SRCH_700		;"R6":行程番号


POS_STEP1_SRCH_300:
;	------------- "逆":R3(Sn_1)＞ R7(SX) ≧R2(Sn) ---------------
	CMP/GT	R7,R2				;
	BT	POS_STEP1_SRCH_500		;R7<R2:範囲外

	CMP/GE	R3,R7				;
	BT	POS_STEP1_SRCH_500		;R3≦R7:範囲外

;	------対象位置の存在する行程がある-----------
	M_BRA	POS_STEP1_SRCH_700		;"R6":行程番号

;	-------------- NEXT ---------------
POS_STEP1_SRCH_500:
	ADD	#1,R6				;

	MOV.L	#_SETX_POS_STEP_MAX,R1		;
	MOV.W	@R1,R0				;LOOP data 1~10
	ADD	#1,R0				;2~11

	CMP/HI	R0,R6				;
	BT	POS_STEP1_SRCH_600		;11<12 見つからなかった 11は回転では1回転先の待機点
	M_BRA	POS_STEP1_SRCH_100		;


POS_STEP1_SRCH_600
	XOR	R6,R6				;ﾃﾞｰﾀが存在しない
	M_BRA	POS_STEP1_SRCH_END		;
POS_STEP1_SRCH_700
	NOP					;ANS 	R6
						;	R5
						;	R3
						;	R2

POS_STEP1_SRCH_END
	MOV	R6,R0				;ANS R0(R6)=行程,
						;	R5=方向 BIT1=0(正)/1(逆)
						;	R3(Sn_1)
						;	R2(Sn)
						;	R7:input(目標位置)

	SUB_END
	M_RTS





























;	*******************************************
;	***					***
;	***					***
;	***	2013-06-20			***
;	***	ここは全てのラベルがある	***
;	***					***
;	*******************************************
;	全部で
	.ALIGN	4			;
_DUMMY_MEM	.DATA.L		0
;;	.GLOBAL				;移動平均8回後
;;	.GLOBAL		_CPUD_PV_AD3		;移動平均8回後
;;	.GLOBAL		_CPUD_PV_AD4		;移動平均8回後
	.ALIGN	4			;

;	C00(4)*8,A00(2)*8を対象

	.ALIGN	4			;
_DEBUG_MONI_LABEL00
	.DATA.L	_RNA_CTL_POS1			;00:0:H		DBG4_MONI_*00 ﾘﾆｱ
	.DATA.L	_RNA_CTL_POS1+2			;01:0:L		
	.DATA.L	_SH_POSCTL_RL_ABSPLS+4		;02:1:H CPUA	DBG4_MONI_*01 目標ﾊﾟﾙｽ
	.DATA.L	_SH_POSCTL_RL_ABSPLS+4+2	;03:1:L 	
	.DATA.L	_SH_POSCTL_RL_ABSPLS+8+4	;04:2:H CPUB	DBG4_MONI_*02 実測ﾊﾟﾙｽ
	.DATA.L	_SH_POSCTL_RL_ABSPLS+8+4+2	;05:2:L		
	.DATA.L	_DUMMY_MEM			;06:3:H CPUB	DBG4_MONI_*03 
	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
	.DATA.L	_CPUD_AD_INF
	.AELSE
	.DATA.L	_SH2_AD_DATA			;07:3:L		　　　　　　　ﾊﾟﾜｰﾓﾆﾀ
	.AENDI
	.DATA.L	_DUMMY_MEM			;08:4:H		DBG4_MONI_*04 
	.DATA.L	_DUMMY_MEM			;09:4:L
	.DATA.L	_DUMMY_MEM			;10:5:H		DBG4_MONI_*05 
	.DATA.L	_DUMMY_MEM			;11:5:L
	.DATA.L	_DUMMY_MEM			;12:6:H		DBG4_MONI_*06 
	.DATA.L	_DUMMY_MEM			;13:6:L
	.DATA.L	_DUMMY_MEM			;14:7:H		DBG4_MONI_*07
	.DATA.L	_DUMMY_MEM			;15:7:L
	.DATA.L	_OBJ_ENC360			;16 DIG		DBG2_MONI_*00角度
	.DATA.L	_INC_ENC360			;17 DIG		DBG2_MONI_*01角度
	.DATA.L	_PV_OUT_SPD_PER			;18 SPD		DBG2_MONI_*02目標速度
	.DATA.L	_PV_ENC_SPD_PER			;19 SPD 	DBG2_MONI_*03実速度

	.AIF	_CB_CPU_SEL EQ	_CB_CPUA	
						;2015-08-12
	.DATA.L	_PVX_CPUD_AD2			;_CPUD_PV_AD2	;20 KJ		DBG2_MONI_*04左荷重
	.DATA.L	_PVX_CPUD_AD3			;_CPUD_PV_AD3	;21 KJ		DBG2_MONI_*05右荷重
	.DATA.L	_PVX_CPUD_AD4			;_CPUD_PV_AD4	;22 KJ		DBG2_MONI_*06合計荷重
	.AELSE
	.DATA.L	_DUMMY_MEM			;20
	.DATA.L	_DUMMY_MEM			;21
	.DATA.L	_DUMMY_MEM			;22
	.AENDI

	.DATA.L	_DUMMY_MEM			;23[SQ]		DBG2_MONI_*07


	.ALIGN	4			;
_DEBUG_MONI_LABEL01
	.DATA.L	_LINK_RL_OBJ_ABSPLS+4		;00:0:H		DBG4_MONI_*00 ﾘﾆｱ
	.DATA.L	_LINK_RL_OBJ_ABSPLS+6		;01:0:L		
	.DATA.L	_SH_POSCTL_RL_ABSPLS+4		;02:1:H CPUA	DBG4_MONI_*01 目標ﾊﾟﾙｽ
	.DATA.L	_SH_POSCTL_RL_ABSPLS+4+2	;03:1:L 	
	.DATA.L	_SH_POSCTL_RL_ABSPLS+8+4	;04:2:H CPUB	DBG4_MONI_*02 実測ﾊﾟﾙｽ
	.DATA.L	_SH_POSCTL_RL_ABSPLS+8+4+2	;05:2:L		
	.DATA.L	_DUMMY_MEM			;06:3:H CPUB	DBG4_MONI_*03 
	.DATA.L	_POS_HLDSTOP1_FLG		;07:3:L		　　　　　　　ﾊﾟﾜｰﾓﾆﾀ
	.DATA.L	_DUMMY_MEM			;08:4:H		DBG4_MONI_*04 
	.DATA.L	_DUMMY_MEM			;09:4:L
	.DATA.L	_DUMMY_MEM			;10:5:H		DBG4_MONI_*05 
	.DATA.L	_DUMMY_MEM			;11:5:L
	.DATA.L	_DUMMY_MEM			;12:6:H		DBG4_MONI_*06 
	.DATA.L	_DUMMY_MEM			;13:6:L
	.DATA.L	_DUMMY_MEM			;14:7:H		DBG4_MONI_*07
	.DATA.L	_DUMMY_MEM			;15:7:L
	.DATA.L	_SH4_HD_POS_START		;16 DIG		DBG2_MONI_*00角度
	.DATA.L	_SH2_HD_POS_START		;17 DIG		DBG2_MONI_*01角度
	.DATA.L	_SH4_HD_HLDSTOP1		;18 SPD		DBG2_MONI_*02目標速度
	.DATA.L	_SH2_HD_HLDSTOP1		;19 SPD 	DBG2_MONI_*03実速度
	.DATA.L	_POS_HOLD_CMD			;20 KJ		DBG2_MONI_*04左荷重
	.DATA.L	_POS_HOLD_FLG			;21 KJ		DBG2_MONI_*05右荷重
	.DATA.L	_POS_HOLD_RESTARTCMD		;22 KJ		DBG2_MONI_*06合計荷重
	.DATA.L	_DUMMY_MEM			;23[SQ]		DBG2_MONI_*07


;	---------------------- 手動パルサ-------------------
	.ALIGN	4			;
_DEBUG_MONI_LABEL02
	.DATA.L	_TEP_POS_ADD_CNT		;00:0:H		DBG4_MONI_*00 ﾘﾆｱ
	.DATA.L	_TEP_POS_ADD_CNT+2		;01:0:L		
	.DATA.L	_SH_POSCTL_RL_ABSPLS+4		;02:1:H CPUA	DBG4_MONI_*01 目標ﾊﾟﾙｽ
	.DATA.L	_SH_POSCTL_RL_ABSPLS+6		;03:1:L 	
	.DATA.L	_SH_POSCTL_RL_ABSPLS+8+4	;04:2:H CPUB	DBG4_MONI_*02 実測ﾊﾟﾙｽ
	.DATA.L	_SH_POSCTL_RL_ABSPLS+8+6	;05:2:L		
	.DATA.L	_SH_POSCTL_REST_PLS+4		;06:3:H CPUB	DBG4_MONI_*03 
	.DATA.L	_SH_POSCTL_REST_PLS+6		;07:3:L		　　　　　　　ﾊﾟﾜｰﾓﾆﾀ
	.DATA.L	_DUMMY_MEM			;08:4:H		DBG4_MONI_*04 
	.DATA.L	_DUMMY_MEM			;09:4:L
	.DATA.L	_DUMMY_MEM			;10:5:H		DBG4_MONI_*05 
	.DATA.L	_DUMMY_MEM			;11:5:L
	.DATA.L	_DUMMY_MEM			;12:6:H		DBG4_MONI_*06 
	.DATA.L	_DUMMY_MEM			;13:6:L
	.DATA.L	_DUMMY_MEM			;14:7:H		DBG4_MONI_*07
	.DATA.L	_DUMMY_MEM			;15:7:L
	.DATA.L	_OBJ_ENC360			;16 DIG		DBG2_MONI_*00角度
	.DATA.L	_INC_ENC360			;17 DIG		DBG2_MONI_*01角度
	.DATA.L	_PV_OUT_SPD_PER			;18 SPD		DBG2_MONI_*02目標速度
	.DATA.L	_SH_POSCTL_REST_PLS+2		;19 SPD CPUA	DBG2_MONI_*03実速度
	.DATA.L	_TEP_STEP_WTTM			;20 KJ		DBG2_MONI_*04左荷重
	.DATA.L	_TEP_CNTSMP_TIM			;21 KJ		DBG2_MONI_*05右荷重
	.DATA.L	_TEP_CHG_SPD2+2			;22 KJ		DBG2_MONI_*06合計荷重
	.DATA.L	_TEP_STEP_FLG			;23[SQ]		DBG2_MONI_*07　SQBIT8~BIT15

	.ALIGN	4			;2010-08-23
	.EXPORT	_CPU_DEBUG_MONITOR	;
_CPU_DEBUG_MONITOR
	SUB_START

	MOV.L	#_SVP_MOADRF_SQL,R1	;
	MOV.W	@R1,R0			;
	AND	#H'00,R0		;MAX 00,01 2ﾊﾟﾀｰﾝ
	MOV.W	#D'24*4,R4		;
	DMULS.L	R4,R0			;

	MOV.L	#_DEBUG_MONI_LABEL00,R5	;
	STS	MACL,R1			;
	ADD	R1,R5			;

 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	MOV.L	#_DBG4_MONI_A00,R6
 .AELSE
	MOV.L	#_DBG4_MONI_B00,R6
 .AENDI
 
	MOV.W	#D'24,R3								;

CPU_DEBUG_MONLOOP
	MOV.L	@R5+,R1	;
	MOV.W	@R1,R0
	MOV.W	R0,@R6
	ADD	#2,R6
	ADD	#-1,R3
	TST	R3,R3
	TST_BIT_ON CPU_DEBUG_MONLOOP


;	---	2015-08-12	---
 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	FAR_JSR	#_CPU_DEBUG2_MONI,R0
 .AENDI

	SUB_END
	M_RTS

;	-------- 2015-08-12----------
 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	.ALIGN	4				;
_DEBUG_MONI2_LABEL01
	.DATA.L	_CPUD_PV_AD2			;
	.DATA.L	_CPUD_PV_AD3			;
	.DATA.L	_CPUD_PV_AD4			;
	.DATA.L	_CPUD_AD_INF			;
	.DATA.L	_PVX_CPUD_AD2			;
	.DATA.L	_PVX_CPUD_AD3			;
	.DATA.L	_PVX_CPUD_AD4			;
	.DATA.L	_DUMMY_MEM			;


_CPU_DEBUG2_MONI
	SUB_START

	MOV.L	#_DEBUG_MONI2_LABEL01,R5
	MOV.L	#_WK_DBG2B_B_MONI,R6

	MOV.W	#D'8,R3								;
CPU_DEBUG2_MONLOOP
	MOV.L	@R5+,R1	;
	MOV.W	@R1,R0
	MOV.W	R0,@R6
	ADD	#2,R6
	ADD	#-1,R3
	TST	R3,R3
	TST_BIT_ON CPU_DEBUG2_MONLOOP
	SUB_END
	M_RTS

 .AENDI		;//CPUA




	.EXPORT	_CPU_SV_HAND_ACK		;
	.EXPORT	_PV_DATA_DP_MOV			;
	.EXPORT	_RENEA_CENCER_LOAD		;
	.EXPORT	_CYCLE_END_DISP_SET		;
	.EXPORT	_LOT_SIG_SET

	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
		.INCLUDE	"ssa_dtm4.inc"		; //
		.INCLUDE	"ssa_dtchk.inc"		; //2013-02-20 ﾓｰｼｮﾝﾃﾞｰﾀﾁｪｯｸ
	.AELSE
		.INCLUDE	"ssa_dtm2.inc"		; //
	.AENDI



;	------- 2015-09-30
	.INCLUDE	"ssa_dtmk100.inc"		; //100段に関わる



;	*******************************************
;	***					***
;	***					***
;	***					***
;	***	2015-07-14			***
;	***					***
;	***					***
;	***					***
;	*******************************************
;	ANS R0=1(ﾃﾞﾊﾞｯｸﾓｰﾄﾞ),R0=0
	.EXPORT	_API_WDT_DEBUG_USEFUL
	
_API_WDT_DEBUG_USEFUL
	SUB_START
	PUSH_REG1 R1
	PUSH_REG1 R2

	MOV.L	#_PAR_DEBUG_WDT_STOP,R1		;[ROM参照の必要ある?]
	MOV.W	@R1,R0				;
	MOV.W	#H'5AA5,R2			;
	CMP/EQ	R2,R0				;
	BF	API_WDT_DBGUSEFUL_NO		;NO!

	MOV.L	#_SVP_MACINE_SEL1,R1		;
	MOV.W	@R1,R0				;
	MOV.W	#_MCN_FUJI_DBG1,R2		;
	CMP/EQ	R2,R0				;
	BF	API_WDT_DBGUSEFUL_NO

	MOV.B	#1,R0				;
	M_BRA	API_WDT_DBGUSEFULEND		;

API_WDT_DBGUSEFUL_NO
	XOR	R0,R0
API_WDT_DBGUSEFULEND

	POP_REG1 R2
	POP_REG1 R1

	SUB_END
	M_RTS





;	*******************************************
;	***					***
;	***	2015-07-14			***
;	***					***
;	*******************************************
	.EXPORT	_CPU_AB_WDTCHK_INIT
	.EXPORT	_CPU_AB_1MSEC_ERRCHK
	
_CPU_AB_1MSEC_ERRCHK:
	SUB_START
	DN_TIME W,_PON_ERR_WAIT_TIM,R1,R2		; 

 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	FAR_JSR	#_CPU_A_B_DPRAM_CHK,R0			;DPRAM
	FAR_JSR	#_CPU_A_B_DPRAM_ANS,R0
 .AELSE
	FAR_JSR	#_CPU_A_B_DPRAM_CHK,R0			;DPRAM
	FAR_JSR	#_CPU_A_B_DPRAM_ANS,R0

 .AENDI

	SUB_END
	M_RTS

_CPU_AB_WDTCHK_INIT
	SUB_START

	MOV.W	#D'5000,R0		;
	MOV.L	#_PON_ERR_WAIT_TIM,R1		;//5秒
	MOV.W	R0,@R1				;

	MOV.W	#D'10,R0			;
	MOV.L	#_DPCHK_CPU_ERR_TIM,R1		;
	MOV.W	R0,@R1				;
	
	SUB_END
	M_RTS


;	*******************************************
;	***					***
;	***	2015-07-14			***
;	***	DPRAM故障兼WDT			***
;	***					***
;	***					***
;	*******************************************

;	----- CPUBはCALLしない-------------
_CPU_A_B_DPRAM_CHK
	SUB_START

 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	MOV.L	#_WDT_A_TO_B_REQ,R5			;//A wr-REQ
	MOV.L	#_WDT_A_TO_B_ANS,R6			;//B wr-ANS
 .AELSE
	MOV.L	#_WDT_B_TO_A_REQ,R5			;//B wr-REQ
	MOV.L	#_WDT_B_TO_A_ANS,R6			;//A wr-ANS
 .AENDI
	MOV.L	#_DPCHK_WR_COD,R7			;
	MOV.W	@R7,R2					;


	MOV.W	@R5,R0					;WR-REQ
	CMP/EQ	R2,R0					;書いたものと一致しない
	BF	CPU_A_B_DPCHK_NG			;即NGでもいい話
	MOV.W	@R6,R0					;ANS
	NOT	R0,R0					;
	CMP/EQ	R2,R0
	BF	CPU_A_B_DPCHK_NG			;2msecは時間が必要
	M_BRA	CPU_A_B_DPCHK_OK			;


CPU_A_B_DPCHK_NG:
	MOV.L	#_PON_ERR_WAIT_TIM,R1		;//5秒
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_ON CPU_A_B_DPCHK_WAIT		;WAIT時間中 SAFE

	MOV.L	#_DPCHK_CPU_ERR_TIM,R1		;
	MOV.W	@R1,R0				;
	TST	R0,R0				;
	TST_BIT_OF CPU_A_B_DPCHK_ERR		;
	ADD	#-1,R0				;
	MOV.W	R0,@R1				;まだ大丈夫
	M_BRA	CPU_A_B_DPCHK_END		;

CPU_A_B_DPCHK_ERR:


	FAR_JSR	#_API_WDT_DEBUG_USEFUL,R0	;WDT異常検出禁止[0x5AA5]2015-02-25
	TST	R0,R0
	TST_BIT_OF CPU_A_B_DPCHK_ERRSTOP	;
	M_BRA	CPU_A_B_DPCHK_WAIT		;


CPU_A_B_DPCHK_ERRSTOP:
	MEM1_BIT0_TO_BIT7_ORSET MEM=_DPCHK_ERR_SIG,LG=W,BIT=BIT0,WKREG=R1	;復帰しない

	M_BRA	CPU_A_B_DPCHK_END						;

;	-----------------------------------
CPU_A_B_DPCHK_OK:
 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	MOV.W	@R7,R2				;設定用内部ﾃﾞｰﾀ
	ADD	#1,R2				;CPUAは加算
	MOV.W	R2,@R7				;
 .AELSE
	MOV.W	@R7,R2				;
	ADD	#-1,R2				;CPUBは減算
	MOV.W	R2,@R7				;
 .AENDI
	MOV.W	R2,@R5				;DPRAM SET

CPU_A_B_DPCHK_WAIT:
	MOV.W	#D'10,R0			;10ms
	MOV.L	#_DPCHK_CPU_ERR_TIM,R1		;
	MOV.W	R0,@R1				;

CPU_A_B_DPCHK_END:

	SUB_END
	M_RTS


;	----- CPUBはCALLしない-------------
_CPU_A_B_DPRAM_ANS
	SUB_START

 .AIF	_CB_CPU_SEL EQ	_CB_CPUA
	MOV.L	#_WDT_B_TO_A_REQ,R5	;
	MOV.L	#_WDT_B_TO_A_ANS,R6	;
 .AELSE
	MOV.L	#_WDT_A_TO_B_REQ,R5	;
	MOV.L	#_WDT_A_TO_B_ANS,R6	;
 .AENDI
	MOV.W	@R5,R0		;REQ
	NOT	R0,R0		;反転
	MOV.W	R0,@R6		;ANS

	SUB_END
	M_RTS



;	*******************************************
;	***					***
;	***					***
;	***					***
;	***					***
;	***	2015-02-25			***
;	***	ﾊﾟﾗﾒｰﾀ送信/受信			***
;	***	(送信CPUC,CPUB)			***
;	***	(受信CPUA)			***
;	***					***
;	***					***
;	***					***
;	***					***
;	*******************************************
	.IMPORT	_CBSYS_TOP				;


;	--------ﾊﾟﾗﾒｰﾀﾍﾞﾘﾌｧｲ(CPUA<=>CPUB)-------
	.IMPORT	_SVX_SEND_PAR_NO	;CPUB=>CPUA
	.IMPORT	_SVX_SEND_PAR_DAT	;
;	input DPRAM


	.AIF	_CB_CPU_SEL EQ	_CB_CPUA
;	*******************************************
;	***					***
;	***	2015-07-14			***
;	***	ﾊﾟﾗﾒｰﾀ受信＋ﾍﾞﾘﾌｧｲ		***
;	***	CPUA				***
;	***					***
;	*******************************************
;	DPRAM _SVX_SEND_PAR_NO			;
;	DPRAM _SVX_SEND_PAR_DAT			;

_CPUA_CPUB_PARAM_RCV
	SUB_START

;;[]	MOV.L	#_SVX_SEND_PAR_NO,R5		;CPUA取込終わり?[NO.]=>0=>[NO+1]=>0....
;;[]	MOV.L	#_SVX_SEND_PAR_DAT,R6		;
;;[]	MOV.L	#_CPUB_PARAM_ERR_NO,R7		;//ﾍﾞﾘﾌｧｲ異常
;;[]	FAR_JSR	#_CPUA_CPUX_PARAM_RCV,R0	;

	SUB_END
	M_RTS

	.AELSE

;	*******************************************
;	***					***
;	***	2015-02-25			***
;	***	ﾊﾟﾗﾒｰﾀ送信			***
;	***	CPUB	B=>A			***
;	***					***
;	*******************************************
_CPUB_PARAM_SEND:
	SUB_START

;;[]	MOV.L	#_SVX_SEND_PAR_NO,R5		;CPUA取込終わり? [NO.]=>0=>[NO+1]=>0....
;;[]	MOV.L	#_SVX_SEND_PAR_DAT,R6		;
;;[]	FAR_JSR	#_CPUX_PARAM_SEND,R0		;

	SUB_END
	M_RTS

	.AENDI	;//CPUA<=>CPUB



;	***********************************
;	***				***
;	***	CPUC,CPUB ===>共通	***
;	***				***
;	***********************************
_CPUX_PARAM_SEND:
	SUB_START

	MOV.L	#_CPUX_PARAM_SEND_FLG,R7	;//1~512:512まで送ったら終了
	MOV.W	@R7,R0				;R7=CPUX_PARAM_SEND_FLG
	TST	#BIT6,R0			;
	TST_BIT_ON CPUX_PARSEND_END	;
	TST	#BIT0,R0			;
	TST_BIT_ON CPUX_PARSEND_100	;
	MOV.B	#BIT0,R0			;
	MOV.W	R0,@R7				;R7=CPUX_PARAM_SEND_FLG

	XOR	R0,R0				;
	MOV.L	#_CPUX_PARAM_SEND_NO,R8		;
	MOV.W	R0,@R8				;R8=WORK=CPUX_PARAM_SEND_NO:CLR

CPUX_PARSEND_100
;;;;DPRAM INPUT		MOV.L	#_COP2_SEND_PAR_NO,R5		;DPRAM CPUA取込終わり?
	MOV.W	@R5,R0				;
	TST	R0,R0				;
	TST_BIT_ON CPUX_PARSEND_END	;NO

	MOV.L	#_CPUX_PARAM_SEND_NO,R8		;
	MOV.W	@R8,R0				;R8=WORK=CPUX_PARAM_SEND_NO:CLR
	MOV.L	#_CBSYS_TOP,R4			;TOP
	ADD	R0,R4				;
	ADD	R0,R4				;
	MOV.W	@R4,R2				;
;;;;DPRAM INPUT	MOV.L	#_COP2_SEND_PAR_DAT,R6		;DPRAM:DATA
	MOV.W	R2,@R6				;DATA SET

	ADD	#1,R0				;
	MOV.W	R0,@R8				;R8=WORK=CPUX_PARAM_SEND_NO:CLR
	MOV.W	R0,@R5				;DPRAM SET=COP2_SEND_PAR_NO NEXT

	MOV.W	#D'512,R4			;
	CMP/HS	R4,R0				;最後のﾃﾞｰﾀ512[0~511]を書いた CPUCとしては終了
	BF	CPUX_PARSEND_END		;

	MOV.B	#BIT6,R0			;
	MOV.W	R0,@R7				;R7=CPUX_PARAM_SEND_FLG:FLG 終了SET

CPUX_PARSEND_END
	SUB_END
	M_RTS






;	*******************************************
;	***					***
;	***	2015-02-25			***
;	***	ﾊﾟﾗﾒｰﾀ受信＋ﾍﾞﾘﾌｧｲ		***
;	***	CPUA<=CPUC,CPUB			***
;	***					***
;	*******************************************
_CPUA_CPUX_PARAM_RCV
	SUB_START

;;;DPRAM INPUT	MOV.L	#_COP2_SEND_PAR_NO,R5		;CPUA取込終わり?
	MOV.W	@R5,R0				;
	TST	R0,R0				;
	TST_BIT_OF CPUA_CPUX_PARRCV_END		;

;;;DPRAM INPUT	MOV.L	#_COP2_SEND_PAR_DAT,R6		;
	MOV.W	@R6,R3				;DATA LOAD

	MOV.L	#_CBSYS_TOP,R4		;TOP
	ADD	#-1,R0				;
	ADD	R0,R4				;
	ADD	R0,R4				;
	MOV.W	@R4,R2				;
	CMP/EQ	R2,R3				;
	BF	CPUA_CPUX_PARRCV_ERR		;

	XOR	R0,R0				;
	MOV.W	R0,@R5				;CLR
	M_BRA	CPUA_CPUX_PARRCV_END		;

CPUA_CPUX_PARRCV_ERR
	ADD	#1,R0				;1~
;;;WORK-input	MOV.L	#_CPUC_PARAM_ERR_NO,R7		;//ﾍﾞﾘﾌｧｲ異常
	MOV.W	R0,@R7				;番号出力

CPUA_CPUX_PARRCV_END
	
	SUB_END
	M_RTS





;	***************************************************
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***		CPUBの高速化			***
;	***		2013-03-15			***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***						***
;	***************************************************
	.ALIGN	4					;
	.AIF	_SIT_CPU_SEL EQ _SIT4_CPUB		;
	.SECTION	PHiROM,CODE			;
	.AENDI						;

;
;	*******************************************
;	***					***
;	***					***
;	***	データ変換			***
;	***	演算サブルーチン		***
;	***					***
;	***					***
;	*******************************************
;	_TIM10MS_TO_1MS
;	_PG_SPD1
;	_CYCLE_SPD1
;
;
;	_POSCHG_LINK_DIG_TO_LINK_PLS
;
;
;
;

;	***********************************
;	***				***
;	***	R2*10			***
;	***	10msecﾀｲﾏ→1msec	***
;	***				***
;	***********************************
_TIM10MS_TO_1MS:
	SUB_START
	ADD	R2,R2		;*2
	MOV	R2,R1		;
	ADD	R2,R2		;*4
	ADD	R2,R2		;*8
	ADD	R1,R2		;*10
	SUB_END
	M_RTS

;	***********************************
;	***		R2/10		***
;	***********************************
_WD_DIV10:
	SUB_START
	MOV.W	#D'10,R4
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0
	SUB_END
	M_RTS
;	***********************************
;	***		R2/100		***
;	***********************************
_WD_DIV100:
	SUB_START
	MOV.W	#D'100,R4
	FAR_JSR	#_FPU_DIVS_32REG2_32REG1_R4_32REG2_R2,R0
	SUB_END
	M_RTS
;	***************************
;	***	R2*10		***
;	***************************
_MUL10:
	SUB_START
	ADD	R2,R2		;*2
	MOV	R2,R1		;
	ADD	R2,R2		;*4
	ADD	R2,R2		;*8
	ADD	R1,R2		;*10
	SUB_END
	M_RTS
;	***************************
;	***	R2*100		***
;	***************************
_UW_MUL100:
	SUB_START
	EXTU.W	R2,R2		;
	MOV.W	#D'100,R4	;
	DMULS.L	R4,R2		;
	STS	MACL,R2		;
	SUB_END
	M_RTS

	
;	***************************
;	***	R2*1000		***
;	***************************
_UW_MUL1000:
	SUB_START
	EXTU.W	R2,R2		;
	MOV.W	#D'1000,R4	;
	DMULS.L	R4,R2		;
	STS	MACL,R2		;
	SUB_END
	M_RTS
;	===================================================
;	===	 データが０の場合だけ５０００にする 	===
;	===================================================
_DATMOV_0_THEN_5000:
	SUB_START
	TST	R2,R2				;data=0なら設定を忘れているから5000
	TST_BIT_ON DATMOV_0_THEN5000_020	;
	MOV.W	#D'5000,R2			;
DATMOV_0_THEN5000_020:				;
	SUB_END
	M_RTS

;	*******************************************************************
;	***								***
;	***	R2*RPM/100.0						***
;	***	0~100.0per/100.0 *3000.0[rpm]/10 * 8192(pls)/60=pls/sec	***
;	***								***
;	*******************************************************************
;	100.0%*3000.0*8192/(10*60)/100.0=max
;	R2=100.0%
;
_PG_SPD1:
	SUB_START

	MOV.L	#(D'10*60*_SPD_PER_MAX),R4	;0.1rpm:10 ,min:60,100.0%:max
						;SPD_PER_MAXは100.00
;	----------[2009-11-03 PG04]---
	MOV.L	#_SET1_INCPLS_1REV,R0		;
	MOV.L	@R0,R1				;R1*R2*R3

	MOV.L	#_SET1_MOTRPM_MAXM,R0		;
	MOV.W	@R0,R3				;R2*R1*R3/R4
	EXTU.W	R3,R3				;
	FAR_JSR	#_FPU_R2_MUL_R1_R3_DIV_R4,R0	;

	SUB_END
	M_RTS

_MAXABS_PG_SPD1:
	SUB_START

	MOV.L	#(D'10*60*_SPD_PER_MAX),R4	;0.1rpm:10 ,min:60,100.0%:max
						;SPD_PER_MAXは100.00
	MOV.L	#_SET1_INCPLS_1REV,R0		;
	MOV.L	@R0,R1				;R1*R2*R3

	MOV.L	#_SETD_MOTRPM_MAXM,R0		;
	MOV.W	@R0,R3				;R2*R1*R3/R4
	EXTU.W	R3,R3				;
	FAR_JSR	#_FPU_R2_MUL_R1_R3_DIV_R4,R0	;

	SUB_END
	M_RTS






;	*******************************************************************
;	***								***
;	***	R2*Max[pls/s]/100.00					***
;	***								***
;	***								***
;	*******************************************************************
;	3000.0rpm*8192/10/60=MAX pls/s
;	data * Max/100.00= pls/s
;	===== サーボパラメータの画面設定====
_CYCLE_SPD1:
	SUB_START

;	==== 2002-12-16(1~10000(0.01%~100.00)以外なら1(0.01%)) ====
	MOV.W	#D'1,R1				;
	CMP/GE	R1,R2				;MIN =< data
	BT	CYCLESPD1_050			;
	MOV	R1,R2				;
CYCLESPD1_050:					;
	MOV.W	#D'10000,R4			;
	CMP/GE	R2,R4				;data =< max
	BT	CYCLESPD1_100			;
	MOV	R1,R2				;min data set
CYCLESPD1_100:					;

	MOV.L	#_LINK_MAX_SPD_PLS,R0		;
	MOV.L	@R0,R1				;data(R2) *R1/R4
	MOV.W	#_SPD_PER_MAX,R4		;100.00(0.01%単位)
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;
	SUB_END
	M_RTS

;	*******************************************************************
;	***								***
;	***	R2*Max[pls/s]/100.0					***
;	***								***
;	***								***
;	*******************************************************************
;	3000.0rpm*8192/10/60=MAX pls/s
;	data * Max/100.0= pls/s
;	===== 運転関連の画面設定====
;	===== 0.1%~100.0% ==
;	Input R2
_CYCLE_SPD2:
	SUB_START

;	==== 2002-12-16(1~1000(0.1%~100.0)以外なら1(0.1%)) ====
	MOV.W	#D'1,R1				;
	CMP/GE	R1,R2				;MIN =< data
	BT	CYCLESPD2_050			;
	MOV	R1,R2				;
CYCLESPD2_050:					;
	MOV.W	#D'1000,R4			;
	CMP/GE	R2,R4				;data =< max
	BT	CYCLESPD2_100			;
	MOV	R1,R2				;min data set
CYCLESPD2_100:					;

	MOV.L	#_LINK_MAX_SPD_PLS,R0		;[ふりこと回転で異なる]
	MOV.L	@R0,R1				;data(R2) *R1/R4
	MOV.W	#_SPD_PER_MAX/10,R4		;100.0
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0	;
	SUB_END
	M_RTS


;	***************************************************
;	***						***
;	***	ｸﾗﾝｸDIG 0.1度==>ﾘﾝｸDIG 0.1度		***
;	***	[画面]		[制御：360ｴﾝｺｰﾀﾞ相当]	***
;	***************************************************
	.IMPORT		_CLNK_SV_CHG_LINK_TBL_TOP
	.IMPORT		_LINK_PV_CHG_CLNK_TBL_TOP	;

	.EXPORT		_SV_CLNK_DG_CHG_LINK_DG1
	.EXPORT		_PV_LINK_DG_CHG_CLNK_DG1


_SV_CLNK_DG_CHG_LINK_DG1:
	SUB_START
	MOV.L	#_PAR_CLINK_LINK,R0			;2004-05-24追加
	MOV.W	@R0,R0					;
	CMP/EQ	#1,R0					;
	BT	SV_CLNK_DG_CHG_LKDG1_EXT		;"1"中型仕様ﾘﾝｸ入力なので変換しない

	SHLL	R2					;
	MOV.L	#_CLNK_SV_CHG_LINK_TBL_TOP+1*2,R0	;
	ADD	R2,R0					;
	MOV.W	@R0,R2					;

SV_CLNK_DG_CHG_LKDG1_EXT
	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	ﾘﾝｸDIG 0.1度==>ｸﾗﾝｸDIG 0.1度	***
;	***					***
;	*******************************************
_PV_LINK_DG_CHG_CLNK_DG1:
	SUB_START

	MOV.L	#_PAR_CLINK_LINK,R0			;2004-05-24追加
	MOV.W	@R0,R0					;
	CMP/EQ	#1,R0					;
	BT	PV_CLNK_DG_CHG_LKDG1_EXT		;"1"中型仕様ﾘﾝｸ入力なので変換しない

	SHLL	R2					;
	MOV.L	#_LINK_PV_CHG_CLNK_TBL_TOP+1*2,R0	;
	ADD	R2,R0					;
	MOV.W	@R0,R2					;

PV_CLNK_DG_CHG_LKDG1_EXT:				;
	SUB_END
	M_RTS

;	***********************************
;	***				***
;	***	角度の距離を求める	***
;	***	距離は正転側でSV-PV	***
;	***				***
;	***********************************
;	Input R2:SV
;	Input R1:PV
;	ANS R2:+
_DIG_LNGTH_CALC1:
	SUB_START			;
	SUB	R1,R2			;
	CMP/PZ	R2			;
	BT	DIG_LNGTH_CL1_050	;
	MOV.W	#D'3600,R1		;
	ADD	R1,R2			;
DIG_LNGTH_CL1_050:			;
	SUB_END
	M_RTS

;	***********************************
;	***	今までなぜなかった	***
;	***	2003-07-09 		***
;	***	表示角度		***
;	***********************************
_LINK_CLANK_DIG_MAK:
	SUB_START
	MOV.L	#_DISP_ENC360,R1				;ｲﾝｸﾘﾒﾝﾀﾙENC
	MOV.W	@R1,R2						;
	FAR_JSR	#_PV_LINK_DG_CHG_CLNK_DG1,R0			;
	MOV.W	#D'3600,R4					;
	CMP/HI	R2,R4						;
	BT	LINK_CLANK_DIGMK080
	SUB	R4,R2						;
LINK_CLANK_DIGMK080:						;通常制御の結果
	MOV.L	#_LINK_CLANK_PV,R1
	MOV.W	R2,@R1
	SUB_END
	M_RTS

;	***********************************
;	***	2004-03-08		***
;	***	100%時の		***
;	***********************************
_POS_LSI_100PER_FRQ_MAK:
	SUB_START

	MOV.W	#D'1000,R2			;100.0%
	FAR_JSR	#_CYCLE_SPD2,R0			;
	FAR_JSR	#_POS_LSI_FRQ_DATA_MAK,R0	;
	ADD	#1,R2				;
	MOV.L	#_FREQ_PLSI_MAX_FRQ,R1		;
	MOV.L	R2,@R1				;
	SUB_END
	M_RTS

;	=== Input R2 ===
_POS_LSI_FRQ_DATA_MAK:
	SUB_START
	MOV.L	#_POS_LSI_SPDMAX,R0				;
	MOV.L	@R0,R1						;
	MOV.L	#_POS_FRQ_SPDMAX,R0				;500KHZ(500000PLS/S)
	MOV.L	@R0,R4						;
	FAR_JSR	#_FPU_R2_MUL_R1_DIV_R4,R0			;
	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	2byteのﾘﾌﾚｯｼｭとﾃﾞｰﾀ変化を見る	***
;	***	WORD:R5=R6? ANS R7		***
;	***					***
;	*******************************************
;	*******************************************
;	***					***
;	***	R5[2B] != R6[2B]		***
;	***	THEN R5[2B]==>R6[2B]		***
;	***	      R7 |= R5xorR6		***
;	***					***
;	*******************************************
;	R1~R7
_DATA_CMP2B_R5R6_REF:
	SUB_START
	MOV.W	@R5+,R1				;
	MOV.W	@R6,R2				;
	MOV.W	R1,@R6				;
	ADD	#2,R6				;
	XOR	R2,R1				;
	OR	R1,R7				;違えば0以外
	
	SUB_END
	M_RTS


;	***************************************************
;	***						***
;	***		CPUBの高速化終了		***
;	***		2013-03-15			***
;	***						***
;	***************************************************
	.ALIGN	4					;
	.AIF	_SIT_CPU_SEL EQ _SIT4_CPUB		;
	.SECTION	P,CODE				;
	.AENDI						;




	.END
