;	*******************************************
;	***					***
;	***	とりあえずROMﾊﾟﾗﾒｰﾀ送信,受信	***
;	***	CPUB==>CPUA			***
;	*******************************************
	.import		_SNAPBUF_TOP
	.GLOBAL		_CPUBTOA_DAT1_REQADR	;TOP-ADR 2013-12[MC]
	.GLOBAL		_CPUBTOA_DAT1_REQKND	;種別	2013-12[MC]
	.GLOBAL		_CPUBTOA_DAT1_REQCNT	;個数	2013-12[MC]
	.GLOBAL		_CPUBTOA_DAT1_REQCOD	;WR	2013-12[MC]
	.GLOBAL		_CPUBTOA_DAT1_ACKCOD	;ACK	2013-12[MC]
	.GLOBAL		_CPUBTOA_DAT1_DATTOP	;256BYTE(128W)	2013-12[MC]

	.GLOBAL		_CPUDTOA_DAT1_REQADR	;TOP-ADR 2013-12[MC]
	.GLOBAL		_CPUDTOA_DAT1_REQKND	;種別	2013-12[MC]
	.GLOBAL		_CPUDTOA_DAT1_REQCNT	;個数	2013-12[MC]
	.GLOBAL		_CPUDTOA_DAT1_REQCOD	;WR	2013-12[MC]
	.GLOBAL		_CPUDTOA_DAT1_ACKCOD	;ACK	2013-12[MC]
	.GLOBAL		_CPUDTOA_DAT1_DATTOP	;256BYTE(128W)	2013-12[MC]

;	*******************************************
;	***					***
;	***	とりあえずROMﾊﾟﾗﾒｰﾀ送信,受信	***
;	***	CPUB==>CPUA			***
;	*******************************************
_RCV_BTOA_CPUBMEMX:
	SUB_START

	MOV.L	#_CPUBX_MEM1_RCVFLG,R1		;//BIT0=0:自分はON待ち BIT0=1:OFF待ち
	MOV.W	@R1,R0				;
	TST	#BIT0,R0			;
	TST_BIT_ON RCV_BTOA_BMEMX100		;

	MOV.W	#_START_REQ_COD,R4		;
	MOV.L	#_CPUBTOA_DAT1_REQCOD,R5	;ﾊﾝﾄﾞｼｪｲｸON
	MOV.W	@R5,R0				;
	CMP/EQ	R4,R0				;
	BF	RCV_BTOA_BMEMX500		;


	FAR_JSR	#_RCV_BTOA_BMEM_DGET,R0		;


	MOV.W	#_START_ACK_COD,R0		;
	MOV.L	#_CPUBTOA_DAT1_ACKCOD,R5	;
	MOV.W	R0,@R5				;

	MOV.W	#BIT0,R0			;
	MOV.L	#_CPUBX_MEM1_RCVFLG,R1		;
	MOV.W	R0,@R1				;
	M_BRA	RCV_BTOA_BMEMX500		;


RCV_BTOA_BMEMX100
	MOV.L	#_CPUBTOA_DAT1_REQCOD,R5	;ﾊﾝﾄﾞｼｪｲｸON
	MOV.W	@R5,R0				;
	TST	R0,R0				;
	TST_BIT_ON RCV_BTOA_BMEMX500		;

	MOV.L	#_CPUBTOA_DAT1_REQKND,R1	;
	MOV.W	@R1,R0				;
	MOV.W	#BIT15,R4			;
	TST	R4,R0
	TST_BIT_OF RCV_BTOA_BMEMX300		;

	MEM1_BIT0_TO_BIT7_ORSET MEM=_CPUBX_MEM1_ENDFLG,LG=W,BIT=BIT0,WKREG=R1	;

RCV_BTOA_BMEMX300

	XOR	R0,R0
	MOV.L	#_CPUBTOA_DAT1_ACKCOD,R5	;
	MOV.W	R0,@R5				;

	XOR	R0,R0
	MOV.L	#_CPUBX_MEM1_RCVFLG,R1		;
	MOV.W	R0,@R1				;

RCV_BTOA_BMEMX500


	SUB_END
	M_RTS

;
;
;
;
_RCV_BTOA_BMEM_DGET:
	SUB_START

	MOV.L	#_CPUBTOA_DAT1_REQADR,R5	;
	MOV.L	@R5,R0				;WORD OFFSET-ADR
	SHLL	R0				;*2
	MOV.L	#_CPUBX_MEM1_BUF,R8		;
	ADD	R0,R8				;


	MOV.L	#_CPUBTOA_DAT1_REQCNT,R5	;送信個数
	MOV.W	@R5,R2				;MAX 128WORD

	MOV.L	#_CPUBTOA_DAT1_DATTOP,R5	;

RCV_BTOA_BMEMDGET_100LOP:
	TST	R2,R2				;
	TST_BIT_OF RCV_BTOA_BMEMDGET_EXT	;
	MOV.W	@R5+,R0				;
	MOV.W	R0,@R8				;
	ADD	#2,R8				;
	ADD	#-1,R2				;
	M_BRA	RCV_BTOA_BMEMDGET_100LOP	;
	
RCV_BTOA_BMEMDGET_EXT:


	SUB_END
	M_RTS

;	*******************************************
;	***					***
;	***	とりあえずSNAP送信,受信		***
;	***	CPUD==>CPUA			***
;	*******************************************
_RCV_DTOA_CPUDMEMX:
	SUB_START

	MOV.L	#_CPUDX_MEM1_RCVFLG,R1		;//BIT0=0:自分はON待ち BIT0=1:OFF待ち
	MOV.W	@R1,R0				;
	TST	#BIT0,R0			;
	TST_BIT_ON RCV_DTOA_DMEMX100		;

	MOV.W	#_START_REQ_COD,R4		;
	MOV.L	#_CPUDTOA_DAT1_REQCOD,R5	;ﾊﾝﾄﾞｼｪｲｸON
	MOV.W	@R5,R0				;
	CMP/EQ	R4,R0				;
	BF	RCV_DTOA_DMEMX500		;


	FAR_JSR	#_RCV_DTOA_DMEM_DGET,R0		;


	MOV.W	#_START_ACK_COD,R0		;
	MOV.L	#_CPUDTOA_DAT1_ACKCOD,R5	;
	MOV.W	R0,@R5				;

	MOV.W	#BIT0,R0			;
	MOV.L	#_CPUDX_MEM1_RCVFLG,R1		;
	MOV.W	R0,@R1				;
	M_BRA	RCV_DTOA_DMEMX500		;


RCV_DTOA_DMEMX100
	MOV.L	#_CPUDTOA_DAT1_REQCOD,R5	;ﾊﾝﾄﾞｼｪｲｸON
	MOV.W	@R5,R0				;
	TST	R0,R0				;
	TST_BIT_ON RCV_DTOA_DMEMX500		;

	MOV.L	#_CPUDTOA_DAT1_REQKND,R1	;
	MOV.W	@R1,R0				;
	MOV.W	#BIT15,R4			;
	TST	R4,R0
	TST_BIT_OF RCV_DTOA_DMEMX300		;

	MEM1_BIT0_TO_BIT7_ORSET MEM=_CPUDX_MEM1_ENDFLG,LG=W,BIT=BIT0,WKREG=R1	;

RCV_DTOA_DMEMX300

	XOR	R0,R0
	MOV.L	#_CPUDTOA_DAT1_ACKCOD,R5	;
	MOV.W	R0,@R5				;

	XOR	R0,R0
	MOV.L	#_CPUDX_MEM1_RCVFLG,R1		;
	MOV.W	R0,@R1				;

RCV_DTOA_DMEMX500


	SUB_END
	M_RTS

;
;
;
;
_RCV_DTOA_DMEM_DGET:
	SUB_START

	MOV.L	#_CPUDTOA_DAT1_REQADR,R5	;
	MOV.L	@R5,R0				;WORD OFFSET-ADR
	SHLL	R0				;*2
	MOV.L	#_SNAPBUF_TOP,R8		;
	ADD	R0,R8				;


	MOV.L	#_CPUDTOA_DAT1_REQCNT,R5	;送信個数
	MOV.W	@R5,R2				;MAX 512WORD

	MOV.L	#_CPUDTOA_DAT1_DATTOP,R5	;

RCV_DTOA_DMEMDGET_100LOP:
	TST	R2,R2				;
	TST_BIT_OF RCV_DTOA_DMEMDGET_EXT	;
	MOV.W	@R5+,R0				;
	MOV.W	R0,@R8				;
	ADD	#2,R8				;
	ADD	#-1,R2				;
	M_BRA	RCV_DTOA_DMEMDGET_100LOP	;
	
RCV_DTOA_DMEMDGET_EXT:


	SUB_END
	M_RTS





